<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loginus - Дашборд</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8fafc;
            color: #1a202c;
            line-height: 1.6;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            position: fixed;
            height: 100vh;
            left: 0;
            top: 0;
            z-index: 1000;
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .sidebar-header {
            padding: 2rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo {
            font-size: 1.8rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(45deg, #ff6b6b, #ffa500);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .sidebar-nav {
            padding: 1rem 0;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: all 0.3s ease;
            position: relative;
            margin: 0.25rem 1rem;
            border-radius: 12px;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            transform: translateX(4px);
        }

        .nav-item.active {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .nav-item.active::before {
            content: '';
            position: absolute;
            left: -1rem;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 24px;
            background: #ff6b6b;
            border-radius: 2px;
        }

        .nav-icon {
            width: 24px;
            height: 24px;
            margin-right: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .user-info {
            padding: 1rem 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: auto;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff6b6b, #ffa500);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .user-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .user-role {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .logout-btn {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.8);
            cursor: pointer;
            font-size: 0.9rem;
            margin-top: 0.5rem;
            padding: 0.5rem;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        /* Main Content */
        .main-content {
            margin-left: 280px;
            flex: 1;
            background: #f8fafc;
            min-height: 100vh;
        }

        .content-header {
            background: white;
            padding: 2rem;
            border-bottom: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .page-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: #1a202c;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .notification-btn {
            position: relative;
            background: none;
            border: none;
            color: #64748b;
            cursor: pointer;
            padding: 0.75rem;
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .notification-btn:hover {
            background: #f1f5f9;
            color: #374151;
        }

        .notification-badge {
            position: absolute;
            top: 0.25rem;
            right: 0.25rem;
            width: 8px;
            height: 8px;
            background: #ef4444;
            border-radius: 50%;
        }

        .content-body {
            padding: 2rem;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
            margin-bottom: 2rem;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1a202c;
        }

        /* Statistics */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid #e2e8f0;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .stat-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            font-size: 1.5rem;
            color: white;
        }

        .stat-icon.users {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .stat-icon.security {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .stat-icon.invitations {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .stat-icon.articles {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        }

        .stat-value {
            font-size: 3rem;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #64748b;
            font-size: 1rem;
            font-weight: 500;
        }

        /* Tables */
        .table-container {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid #e2e8f0;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th {
            background: #f8fafc;
            padding: 1.5rem 2rem;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e2e8f0;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .table td {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid #f1f5f9;
            vertical-align: top;
        }

        .table tbody tr:hover {
            background: #f8fafc;
        }

        .user-info {
            display: flex;
            align-items: center;
        }

        .user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            margin-right: 1rem;
            font-size: 1.2rem;
        }

        .user-details h4 {
            font-weight: 600;
            color: #1a202c;
            margin-bottom: 0.25rem;
        }

        .user-details p {
            color: #64748b;
            font-size: 0.9rem;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .status-badge.active {
            background: #d1fae5;
            color: #065f46;
        }

        .status-badge.pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-badge.inactive {
            background: #fee2e2;
            color: #991b1b;
        }

        .role-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            background: #e0e7ff;
            color: #3730a3;
            margin-right: 0.5rem;
            margin-bottom: 0.25rem;
        }

        .role-badge.team-role {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        .role-badge.org-role {
            background: #f3e8ff;
            color: #7c3aed;
            border: 1px solid #c4b5fd;
        }

        .team-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
            margin-right: 0.5rem;
            margin-bottom: 0.25rem;
        }

        .org-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            background: #f3e8ff;
            color: #7c3aed;
            border: 1px solid #c4b5fd;
            margin-right: 0.5rem;
            margin-bottom: 0.25rem;
        }

        .member-details {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #f1f5f9;
            color: #64748b;
            border: 1px solid #e2e8f0;
        }

        .btn-secondary:hover {
            background: #e2e8f0;
            color: #374151;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        .btn:disabled:hover {
            transform: none !important;
            box-shadow: none !important;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid #e2e8f0;
        }

        .tab {
            padding: 1rem 2rem;
            background: none;
            border: none;
            color: #64748b;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            border-radius: 8px 8px 0 0;
        }

        .tab:hover {
            color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .tab.active {
            color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 2px;
        }

        /* Search */
        .search-container {
            position: relative;
            margin-bottom: 2rem;
        }

        .search-input {
            width: 100%;
            padding: 1rem 1rem 1rem 3rem;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #64748b;
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            border-left: 4px solid #10b981;
            z-index: 10000;
            max-width: 400px;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            border-left-color: #10b981;
        }

        .notification.error {
            border-left-color: #ef4444;
        }

        .notification.warning {
            border-left-color: #f59e0b;
        }

        /* Hidden sections */
        .section {
            display: none;
        }

        .section.active {
            display: block;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .table-container {
                overflow-x: auto;
            }
        }

        /* Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in-up {
            animation: fadeInUp 0.6s ease-out;
        }

        /* Settings Form Styles */
        .settings-form {
            max-width: 600px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #374151;
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group input[readonly] {
            background-color: #f9fafb;
            color: #6b7280;
        }

        .input-group {
            display: flex;
            gap: 0.5rem;
        }

        .input-group input {
            flex: 1;
        }

        .btn-outline {
            background: transparent;
            color: #667eea;
            border: 2px solid #667eea;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        .btn-outline:hover {
            background: #667eea;
            color: white;
        }

        .text-muted {
            color: #6b7280;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid #e5e7eb;
        }

        .security-settings {
            margin-top: 1rem;
        }

        .security-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .security-item:last-child {
            border-bottom: none;
        }

        .security-info h3 {
            margin: 0 0 0.25rem 0;
            font-size: 1rem;
            font-weight: 600;
            color: #374151;
        }

        .security-info p {
            margin: 0;
            font-size: 0.875rem;
            color: #6b7280;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #667eea;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background-color: #f3f4f6;
            color: #374151;
        }

        .modal form {
            padding: 1.5rem;
        }

        .modal .form-group {
            margin-bottom: 1rem;
        }

        .modal .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }

        .modal .form-group input,
        .modal .form-group textarea,
        .modal .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s ease;
        }

        .modal .form-group input:focus,
        .modal .form-group textarea:focus,
        .modal .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .modal .form-group small {
            display: block;
            margin-top: 0.25rem;
            color: #6b7280;
            font-size: 0.875rem;
        }

        .modal .form-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">
                        <i class="fas fa-brain"></i>
                    </div>
                    <div>Loginus</div>
                </div>
            </div>
            <div class="sidebar-nav">
                <a href="#" class="nav-item active" data-section="dashboard">
                    <div class="nav-icon">
                        <i class="fas fa-chart-pie"></i>
                    </div>
                    Дашборд
                </a>
                <!-- <a href="#" class="nav-item" data-section="knowledge">
                    <div class="nav-icon">
                        <i class="fas fa-book"></i>
                    </div>
                    База знаний
                </a> -->
                <a href="#" class="nav-item" data-section="users">
                    <div class="nav-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    Сотрудники
                </a>
                <a href="#" class="nav-item" data-section="teams">
                    <div class="nav-icon">
                        <i class="fas fa-user-friends"></i>
                    </div>
                    Команды
                </a>
                <a href="#" class="nav-item" data-section="organizations">
                    <div class="nav-icon">
                        <i class="fas fa-building"></i>
                    </div>
                    Организации
                </a>
                <!-- <a href="#" class="nav-item" data-section="support">
                    <div class="nav-icon">
                        <i class="fas fa-headset"></i>
                    </div>
                    Поддержка
                </a> -->
                <!-- <a href="#" class="nav-item" data-section="statistics">
                    <div class="nav-icon">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                    Статистика
                </a> -->
                <a href="#" class="nav-item" data-section="invitations" onclick="showSection('invitations'); return false;">
                    <div class="nav-icon">
                        <i class="fas fa-envelope"></i>
                    </div>
                    Приглашения
                </a>
                <a href="#" class="nav-item" data-section="settings">
                    <div class="nav-icon">
                        <i class="fas fa-cog"></i>
                    </div>
                    Настройки
                </a>
                <!-- Admin panel removed for regular admin users -->
            </div>
            
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="user-name" id="userName">Загрузка...</div>
                <div class="user-role" id="userRole">Пользователь</div>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    Выйти
                </button>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <div class="content-header">
                <h1 class="page-title">Дашборд</h1>
                <div class="header-actions">
                    <button class="notification-btn" onclick="showNotifications()">
                        <i class="fas fa-bell"></i>
                        <div class="notification-badge" id="notificationBadge"></div>
                    </button>
                </div>
            </div>

            <div class="content-body">
                <!-- Dashboard Section -->
                <div id="dashboard" class="section active">
                    <!-- Statistics Cards -->
                    <div class="stats-grid">
                        <div class="stat-card fade-in-up">
                            <div class="stat-header">
                                <div class="stat-icon users">
                                    <i class="fas fa-users"></i>
                                </div>
                                <div>
                                    <div class="stat-value" id="totalUsers">0</div>
                                        <div class="stat-label" id="totalUsersLabel">Сотрудников в системе</div>
                                </div>
                            </div>
                        </div>

                        <div class="stat-card fade-in-up">
                            <div class="stat-header">
                                <div class="stat-icon security">
                                    <i class="fas fa-shield-alt"></i>
                                </div>
                                <div>
                                    <div class="stat-value" id="activeUsers">0</div>
                                    <div class="stat-label" id="activeUsersLabel">Активных пользователей</div>
                                </div>
                            </div>
                        </div>

                        <div class="stat-card fade-in-up">
                            <div class="stat-header">
                                <div class="stat-icon invitations">
                                    <i class="fas fa-envelope"></i>
                                </div>
                                <div>
                                    <div class="stat-value" id="invitationsCount">0</div>
                                    <div class="stat-label" id="invitationsLabel">Ожидающих приглашений</div>
                                </div>
                            </div>
                        </div>

                        <div class="stat-card fade-in-up">
                            <div class="stat-header">
                                <div class="stat-icon articles">
                                    <i class="fas fa-book"></i>
                                </div>
                                <div>
                                    <div class="stat-value" id="articles">0</div>
                                    <div class="stat-label" id="articlesLabel">Статей в базе знаний</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    

                    <!-- Recent Activity -->
                    <div class="card fade-in-up">
                        <div class="card-header">
                            <h2 class="card-title">Последняя активность</h2>
                        </div>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Пользователь</th>
                                        <th>Действие</th>
                                        <th>Время</th>
                                        <th>Статус</th>
                                    </tr>
                                </thead>
                                <tbody id="recentActivityBody">
                                    <tr>
                                        <td>
                                            <div class="user-info">
                                                <div class="user-avatar">A</div>
                                                <div class="user-details">
                                                    <h4>Админ Системы</h4>
                                                    <p>admin@loginus.ru</p>
                                                </div>
                                            </div>
                                        </td>
                                        <td>Вход в систему</td>
                                        <td>Только что</td>
                                        <td><span class="status-badge active">Успешно</span></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Users Section -->
                <div id="users" class="section">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Сотрудники</h2>
                            <button class="btn btn-primary" onclick="showInviteModal()">
                                <i class="fas fa-user-plus"></i>
                                Пригласить сотрудника
                            </button>
                        </div>
                        
                        <div class="tabs">
                            <button class="tab active" onclick="switchUserTab('active')">Активные</button>
                            <button class="tab" onclick="switchUserTab('invited')">Приглашенные</button>
                        </div>

                        <div class="search-container">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" class="search-input" placeholder="Поиск по имени, email, роли..." id="userSearch">
                        </div>

                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Сотрудник</th>
                                        <th>Роль</th>
                                        <th>Команда</th>
                                        <th>Статус</th>
                                        <th>Действия</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                    <!-- Users will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Teams Section -->
                <div id="teams" class="section">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Команды</h2>
                            <button class="btn btn-primary" onclick="showCreateTeamModal()">
                                <i class="fas fa-plus"></i>
                                Создать команду
                            </button>
                        </div>
                        
                        <div class="search-container">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" class="search-input" placeholder="Поиск по названию команды..." id="teamSearch">
                        </div>

                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Команда</th>
                                        <th>Участники</th>
                                        <th>Руководитель</th>
                                        <th>Создана</th>
                                        <th>Действия</th>
                                    </tr>
                                </thead>
                                <tbody id="teamsTableBody">
                                    <!-- Teams will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Organizations Section -->
                <div id="organizations" class="section">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Организации</h2>
                            <button class="btn btn-primary" onclick="showCreateOrgModal()">
                                <i class="fas fa-plus"></i>
                                Создать организацию
                            </button>
                        </div>
                        
                        <div class="search-container">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" class="search-input" placeholder="Поиск по названию организации..." id="orgSearch">
                        </div>

                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Организация</th>
                                        <th>Команды</th>
                                        <th>Сотрудники</th>
                                        <th>Руководитель</th>
                                        <th>Действия</th>
                                    </tr>
                                </thead>
                                <tbody id="organizationsTableBody">
                                    <!-- Organizations will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Statistics Section -->
                <div id="statistics" class="section">
                    <div class="card">
                        <h2 class="card-title">Статистика системы</h2>
                        
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-header">
                                    <div class="stat-icon users">
                                        <i class="fas fa-users"></i>
                                    </div>
                                    <div>
                                        <div class="stat-value" id="statsTotalUsers">0</div>
                                        <div class="stat-label">Всего пользователей</div>
                                    </div>
                                </div>
                            </div>

                            <div class="stat-card">
                                <div class="stat-header">
                                    <div class="stat-icon security">
                                        <i class="fas fa-shield-alt"></i>
                                    </div>
                                    <div>
                                        <div class="stat-value" id="statsActiveUsers">0</div>
                                        <div class="stat-label">Активных сессий</div>
                                    </div>
                                </div>
                            </div>

                            <div class="stat-card">
                                <div class="stat-header">
                                    <div class="stat-icon invitations">
                                        <i class="fas fa-envelope"></i>
                                    </div>
                                    <div>
                                        <div class="stat-value" id="statsInvitations">0</div>
                                        <div class="stat-label">Приглашений отправлено</div>
                                    </div>
                                </div>
                            </div>

                            <div class="stat-card">
                                <div class="stat-header">
                                    <div class="stat-icon articles">
                                        <i class="fas fa-book"></i>
                                    </div>
                                    <div>
                                        <div class="stat-value" id="statsArticles">0</div>
                                        <div class="stat-label">Статей в базе знаний</div>
                                    </div>
                                </div>
                            </div>

                            <div class="stat-card">
                                <div class="stat-header">
                                    <div class="stat-icon" style="background: linear-gradient(135deg, #06b6d4, #0891b2);">
                                        <i class="fas fa-headset"></i>
                                    </div>
                                    <div>
                                        <div class="stat-value" id="statsTickets">0</div>
                                        <div class="stat-label">Тикетов поддержки</div>
                                    </div>
                                </div>
                            </div>

                            <div class="stat-card">
                                <div class="stat-header">
                                    <div class="stat-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                                        <i class="fas fa-clock"></i>
                                    </div>
                                    <div>
                                        <div class="stat-value" id="statsAvgResponse">0ч</div>
                                        <div class="stat-label">Среднее время ответа</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Other sections -->
                <div id="knowledge" class="section">
                    <div class="card">
                        <h2 class="card-title">База знаний</h2>
                        <p>Раздел базы знаний будет здесь...</p>
                    </div>
                </div>

                <div id="support" class="section">
                    <div class="card">
                        <h2 class="card-title">Поддержка</h2>
                        <p>Раздел поддержки будет здесь...</p>
                    </div>
                </div>


                <div id="invitations" class="section">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Приглашения</h2>
                            <button class="btn btn-primary" onclick="refreshInvitations()">
                                <i class="fas fa-sync-alt"></i>
                                Обновить
                            </button>
                        </div>
                        
                        <div id="invitationsContainer">
                            <div class="loading-placeholder">Загрузка приглашений...</div>
                        </div>
                    </div>
                </div>

                <div id="settings" class="section">
                    <div class="card">
                        <h2 class="card-title">Настройки профиля</h2>
                        <form id="settingsForm" class="settings-form">
                            <div class="form-group">
                                <label for="firstName">Имя</label>
                                <input type="text" id="firstName" name="firstName" placeholder="Введите ваше имя">
                            </div>
                            
                            <div class="form-group">
                                <label for="lastName">Фамилия</label>
                                <input type="text" id="lastName" name="lastName" placeholder="Введите вашу фамилию">
                            </div>
                            
                            <div class="form-group">
                                <label for="email">Email</label>
                                <div class="input-group">
                                    <input type="email" id="email" name="email" readonly>
                                    <button type="button" id="verifyEmailBtn" class="btn btn-outline">Подтвердить</button>
                                </div>
                                <small class="text-muted" id="emailStatus">Email не подтвержден</small>
                            </div>
                            
                            <div class="form-group" id="githubInfoGroup" style="display: none;">
                                <label>GitHub информация</label>
                                <div style="background: #f3f4f6; padding: 0.75rem; border-radius: 6px; margin-top: 0.5rem;">
                                    <div style="margin-bottom: 0.5rem;">
                                        <strong>GitHub Username:</strong> <span id="displayGithubUsername" style="font-family: monospace; background: white; padding: 0.25rem 0.5rem; border-radius: 4px;">-</span>
                                        <button type="button" onclick="copyToClipboard(document.getElementById('displayGithubUsername').textContent)" style="margin-left: 0.5rem; padding: 0.25rem 0.5rem; font-size: 0.85rem; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                            <i class="fas fa-copy"></i> Копировать
                                        </button>
                                    </div>
                                    <div style="margin-bottom: 0.5rem;">
                                        <strong>GitHub ID:</strong> <span id="displayGithubId" style="font-family: monospace; background: white; padding: 0.25rem 0.5rem; border-radius: 4px;">-</span>
                                        <small class="text-muted" style="margin-left: 0.5rem;">(только для справки)</small>
                                    </div>
                                    <small class="text-muted" style="display: block; margin-top: 0.5rem;">
                                        💡 Ваш GitHub username используется для приглашений других пользователей. Система ищет пользователей строго по полю GitHub username в базе данных.
                                    </small>
                                </div>
                            </div>
                            
                            
                            
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">Сохранить изменения</button>
                                <button type="button" id="cancelSettings" class="btn btn-secondary">Отмена</button>
                            </div>
                        </form>
                    </div>
                    
                    <div class="card">
                        <h2 class="card-title">Способы входа</h2>
                        <div id="authMethodsContainer">
                            <div class="loading-placeholder">Загрузка способов входа...</div>
                        </div>
                        <!-- Управление модулями для super_admin -->
                        <div id="adminModuleControls" style="display: none; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #e5e7eb;">
                            <h3 style="margin-bottom: 1rem; font-size: 1.125rem; font-weight: 600;">Управление способами входа (только для суперадмина)</h3>
                            <div id="moduleTogglesContainer">
                                <div class="loading-placeholder">Загрузка модулей...</div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <h2 class="card-title">Безопасность</h2>
                        <div class="security-settings">
                            <div class="security-item">
                                <div class="security-info">
                                    <h3>nFA (Многофакторная аутентификация)</h3>
                                    <p>Выберите методы подтверждения при входе. Можно выбрать любое количество из подключенных способов входа.</p>
                                </div>
                            </div>
                            
                            <div id="nfaMethodsContainer" style="margin-top: 1rem;">
                                <!-- Чекбоксы для методов nFA будут добавлены динамически -->
                            </div>
                            
                            <div style="margin-top: 1rem;">
                                <button type="button" class="btn btn-primary" id="saveNfaSettingsBtn">
                                    <i class="fas fa-save"></i> Сохранить настройки nFA
                                </button>
                            </div>
                            
                        </div>
                    </div>

                    <div class="card" id="referralCard">
                        <h2 class="card-title">Реферальные ссылки</h2>
                        <div class="referral-settings">
                            <!-- Управление реферальной системой для super_admin -->
                            <div id="referralModuleControl" style="display: none; margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid #e5e7eb;">
                                <div class="security-item">
                                    <div class="security-info">
                                        <h3>Реферальная система</h3>
                                        <p>Включить/отключить реферальную систему</p>
                                    </div>
                                    <div class="security-action">
                                        <label class="switch">
                                            <input type="checkbox" id="referralSystemToggle">
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-actions">
                                <button type="button" class="btn btn-primary" id="generateReferralLinkBtn">
                                    <i class="fas fa-link"></i>
                                    Создать реферальную ссылку
                                </button>
                            </div>
                            
                            <div id="referralLinksList" style="margin-top: 1.5rem;">
                                <h3 style="margin-bottom: 1rem;">Мои реферальные ссылки</h3>
                                <div id="referralLinksContainer">
                                    <div class="loading-placeholder">Загрузка ссылок...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer"></div>

    <!-- Модальное окно создания организации -->
    <div id="createOrgModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Создать организацию</h2>
                <button class="modal-close" onclick="closeCreateOrgModal()">&times;</button>
            </div>
            <form id="createOrgForm" method="POST">
                <div class="form-group">
                    <label for="orgName">Название организации *</label>
                    <input type="text" id="orgName" name="name" required placeholder="Введите название организации">
                </div>
                <div class="form-group">
                    <label for="orgDescription">Описание</label>
                    <textarea id="orgDescription" name="description" rows="3" placeholder="Описание организации (необязательно)"></textarea>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" id="createOrgBtn">
                        <span id="createOrgText">Создать организацию</span>
                        <span id="createOrgLoading" class="loading hidden"></span>
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeCreateOrgModal()">Отмена</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Модальное окно создания команды -->
    <div id="createTeamModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Создать команду</h2>
                <button class="modal-close" onclick="closeCreateTeamModal()">&times;</button>
            </div>
            <form id="createTeamForm" method="POST">
                <div class="form-group">
                    <label for="teamName">Название команды *</label>
                    <input type="text" id="teamName" name="name" required placeholder="Введите название команды">
                </div>
                <div class="form-group">
                    <label for="teamDescription">Описание</label>
                    <textarea id="teamDescription" name="description" rows="3" placeholder="Описание команды (необязательно)"></textarea>
                </div>
                <div class="form-group">
                    <label for="teamOrganization">Организация *</label>
                    <select id="teamOrganization" name="organizationId" required>
                        <option value="">Выберите организацию</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" id="createTeamBtn">
                        <span id="createTeamText">Создать команду</span>
                        <span id="createTeamLoading" class="loading hidden"></span>
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeCreateTeamModal()">Отмена</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Модальное окно приглашения пользователя -->
    <div id="inviteUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Пригласить сотрудника</h2>
                <button class="modal-close" onclick="closeInviteUserModal()">&times;</button>
            </div>
            <form id="inviteUserForm" method="POST">
                <div class="form-group">
                    <label for="inviteIdentifierType">Способ идентификации *</label>
                    <select id="inviteIdentifierType" name="identifierType" required onchange="toggleInviteIdentifierType()">
                        <option value="">Выберите способ</option>
                        <option value="email">Email</option>
                        <option value="github">GitHub username</option>
                        <option value="telegram">Telegram username</option>
                    </select>
                </div>
                <div class="form-group" id="inviteEmailGroup">
                    <label for="inviteEmail">Email сотрудника *</label>
                    <input type="email" id="inviteEmail" name="email" placeholder="user@example.com">
                </div>
                <div class="form-group" id="inviteGithubGroup" style="display: none;">
                    <label for="inviteGithubUsername">GitHub username *</label>
                    <input type="text" id="inviteGithubUsername" name="githubUsername" placeholder="username (без @)">
                    <small class="form-text text-muted">
                        Введите GitHub username пользователя (без символа @). 
                        <strong>💡 Совет:</strong> Свой GitHub username можно посмотреть в настройках профиля (раздел "Настройки" → "GitHub информация").
                        Система будет искать пользователя строго по полю GitHub username в базе данных, поэтому важно указать точный username.
                    </small>
                </div>
                <div class="form-group" id="inviteTelegramGroup" style="display: none;">
                    <label for="inviteTelegramUsername">Telegram username *</label>
                    <input type="text" id="inviteTelegramUsername" name="telegramUsername" placeholder="username">
                    <small class="form-text text-muted">Введите Telegram username пользователя (без @)</small>
                </div>
                <div class="form-group">
                    <label for="inviteType">Тип приглашения *</label>
                    <select id="inviteType" name="type" required onchange="toggleInviteTarget()">
                        <option value="">Выберите тип</option>
                        <option value="organization">В организацию</option>
                        <option value="team">В команду</option>
                    </select>
                </div>
                <div class="form-group" id="inviteOrganizationGroup" style="display: none;">
                    <label for="inviteOrganization">Организация *</label>
                    <select id="inviteOrganization" name="organizationId" onchange="loadRolesForInvite('organization')">
                        <option value="">Выберите организацию</option>
                    </select>
                </div>
                <div class="form-group" id="inviteTeamGroup" style="display: none;">
                    <label for="inviteTeam">Команда *</label>
                    <select id="inviteTeam" name="teamId" onchange="loadRolesForInvite('team')">
                        <option value="">Выберите команду</option>
                    </select>
                </div>
                <div class="form-group" id="inviteRoleGroup" style="display: none;">
                    <label for="inviteRole">Роль в команде/организации *</label>
                    <select id="inviteRole" name="roleId">
                        <option value="">Выберите роль</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" id="inviteUserBtn">
                        <span id="inviteUserText">Отправить приглашение</span>
                        <span id="inviteUserLoading" class="loading hidden"></span>
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeInviteUserModal()">Отмена</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="editUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Редактировать сотрудника</h2>
                <button class="modal-close" onclick="closeEditUserModal()">&times;</button>
            </div>
                        <form id="editUserForm" method="POST">
                            <input type="hidden" id="editUserId" name="userId">
                            <div class="form-group">
                                <label for="editUserEmail">Email</label>
                                <input type="email" id="editUserEmail" name="email" readonly>
                            </div>
                            <div class="form-group">
                                <label for="editUserTargetType">Тип назначения</label>
                                <select id="editUserTargetType" name="targetType" onchange="toggleEditTarget()">
                                    <option value="team">Команда</option>
                                    <option value="organization">Организация</option>
                                </select>
                            </div>
                            <div class="form-group" id="editUserTeamGroup">
                                <label for="editUserTeam">Команда</label>
                                <select id="editUserTeam" name="teamId">
                                    <option value="">Выберите команду</option>
                                </select>
                            </div>
                            <div class="form-group" id="editUserOrgGroup" style="display: none;">
                                <label for="editUserOrganization">Организация</label>
                                <select id="editUserOrganization" name="organizationId">
                                    <option value="">Выберите организацию</option>
                                </select>
                            </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" id="editUserBtn">
                        <span id="editUserText">Сохранить изменения</span>
                        <span id="editUserLoading" class="loading hidden"></span>
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeEditUserModal()">Отмена</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Модальное окно переноса пользователя между командами -->
    <div id="transferUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Перенести сотрудника между командами</h2>
                <button class="modal-close" onclick="closeTransferUserModal()">&times;</button>
            </div>
            <form id="transferUserForm" method="POST">
                <input type="hidden" id="transferUserId" name="userId">
                <div class="form-group">
                    <label for="transferUserEmail">Email сотрудника</label>
                    <input type="email" id="transferUserEmail" name="email" readonly>
                </div>
                <div class="form-group">
                    <label for="transferFromTeam">Из команды</label>
                    <select id="transferFromTeam" name="fromTeamId" required>
                        <option value="">Выберите команду</option>
                    </select>
                    <small class="form-text text-muted">Выберите команду, из которой переносится сотрудник</small>
                </div>
                <div class="form-group">
                    <label for="transferToTeam">В команду</label>
                    <select id="transferToTeam" name="toTeamId" required>
                        <option value="">Выберите команду</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="transferUserRole">Роль в новой команде</label>
                    <select id="transferUserRole" name="roleId" required>
                        <option value="">Выберите роль</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" id="transferUserBtn">
                        <span id="transferUserText">Перенести</span>
                        <span id="transferUserLoading" class="loading" style="display: none;">⏳</span>
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeTransferUserModal()">Отмена</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Bind Email Modal -->
    <div id="bindEmailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Привязать Email</h2>
                <button class="modal-close" onclick="closeBindEmailModal()">&times;</button>
            </div>
            <form id="bindEmailForm" onsubmit="handleBindEmail(event)">
                <div class="form-group">
                    <label for="bindEmailInput">Email</label>
                    <input type="email" id="bindEmailInput" name="email" placeholder="your@email.com" required>
                </div>
                <div class="form-group">
                    <label for="bindEmailPassword">Пароль для этого email</label>
                    <input type="password" id="bindEmailPassword" name="password" placeholder="Введите пароль" required>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" id="bindEmailBtn">
                        <span id="bindEmailBtnText">Привязать</span>
                        <span id="bindEmailLoading" class="loading hidden"></span>
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeBindEmailModal()">Отмена</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Change User Role Modal -->
    <div id="changeUserRoleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Изменить роль сотрудника</h2>
                <button class="modal-close" onclick="closeChangeUserRoleModal()">&times;</button>
            </div>
            <form id="changeUserRoleForm" method="POST">
                <input type="hidden" id="changeUserRoleUserId" name="userId">
                <div class="form-group">
                    <label for="changeUserRoleEmail">Email сотрудника</label>
                    <input type="email" id="changeUserRoleEmail" name="email" readonly>
                </div>
                <div class="form-group">
                    <label for="changeUserRoleContext">Контекст</label>
                    <select id="changeUserRoleContext" name="context" required>
                        <option value="">Выберите контекст</option>
                        <option value="organization">Организация</option>
                        <option value="team">Команда</option>
                    </select>
                </div>
                <div class="form-group" id="changeUserRoleOrganizationGroup" style="display: none;">
                    <label for="changeUserRoleOrganization">Организация</label>
                    <select id="changeUserRoleOrganization" name="organizationId">
                        <option value="">Выберите организацию</option>
                    </select>
                </div>
                <div class="form-group" id="changeUserRoleTeamGroup" style="display: none;">
                    <label for="changeUserRoleTeam">Команда</label>
                    <select id="changeUserRoleTeam" name="teamId">
                        <option value="">Выберите команду</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="changeUserRoleNewRole">Новая роль</label>
                    <select id="changeUserRoleNewRole" name="roleId" required>
                        <option value="">Выберите роль</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" id="changeUserRoleBtn">
                        <span id="changeUserRoleText">Изменить роль</span>
                        <span id="changeUserRoleLoading" class="loading" style="display: none;">⏳</span>
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeChangeUserRoleModal()">Отмена</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Define API_BASE_URL globally
        window.API_BASE_URL = (() => {
            const hostname = window.location.hostname;
            if (hostname === 'localhost' || hostname === '127.0.0.1') {
                return 'http://localhost:3001';
            }
            if (hostname.match(/^\d+\.\d+\.\d+\.\d+$/)) {
                return `${window.location.protocol}//${window.location.hostname}:3001`;
            }
            return `${window.location.protocol}//${window.location.hostname}`;
        })();
        console.log('API_BASE_URL defined:', window.API_BASE_URL);
    </script>
    <script>
        // Global variables
        let currentUser = null;
        let authToken = null;
        let currentUsersList = [];

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            
            // Принудительно загружаем приглашения при загрузке страницы
            setTimeout(() => {
                console.log('Force loading invitations...');
                loadInvitations();
            }, 1000);
        });

        // Флаг для предотвращения множественных инициализаций
        let isAppInitializing = false;

        // Initialize application
        async function initializeApp() {
            // Предотвращаем множественные инициализации
            if (isAppInitializing) {
                console.log('🚫 App already initializing, skipping');
                return;
            }
            isAppInitializing = true;
            
            // Check for tokens in URL parameters (from OAuth callbacks) - ПЕРВЫМ делом!
            const urlParams = new URLSearchParams(window.location.search);
            const urlToken = urlParams.get('token');
            const urlRefreshToken = urlParams.get('refreshToken');
            
            if (urlToken) {
                console.log('🔑 Token found in URL, saving to localStorage');
                authToken = urlToken;
                localStorage.setItem('authToken', urlToken);
                localStorage.setItem('accessToken', urlToken); // Также сохраняем как accessToken для совместимости
                if (urlRefreshToken) {
                    localStorage.setItem('refreshToken', urlRefreshToken);
                    console.log('✅ Refresh token also saved');
                }
                console.log('✅ Token saved to localStorage:', urlToken.substring(0, 20) + '...');
                console.log('✅ Token length:', urlToken.length);
                
                // НЕМЕДЛЕННО очищаем URL чтобы избежать проблем с повторным парсингом
                const cleanUrl = window.location.pathname;
                window.history.replaceState({}, document.title, cleanUrl);
                
                // Небольшая задержка чтобы убедиться что localStorage сохранен
                await new Promise(resolve => setTimeout(resolve, 50));
            } else {
                // Check if user is logged in
                authToken = localStorage.getItem('authToken') || localStorage.getItem('accessToken');
            }
            
            if (!authToken) {
                console.log('❌ No token found, redirecting to login');
                window.location.href = 'index.html';
                return;
            }
            console.log('🔑 Token found, proceeding with dashboard initialization. Token:', authToken.substring(0, 20) + '...');
            console.log('🔑 AuthToken from localStorage:', localStorage.getItem('authToken')?.substring(0, 20) + '...');

            try {
                // Load user data
                await loadCurrentUser();
                
                // Load dashboard data
                await loadDashboardData();
                
                // Setup event listeners
                setupEventListeners();
                
                // Show welcome notification
                showNotification('Добро пожаловать в систему!', 'success');
            } catch (error) {
                console.error('Error initializing app:', error);
                // Проверяем, не является ли ошибка 401 - тогда возможно токен невалиден
                if (error.message && error.message.includes('Unauthorized')) {
                    console.error('❌ Token validation failed, redirecting to login');
                    // Не редиректим сразу - возможно токен еще не сохранен
                    // Дадим еще один шанс через небольшую задержку
                    setTimeout(() => {
                        const tokenCheck = localStorage.getItem('authToken');
                        if (!tokenCheck) {
                            console.error('❌ Token still not in localStorage, redirecting to login');
                            window.location.href = 'index.html';
                        } else {
                            console.log('✅ Token found in localStorage, retrying initialization');
                            // Повторяем попытку инициализации
                            initializeApp();
                        }
                    }, 500);
                } else {
                    showNotification('Ошибка загрузки данных', 'error');
                }
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', async function(e) {
                    e.preventDefault();
                    const section = this.dataset.section;

                    showSection(section);

                    // Update active nav item
                    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                    this.classList.add('active');
                });
            });

            // Search functionality
            document.getElementById('userSearch')?.addEventListener('input', function() {
                filterUsers(this.value);
            });

            document.getElementById('teamSearch')?.addEventListener('input', function() {
                filterTeams(this.value);
            });

            document.getElementById('orgSearch')?.addEventListener('input', function() {
                filterOrganizations(this.value);
            });

            
            // Initialize settings
            initializeSettings();
            
            // Initialize modals
            initializeModals();
        }

        // Show section
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });

            // Show selected section
            const section = document.getElementById(sectionId);
            if (section) {
                section.classList.add('active');
                
                // Update page title
                const pageTitle = document.querySelector('.page-title');
                const titles = {
                    'dashboard': 'Дашборд',
                    'knowledge': 'База знаний',
                    'users': 'Сотрудники',
                    'teams': 'Команды',
                    'organizations': 'Организации',
                    'support': 'Поддержка',
                    'statistics': 'Статистика',
                    'invitations': 'Приглашения',
                    'settings': 'Настройки'
                };
                pageTitle.textContent = titles[sectionId] || 'Дашборд';
            }

            // Load section data
            loadSectionData(sectionId);
        }

        // Load section data
        async function loadSectionData(sectionId) {
            switch(sectionId) {
                case 'users':
                    await loadUsers();
                    break;
                case 'teams':
                    await loadTeams();
                    break;
                case 'organizations':
                    await loadOrganizations();
                    break;
                case 'statistics':
                    await loadStatistics();
                    break;
                case 'invitations':
                    console.log('Loading invitations section...');
                    await loadInvitations();
                    // Принудительно показываем секцию
                    const invitationsSection = document.getElementById('invitations');
                    if (invitationsSection) {
                        invitationsSection.style.display = 'block';
                        invitationsSection.style.visibility = 'visible';
                        invitationsSection.style.opacity = '1';
                        invitationsSection.classList.add('active');
                        console.log('Invitations section made visible');
                    }
                    break;
                case 'settings':
                    await loadSettings();
                    // Принудительно вызываем ensureReferralSection для создания раздела, если его нет
                    setTimeout(() => {
                        if (typeof window.ensureReferralSection === 'function') {
                            window.ensureReferralSection();
                        }
                        // Не принуждаем показывать - позволим loadModuleControls управлять видимостью на основе статуса модуля
                        const referralCard = document.getElementById('referralCard');
                        if (referralCard) {
                            console.log('✅ Referral card exists in DOM');
                        }
                    }, 300);
                    setTimeout(() => {
                        if (typeof window.ensureReferralSection === 'function') {
                            window.ensureReferralSection();
                        }
                    }, 1000);
                    break;
            }
        }

        // Load current user
        async function loadCurrentUser() {
            try {
                // Проверяем, что токен доступен перед запросом
                const tokenBeforeRequest = localStorage.getItem('authToken') || localStorage.getItem('accessToken');
                if (!tokenBeforeRequest) {
                    console.error('❌ No token available for loadCurrentUser');
                    throw new Error('No authentication token available');
                }
                console.log('🔑 Making request to /api/auth/me with token:', tokenBeforeRequest.substring(0, 20) + '...');
                
                // Always load user data from API to get current user info
                const response = await apiCall('/api/auth/me', { method: 'GET' });
                console.log('✅ User data loaded successfully:', response);
                currentUser = response;
                
                // Update localStorage with fresh user data
                localStorage.setItem('userData', JSON.stringify(currentUser));
                
                // Update user info in sidebar
                document.getElementById('userName').textContent = 
                    `${currentUser.firstName || ''} ${currentUser.lastName || ''}`.trim() || currentUser.email;
                
                // Get the highest priority role
                const rolePriority = {
                    'super_admin': 5,
                    'admin': 4,
                    'manager': 3,
                    'editor': 2,
                    'viewer': 1
                };
                
                // Handle both array of role objects and array of role names
                let roles = currentUser.roles || [];
                console.log('🔍 Current user roles:', roles);
                console.log('🔍 Current user:', currentUser);
                if (roles.length > 0 && typeof roles[0] === 'string') {
                    // If roles is array of strings, convert to objects
                    roles = roles.map(roleName => ({ name: roleName }));
                }
                
                const highestRole = roles.reduce((highest, current) => {
                    const currentPriority = rolePriority[current.name] || 0;
                    const highestPriority = rolePriority[highest?.name] || 0;
                    return currentPriority > highestPriority ? current : highest;
                }, null);
                
                document.getElementById('userRole').textContent = 
                    highestRole?.name || 'Пользователь';
                
                // Handle role-based redirection and UI
                if (highestRole?.name === 'super_admin') {
                    // super_admin должен быть перенаправлен на страницу управления модулями
                    if (!window.location.pathname.includes('test-micro-modules.html')) {
                        console.log('🔄 Redirecting super_admin to test-micro-modules.html');
                        window.location.href = 'test-micro-modules.html';
                        return;
                    }
                    console.log('✅ Super admin already on correct page');
                    
                    // Загружаем модули управления для суперадмина
                    await loadModuleControls();
                } else if (highestRole?.name === 'admin') {
                    // admin sees standard interface with all admin features
                    // No special handling needed
                } else {
                    // viewer sees simplified interface
                    // Hide admin-only sections for viewer
                    hideAdminOnlySections();
                }
                
                // Update avatar
                const avatar = document.getElementById('userAvatar');
                const initials = (currentUser.firstName?.[0] || '') + (currentUser.lastName?.[0] || '');
                if (initials) {
                    avatar.textContent = initials;
                } else {
                    avatar.innerHTML = '<i class="fas fa-user"></i>';
                }
            } catch (error) {
                console.error('Error loading current user:', error);
                throw error;
            }
        }

        // Load dashboard data
        async function loadDashboardData() {
            try {
                // Load statistics using the new function
                await loadStatistics();

                // Load recent activity
                await loadRecentActivity();
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        // Load users
        async function loadUsers() {
            try {
                console.log('Loading users in context...');
                const response = await apiCall('/api/users/in-context', { method: 'GET' });
                console.log('Users in context response:', response);
                const users = Array.isArray(response) ? response : (response.users || response.data || []);
                console.log('Users array:', users);
                
                // Сохраняем в глобальный кеш для использования при удалении
                window.allUsersCache = users;
                
                displayUsers(users);
            } catch (error) {
                console.error('Error loading users in context:', error);
                showNotification('Ошибка загрузки пользователей', 'error');
            }
        }

        // Проверить, может ли текущий пользователь управлять другим пользователем
        async function canManageUser(targetUserId, context = {}) {
            console.log('🔐 canManageUser called for user:', targetUserId, 'context:', context);
            try {
                // Формируем URL с query параметрами для контекста
                let url = `/api/users/${targetUserId}/can-manage`;
                const params = new URLSearchParams();
                if (context.organizationId) params.append('organizationId', context.organizationId);
                if (context.teamId) params.append('teamId', context.teamId);
                if (params.toString()) url += `?${params.toString()}`;
                
                const response = await apiCall(url, { method: 'GET' });
                console.log('🔐 canManageUser response:', response);
                return response.canManage;
            } catch (error) {
                console.error('🔐 Error checking permissions:', error);
                return false;
            }
        }

        // Display users
        async function displayUsers(users) {
            console.log('Displaying users:', users);
            const tbody = document.getElementById('usersTableBody');
            console.log('Table body element:', tbody);
            tbody.innerHTML = '';

            // Сохраняем список пользователей для редактирования
            currentUsersList = users;

            // Отладочная информация для каждого пользователя
            users.forEach(user => {
                console.log(`🔍 User ${user.email}:`, {
                    rolesByContext: user.rolesByContext,
                    globalRole: user.globalRole,
                    organizationMemberships: user.organizationMemberships,
                    teamMemberships: user.teamMemberships,
                    teams: user.teams,
                    organizations: user.organizations
                });
            });

            // Проверяем права для каждого пользователя
            for (const user of users) {
                // Определяем контекст для проверки прав
                let context = {};
                
                // Если у пользователя есть членство в командах, используем первую команду
                if (user.teamMemberships && user.teamMemberships.length > 0) {
                    context.teamId = user.teamMemberships[0].teamId;
                }
                // Если нет команд, но есть организации, используем первую организацию
                else if (user.organizationMemberships && user.organizationMemberships.length > 0) {
                    context.organizationId = user.organizationMemberships[0].organizationId;
                }
                
                console.log(`🔐 Checking permissions for ${user.email} with context:`, context);
                const canManage = await canManageUser(user.id, context);
                
                // Проверяем, является ли пользователь самим собой
                const isCurrentUser = currentUser && user.id === currentUser.id;
                
                // Определяем, какие действия разрешены
                const canChangeRole = canManage && !isCurrentUser; // Нельзя изменить свою роль
                const canTransfer = canManage && !isCurrentUser;   // Нельзя перевести себя
                const canDelete = canManage; // Можно удалить себя
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div class="user-info">
                            <div class="user-avatar">
                                ${user.firstName ? user.firstName[0] : user.email[0].toUpperCase()}
                            </div>
                            <div class="user-details">
                                <h4>${user.firstName || ''} ${user.lastName || ''}</h4>
                                <p>${user.email}</p>
                            </div>
                        </div>
                    </td>
                    <td>
                        ${(() => {
                            // ✅ ИСПРАВЛЕНИЕ: В колонке "РОЛЬ" всегда показываем ГЛОБАЛЬНУЮ роль
                            const displayRole = user.globalRole || 'viewer';
                            const roleTitle = 'Глобальная роль';
                            
                            return `<span class="role-badge global-role" title="${roleTitle}">
                                ${displayRole}
                            </span>`;
                        })()}
                    </td>
                            <td>
                                ${user.rolesByContext ? 
                                    [
                                        ...(user.rolesByContext.organizations || []).map(roleInfo => 
                                            `<span class="org-badge" title="Роль в организации">
                                                🏢 ${roleInfo.organization} (${roleInfo.role})
                                            </span>`
                                        ),
                                        ...(user.rolesByContext.teams || []).map(roleInfo => 
                                            `<span class="team-badge" title="Роль в команде">
                                                👥 ${roleInfo.team} (${roleInfo.role})
                                            </span>`
                                        )
                                    ].join(' ') :
                                    'Не назначена'
                                }
                            </td>
                    <td>
                        <span class="status-badge ${user.isActive ? 'active' : 'inactive'}">
                            ${user.isActive ? 'Активен' : 'Неактивен'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-warning" onclick="changeUserRole('${user.id}')" title="${canChangeRole ? 'Изменить роль' : (isCurrentUser ? 'Нельзя изменить свою роль' : 'Недостаточно прав')}" ${!canChangeRole ? 'disabled' : ''}>
                            <i class="fas fa-user-tag"></i>
                        </button>
                        <button class="btn btn-info" onclick="transferUser('${user.id}')" title="${canTransfer ? 'Перенести между командами' : (isCurrentUser ? 'Нельзя перевести себя' : 'Недостаточно прав')}" ${!canTransfer ? 'disabled' : ''}>
                            <i class="fas fa-exchange-alt"></i>
                        </button>
                        <button class="btn btn-danger" onclick="deleteUser('${user.id}')" title="${canDelete ? 'Удалить' : 'Недостаточно прав'}" ${!canDelete ? 'disabled' : ''}>
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            }
        }

        // Load teams
        async function loadTeams() {
            try {
                const response = await apiCall('/api/teams/accessible', { method: 'GET' });
                await displayTeams(response);
            } catch (error) {
                console.error('Error loading teams:', error);
                showNotification('Ошибка загрузки команд', 'error');
            }
        }

        // Display teams
        async function displayTeams(teams) {
            const tbody = document.getElementById('teamsTableBody');
            tbody.innerHTML = '';

            for (const team of teams) {
                // Загружаем участников команды
                let membersCount = 0;
                try {
                    const membersResponse = await apiCall(`/api/teams/${team.id}/members`, { method: 'GET' });
                    // ✅ ИСПРАВЛЕНИЕ: Создатель команды НЕ включается в список участников, поэтому не отнимаем 1
                    const members = membersResponse?.members || membersResponse || [];
                    membersCount = members.length;
                } catch (error) {
                    console.error('Error loading team members:', error);
                    membersCount = 0;
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div class="user-info">
                            <div class="user-avatar" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="user-details">
                                <h4>${team.name}</h4>
                                <p>${team.description || 'Описание отсутствует'}</p>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="status-badge active">${membersCount} участников</span>
                    </td>
                    <td>${team.creator?.firstName || ''} ${team.creator?.lastName || ''}</td>
                    <td>${new Date(team.createdAt).toLocaleDateString('ru-RU')}</td>
                    <td>
                        <button class="btn btn-secondary" onclick="editTeam('${team.id}')" title="Просмотр участников">
                            <i class="fas fa-users"></i>
                        </button>
                        <button class="btn btn-danger" onclick="deleteTeam('${team.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            }
        }

        // Delete team
        async function deleteTeam(teamId) {
            if (!confirm('Вы уверены, что хотите удалить эту команду?')) {
                return;
            }

            try {
                await apiCall(`/api/teams/${teamId}`, {
                    method: 'DELETE'
                });
                
                showNotification('Команда удалена успешно!', 'success');
                await loadTeams();
            } catch (error) {
                console.error('Ошибка удаления команды:', error);
                showNotification('Ошибка удаления команды: ' + error.message, 'error');
            }
        }

        // Edit team
        async function editTeam(teamId) {
            try {
                // Загружаем информацию о команде и её участниках
                const [teamResponse, membersResponse] = await Promise.all([
                    apiCall(`/api/teams/${teamId}`, { method: 'GET' }),
                    apiCall(`/api/teams/${teamId}/members`, { method: 'GET' })
                ]);

                const team = teamResponse;
                const membersData = membersResponse || {};
                const members = membersData.members || membersData || [];
                const teamInfo = membersData.team || team;

                // Создаем модальное окно для отображения участников команды
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>Участники команды: ${team.name}</h2>
                            <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="members-list">
                                ${members.length > 0 ? 
                                    members
                                        .filter(member => member.id !== teamInfo.creator?.id) // Исключаем создателя команды
                                        .map(member => `
                                        <div class="member-item">
                                            <div class="user-avatar" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                                                <i class="fas fa-user"></i>
                                            </div>
                                            <div class="member-info">
                                                <h4>${member.firstName || ''} ${member.lastName || ''}</h4>
                                                <p>${member.email || ''}</p>
                                                <div class="member-details">
                                                    <span class="role-badge">${member.role?.name || 'viewer'}</span>
                                                    <span class="status-badge ${member.isActive ? 'active' : 'inactive'}">
                                                        ${member.isActive ? 'Активен' : 'Неактивен'}
                                                    </span>
                                                </div>
                                            </div>
                                            <button class="btn btn-danger btn-sm" onclick="removeMemberFromTeam('${member.id}', '${teamId}', this)" title="Удалить из команды" data-member-id="${member.id}">
                                                <i class="fas fa-user-minus"></i>
                                            </button>
                                        </div>
                                    `).join('') :
                                    '<p>В команде пока нет участников</p>'
                                }
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-primary" onclick="this.closest('.modal').remove()">Закрыть</button>
                        </div>
                    </div>
                `;

                // Добавляем стили для модального окна
                const style = document.createElement('style');
                style.textContent = `
                    .members-list {
                        max-height: 400px;
                        overflow-y: auto;
                    }
                    .member-item {
                        display: flex;
                        align-items: center;
                        padding: 1rem;
                        border-bottom: 1px solid #e5e7eb;
                        gap: 1rem;
                    }
                    .member-item:last-child {
                        border-bottom: none;
                    }
                    .member-info h4 {
                        margin: 0 0 0.25rem 0;
                        font-size: 1rem;
                        font-weight: 600;
                    }
                    .member-info p {
                        margin: 0 0 0.5rem 0;
                        color: #6b7280;
                        font-size: 0.875rem;
                    }
                `;
                document.head.appendChild(style);

                document.body.appendChild(modal);
                
                // Показываем модальное окно
                modal.style.display = 'block';
            } catch (error) {
                console.error('Error loading team members:', error);
                showNotification('Ошибка загрузки участников команды', 'error');
            }
        }

        // Remove member from team
        async function removeMemberFromTeam(memberId, teamId, buttonElement) {
            if (!confirm('Вы уверены, что хотите удалить этого участника из команды?')) {
                return;
            }

            try {
                // Проверяем права В КОНТЕКСТЕ КОМАНДЫ
                const permissionCheck = await canManageUser(memberId, { teamId });
                if (!permissionCheck) {
                    showNotification('Недостаточно прав для удаления этого участника из команды', 'error');
                    return;
                }

                // Удаляем участника из команды
                await apiCall(`/api/teams/${teamId}/members/${memberId}`, {
                    method: 'DELETE'
                });

                showNotification('Участник удалён из команды', 'success');
                
                // Удаляем элемент из DOM
                const memberItem = buttonElement.closest('.member-item');
                if (memberItem) {
                    memberItem.remove();
                }

                // Перезагружаем список команд
                await loadTeams();
            } catch (error) {
                console.error('Error removing member from team:', error);
                showNotification('Ошибка удаления участника: ' + error.message, 'error');
            }
        }


        // Remove member from organization
        async function removeMemberFromOrganization(memberId, organizationId, buttonElement) {
            if (!confirm('Вы уверены, что хотите удалить этого участника из организации?')) {
                return;
            }

            try {
                // Проверяем права В КОНТЕКСТЕ ОРГАНИЗАЦИИ
                const permissionCheck = await canManageUser(memberId, { organizationId });
                if (!permissionCheck) {
                    showNotification('Недостаточно прав для удаления этого участника из организации', 'error');
                    return;
                }

                // Удаляем участника из организации
                await apiCall(`/api/organizations/${organizationId}/members/${memberId}`, {
                    method: 'DELETE'
                });

                showNotification('Участник удалён из организации', 'success');
                
                // Удаляем элемент из DOM
                const memberItem = buttonElement.closest('.member-item');
                if (memberItem) {
                    memberItem.remove();
                }

                // Перезагружаем список организаций
                await loadOrganizations();
            } catch (error) {
                console.error('Error removing member from organization:', error);
                showNotification('Ошибка удаления участника: ' + error.message, 'error');
            }
        }


        // Load organizations
        async function loadOrganizations() {
            try {
                const response = await apiCall('/api/organizations', { method: 'GET' });
                displayOrganizations(response);
            } catch (error) {
                console.error('Error loading organizations:', error);
                showNotification('Ошибка загрузки организаций', 'error');
            }
        }

        // View organization members
        async function viewOrganizationMembers(organizationId) {
            try {
                const response = await apiCall(`/api/organizations/${organizationId}/members`, { method: 'GET' });
                const members = Array.isArray(response) ? response : (response.members || response.data || []);

                // Создаем модальное окно для отображения участников организации
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>Участники организации</h2>
                            <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="members-list">
                                ${(() => {
                                    const filteredMembers = members; // Показываем всех участников
                                    return filteredMembers.length > 0 ? 
                                        filteredMembers.map(member => `
                                        <div class="member-item">
                                            <div class="user-avatar" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                                                ${member.user?.firstName ? member.user.firstName[0] : member.user?.email[0].toUpperCase()}
                                            </div>
                                            <div class="member-details">
                                                <h4>${member.user?.firstName || ''} ${member.user?.lastName || ''}</h4>
                                                <p>${member.user?.email}</p>
                                                <span class="role-badge">${member.role?.name || 'viewer'}</span>
                                            </div>
                                            <button class="btn btn-danger btn-sm" onclick="removeMemberFromOrganization('${member.user?.id}', '${organizationId}', this)" title="Удалить из организации" data-member-id="${member.user?.id}">
                                                <i class="fas fa-user-minus"></i>
                                            </button>
                                        </div>
                                    `).join('') :
                                    '<p>В организации пока нет участников</p>';
                                })()}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-primary" onclick="this.closest('.modal').remove()">Закрыть</button>
                        </div>
                    </div>
                `;

                // Добавляем стили для модального окна
                const style = document.createElement('style');
                style.textContent = `
                    .members-list {
                        max-height: 400px;
                        overflow-y: auto;
                    }
                    .member-item {
                        display: flex;
                        align-items: center;
                        padding: 1rem;
                        border-bottom: 1px solid #e5e7eb;
                    }
                    .member-item:last-child {
                        border-bottom: none;
                    }
                    .member-details {
                        margin-left: 1rem;
                        flex: 1;
                    }
                    .member-details h4 {
                        margin: 0 0 0.25rem 0;
                        font-size: 1rem;
                        font-weight: 600;
                    }
                    .member-details p {
                        margin: 0 0 0.5rem 0;
                        color: #6b7280;
                        font-size: 0.875rem;
                    }
                `;
                document.head.appendChild(style);

                document.body.appendChild(modal);
                
                // Показываем модальное окно
                modal.style.display = 'block';
            } catch (error) {
                console.error('Error loading organization members:', error);
                showNotification('Ошибка загрузки участников организации', 'error');
            }
        }

        // Display organizations
        function displayOrganizations(organizations) {
            const tbody = document.getElementById('organizationsTableBody');
            tbody.innerHTML = '';

            organizations.forEach(org => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div class="user-info">
                            <div class="user-avatar" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                                <i class="fas fa-building"></i>
                            </div>
                            <div class="user-details">
                                <h4>${org.name}</h4>
                                <p>${org.slug}</p>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="status-badge active">${org.teams?.length || 0} команд</span>
                    </td>
                    <td>
                        <span class="status-badge active">${(org.members?.filter(member => !['creator', 'manager'].includes(member.role?.name)) || []).length} сотрудников</span>
                    </td>
                    <td>${org.creator?.firstName || ''} ${org.creator?.lastName || ''}</td>
                    <td>
                        <button class="btn btn-info" onclick="viewOrganizationMembers('${org.id}')" title="Просмотр участников">
                            <i class="fas fa-users"></i>
                        </button>
                        <button class="btn btn-danger" onclick="deleteOrganization('${org.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Delete organization
        async function deleteOrganization(organizationId) {
            if (!confirm('Вы уверены, что хотите удалить эту организацию?')) {
                return;
            }

            try {
                await apiCall(`/api/organizations/${organizationId}`, {
                    method: 'DELETE'
                });
                
                showNotification('Организация удалена успешно!', 'success');
                await loadOrganizations();
            } catch (error) {
                console.error('Ошибка удаления организации:', error);
                showNotification('Ошибка удаления организации: ' + error.message, 'error');
            }
        }

        // Edit organization
        function editOrganization(organizationId) {
            showNotification('Редактирование организации в разработке', 'info');
        }

        // Load statistics
        async function loadStatistics() {
            try {
                console.log('Loading statistics...');
                // Load all data for statistics (only working endpoints)
                const [teamMembers, teams, organizations, invitations] = await Promise.all([
                    apiCall('/api/users/in-context', { method: 'GET' }).catch((err) => { console.error('Error loading team members:', err); return []; }),
                    apiCall('/api/teams', { method: 'GET' }).catch((err) => { console.error('Error loading teams:', err); return []; }),
                    apiCall('/api/organizations', { method: 'GET' }).catch((err) => { console.error('Error loading organizations:', err); return []; }),
                    apiCall('/api/invitations/my', { method: 'GET' }).catch((err) => { console.error('Error loading invitations:', err); return []; })
                ]);

                console.log('Statistics data loaded:', { teamMembers, teams, organizations, invitations });

                // Process data
                const usersList = Array.isArray(teamMembers) ? teamMembers : (teamMembers?.users || teamMembers?.data || []);
                const teamsList = Array.isArray(teams) ? teams : (teams?.teams || teams?.data || []);
                const orgsList = Array.isArray(organizations) ? organizations : (organizations?.organizations || organizations?.data || []);
                const invitationsList = Array.isArray(invitations) ? invitations : (invitations?.invitations || invitations?.data || []);

                // Calculate real statistics
                const totalUsers = usersList.length || 0;
                const activeUsers = usersList.filter(u => u.isActive !== false).length || 0;
                const totalTeams = teamsList.length || 0;
                const totalOrganizations = orgsList.length || 0;
                const pendingInvitations = invitationsList.filter(inv => inv.status === 'pending').length || 0;
                const totalInvitations = invitationsList.length || 0;
                
                // If no team members, show total teams and organizations as meaningful stats
                const displayUsers = totalUsers > 0 ? totalUsers : totalTeams;
                const displayActiveUsers = activeUsers > 0 ? activeUsers : totalOrganizations;

                        // Update statistics
                        console.log('Updating statistics:', { totalUsers, activeUsers, pendingInvitations, totalTeams, totalInvitations, totalOrganizations });
                        
                        // Update main dashboard statistics
                        const totalUsersEl = document.getElementById('totalUsers');
                        const activeUsersEl = document.getElementById('activeUsers');
                        const invitationsEl = document.getElementById('invitationsCount');
                        const articlesEl = document.getElementById('articles');
                        
                        // Update additional statistics
                        const statsTotalUsersEl = document.getElementById('statsTotalUsers');
                        const statsActiveUsersEl = document.getElementById('statsActiveUsers');
                        const statsInvitationsEl = document.getElementById('statsInvitations');
                        const statsArticlesEl = document.getElementById('statsArticles');
                        const statsTotalUsersLabelEl = document.getElementById('statsTotalUsersLabel');
                        
                        console.log('Statistics elements found:', { 
                            totalUsersEl: !!totalUsersEl, 
                            activeUsersEl: !!activeUsersEl, 
                            invitationsEl: !!invitationsEl, 
                            articlesEl: !!articlesEl,
                            statsTotalUsersEl: !!statsTotalUsersEl, 
                            statsActiveUsersEl: !!statsActiveUsersEl, 
                            statsInvitationsEl: !!statsInvitationsEl, 
                            statsArticlesEl: !!statsArticlesEl,
                            statsTotalUsersLabelEl: !!statsTotalUsersLabelEl
                        });
                        
                        // Update main dashboard statistics
                        console.log('Updating main dashboard:', { displayUsers, displayActiveUsers, pendingInvitations, totalTeams });
                        if (totalUsersEl) {
                            totalUsersEl.textContent = displayUsers;
                            console.log('Updated totalUsersEl to:', displayUsers);
                        }
                        if (activeUsersEl) {
                            activeUsersEl.textContent = displayActiveUsers;
                            console.log('Updated activeUsersEl to:', displayActiveUsers);
                        }
                        if (invitationsEl) {
                            invitationsEl.textContent = pendingInvitations;
                            console.log('Updated invitationsEl to:', pendingInvitations);
                        }
                        if (articlesEl) {
                            articlesEl.textContent = totalTeams; // Using teams as articles placeholder
                            console.log('Updated articlesEl to:', totalTeams);
                        }
                        
                        // Update additional statistics
                        if (statsTotalUsersEl) statsTotalUsersEl.textContent = displayUsers;
                        if (statsActiveUsersEl) statsActiveUsersEl.textContent = displayActiveUsers;
                        if (statsInvitationsEl) statsInvitationsEl.textContent = pendingInvitations;
                        if (statsArticlesEl) statsArticlesEl.textContent = totalTeams; // Using teams as articles placeholder
                        
                        // Update labels dynamically for main dashboard
                        const totalUsersLabelEl = document.getElementById('totalUsersLabel');
                        if (totalUsersLabelEl) {
                            totalUsersLabelEl.textContent = totalUsers > 0 ? 'Сотрудников в системе' : 'Команд в системе';
                        }
                        
                        const activeUsersLabelEl = document.getElementById('activeUsersLabel');
                        if (activeUsersLabelEl) {
                            activeUsersLabelEl.textContent = activeUsers > 0 ? 'Активных пользователей' : 'Организаций в системе';
                        }
                        
                        // Update labels dynamically for additional statistics
                        if (statsTotalUsersLabelEl) {
                            statsTotalUsersLabelEl.textContent = totalUsers > 0 ? 'Сотрудников в системе' : 'Команд в системе';
                        }
                        
                        const statsActiveUsersLabelEl = document.getElementById('statsActiveUsersLabel');
                        if (statsActiveUsersLabelEl) {
                            statsActiveUsersLabelEl.textContent = activeUsers > 0 ? 'Активных пользователей' : 'Организаций в системе';
                        }
                
                // Update additional stats if they exist
                const statsTicketsEl = document.getElementById('statsTickets');
                const statsAvgResponseEl = document.getElementById('statsAvgResponse');
                if (statsTicketsEl) statsTicketsEl.textContent = totalInvitations; // Using invitations as tickets placeholder
                if (statsAvgResponseEl) statsAvgResponseEl.textContent = totalOrganizations > 0 ? '1.5ч' : 'Н/Д'; // Dynamic based on data

                // Update additional stats if elements exist
                const statsContainer = document.getElementById('statistics');
                if (statsContainer) {
                    // Add more detailed statistics
                    const additionalStats = `
                        <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-top: 20px;">
                            <div class="stat-card" style="background: #F3F4F6; padding: 20px; border-radius: 12px; text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #1F2937;">${totalTeams}</div>
                                <div style="color: #6B7280; margin-top: 4px;">Команд</div>
                            </div>
                            <div class="stat-card" style="background: #F3F4F6; padding: 20px; border-radius: 12px; text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #1F2937;">${totalOrganizations}</div>
                                <div style="color: #6B7280; margin-top: 4px;">Организаций</div>
                            </div>
                            <div class="stat-card" style="background: #F3F4F6; padding: 20px; border-radius: 12px; text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #1F2937;">${totalInvitations}</div>
                                <div style="color: #6B7280; margin-top: 4px;">Всего приглашений</div>
                            </div>
                            <div class="stat-card" style="background: #F3F4F6; padding: 20px; border-radius: 12px; text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #1F2937;">${pendingInvitations}</div>
                                <div style="color: #6B7280; margin-top: 4px;">Ожидающих приглашений</div>
                            </div>
                        </div>
                    `;
                    
                    // Add additional stats to the statistics section
                    const existingAdditional = statsContainer.querySelector('.additional-stats');
                    if (existingAdditional) {
                        existingAdditional.remove();
                    }
                    
                    const additionalDiv = document.createElement('div');
                    additionalDiv.className = 'additional-stats';
                    additionalDiv.innerHTML = additionalStats;
                    statsContainer.appendChild(additionalDiv);
                }

            } catch (error) {
                console.error('Error loading statistics:', error);
                showNotification('Ошибка загрузки статистики', 'error');
            }
        }

        // Switch user tab
        function switchUserTab(tab) {
            // Update tab styles
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            // Load appropriate data
            if (tab === 'active') {
                // Используем кеш, если он есть, иначе загружаем с сервера
                if (window.allUsersCache) {
                    displayUsers(window.allUsersCache);
                } else {
                    loadUsers();
                }
            } else if (tab === 'invited') {
                // Загружаем отправленные приглашения
                loadSentInvitations();
            }
        }

        // Функция для загрузки отправленных приглашений
        async function loadSentInvitations() {
            try {
                console.log('Loading sent invitations...');
                const response = await apiCall('/api/invitations/sent', { method: 'GET' });
                console.log('Sent invitations response:', response);
                displaySentInvitations(response);
            } catch (error) {
                console.error('Error loading sent invitations:', error);
                displaySentInvitations([]);
            }
        }

        // Функция для отображения отправленных приглашений
        function displaySentInvitations(invitations) {
            const tbody = document.getElementById('usersTableBody');
            if (!tbody) return;

            if (!invitations || invitations.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="no-data">Нет отправленных приглашений</td></tr>';
                return;
            }

            let html = '';
            invitations.forEach(invitation => {
                const statusClass = invitation.status === 'pending' ? 'pending' : 
                                  invitation.status === 'accepted' ? 'accepted' : 'declined';
                const statusText = invitation.status === 'pending' ? 'Ожидает ответа' :
                                  invitation.status === 'accepted' ? 'Принято' : 'Отклонено';
                
                html += `
                    <tr>
                        <td>
                            <div class="user-info">
                                <div class="user-avatar">${invitation.email.charAt(0).toUpperCase()}</div>
                                <div class="user-details">
                                    <h4>${invitation.email}</h4>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="role-badge">${invitation.roleName || 'Не указано'}</span>
                        </td>
                        <td>
                            <span class="team-badge">${invitation.targetName || 'Не указано'}</span>
                        </td>
                        <td>
                            <span class="status ${statusClass}">${statusText}</span>
                        </td>
                        <td>
                            <span class="date">${new Date(invitation.createdAt).toLocaleDateString()}</span>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        // Load invited users (users who haven't accepted invitations yet)
        async function loadInvitedUsers() {
            try {
                // Get all users and filter those who are invited but not active
                const response = await apiCall('/api/users', { method: 'GET' });
                console.log('All users response for invited:', response);
                const users = Array.isArray(response) ? response : (response.users || response.data || []);
                
                // Сохраняем в глобальный кеш
                window.allUsersCache = users;
                
                // Filter users who are invited but not active (you can customize this logic)
                const invitedUsers = users.filter(user => {
                    // Show users who are not active or don't have teams
                    return !user.isActive || !user.teams || user.teams.length === 0;
                });
                
                console.log('Filtered invited users:', invitedUsers);
                displayInvitedUsers(invitedUsers);
            } catch (error) {
                console.error('Error loading invited users:', error);
                showNotification('Ошибка загрузки приглашенных пользователей', 'error');
            }
        }

        // Display invited users
        function displayInvitedUsers(users) {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';

            if (!users || !Array.isArray(users)) {
                return;
            }

            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div class="user-info">
                            <div class="user-avatar">
                                ${user.email[0].toUpperCase()}
                            </div>
                            <div class="user-details">
                                <h4>${user.firstName || ''} ${user.lastName || ''}</h4>
                                <p>${user.email}</p>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="status-badge pending">Приглашен</span>
                    </td>
                    <td>${user.teams && user.teams.length > 0 ? user.teams[0].name : 'Не назначено'}</td>
                    <td>
                        <span class="status-badge ${user.isActive ? 'active' : 'pending'}">
                            ${user.isActive ? 'Активен' : 'Приглашен'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-secondary" onclick="resendInvitation('${user.id}')">
                            <i class="fas fa-redo"></i>
                        </button>
                        <button class="btn btn-danger" onclick="cancelInvitation('${user.id}')">
                            <i class="fas fa-times"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Filter functions
        function filterUsers(query) {
            const rows = document.querySelectorAll('#usersTableBody tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(query.toLowerCase()) ? '' : 'none';
            });
        }

        function filterTeams(query) {
            const rows = document.querySelectorAll('#teamsTableBody tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(query.toLowerCase()) ? '' : 'none';
            });
        }

        function filterOrganizations(query) {
            const rows = document.querySelectorAll('#organizationsTableBody tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(query.toLowerCase()) ? '' : 'none';
            });
        }

        // API call function
        async function apiCall(endpoint, options = {}) {
            // Убеждаемся что токен актуален перед каждым запросом
            let currentToken = authToken || localStorage.getItem('authToken') || localStorage.getItem('accessToken');
            
            // Если токен все еще не найден, проверяем URL (на случай если мы только что перешли с токеном)
            if (!currentToken) {
                const urlParamsCheck = new URLSearchParams(window.location.search);
                const urlTokenCheck = urlParamsCheck.get('token');
                if (urlTokenCheck) {
                    console.log('🔑 Found token in URL during API call, saving it');
                    currentToken = urlTokenCheck;
                    authToken = urlTokenCheck;
                    localStorage.setItem('authToken', urlTokenCheck);
                    localStorage.setItem('accessToken', urlTokenCheck);
                }
            }
            
            if (!currentToken) {
                console.error('❌ No token available for API call to:', endpoint);
                throw new Error('No authentication token available');
            }
            
            const url = `${window.API_BASE_URL}${endpoint}`;
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${currentToken}`
                }
            };
            
            // Обновляем authToken если он изменился
            if (currentToken !== authToken) {
                authToken = currentToken;
                console.log('🔄 Updated authToken from localStorage/URL');
            }

            const response = await fetch(url, { ...defaultOptions, ...options });
            
            if (!response.ok) {
                if (response.status === 401) {
                    // Check if it's a 2FA requirement
                    const errorData = await response.json().catch(() => ({}));
                    if (errorData.message && errorData.message.includes('2FA')) {
                        // 2FA required, redirect to login with 2FA
                        localStorage.removeItem('authToken');
                        localStorage.removeItem('refreshToken');
                        localStorage.removeItem('userData');
                        window.location.href = 'index.html?require2fa=true';
                        throw new Error('2FA required');
                    } else {
                        // Token expired или невалиден - проверяем, может токен еще в URL
                        const urlParamsCheck = new URLSearchParams(window.location.search);
                        const urlTokenCheck = urlParamsCheck.get('token');
                        
                        if (urlTokenCheck) {
                            console.log('⚠️ 401 error, but token found in URL, saving and retrying');
                            authToken = urlTokenCheck;
                            localStorage.setItem('authToken', urlTokenCheck);
                            localStorage.setItem('accessToken', urlTokenCheck);
                            // Повторяем запрос с токеном из URL
                            console.log('🔄 Retrying request with token from URL');
                            const retryUrl = `${window.API_BASE_URL}${endpoint}`;
                            const retryOptions = {
                                ...defaultOptions,
                                ...options,
                                headers: {
                                    ...defaultOptions.headers,
                                    ...options.headers,
                                    'Authorization': `Bearer ${urlTokenCheck}`
                                }
                            };
                            const retryResponse = await fetch(retryUrl, retryOptions);
                            if (retryResponse.ok) {
                                const retryData = await retryResponse.json();
                                return retryData;
                            } else {
                                console.error('❌ Retry also failed with status:', retryResponse.status);
                            }
                        }
                        
                        // Token expired, redirect to login
                        console.error('❌ Token expired and no token in URL, redirecting to login');
                        localStorage.removeItem('authToken');
                        localStorage.removeItem('refreshToken');
                        localStorage.removeItem('userData');
                        window.location.href = 'index.html';
                        throw new Error('Unauthorized');
                    }
                }
                if (response.status === 403) {
                    const errorData = await response.json().catch(() => ({}));
                    const msg = errorData?.message || 'Недостаточно прав для выполнения действия';
                    // Show friendly permissions message instead of generic error
                    showNotification(msg, 'error');
                    throw new Error('Forbidden');
                }
                
                // Try to get error message from response
                let errorMessage = `HTTP error! status: ${response.status}`;
                try {
                    const errorData = await response.json();
                    if (errorData.message) {
                        errorMessage = errorData.message;
                    }
                } catch (e) {
                    // If JSON parsing fails, use default message
                }
                
                throw new Error(errorMessage);
            }

            return await response.json();
        }

        // Show notification
        function showNotification(message, type = 'success') {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            container.appendChild(notification);
            
            // Show notification
            setTimeout(() => notification.classList.add('show'), 100);
            
            // Hide notification after 5 seconds
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => container.removeChild(notification), 300);
            }, 5000);
        }

        // Logout function
        function logout() {
            if (confirm('Вы уверены, что хотите выйти?')) {
                console.log('🚪 Logging out...');
                localStorage.removeItem('authToken');
                localStorage.removeItem('accessToken'); // Дополнительно очищаем accessToken
                localStorage.removeItem('refreshToken');
                localStorage.removeItem('userData');
                window.location.href = 'index.html';
            }
        }

        // Placeholder functions for actions
        function editUser(userId) {
            // Найти пользователя в текущем списке
            const user = currentUsersList.find(u => u.id === userId);
            if (!user) {
                showNotification('Пользователь не найден', 'error');
                return;
            }

            // Заполнить форму данными пользователя
            document.getElementById('editUserId').value = user.id;
            document.getElementById('editUserEmail').value = user.email;

            // Загрузить команды и организации для выбора
            loadTeamsForEdit();
            loadOrganizationsForEdit();

            // Установить текущую команду пользователя (если есть)
            if (user.teams && user.teams.length > 0) {
                document.getElementById('editUserTargetType').value = 'team';
                document.getElementById('editUserTeam').value = user.teams[0].id;
                toggleEditTarget();
            } else if (user.organization && user.organization.id) {
                document.getElementById('editUserTargetType').value = 'organization';
                document.getElementById('editUserOrganization').value = user.organization.id;
                toggleEditTarget();
            } else {
                document.getElementById('editUserTargetType').value = 'team';
                toggleEditTarget();
            }

            // Показать модальное окно
            document.getElementById('editUserModal').style.display = 'block';
        }

        function transferUser(userId) {
            // Проверяем, что пользователь не пытается перевести самого себя
            if (currentUser && userId === currentUser.id) {
                showNotification('Вы не можете перевести самого себя в другую команду', 'error');
                return;
            }

            // Найти пользователя в текущем списке
            const user = currentUsersList.find(u => u.id === userId);
            if (!user) {
                showNotification('Пользователь не найден', 'error');
                return;
            }

            // Заполнить форму переноса
            document.getElementById('transferUserId').value = user.id;
            document.getElementById('transferUserEmail').value = user.email;

            // Загрузить команды для переноса
            loadTeamsForTransfer();

            // Установить текущие команды пользователя
            const currentTeams = user.teams || [];
            const teamSelect = document.getElementById('transferFromTeam');
            const toTeamSelect = document.getElementById('transferToTeam');
            
            // Очистить предыдущие опции
            teamSelect.innerHTML = '<option value="">Выберите команду</option>';
            toTeamSelect.innerHTML = '<option value="">Выберите команду</option>';

            // Добавить текущие команды в "Откуда"
            currentTeams.forEach(team => {
                const option = document.createElement('option');
                option.value = team.id;
                option.textContent = team.name;
                teamSelect.appendChild(option);
            });

            // Показать модальное окно
            document.getElementById('transferUserModal').style.display = 'block';
        }

        async function deleteUser(userId) {
            // Проверяем роль текущего пользователя
            const isSuperAdmin = currentUser && currentUser.roles && 
                currentUser.roles.some(r => (typeof r === 'string' ? r : r.name) === 'super_admin');
            
            let confirmMessage;
            let successMessage;
            
            if (isSuperAdmin) {
                confirmMessage = 'Вы уверены, что хотите полностью удалить этого пользователя из системы? Это действие нельзя отменить!';
                successMessage = 'Пользователь полностью удален из системы';
            } else {
                confirmMessage = 'Вы уверены, что хотите удалить этого пользователя из ваших команд/организаций?';
                successMessage = 'Пользователь удален из ваших команд/организаций';
            }
            
            if (!confirm(confirmMessage)) {
                return;
            }

            try {
                let endpoint;
                if (isSuperAdmin) {
                    // Суперадмин - полное удаление пользователя
                    console.log('Super admin deleting user completely:', userId);
                    endpoint = `/api/users/${userId}`;
                } else {
                    // Обычный админ - удаление из контекста
                    console.log('Removing user from context:', userId);
                    endpoint = `/api/users/${userId}/from-context`;
                }
                
                await apiCall(endpoint, {
                    method: 'DELETE'
                });

                showNotification(successMessage, 'success');
                
                // Удаляем пользователя из локального списка
                if (window.allUsersCache) {
                    window.allUsersCache = window.allUsersCache.filter(u => u.id !== userId);
                }
                
                // Перерисовываем таблицу с обновленным списком
                const activeUsersBtn = document.querySelector('.tab.active');
                if (activeUsersBtn && activeUsersBtn.textContent.includes('Активные')) {
                    displayUsers(window.allUsersCache || []);
                } else {
                    displayInvitedUsers(window.allUsersCache || []);
                }
            } catch (error) {
                console.error('Error deleting user:', error);
                // Backend вернёт 403 если нет прав
                showNotification('Ошибка удаления пользователя: ' + error.message, 'error');
            }
        }

        // Функции для модального окна редактирования пользователя
        function closeEditUserModal() {
            document.getElementById('editUserModal').style.display = 'none';
        }

        async function loadTeamsForEdit() {
            try {
                const response = await apiCall('/api/teams/accessible', { method: 'GET' });
                const teams = Array.isArray(response) ? response : (response.teams || response.data || []);
                
                const teamSelect = document.getElementById('editUserTeam');
                teamSelect.innerHTML = '<option value="">Выберите команду</option>';
                
                teams.forEach(team => {
                    const option = document.createElement('option');
                    option.value = team.id;
                    option.textContent = team.name;
                    teamSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading teams for edit:', error);
                showNotification('Ошибка загрузки команд', 'error');
            }
        }

        async function loadTeamsForTransfer() {
            try {
                const response = await apiCall('/api/teams/accessible', { method: 'GET' });
                const teams = Array.isArray(response) ? response : (response.teams || response.data || []);
                
                const toTeamSelect = document.getElementById('transferToTeam');
                toTeamSelect.innerHTML = '<option value="">Выберите команду</option>';
                
                teams.forEach(team => {
                    const option = document.createElement('option');
                    option.value = team.id;
                    option.textContent = team.name;
                    toTeamSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading teams for transfer:', error);
                showNotification('Ошибка загрузки команд', 'error');
            }
        }

        async function loadOrganizationsForEdit() {
            try {
                const response = await apiCall('/api/organizations', { method: 'GET' });
                const organizations = Array.isArray(response) ? response : (response.organizations || response.data || []);
                
                const orgSelect = document.getElementById('editUserOrganization');
                orgSelect.innerHTML = '<option value="">Выберите организацию</option>';
                
                organizations.forEach(org => {
                    const option = document.createElement('option');
                    option.value = org.id;
                    option.textContent = org.name;
                    orgSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading organizations for edit:', error);
                showNotification('Ошибка загрузки организаций', 'error');
            }
        }

        // Функции для модального окна переноса пользователя
        function closeTransferUserModal() {
            document.getElementById('transferUserModal').style.display = 'none';
        }

        function transferUser(userId) {
            // Проверяем, что пользователь не пытается перевести самого себя
            if (currentUser && userId === currentUser.id) {
                showNotification('Вы не можете перевести самого себя в другую команду', 'error');
                return;
            }

            const user = currentUsersList.find(u => u.id === userId);
            if (!user) {
                showNotification('Пользователь не найден', 'error');
                return;
            }

            // Заполняем данные пользователя
            document.getElementById('transferUserId').value = user.id;
            document.getElementById('transferUserEmail').value = user.email;

            // Загружаем команды и роли
            loadTeamsForTransfer(user);
            loadRolesForTransfer();

            // Показываем модальное окно
            document.getElementById('transferUserModal').style.display = 'block';
        }

        // Change User Role Functions
        function closeChangeUserRoleModal() {
            document.getElementById('changeUserRoleModal').style.display = 'none';
        }

        function changeUserRole(userId) {
            // Проверяем, что пользователь не пытается изменить свою роль
            if (currentUser && userId === currentUser.id) {
                showNotification('Вы не можете изменить свою собственную роль', 'error');
                return;
            }

            const user = currentUsersList.find(u => u.id === userId);
            if (!user) {
                showNotification('Пользователь не найден', 'error');
                return;
            }

            // Заполняем данные пользователя
            document.getElementById('changeUserRoleUserId').value = user.id;
            document.getElementById('changeUserRoleEmail').value = user.email;

            // Загружаем роли
            loadRolesForChangeRole();

            // Показываем модальное окно
            document.getElementById('changeUserRoleModal').style.display = 'block';
        }

        async function loadTeamsForTransfer(user) {
            try {
                const response = await apiCall('/api/teams/accessible', { method: 'GET' });
                const teams = Array.isArray(response) ? response : (response.teams || response.data || []);
                
                const fromTeamSelect = document.getElementById('transferFromTeam');
                const toTeamSelect = document.getElementById('transferToTeam');
                
                // Очищаем селекты
                fromTeamSelect.innerHTML = '<option value="">Выберите команду</option>';
                toTeamSelect.innerHTML = '<option value="">Выберите команду</option>';
                
                // Получаем текущие команды пользователя
                const userTeams = user.teams || [];
                const userTeamIds = userTeams.map(team => team.id);
                
                console.log(`🔍 User ${user.email} is in teams:`, userTeamIds);
                
                teams.forEach(team => {
                    // Для "Из команды" - показываем только команды, где состоит пользователь
                    if (userTeamIds.includes(team.id)) {
                        const fromOption = document.createElement('option');
                        fromOption.value = team.id;
                        fromOption.textContent = team.name;
                        fromTeamSelect.appendChild(fromOption);
                    }
                    
                    // Для "В команду" - показываем команды, где НЕ состоит пользователь
                    if (!userTeamIds.includes(team.id)) {
                        const toOption = document.createElement('option');
                        toOption.value = team.id;
                        toOption.textContent = team.name;
                        toTeamSelect.appendChild(toOption);
                    }
                });
                
                // Если пользователь состоит только в одной команде - автоматически выбираем её
                if (userTeamIds.length === 1) {
                    fromTeamSelect.value = userTeamIds[0];
                }
                // Если пользователь состоит в нескольких командах - не выбираем автоматически
                // Пользователь должен сам выбрать, из какой команды переносить
                
                console.log(`✅ Loaded ${fromTeamSelect.children.length - 1} source teams and ${toTeamSelect.children.length - 1} destination teams`);
            } catch (error) {
                console.error('Error loading teams for transfer:', error);
                showNotification('Ошибка загрузки команд', 'error');
            }
        }

        async function loadRolesForTransfer() {
            try {
                const response = await apiCall('/api/roles', { method: 'GET' });
                const roles = Array.isArray(response) ? response : (response.roles || response.data || []);
                
                const roleSelect = document.getElementById('transferUserRole');
                roleSelect.innerHTML = '<option value="">Выберите роль</option>';
                
                roles.forEach(role => {
                    const option = document.createElement('option');
                    option.value = role.id;
                    option.textContent = `${role.name} - ${role.description || ''}`;
                    roleSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading roles for transfer:', error);
                showNotification('Ошибка загрузки ролей', 'error');
            }
        }

        // Загрузка ролей для конкретного контекста (организация/команда)
        async function loadRolesForContext(contextType, contextId) {
            try {
                let url;
                if (contextType === 'organization') {
                    url = `/api/organizations/${contextId}/roles`;
                } else if (contextType === 'team') {
                    url = `/api/teams/${contextId}/roles`;
                } else {
                    console.error('Invalid context type:', contextType);
                    return;
                }

                const response = await apiCall(url, { method: 'GET' });
                const roles = Array.isArray(response) ? response : (response.roles || response.data || []);
                
                console.log(`🔍 Loaded roles for ${contextType} ${contextId}:`, roles);
                
                const roleSelect = document.getElementById('changeUserRoleNewRole');
                roleSelect.innerHTML = '<option value="">Выберите роль</option>';
                
                // Роли уже отфильтрованы на backend по уровню текущего пользователя
                roles.forEach(role => {
                    const option = document.createElement('option');
                    option.value = role.id;
                    option.textContent = `${role.name} - ${role.description || ''}`;
                    roleSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading roles for context:', error);
                showNotification('Ошибка загрузки ролей: ' + error.message, 'error');
            }
        }

        // Старая функция для обратной совместимости (не используется)
        async function loadRolesForChangeRole() {
            console.warn('loadRolesForChangeRole is deprecated. Use loadRolesForContext instead.');
        }

        async function loadOrganizationsForChangeRole() {
            try {
                const response = await apiCall('/api/organizations', { method: 'GET' });
                const organizations = Array.isArray(response) ? response : (response.organizations || response.data || []);
                
                const orgSelect = document.getElementById('changeUserRoleOrganization');
                orgSelect.innerHTML = '<option value="">Выберите организацию</option>';
                
                organizations.forEach(org => {
                    const option = document.createElement('option');
                    option.value = org.id;
                    option.textContent = org.name;
                    orgSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading organizations for change role:', error);
                showNotification('Ошибка загрузки организаций', 'error');
            }
        }

        async function loadTeamsForChangeRole() {
            try {
                const response = await apiCall('/api/teams/accessible', { method: 'GET' });
                const teams = Array.isArray(response) ? response : (response.teams || response.data || []);
                
                const teamSelect = document.getElementById('changeUserRoleTeam');
                teamSelect.innerHTML = '<option value="">Выберите команду</option>';
                
                teams.forEach(team => {
                    const option = document.createElement('option');
                    option.value = team.id;
                    option.textContent = team.name;
                    teamSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading teams for change role:', error);
                showNotification('Ошибка загрузки команд', 'error');
            }
        }

        async function transferUserSubmit() {
            const userId = document.getElementById('transferUserId').value;
            const fromTeamId = document.getElementById('transferFromTeam').value;
            const toTeamId = document.getElementById('transferToTeam').value;
            const roleId = document.getElementById('transferUserRole').value;

            if (!userId || !fromTeamId || !toTeamId || !roleId) {
                showNotification('Заполните все поля', 'error');
                return;
            }

            if (fromTeamId === toTeamId) {
                showNotification('Команды должны быть разными', 'error');
                return;
            }

            try {
                showLoading('transferUserBtn', 'transferUserText', 'transferUserLoading');

                await apiCall(`/api/users/${userId}/transfer-team`, {
                    method: 'PATCH',
                    body: JSON.stringify({
                        fromTeamId: fromTeamId,
                        toTeamId: toTeamId,
                        roleId: roleId
                    })
                });

                hideLoading('transferUserBtn', 'transferUserText', 'transferUserLoading');
                showNotification('Пользователь успешно перенесен', 'success');
                closeTransferUserModal();
                loadUsers(); // Перезагружаем список пользователей
            } catch (error) {
                hideLoading('transferUserBtn', 'transferUserText', 'transferUserLoading');
                console.error('Error transferring user:', error);
                showNotification('Ошибка переноса пользователя: ' + error.message, 'error');
            }
        }

        // Change User Role Submit
        async function changeUserRoleSubmit() {
            const userId = document.getElementById('changeUserRoleUserId').value;
            const context = document.getElementById('changeUserRoleContext').value;
            const organizationId = document.getElementById('changeUserRoleOrganization').value;
            const teamId = document.getElementById('changeUserRoleTeam').value;
            const roleId = document.getElementById('changeUserRoleNewRole').value;

            if (!userId || !context || !roleId) {
                showNotification('Заполните все обязательные поля', 'error');
                return;
            }

            if (context === 'organization' && !organizationId) {
                showNotification('Выберите организацию', 'error');
                return;
            }

            if (context === 'team' && !teamId) {
                showNotification('Выберите команду', 'error');
                return;
            }

            try {
                showLoading('changeUserRoleBtn', 'changeUserRoleText', 'changeUserRoleLoading');

                const requestBody = {
                    roleId: roleId
                };

                if (context === 'organization') {
                    requestBody.organizationId = organizationId;
                } else if (context === 'team') {
                    requestBody.teamId = teamId;
                }

                await apiCall(`/api/users/${userId}/change-role`, {
                    method: 'PATCH',
                    body: JSON.stringify(requestBody)
                });

                hideLoading('changeUserRoleBtn', 'changeUserRoleText', 'changeUserRoleLoading');
                showNotification('Роль пользователя успешно изменена', 'success');
                closeChangeUserRoleModal();
                loadUsers(); // Перезагружаем список пользователей
            } catch (error) {
                hideLoading('changeUserRoleBtn', 'changeUserRoleText', 'changeUserRoleLoading');
                console.error('Error changing user role:', error);
                showNotification('Ошибка изменения роли: ' + error.message, 'error');
            }
        }

        function toggleEditTarget() {
            const targetType = document.getElementById('editUserTargetType').value;
            const teamGroup = document.getElementById('editUserTeamGroup');
            const orgGroup = document.getElementById('editUserOrgGroup');
            
            if (targetType === 'team') {
                teamGroup.style.display = 'block';
                orgGroup.style.display = 'none';
            } else {
                teamGroup.style.display = 'none';
                orgGroup.style.display = 'block';
            }
        }

        async function saveUserChanges() {
            const userId = document.getElementById('editUserId').value;
            const targetType = document.getElementById('editUserTargetType').value;
            const teamId = document.getElementById('editUserTeam').value;
            const organizationId = document.getElementById('editUserOrganization').value;

            if (!userId) {
                showNotification('Ошибка: ID пользователя не найден', 'error');
                return;
            }

            if (targetType === 'team' && !teamId) {
                showNotification('Выберите команду', 'error');
                return;
            }

            if (targetType === 'organization' && !organizationId) {
                showNotification('Выберите организацию', 'error');
                return;
            }

            try {
                showLoading('editUserBtn', 'editUserText', 'editUserLoading');

                if (targetType === 'team' && teamId) {
                    // Обновляем команду пользователя
                    console.log('Updating user team:', userId, teamId);
                    await apiCall(`/api/users/${userId}/team`, {
                        method: 'PATCH',
                        body: JSON.stringify({ teamId })
                    });
                } else if (targetType === 'organization' && organizationId) {
                    // Обновляем организацию пользователя
                    console.log('Updating user organization:', userId, organizationId);
                    await apiCall(`/api/users/${userId}/organization`, {
                        method: 'PATCH',
                        body: JSON.stringify({ organizationId })
                    });
                }

                hideLoading('editUserBtn', 'editUserText', 'editUserLoading');
                showNotification('Изменения сохранены успешно', 'success');
                closeEditUserModal();
                
                // Перезагружаем список пользователей
                console.log('Reloading users after change...');
                await loadUsers();
            } catch (error) {
                hideLoading('editUserBtn', 'editUserText', 'editUserLoading');
                console.error('Error saving user changes:', error);
                showNotification('Ошибка сохранения изменений: ' + error.message, 'error');
            }
        }

        async function transferUserSubmit() {
            const userId = document.getElementById('transferUserId').value;
            const fromTeamId = document.getElementById('transferFromTeam').value;
            const toTeamId = document.getElementById('transferToTeam').value;

            if (!userId) {
                showNotification('Ошибка: ID пользователя не найден', 'error');
                return;
            }

            if (!fromTeamId && !toTeamId) {
                showNotification('Выберите команду для переноса', 'error');
                return;
            }

            try {
                showLoading('transferUserBtn', 'transferUserText', 'transferUserLoading');

                console.log('Transferring user:', userId, 'from:', fromTeamId, 'to:', toTeamId);
                await apiCall(`/api/users/${userId}/transfer-team`, {
                    method: 'PATCH',
                    body: JSON.stringify({ 
                        fromTeamId: fromTeamId || null, 
                        toTeamId: toTeamId || null 
                    })
                });

                hideLoading('transferUserBtn', 'transferUserText', 'transferUserLoading');
                showNotification('Пользователь успешно перенесен', 'success');
                closeTransferUserModal();
                
                // Перезагружаем список пользователей
                console.log('Reloading users after transfer...');
                await loadUsers();
            } catch (error) {
                hideLoading('transferUserBtn', 'transferUserText', 'transferUserLoading');
                console.error('Error transferring user:', error);
                showNotification('Ошибка переноса пользователя: ' + error.message, 'error');
            }
        }

        function closeTransferUserModal() {
            document.getElementById('transferUserModal').style.display = 'none';
        }

        function editOrganization(orgId) {
            showNotification('Функция редактирования организации в разработке', 'warning');
        }

        function resendInvitation(invitationId) {
            showNotification('Приглашение отправлено повторно', 'success');
        }

        function showInviteModal() {
            document.getElementById('inviteUserModal').style.display = 'block';
            // Очистить форму
            document.getElementById('inviteUserForm').reset();
            // Загрузить список организаций и команд
            loadOrganizationsForInvite();
            loadTeamsForInvite();
        }

        function closeInviteUserModal() {
            document.getElementById('inviteUserModal').style.display = 'none';
        }

        function showCreateTeamModal() {
            document.getElementById('createTeamModal').style.display = 'block';
            // Очистить форму
            document.getElementById('createTeamForm').reset();
            // Загрузить список организаций
            loadOrganizationsForTeam();
        }

        function showCreateOrgModal() {
            document.getElementById('createOrgModal').style.display = 'block';
            // Очистить форму
            document.getElementById('createOrgForm').reset();
        }

        function closeCreateOrgModal() {
            document.getElementById('createOrgModal').style.display = 'none';
        }

        function showNotifications() {
            showNotification('Уведомления в разработке', 'info');
        }

        // Initialize modals
        function initializeModals() {
            // Organization creation form
            document.getElementById('createOrgForm')?.addEventListener('submit', async function(e) {
                e.preventDefault();
                await createOrganization();
            });

            // Team creation form
            document.getElementById('createTeamForm')?.addEventListener('submit', async function(e) {
                e.preventDefault();
                await createTeam();
            });

            // Invite user form
            document.getElementById('inviteUserForm')?.addEventListener('submit', async function(e) {
                e.preventDefault();
                await sendInvitation();
            });

            // Edit user form
            document.getElementById('editUserForm')?.addEventListener('submit', async function(e) {
                e.preventDefault();
                await saveUserChanges();
            });

            // Transfer user form
            document.getElementById('transferUserForm')?.addEventListener('submit', async function(e) {
                e.preventDefault();
                await transferUserSubmit();
            });

            // Change user role form
            document.getElementById('changeUserRoleForm')?.addEventListener('submit', async function(e) {
                e.preventDefault();
                await changeUserRoleSubmit();
            });

            // Change User Role Context Handler
            document.getElementById('changeUserRoleContext')?.addEventListener('change', function() {
                const context = this.value;
                const orgGroup = document.getElementById('changeUserRoleOrganizationGroup');
                const teamGroup = document.getElementById('changeUserRoleTeamGroup');

                if (context === 'organization') {
                    orgGroup.style.display = 'block';
                    teamGroup.style.display = 'none';
                    loadOrganizationsForChangeRole();
                } else if (context === 'team') {
                    orgGroup.style.display = 'none';
                    teamGroup.style.display = 'block';
                    loadTeamsForChangeRole();
                } else {
                    orgGroup.style.display = 'none';
                    teamGroup.style.display = 'none';
                }
            });

            // Обработчик выбора организации - загружаем роли организации
            document.getElementById('changeUserRoleOrganization')?.addEventListener('change', function() {
                const organizationId = this.value;
                if (organizationId) {
                    loadRolesForContext('organization', organizationId);
                }
            });

            // Обработчик выбора команды - загружаем роли команды
            document.getElementById('changeUserRoleTeam')?.addEventListener('change', function() {
                const teamId = this.value;
                if (teamId) {
                    loadRolesForContext('team', teamId);
                }
            });

            // Close modals when clicking outside
            window.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal')) {
                    e.target.style.display = 'none';
                }
            });
        }

        // Create organization
        async function createOrganization() {
            const formData = {
                name: document.getElementById('orgName').value,
                description: document.getElementById('orgDescription').value
            };

            const createBtn = document.getElementById('createOrgBtn');
            const createText = document.getElementById('createOrgText');
            const createLoading = document.getElementById('createOrgLoading');

            try {
                showLoading('createOrgBtn', 'createOrgText', 'createOrgLoading');

                const response = await apiCall('/api/organizations', {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });

                if (response) {
                    showNotification('Организация создана успешно!', 'success');
                    closeCreateOrgModal();
                    // Reload organizations if we're on that page
                    const organizationsSection = document.getElementById('organizations');
                    if (organizationsSection && organizationsSection.style.display !== 'none') {
                        await loadOrganizations();
                    }
                }
            } catch (error) {
                console.error('Ошибка создания организации:', error);
                console.log('Error details:', error);
                
                // Проверяем разные варианты сообщения об ошибке
                const errorMessage = error.message || error.error || error.toString();
                if (errorMessage.includes('уже создали организацию') || 
                    errorMessage.includes('Один пользователь может создать только одну организацию')) {
                    showNotification('Вы уже создали организацию. Один пользователь может создать только одну организацию.', 'error');
                } else {
                    showNotification('Ошибка создания организации: ' + errorMessage, 'error');
                }
            } finally {
                hideLoading('createOrgBtn', 'createOrgText', 'createOrgLoading');
            }
        }

        // Create team
        async function createTeam() {
            const formData = {
                name: document.getElementById('teamName').value,
                description: document.getElementById('teamDescription').value,
                organizationId: document.getElementById('teamOrganization').value
            };

            const createBtn = document.getElementById('createTeamBtn');
            const createText = document.getElementById('createTeamText');
            const createLoading = document.getElementById('createTeamLoading');

            try {
                showLoading('createTeamBtn', 'createTeamText', 'createTeamLoading');

                const response = await apiCall('/api/teams', {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });

                if (response) {
                    showNotification('Команда создана успешно!', 'success');
                    closeCreateTeamModal();
                    // Reload teams if we're on that page
                    const teamsSection = document.getElementById('teams');
                    if (teamsSection && teamsSection.style.display !== 'none') {
                        await loadTeams();
                    }
                }
            } catch (error) {
                console.error('Ошибка создания команды:', error);
                showNotification('Ошибка создания команды: ' + error.message, 'error');
            } finally {
                hideLoading('createTeamBtn', 'createTeamText', 'createTeamLoading');
            }
        }

        function closeCreateTeamModal() {
            document.getElementById('createTeamModal').style.display = 'none';
        }

        // Bind Email Modal
        function showBindEmailModal() {
            document.getElementById('bindEmailModal').style.display = 'block';
            document.getElementById('bindEmailInput').value = '';
            document.getElementById('bindEmailPassword').value = '';
            setTimeout(() => document.getElementById('bindEmailInput').focus(), 100);
        }

        function closeBindEmailModal() {
            document.getElementById('bindEmailModal').style.display = 'none';
            document.getElementById('bindEmailForm').reset();
        }

        async function handleBindEmail(event) {
            event.preventDefault();
            const email = document.getElementById('bindEmailInput').value;
            const password = document.getElementById('bindEmailPassword').value;
            
            if (!email || !password) {
                showNotification('Заполните все поля', 'error');
                return;
            }

            const btn = document.getElementById('bindEmailBtn');
            const btnText = document.getElementById('bindEmailBtnText');
            const loading = document.getElementById('bindEmailLoading');
            
            btn.disabled = true;
            btnText.classList.add('hidden');
            loading.classList.remove('hidden');

            try {
                await apiCall('/api/auth/multi/bind', {
                    method: 'POST',
                    body: JSON.stringify({ authMethod: 'EMAIL', identifier: email, password })
                });
                showNotification('Email привязан', 'success');
                closeBindEmailModal();
                await loadSettings();
            } catch (e) {
                showNotification('Ошибка привязки: ' + e.message, 'error');
            } finally {
                btn.disabled = false;
                btnText.classList.remove('hidden');
                loading.classList.add('hidden');
            }
        }

        // Load organizations for team creation
        async function loadOrganizationsForTeam() {
            try {
                const response = await apiCall('/api/organizations', { method: 'GET' });
                const select = document.getElementById('teamOrganization');
                select.innerHTML = '<option value="">Выберите организацию</option>';
                
                // Handle both array and object responses
                const organizations = Array.isArray(response) ? response : (response?.organizations || []);
                
                if (organizations && Array.isArray(organizations)) {
                    organizations.forEach(org => {
                        const option = document.createElement('option');
                        option.value = org.id;
                        option.textContent = org.name;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Ошибка загрузки организаций:', error);
                showNotification('Ошибка загрузки организаций', 'error');
            }
        }

        // Load organizations for invite
        async function loadOrganizationsForInvite() {
            try {
                const response = await apiCall('/api/organizations', { method: 'GET' });
                const select = document.getElementById('inviteOrganization');
                select.innerHTML = '<option value="">Выберите организацию</option>';
                
                // Handle both array and object responses
                const organizations = Array.isArray(response) ? response : (response?.organizations || []);
                
                if (organizations && Array.isArray(organizations)) {
                    organizations.forEach(org => {
                        const option = document.createElement('option');
                        option.value = org.id;
                        option.textContent = org.name;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Ошибка загрузки организаций:', error);
                showNotification('Ошибка загрузки организаций', 'error');
            }
        }

        // Load teams for invite
        async function loadTeamsForInvite() {
            try {
                const response = await apiCall('/api/teams/accessible', { method: 'GET' });
                const select = document.getElementById('inviteTeam');
                select.innerHTML = '<option value="">Выберите команду</option>';
                
                // Handle both array and object responses
                const teams = Array.isArray(response) ? response : (response?.teams || []);
                
                if (teams && Array.isArray(teams)) {
                    teams.forEach(team => {
                        const option = document.createElement('option');
                        option.value = team.id;
                        option.textContent = team.name;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Ошибка загрузки команд:', error);
                showNotification('Ошибка загрузки команд', 'error');
            }
        }

        // Load roles for invitation
        async function loadRolesForInvite(type) {
            try {
                const roleSelect = document.getElementById('inviteRole');
                if (!roleSelect) {
                    console.error('Role select element not found');
                    return;
                }
                roleSelect.innerHTML = '<option value="">Загрузка ролей...</option>';
                roleSelect.disabled = true;
                
                if (type === 'team') {
                    // Для команды загружаем роли команды
                    const teamId = document.getElementById('inviteTeam')?.value;
                    if (!teamId) {
                        roleSelect.innerHTML = '<option value="">Выберите команду</option>';
                        roleSelect.disabled = false;
                        return;
                    }
                    
                    const response = await apiCall(`/api/teams/${teamId}/roles`, {
                        method: 'GET'
                    });
                    
                    // Handle different response formats
                    const roles = Array.isArray(response) ? response : (response?.roles || response?.data || []);
                    
                    roleSelect.innerHTML = '<option value="">Выберите роль</option>';
                    roleSelect.disabled = false;
                    
                    if (roles && roles.length > 0) {
                        roles.forEach(role => {
                            const option = document.createElement('option');
                            option.value = role.id || role.value;
                            option.textContent = (role.name || role.label) + (role.description ? ' - ' + role.description : '');
                            roleSelect.appendChild(option);
                        });
                    } else {
                        roleSelect.innerHTML = '<option value="">Роли не найдены</option>';
                    }
                } else if (type === 'organization') {
                    // Для организации загружаем роли организации
                    const organizationId = document.getElementById('inviteOrganization')?.value;
                    if (!organizationId) {
                        roleSelect.innerHTML = '<option value="">Выберите организацию</option>';
                        roleSelect.disabled = false;
                        return;
                    }
                    
                    console.log(`🔍 [loadRolesForInvite] Loading roles for organization ${organizationId}`);
                    const response = await apiCall(`/api/organizations/${organizationId}/roles`, {
                        method: 'GET'
                    });
                    console.log(`🔍 [loadRolesForInvite] Response:`, response);
                    
                    // Handle different response formats
                    const roles = Array.isArray(response) ? response : (response?.roles || response?.data || []);
                    console.log(`🔍 [loadRolesForInvite] Parsed ${roles.length} roles`);
                    
                    roleSelect.innerHTML = '<option value="">Выберите роль</option>';
                    roleSelect.disabled = false;
                    
                    if (roles && roles.length > 0) {
                        console.log(`✅ [loadRolesForInvite] Adding ${roles.length} roles to select`);
                        roles.forEach(role => {
                            const option = document.createElement('option');
                            option.value = role.id || role.value;
                            option.textContent = (role.name || role.label) + (role.description ? ' - ' + role.description : '');
                            roleSelect.appendChild(option);
                        });
                    } else {
                        console.warn(`⚠️ [loadRolesForInvite] No roles found, showing error message`);
                        roleSelect.innerHTML = '<option value="">Роли не найдены</option>';
                    }
                }
            } catch (error) {
                console.error('Error loading roles:', error);
                const roleSelect = document.getElementById('inviteRole');
                if (roleSelect) {
                    roleSelect.innerHTML = '<option value="">Ошибка загрузки ролей</option>';
                    roleSelect.disabled = false;
                }
                showNotification('Ошибка загрузки ролей: ' + (error.message || 'Неизвестная ошибка'), 'error');
            }
        }

        // Toggle invite target based on type
        function toggleInviteTarget() {
            const type = document.getElementById('inviteType').value;
            const orgGroup = document.getElementById('inviteOrganizationGroup');
            const teamGroup = document.getElementById('inviteTeamGroup');
            const roleGroup = document.getElementById('inviteRoleGroup');
            
            if (type === 'organization') {
                orgGroup.style.display = 'block';
                teamGroup.style.display = 'none';
                roleGroup.style.display = 'block';
                document.getElementById('inviteOrganization').required = true;
                document.getElementById('inviteTeam').required = false;
                document.getElementById('inviteRole').required = true;
                loadOrganizationsForInvite();
                // Роли загружаются после выбора организации
            } else if (type === 'team') {
                orgGroup.style.display = 'none';
                teamGroup.style.display = 'block';
                roleGroup.style.display = 'block';
                document.getElementById('inviteOrganization').required = false;
                document.getElementById('inviteTeam').required = true;
                document.getElementById('inviteRole').required = true;
                loadTeamsForInvite();
                // Роли загружаются после выбора команды
            } else {
                orgGroup.style.display = 'none';
                teamGroup.style.display = 'none';
                roleGroup.style.display = 'none';
                document.getElementById('inviteOrganization').required = false;
                document.getElementById('inviteTeam').required = false;
                document.getElementById('inviteRole').required = false;
            }
        }

        // Toggle invite identifier type
        function toggleInviteIdentifierType() {
            const identifierType = document.getElementById('inviteIdentifierType').value;
            const emailGroup = document.getElementById('inviteEmailGroup');
            const githubGroup = document.getElementById('inviteGithubGroup');
            const telegramGroup = document.getElementById('inviteTelegramGroup');
            const emailInput = document.getElementById('inviteEmail');
            const githubUsernameInput = document.getElementById('inviteGithubUsername');
            const telegramInput = document.getElementById('inviteTelegramUsername');

            // Скрываем все группы и очищаем поля
            if (emailGroup) emailGroup.style.display = 'none';
            if (githubGroup) githubGroup.style.display = 'none';
            if (telegramGroup) telegramGroup.style.display = 'none';
            if (emailInput) emailInput.required = false;
            if (githubUsernameInput) githubUsernameInput.required = false;
            if (telegramInput) telegramInput.required = false;

            // Показываем нужную группу
            if (identifierType === 'email') {
                if (emailGroup) emailGroup.style.display = 'block';
                if (emailInput) emailInput.required = true;
            } else if (identifierType === 'github') {
                if (githubGroup) githubGroup.style.display = 'block';
                if (githubUsernameInput) githubUsernameInput.required = true;
            } else if (identifierType === 'telegram') {
                if (telegramGroup) telegramGroup.style.display = 'block';
                if (telegramInput) telegramInput.required = true;
            }
        }


        // Send invitation
        async function sendInvitation() {
            const identifierType = document.getElementById('inviteIdentifierType').value;
            const email = document.getElementById('inviteEmail').value;
            const githubUsername = document.getElementById('inviteGithubUsername').value;
            const telegramUsername = document.getElementById('inviteTelegramUsername').value;
            const targetType = document.getElementById('inviteType').value;

            if (!identifierType || !targetType) {
                showNotification('Заполните все обязательные поля', 'error');
                return;
            }

            // Проверяем, что указан хотя бы один идентификатор
            if (identifierType === 'email' && !email) {
                showNotification('Введите email', 'error');
                return;
            }
            if (identifierType === 'github' && !githubUsername) {
                showNotification('Введите GitHub username', 'error');
                return;
            }
            if (identifierType === 'telegram' && !telegramUsername) {
                showNotification('Введите Telegram username', 'error');
                return;
            }

            // Проверяем, что пользователь не приглашает сам себя (только для email)
            if (identifierType === 'email') {
                const currentUser = JSON.parse(localStorage.getItem('userData') || '{}');
                if (email === currentUser.email) {
                    showNotification('Вы не можете пригласить самого себя', 'error');
                    return;
                }
            }

            const formData = {
                type: targetType
            };

            // Добавляем идентификатор в зависимости от типа
            if (identifierType === 'email') {
                formData.email = email;
            } else if (identifierType === 'github') {
                formData.githubUsername = githubUsername;
            } else if (identifierType === 'telegram') {
                formData.telegramUsername = telegramUsername;
            }

            // Add target based on type
            if (targetType === 'organization') {
                const organizationId = document.getElementById('inviteOrganization').value;
                if (!organizationId) {
                    showNotification('Выберите организацию', 'error');
                    return;
                }
                formData.organizationId = organizationId;
            } else if (targetType === 'team') {
                const teamId = document.getElementById('inviteTeam').value;
                if (!teamId) {
                    showNotification('Выберите команду', 'error');
                    return;
                }
                formData.teamId = teamId;
            }

            // Add role
            const roleId = document.getElementById('inviteRole').value;
            if (!roleId) {
                showNotification('Выберите роль', 'error');
                return;
            }
            formData.roleId = roleId;

            try {
                showLoading('inviteUserBtn', 'inviteUserText', 'inviteUserLoading');

                const response = await apiCall('/api/invitations', {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });

                if (response) {
                    // Очищаем форму ПЕРЕД закрытием модального окна
                    document.getElementById('inviteIdentifierType').value = '';
                    document.getElementById('inviteEmail').value = '';
                    document.getElementById('inviteGithubUsername').value = '';
                    document.getElementById('inviteTelegramUsername').value = '';
                    document.getElementById('inviteType').value = '';
                    toggleInviteIdentifierType(); // Скрываем все поля идентификации
                    const teamGroup = document.getElementById('inviteTeamGroup');
                    const orgGroup = document.getElementById('inviteOrgGroup');
                    if (teamGroup) {
                        document.getElementById('inviteTeam').value = '';
                        teamGroup.style.display = 'none';
                    }
                    if (orgGroup) {
                        document.getElementById('inviteOrganization').value = '';
                        orgGroup.style.display = 'none';
                    }
                    document.getElementById('inviteRoleGroup').style.display = 'none';
                    document.getElementById('inviteRole').value = '';
                    
                    showNotification('Приглашение отправлено успешно!', 'success');
                    closeInviteUserModal();
                    
                    // Обновляем список приглашений И приглашенных пользователей
                    console.log('🔄 Обновляем списки после отправки...');
                    await loadInvitations();
                    await loadInvitedUsers(); // Добавляем обновление приглашенных пользователей
                    console.log('✅ Списки обновлены');
                }
            } catch (error) {
                console.error('Ошибка отправки приглашения:', error);
                showNotification('Ошибка отправки приглашения: ' + error.message, 'error');
            } finally {
                hideLoading('inviteUserBtn', 'inviteUserText', 'inviteUserLoading');
            }
        }

        // Load invitations
        async function loadInvitations() {
            console.log('loadInvitations called');
            try {
                // Принудительно очищаем контейнер перед загрузкой
                const container = document.getElementById('invitationsContainer');
                if (container) {
                    container.innerHTML = '<div class="loading-placeholder">Загрузка приглашений...</div>';
                }
                
                const response = await apiCall('/api/invitations/my', { method: 'GET' });
                console.log('Invitations response:', response);
                console.log('Response type:', typeof response);
                console.log('Response length:', response ? response.length : 'null');
                displayInvitations(response);
            } catch (error) {
                console.error('Ошибка загрузки приглашений:', error);
                document.getElementById('invitationsContainer').innerHTML = 
                    '<p style="color: #EF4444; text-align: center; padding: 20px;">Ошибка загрузки приглашений</p>';
            }
        }

        // Display invitations
        function displayInvitations(invitations) {
            console.log('🎨 DISPLAY_INVITATIONS вызвана с:', invitations);
            console.log('📊 Количество приглашений:', invitations ? invitations.length : 'null');
            const container = document.getElementById('invitationsContainer');
            console.log('📦 Контейнер найден:', !!container);
            console.log('📦 Текущее содержимое контейнера:', container ? container.innerHTML.length : 'null');
            
            // Handle different response formats
            let invitationList = invitations;
            if (invitations && typeof invitations === 'object' && !Array.isArray(invitations)) {
                // If it's an object, try to extract the array
                invitationList = invitations.invitations || invitations.data || invitations;
            }
            
            console.log('Processed invitationList:', invitationList);
            console.log('Is array:', Array.isArray(invitationList));
            console.log('Length:', invitationList ? invitationList.length : 'null');
            
            if (!invitationList || !Array.isArray(invitationList) || invitationList.length === 0) {
                console.log('No invitations found, showing empty state');
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6B7280;">
                        <i class="fas fa-envelope-open" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                        <h3>Нет приглашений</h3>
                        <p>У вас пока нет приглашений в организации или команды</p>
                    </div>
                `;
                return;
            }
            
            console.log('Rendering invitations...');
            // Принудительно показываем контейнер
            container.style.display = 'block';
            container.style.visibility = 'visible';
            container.style.opacity = '1';

            // Принудительно очищаем контейнер перед обновлением
            container.innerHTML = '';
            
            // Небольшая задержка для принудительного обновления DOM
            setTimeout(() => {
                console.log('🎨 Рендерим приглашения, количество:', invitationList.length);
                container.innerHTML = invitationList.map(invitation => `
                <div class="invitation-item" style="
                    border: 1px solid #E5E7EB;
                    border-radius: 12px;
                    padding: 20px;
                    margin-bottom: 16px;
                    background: #F9FAFB;
                    transition: all 0.3s ease;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                        <div>
                            <h3 style="margin: 0 0 8px 0; color: #1F2937; font-size: 1.1rem;">
                                ${invitation.type === 'organization' ? 'Организация' : 'Команда'}: ${invitation.targetName || (invitation.teamId ? 'Команда назначена' : 'Не назначено')}
                            </h3>
                            <p style="margin: 0; color: #6B7280; font-size: 0.9rem;">
                                Приглашение от: ${invitation.inviterName || invitation.inviterEmail}
                            </p>
                        </div>
                        <span class="status-badge ${getInvitationStatusClass(invitation.status)}">
                            ${getInvitationStatusText(invitation.status)}
                        </span>
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <p style="margin: 0; color: #374151; line-height: 1.5;">
                            ${invitation.message || 'Приглашение в ' + (invitation.type === 'organization' ? 'организацию' : 'команду')}
                        </p>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="font-size: 0.875rem; color: #6B7280;">
                            <i class="fas fa-clock"></i>
                            ${new Date(invitation.createdAt).toLocaleDateString('ru-RU', {
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            })}
                        </div>
                        
                        ${invitation.status === 'pending' ? `
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-success btn-sm" onclick="respondToInvitation('${invitation.id}', 'accepted')">
                                    <i class="fas fa-check"></i>
                                    Принять
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="respondToInvitation('${invitation.id}', 'declined')">
                                    <i class="fas fa-times"></i>
                                    Отклонить
                                </button>
                                <button class="btn btn-warning btn-sm" onclick="cancelInvitation('${invitation.id}')">
                                    <i class="fas fa-ban"></i>
                                    Отменить
                                </button>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');
                console.log('✅ Приглашения отрендерены, длина HTML:', container.innerHTML.length);
            }, 10); // Небольшая задержка для принудительного обновления DOM
        }

        // Get invitation status class
        function getInvitationStatusClass(status) {
            switch (status) {
                case 'pending': return 'pending';
                case 'accepted': return 'active';
                case 'declined': return 'inactive';
                case 'expired': return 'inactive';
                default: return 'inactive';
            }
        }

        // Get invitation status text
        function getInvitationStatusText(status) {
            switch (status) {
                case 'pending': return 'Ожидает ответа';
                case 'accepted': return 'Принято';
                case 'declined': return 'Отклонено';
                case 'expired': return 'Истекло';
                default: return 'Неизвестно';
            }
        }

        // Respond to invitation
        async function respondToInvitation(invitationId, response) {
            try {
                // Используем правильные endpoints для принятия/отклонения приглашения
                const endpoint = response === 'accepted' 
                    ? `/api/invitations/accept-notification/${invitationId}`
                    : `/api/invitations/decline-notification/${invitationId}`;

                await apiCall(endpoint, {
                    method: 'POST'
                });

                const actionText = response === 'accepted' ? 'принято' : 'отклонено';
                showNotification(`Приглашение ${actionText}`, 'success');
                
                // Reload invitations
                await loadInvitations();
            } catch (error) {
                console.error('Ошибка ответа на приглашение:', error);
                showNotification('Ошибка ответа на приглашение: ' + error.message, 'error');
            }
        }

        // Cancel invitation
        async function cancelInvitation(invitationId) {
            if (!confirm('Вы уверены, что хотите отменить это приглашение?')) {
                return;
            }

            try {
                console.log('🚨 ОТМЕНА ПРИГЛАШЕНИЯ:', invitationId);
                console.log('📧 Контейнер до удаления:', document.getElementById('invitationsContainer').innerHTML.length);
                
                await apiCall(`/api/invitations/${invitationId}`, {
                    method: 'DELETE'
                });

                console.log('✅ Приглашение удалено с сервера');
                showNotification('Приглашение отменено', 'success');
                
                // Принудительно очищаем контейнер и перезагружаем
                const container = document.getElementById('invitationsContainer');
                if (container) {
                    console.log('🧹 Очищаем контейнер...');
                    container.innerHTML = '<div class="loading-placeholder">Обновление списка...</div>';
                    console.log('📧 Контейнер после очистки:', container.innerHTML);
                }
                
                // Небольшая задержка перед перезагрузкой
                setTimeout(async () => {
                    console.log('🔄 Перезагружаем приглашения и приглашенных пользователей...');
                    await loadInvitations();
                    await loadInvitedUsers(); // Добавляем обновление приглашенных пользователей
                    console.log('✅ Списки перезагружены');
                }, 100);
                
            } catch (error) {
                console.error('Ошибка отмены приглашения:', error);
                showNotification('Ошибка отмены приглашения: ' + error.message, 'error');
            }
        }

        // Refresh invitations
        function refreshInvitations() {
            loadInvitations();
        }

        // Show loading state
        function showLoading(buttonId, textId, loadingId) {
            const button = document.getElementById(buttonId);
            const text = document.getElementById(textId);
            const loading = document.getElementById(loadingId);
            
            if (button) button.disabled = true;
            if (text) text.classList.add('hidden');
            if (loading) loading.classList.remove('hidden');
        }

        // Hide loading state
        function hideLoading(buttonId, textId, loadingId) {
            const button = document.getElementById(buttonId);
            const text = document.getElementById(textId);
            const loading = document.getElementById(loadingId);
            
            if (button) button.disabled = false;
            if (text) text.classList.remove('hidden');
            if (loading) loading.classList.add('hidden');
        }

        // Load recent activity
        async function loadRecentActivity() {
            try {
                // Load recent data from working sources only
                const [teamMembers, invitations] = await Promise.all([
                    apiCall('/api/users/in-context', { method: 'GET' }).catch(() => []),
                    apiCall('/api/invitations/my', { method: 'GET' }).catch(() => [])
                ]);

                const usersList = Array.isArray(teamMembers) ? teamMembers : (teamMembers?.users || teamMembers?.data || []);
                const invitationsList = Array.isArray(invitations) ? invitations : (invitations?.invitations || invitations?.data || []);

                // Create activity items
                const activities = [];

                // Add recent user activities
                usersList.slice(0, 3).forEach(user => {
                    activities.push({
                        user: user,
                        action: 'Активен в системе',
                        time: user.updatedAt || user.createdAt,
                        status: 'success',
                        type: 'activity'
                    });
                });

                // Add recent invitation activities
                invitationsList.slice(0, 2).forEach(invitation => {
                    activities.push({
                        user: { firstName: invitation.inviterName?.split(' ')[0] || 'Пользователь', lastName: invitation.inviterName?.split(' ')[1] || '', email: invitation.inviterEmail },
                        action: `Приглашение в ${invitation.type === 'organization' ? 'организацию' : 'команду'}`,
                        time: invitation.createdAt,
                        status: invitation.status === 'pending' ? 'warning' : (invitation.status === 'accepted' ? 'success' : 'error'),
                        type: 'invitation'
                    });
                });

                // Add recent notification activities (placeholder - notifications not implemented yet)
                // notificationsList.slice(0, 2).forEach(notification => {
                //     activities.push({
                //         user: currentUser,
                //         action: notification.title || 'Новое уведомление',
                //         time: notification.createdAt,
                //         status: notification.isRead ? 'success' : 'warning',
                //         type: 'notification'
                //     });
                // });

                // Sort by time (most recent first)
                activities.sort((a, b) => new Date(b.time) - new Date(a.time));

                // Display activities
                displayRecentActivity(activities.slice(0, 5)); // Show only 5 most recent

            } catch (error) {
                console.error('Error loading recent activity:', error);
                // Show placeholder if error
                displayRecentActivity([]);
            }
        }

        // Display recent activity
        function displayRecentActivity(activities) {
            const tbody = document.getElementById('recentActivityBody');
            
            if (!activities || activities.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 20px; color: #6B7280;">
                            <i class="fas fa-clock" style="font-size: 24px; margin-bottom: 8px; opacity: 0.5;"></i>
                            <div>Нет недавней активности</div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = activities.map(activity => {
                const user = activity.user;
                const initials = (user.firstName?.[0] || '') + (user.lastName?.[0] || '');
                const fullName = `${user.firstName || ''} ${user.lastName || ''}`.trim() || user.email;
                const timeAgo = getTimeAgo(activity.time);
                const statusClass = getActivityStatusClass(activity.status);

                return `
                    <tr>
                        <td>
                            <div class="user-info">
                                <div class="user-avatar">${initials || 'U'}</div>
                                <div class="user-details">
                                    <h4>${fullName}</h4>
                                    <p>${user.email || ''}</p>
                                </div>
                            </div>
                        </td>
                        <td>${activity.action}</td>
                        <td>${timeAgo}</td>
                        <td>
                            <span class="status-badge ${statusClass}">
                                ${getActivityStatusText(activity.status)}
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Get time ago string
        function getTimeAgo(dateString) {
            const now = new Date();
            const date = new Date(dateString);
            const diffInMinutes = Math.floor((now - date) / (1000 * 60));

            if (diffInMinutes < 1) return 'Только что';
            if (diffInMinutes < 60) return `${diffInMinutes} мин назад`;
            
            const diffInHours = Math.floor(diffInMinutes / 60);
            if (diffInHours < 24) return `${diffInHours} ч назад`;
            
            const diffInDays = Math.floor(diffInHours / 24);
            if (diffInDays < 7) return `${diffInDays} дн назад`;
            
            return date.toLocaleDateString('ru-RU');
        }

        // Get activity status class
        function getActivityStatusClass(status) {
            switch (status) {
                case 'success': return 'active';
                case 'warning': return 'pending';
                case 'error': return 'inactive';
                default: return 'inactive';
            }
        }

        // Get activity status text
        function getActivityStatusText(status) {
            switch (status) {
                case 'success': return 'Успешно';
                case 'warning': return 'В ожидании';
                case 'error': return 'Ошибка';
                default: return 'Неизвестно';
            }
        }

        // Ensure referral section exists in DOM - defined globally for proper hoisting
        window.ensureReferralSection = function ensureReferralSection() {
            const referralCard = document.getElementById('referralCard');
            const settingsSection = document.getElementById('settings');
            
            if (!settingsSection) {
                console.warn('⚠️ Settings section not found');
                return;
            }
            
            // Если карточка не найдена, создаем её
            if (!referralCard) {
                console.log('🔧 Referral card not found in DOM, creating dynamically...');
                
                // Ищем карточку "Способы входа"
                const authMethodsCard = Array.from(settingsSection.querySelectorAll('.card')).find(c => {
                    const title = c.querySelector('h2.card-title');
                    return title && title.textContent.includes('Способы входа');
                });
                
                // Ищем карточку "Безопасность"
                const securityCard = Array.from(settingsSection.querySelectorAll('.card')).find(c => {
                    const title = c.querySelector('h2.card-title');
                    return title && title.textContent.includes('Безопасность');
                });
                
                if (authMethodsCard && securityCard) {
                    // Создаем карточку реферальных ссылок
                    const referralCardHTML = `
                    <div class="card" id="referralCard">
                        <h2 class="card-title">Реферальные ссылки</h2>
                        <div class="referral-settings">
                            <div class="form-group">
                                <label for="referralExpiresInDays">Срок действия (дни)</label>
                                <input type="number" id="referralExpiresInDays" name="expiresInDays" placeholder="30" min="1" max="365" value="30">
                                <small class="text-muted">Через сколько дней ссылка истечет (по умолчанию 30)</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="referralUsageLimit">Количество использований</label>
                                <input type="number" id="referralUsageLimit" name="usageLimit" placeholder="Неограниченно" min="1">
                                <small class="text-muted">Максимальное количество использований ссылки (оставьте пустым для неограниченного использования)</small>
                            </div>
                            
                            <div class="form-actions">
                                <button type="button" class="btn btn-primary" onclick="generateReferralLink(event)">
                                    <i class="fas fa-link"></i>
                                    Создать реферальную ссылку
                                </button>
                            </div>
                            
                            <div id="referralLinksList" style="margin-top: 1.5rem;">
                                <h3 style="margin-bottom: 1rem;">Мои реферальные ссылки</h3>
                                <div id="referralLinksContainer">
                                    <div class="loading-placeholder">Загрузка ссылок...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    `;
                    
                    // Вставляем между "Способы входа" и "Безопасность"
                    authMethodsCard.insertAdjacentHTML('afterend', referralCardHTML);
                    console.log('✅ Referral section created dynamically');
                    
                    // Загружаем реферальные ссылки
                    if (typeof loadReferralLinks === 'function') {
                        loadReferralLinks();
                    }
                } else {
                    console.warn('⚠️ Cannot find authMethodsCard or securityCard to insert referral section');
                }
            } else {
                console.log('✅ Referral card already exists in DOM');
            }
        };

        // Функция для создания раздела реферальных ссылок - сделана глобальной
        window.ensureReferralSection = function ensureReferralSection() {
            console.log('🔧 ensureReferralSection called');
            const referralCard = document.getElementById('referralCard');
            const settingsSection = document.getElementById('settings');
            
            if (!settingsSection) {
                console.warn('⚠️ Settings section not found');
                return false;
            }
            
            if (referralCard) {
                // Раздел уже есть, но не принуждаем показывать - позволим loadModuleControls управлять видимостью
                console.log('✅ Referral card already exists in DOM');
                return true;
            }
            
            // Создаем раздел
            const authMethodsCard = Array.from(settingsSection.querySelectorAll('.card')).find(c => {
                const title = c.querySelector('h2.card-title');
                return title && title.textContent.includes('Способы входа');
            });
            
            const securityCard = Array.from(settingsSection.querySelectorAll('.card')).find(c => {
                const title = c.querySelector('h2.card-title');
                return title && title.textContent.includes('Безопасность');
            });
            
            console.log('🔍 Cards found:', { 
                authMethodsCard: !!authMethodsCard, 
                securityCard: !!securityCard 
            });
            
            if (!authMethodsCard || !securityCard) {
                console.warn('⚠️ Cannot find authMethodsCard or securityCard');
                return false;
            }
            
            const referralCardHTML = `
                <div class="card" id="referralCard">
                    <h2 class="card-title">Реферальные ссылки</h2>
                    <div class="referral-settings">
                        <div class="form-group">
                            <label for="referralExpiresInDays">Срок действия (дни)</label>
                            <input type="number" id="referralExpiresInDays" name="expiresInDays" placeholder="30" min="1" max="365" value="30">
                            <small class="text-muted">Через сколько дней ссылка истечет (по умолчанию 30)</small>
                        </div>
                        <div class="form-group">
                            <label for="referralUsageLimit">Количество использований</label>
                            <input type="number" id="referralUsageLimit" name="usageLimit" placeholder="Неограниченно" min="1">
                            <small class="text-muted">Максимальное количество использований ссылки (оставьте пустым для неограниченного использования)</small>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="btn btn-primary" id="generateReferralLinkBtn">
                                <i class="fas fa-link"></i>
                                Создать реферальную ссылку
                            </button>
                        </div>
                        <div id="referralLinksList" style="margin-top: 1.5rem;">
                            <h3 style="margin-bottom: 1rem;">Мои реферальные ссылки</h3>
                            <div id="referralLinksContainer">
                                <div class="loading-placeholder">Загрузка ссылок...</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            authMethodsCard.insertAdjacentHTML('afterend', referralCardHTML);
            console.log('✅ Referral card created dynamically');
            return true;
        };
        
        // Load settings
        async function loadSettings() {
            console.log('🔧 loadSettings called');
            // Создаем раздел реферальных ссылок (с задержкой для надежности)
            setTimeout(() => window.ensureReferralSection(), 100);
            setTimeout(() => window.ensureReferralSection(), 300);
            setTimeout(() => window.ensureReferralSection(), 500);
            setTimeout(() => window.ensureReferralSection(), 1000);
            window.ensureReferralSection();
            
            // Загружаем реферальные ссылки
            await loadReferralLinks();
            
            // Привязываем обработчик к кнопке генерации ссылок
            setTimeout(() => {
                const generateBtn = document.getElementById('generateReferralLinkBtn');
                if (generateBtn && !generateBtn.hasAttribute('data-listener-attached')) {
                    generateBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        if (typeof window.generateReferralLink === 'function') {
                            window.generateReferralLink(e);
                        } else {
                            console.error('❌ generateReferralLink function not available');
                            showNotification('Ошибка: функция создания реферальной ссылки недоступна', 'error');
                        }
                    });
                    generateBtn.setAttribute('data-listener-attached', 'true');
                    console.log('✅ Generate referral link button event listener attached');
                }
                
                // Не принуждаем показывать - позволим loadModuleControls управлять видимостью на основе статуса модуля
                const finalReferralCard = document.getElementById('referralCard');
                if (finalReferralCard) {
                    console.log('✅ Referral card exists in DOM');
                }
            }, 200);
            
            try {
                const response = await apiCall('/api/auth/me', { method: 'GET' });
                const user = response;
                
                // Fill form with current user data
                document.getElementById('firstName').value = user.firstName || '';
                document.getElementById('lastName').value = user.lastName || '';
                document.getElementById('email').value = user.email || '';
                
                // Update status indicators
                const emailStatus = document.getElementById('emailStatus');
                
                if (user.emailVerified) {
                    emailStatus.textContent = 'Email подтвержден';
                    emailStatus.style.color = '#10b981';
                } else {
                    emailStatus.textContent = 'Email не подтвержден';
                    emailStatus.style.color = '#ef4444';
                }
                
                // Load auth methods section
                await renderAuthMethods(user);
                
                // Загружаем модули для суперадмина - это также скрывает отключенные элементы
                // Проверяем роли в разных форматах (объекты или строки)
                const isSuperAdmin = user.roles && user.roles.some(r => {
                    const roleName = typeof r === 'string' ? r : r.name;
                    return roleName === 'super_admin';
                });
                
                if (isSuperAdmin) {
                    console.log('✅ User is super_admin, loading module controls');
                    await loadModuleControls();
                } else {
                    console.log('ℹ️ User is not super_admin, checking module status');
                    // Даже если не суперадмин, проверяем статус модулей для скрытия элементов
                    await checkModuleStatusAndHide();
                }
                
                // Load nFA settings
                await loadNfaSettings(user);
                
                // Показываем GitHub информацию, если пользователь зарегистрирован через GitHub
                if (user.githubId || user.githubUsername) {
                    const githubInfoGroup = document.getElementById('githubInfoGroup');
                    const displayGithubId = document.getElementById('displayGithubId');
                    const displayGithubUsername = document.getElementById('displayGithubUsername');
                    
                    if (githubInfoGroup) {
                        githubInfoGroup.style.display = 'block';
                    }
                    if (displayGithubId && user.githubId) {
                        displayGithubId.textContent = user.githubId;
                    }
                    if (displayGithubUsername && user.githubUsername) {
                        displayGithubUsername.textContent = user.githubUsername;
                    }
                } else {
                    const githubInfoGroup = document.getElementById('githubInfoGroup');
                    if (githubInfoGroup) {
                        githubInfoGroup.style.display = 'none';
                    }
                }
                
            } catch (error) {
                console.error('Ошибка загрузки настроек:', error);
                showNotification('Ошибка загрузки настроек', 'error');
            }
        }

        // Initialize settings event listeners
        function initializeSettings() {
            // Settings form submission
            document.getElementById('settingsForm')?.addEventListener('submit', async function(e) {
                e.preventDefault();
                await saveSettings();
            });

            // Email verification
            document.getElementById('verifyEmailBtn')?.addEventListener('click', async function() {
                await verifyEmail();
            });

            // Init auth methods actions
            initializeAuthMethodsUI();

            // Cancel settings
            document.getElementById('cancelSettings')?.addEventListener('click', function() {
                loadSettings(); // Reload original data
            });

            // nFA settings button
            document.getElementById('saveNfaSettingsBtn')?.addEventListener('click', async function() {
                await saveNfaSettings();
            });
        }

        // Save settings
        async function saveSettings() {
            try {
                const formData = {
                    firstName: document.getElementById('firstName').value,
                    lastName: document.getElementById('lastName').value
                };

                const response = await apiCall('/api/users/me', {
                    method: 'PATCH',
                    body: JSON.stringify(formData)
                });

                showNotification('Настройки сохранены', 'success');

            } catch (error) {
                console.error('Ошибка сохранения настроек:', error);
                showNotification('Ошибка сохранения настроек: ' + error.message, 'error');
            }
        }

        // Verify email
        async function verifyEmail() {
            try {
                console.log('🎯 DASHBOARD: Вызываем новый endpoint для отправки письма с кнопкой');
                console.log('📧 Email:', document.getElementById('email').value);
                
                const response = await apiCall('/api/auth/email-verification/send', {
                    method: 'POST',
                    body: JSON.stringify({ email: document.getElementById('email').value })
                });
                
                // Показываем сообщение в зависимости от ответа сервера
                if (response.success) {
                    if (response.message === 'Email уже подтвержден') {
                        showNotification('Email уже подтвержден', 'info');
                    } else {
                        showNotification('Письмо с кнопкой подтверждения отправлено на вашу почту', 'success');
                    }
                } else {
                    showNotification(response.message || 'Ошибка отправки письма', 'error');
                }
                
                // НЕ показываем диалог ввода кода - письмо содержит кнопку
                // const code = prompt('Введите код подтверждения, отправленный на вашу почту:');
                // if (code) {
                //     await verifyEmailCode(code);
                // }
            } catch (error) {
                console.error('Ошибка отправки кода:', error);
                showNotification('Ошибка отправки кода: ' + error.message, 'error');
            }
        }

        // Verify email code
        async function verifyEmailCode(code) {
            try {
                await apiCall('/api/auth/2fa/email/verify-code', {
                    method: 'POST',
                    body: JSON.stringify({ 
                        email: document.getElementById('email').value,
                        code: code
                    })
                });
                
                showNotification('Email успешно подтвержден', 'success');
                loadSettings(); // Reload to update status
            } catch (error) {
                console.error('Ошибка подтверждения email:', error);
                showNotification('Ошибка подтверждения email: ' + error.message, 'error');
            }
        }

        // Auth methods UI
        function initializeAuthMethodsUI() {
            // No-op for now; actions are bound via buttons when rendered
        }

        async function fetchAvailableAuthMethods() {
            try {
                // Проверяем статус модулей авторизации
                const statusResult = await apiCall('/api/micro-modules/auth/status', { method: 'GET' });
                const enabledMethods = [];
                
                // Email всегда доступен (системный модуль)
                if (statusResult?.email?.enabled !== false) {
                    enabledMethods.push('EMAIL');
                }
                
                // GitHub доступен только если модуль включен
                if (statusResult?.github?.enabled === true) {
                    enabledMethods.push('GITHUB');
                }
                
                // Telegram доступен только если модуль включен
                if (statusResult?.telegram?.enabled === true) {
                    enabledMethods.push('PHONE_TELEGRAM');
                }
                
                return enabledMethods;
            } catch (e) {
                console.warn('Не удалось получить статус модулей, используем дефолтный', e);
                // Fallback к проверке через старый API
                try {
                    const result = await apiCall('/api/auth/multi/methods', { method: 'GET' });
                    return result?.methods || ['EMAIL', 'GITHUB'];
                } catch (e2) {
                    return ['EMAIL', 'GITHUB'];
                }
            }
        }

        function getLinkedMethodsFromUser(user) {
            const methods = user?.availableAuthMethods || [];
            // Normalize to array of strings
            const normalized = Array.isArray(methods) ? methods : [];
            console.log('🔍 User availableAuthMethods:', normalized);
            // Also check primaryAuthMethod
            if (user?.primaryAuthMethod) {
                normalized.push(user.primaryAuthMethod);
            }
            console.log('🔍 All linked methods:', normalized);
            return normalized;
        }

        async function renderAuthMethods(user) {
            const container = document.getElementById('authMethodsContainer');
            if (!container) return;
            
            const allMethods = await fetchAvailableAuthMethods();
            const linked = new Set(getLinkedMethodsFromUser(user));

            const methodTitles = {
                EMAIL: 'Email',
                GITHUB: 'GitHub',
                PHONE_TELEGRAM: 'Telegram OAuth',
                PHONE_WHATSAPP: 'Телефон (WhatsApp)',
                GOSUSLUGI: 'Госуслуги',
                VKONTAKTE: 'ВКонтакте'
            };

            // Показываем только включенные методы
            const shown = allMethods.filter(m => ['EMAIL', 'PHONE_TELEGRAM', 'GITHUB'].includes(m));

            const rows = shown.map(m => {
                const isLinked = linked.has(m);
                const status = isLinked ? '<span class="status-badge active">привязан</span>' : '<span class="status-badge inactive">не привязан</span>';
                const actionBtn = isLinked
                    ? `<button class="btn btn-secondary" data-unbind="${m}">Отвязать</button>`
                    : `<button class="btn btn-primary" data-bind="${m}">Привязать</button>`;
                return `
                    <div class="security-item">
                        <div class="security-info">
                            <h3>${methodTitles[m] || m}</h3>
                            <p>Статус: ${status}</p>
                        </div>
                        <div class="security-action">
                            ${actionBtn}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `<div class="security-settings">${rows || '<p>Нет доступных методов</p>'}</div>`;

            // Bind actions
            container.querySelectorAll('[data-bind]').forEach(btn => {
                btn.addEventListener('click', async () => {
                    await bindAuthMethod(btn.getAttribute('data-bind'));
                });
            });
            container.querySelectorAll('[data-unbind]').forEach(btn => {
                btn.addEventListener('click', async () => {
                    await unbindAuthMethod(btn.getAttribute('data-unbind'));
                });
            });
        }

        async function bindAuthMethod(method) {
            try {
                if (method === 'GITHUB') {
                    // Redirect to GitHub OAuth with bind params
                    const userId = (currentUser && (currentUser.id || currentUser.userId)) || null;
                    const resp = await apiCall(`/api/auth/multi/oauth/github/url?bind=true&userId=${encodeURIComponent(userId || '')}`, { method: 'GET' });
                    if (resp?.url) {
                        window.location.href = resp.url;
                        return;
                    }
                }
                if (method === 'PHONE_TELEGRAM') {
                    const userId = (currentUser && (currentUser.id || currentUser.userId)) || '';
                    window.location.href = `telegram-login.html?bind=true&userId=${encodeURIComponent(userId)}`;
                    return;
                }
                if (method === 'EMAIL') {
                    // Show modal for email binding
                    showBindEmailModal();
                    return;
                }
                // Fallback generic
                await apiCall('/api/auth/multi/bind', {
                    method: 'POST',
                    body: JSON.stringify({ authMethod: method })
                });
                showNotification('Метод привязан', 'success');
                await loadSettings();
            } catch (e) {
                showNotification('Ошибка привязки: ' + e.message, 'error');
            }
        }

        async function unbindAuthMethod(method) {
            try {
                // Проверка количества методов теперь выполняется на backend
                // Frontend просто отправляет запрос, а backend проверит фактически связанные методы
                const response = await apiCall('/api/auth/multi/unbind', {
                    method: 'POST',
                    body: JSON.stringify({ authMethod: method })
                });
                
                if (response?.success) {
                    showNotification('Метод отвязан', 'success');
                    await loadSettings();
                } else {
                    showNotification(response?.error || 'Ошибка отвязки', 'error');
                }
            } catch (e) {
                showNotification('Ошибка отвязки: ' + (e.message || e.error || e), 'error');
            }
        }

        // Загрузка модулей для управления суперадмином
        async function loadModuleControls() {
            try {
                const modules = await apiCall('/api/micro-modules', { method: 'GET' });
                const authModules = modules.filter(m => 
                    m.name === 'email-auth' || 
                    m.name === 'github-auth' || 
                    m.name === 'telegram-auth'
                );
                
                const referralModule = modules.find(m => m.name === 'referral-system');
                
                // Отображаем переключатели для модулей аутентификации
                const moduleTogglesContainer = document.getElementById('moduleTogglesContainer');
                const adminModuleControls = document.getElementById('adminModuleControls');
                
                if (moduleTogglesContainer && adminModuleControls) {
                    const moduleTitles = {
                        'email-auth': 'Email авторизация',
                        'github-auth': 'GitHub авторизация',
                        'telegram-auth': 'Telegram авторизация'
                    };
                    
                    const togglesHtml = authModules.map(module => `
                        <div class="security-item">
                            <div class="security-info">
                                <h3>${moduleTitles[module.name] || module.displayName || module.name}</h3>
                                <p>${module.description || ''}</p>
                                ${module.isSystem ? '<small style="color: #f59e0b;">(Системный модуль - отключение может привести к проблемам)</small>' : ''}
                            </div>
                            <div class="security-action">
                                <label class="switch">
                                    <input type="checkbox" 
                                           id="moduleToggle_${module.name}" 
                                           ${module.isEnabled ? 'checked' : ''}
                                           data-module-name="${module.name}">
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>
                    `).join('');
                    
                    moduleTogglesContainer.innerHTML = togglesHtml || '<p>Нет доступных модулей</p>';
                    adminModuleControls.style.display = 'block';
                    
                    // Привязываем обработчики
                    authModules.forEach(module => {
                        const toggle = document.getElementById(`moduleToggle_${module.name}`);
                        if (toggle) {
                            // Удаляем старый обработчик, если есть
                            const newToggle = toggle.cloneNode(true);
                            toggle.parentNode.replaceChild(newToggle, toggle);
                            
                            // Добавляем новый обработчик
                            newToggle.addEventListener('change', async (e) => {
                                if (module.isSystem && !e.target.checked) {
                                    if (!confirm('Вы уверены, что хотите отключить системный модуль? Это может привести к проблемам с работой системы.')) {
                                        e.target.checked = true;
                                        return;
                                    }
                                }
                                await toggleModule(module.name, e.target.checked);
                            });
                        }
                    });
                }
                
                // Отображаем переключатель для реферальной системы
                const referralModuleControl = document.getElementById('referralModuleControl');
                const referralCard = document.getElementById('referralCard');
                
                if (referralModuleControl && referralModule) {
                    const referralSystemToggle = document.getElementById('referralSystemToggle');
                    
                    if (referralSystemToggle) {
                        referralSystemToggle.checked = referralModule.isEnabled || false;
                        referralModuleControl.style.display = 'block';
                        
                        // Скрываем всю карточку реферальных ссылок, если модуль отключен
                        if (referralCard) {
                            if (referralModule.isEnabled === false) {
                                referralCard.style.display = 'none';
                                referralCard.style.visibility = 'hidden';
                                referralCard.setAttribute('data-hidden-by-module', 'true');
                            } else {
                                referralCard.style.display = '';
                                referralCard.style.visibility = '';
                                referralCard.removeAttribute('data-hidden-by-module');
                            }
                        }
                        
                        // Удаляем старый обработчик, если есть
                        const newToggle = referralSystemToggle.cloneNode(true);
                        referralSystemToggle.parentNode.replaceChild(newToggle, referralSystemToggle);
                        
                        // Добавляем новый обработчик
                        newToggle.addEventListener('change', async (e) => {
                            await toggleModule('referral-system', e.target.checked);
                        });
                    }
                } else if (referralModuleControl && !referralModule) {
                    // Модуль не найден, скрываем переключатель и карточку
                    referralModuleControl.style.display = 'none';
                    if (referralCard) {
                        referralCard.style.display = 'none';
                    }
                } else if (referralCard && !referralModule) {
                    // Если модуль не найден и нет переключателя, просто скрываем карточку
                    referralCard.style.display = 'none';
                }
            } catch (error) {
                console.error('Ошибка загрузки модулей:', error);
            }
        }

        // Проверка статуса модулей и скрытие элементов
        async function checkModuleStatusAndHide() {
            try {
                const modules = await apiCall('/api/micro-modules', { method: 'GET' });
                const referralModule = modules.find(m => m.name === 'referral-system');
                const referralCard = document.getElementById('referralCard');
                
                if (referralCard && referralModule) {
                    if (referralModule.isEnabled === false) {
                        referralCard.style.display = 'none';
                        referralCard.style.visibility = 'hidden';
                        referralCard.setAttribute('data-hidden-by-module', 'true');
                    } else {
                        referralCard.style.display = '';
                        referralCard.style.visibility = '';
                        referralCard.removeAttribute('data-hidden-by-module');
                    }
                }
            } catch (error) {
                console.error('Ошибка проверки статуса модулей:', error);
            }
        }

        // Переключение модуля
        async function toggleModule(moduleName, enable) {
            try {
                const action = enable ? 'enable' : 'disable';
                
                // Показываем индикатор загрузки на переключателе
                const toggle = document.getElementById(`moduleToggle_${moduleName}`);
                const referralToggle = document.getElementById('referralSystemToggle');
                const targetToggle = toggle || (moduleName === 'referral-system' ? referralToggle : null);
                
                if (targetToggle) {
                    targetToggle.disabled = true;
                }
                
                const response = await apiCall(`/api/micro-modules/${moduleName}/${action}`, {
                    method: 'POST'
                });
                
                if (response?.success) {
                    showNotification(response.message || `Модуль ${moduleName} ${enable ? 'включен' : 'отключен'}`, 'success');
                    
                    // Скрываем/показываем элементы в зависимости от состояния модуля
                    if (moduleName === 'referral-system') {
                        const referralCard = document.getElementById('referralCard');
                        if (referralCard) {
                            if (enable === false) {
                                referralCard.style.display = 'none';
                                referralCard.style.visibility = 'hidden';
                                referralCard.setAttribute('data-hidden-by-module', 'true');
                            } else {
                                referralCard.style.display = '';
                                referralCard.style.visibility = '';
                                referralCard.removeAttribute('data-hidden-by-module');
                            }
                        }
                    }
                    
                    // Обновляем UI
                    await loadModuleControls();
                    
                    // Если это модуль аутентификации, обновляем список методов
                    if (moduleName.includes('auth')) {
                        await loadSettings();
                    }
                } else {
                    throw new Error(response.message || 'Ошибка переключения модуля');
                }
            } catch (error) {
                console.error('Ошибка переключения модуля:', error);
                showNotification('Ошибка переключения модуля: ' + error.message, 'error');
                
                // Обновляем UI, чтобы вернуть состояние переключателя
                await loadModuleControls();
            }
        }

        // Реферальные ссылки
        window.generateReferralLink = async function generateReferralLink(event) {
            try {
                // Лимиты убраны - просто создаем ссылку без ограничений
                const button = event?.target?.closest('button') || document.querySelector('button[id="generateReferralLinkBtn"]');
                const originalText = button?.innerHTML;
                if (button) {
                    button.disabled = true;
                    button.innerHTML = '<span class="loading"></span> Создание...';
                }

                const response = await apiCall('/api/auth/referrals/generate', {
                    method: 'POST',
                    body: JSON.stringify({})
                });

                if (response?.success && response?.referral) {
                    showNotification('Реферальная ссылка успешно создана', 'success');
                    // Загружаем список ссылок
                    await loadReferralLinks();
                } else {
                    showNotification('Ошибка создания ссылки', 'error');
                }
            } catch (e) {
                showNotification('Ошибка создания реферальной ссылки: ' + e.message, 'error');
            } finally {
                const button = event?.target?.closest('button') || document.querySelector('button[onclick*="generateReferralLink"]');
                if (button) {
                    button.disabled = false;
                    button.innerHTML = '<i class="fas fa-link"></i> Создать реферальную ссылку';
                }
            }
        }

        async function loadReferralLinks() {
            try {
                const container = document.getElementById('referralLinksContainer');
                if (!container) return;

                container.innerHTML = '<div class="loading-placeholder">Загрузка ссылок...</div>';

                const response = await apiCall('/api/auth/referrals/my-codes', { method: 'GET' });

                if (response?.success && response?.codes) {
                    const links = response.codes;
                    
                    if (links.length === 0) {
                        container.innerHTML = '<p class="text-muted">У вас пока нет реферальных ссылок</p>';
                        return;
                    }

                    const linksHtml = links.map(link => {
                        const expiresAt = link.expiresAt ? new Date(link.expiresAt).toLocaleDateString('ru-RU') : 'Не ограничено';
                        const usageInfo = link.usageLimit ? `${link.usageCount || 0}/${link.usageLimit}` : `${link.usageCount || 0} использований`;
                        const isExpired = link.expiresAt && new Date(link.expiresAt) < new Date();
                        const isUsedUp = link.usageLimit && (link.usageCount || 0) >= link.usageLimit;

                        return `
                            <div class="referral-link-item" style="padding: 1rem; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 0.75rem; background: ${isExpired || isUsedUp ? '#fef2f2' : '#f8fafc'};">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; margin-bottom: 0.25rem; word-break: break-all;">
                                            <a href="${link.link}" target="_blank" style="color: #667eea; text-decoration: none;">${link.link}</a>
                                        </div>
                                        <div style="font-size: 0.875rem; color: #64748b;">
                                            <div>Код: <code style="background: #e2e8f0; padding: 0.125rem 0.375rem; border-radius: 4px;">${link.code}</code></div>
                                            <div>Истекает: ${expiresAt}</div>
                                            <div>Использований: ${usageInfo}</div>
                                            ${isExpired ? '<span style="color: #ef4444;">Истекла</span>' : ''}
                                            ${isUsedUp ? '<span style="color: #ef4444;">Исчерпана</span>' : ''}
                                        </div>
                                    </div>
                                    <button onclick="copyReferralLink('${link.link}')" class="btn btn-sm btn-secondary" style="margin-left: 0.5rem;">
                                        <i class="fas fa-copy"></i> Копировать
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');

                    container.innerHTML = linksHtml;
                } else {
                    container.innerHTML = '<p class="text-muted">Ошибка загрузки ссылок</p>';
                }
            } catch (e) {
                const container = document.getElementById('referralLinksContainer');
                if (container) {
                    container.innerHTML = '<p class="text-muted">Ошибка загрузки ссылок: ' + e.message + '</p>';
                }
            }
        }

        function copyReferralLink(link) {
            navigator.clipboard.writeText(link).then(() => {
                showNotification('Ссылка скопирована в буфер обмена', 'success');
            }).catch(err => {
                console.error('Ошибка копирования:', err);
                showNotification('Ошибка копирования ссылки', 'error');
            });
        }

        // Load and render nFA methods
        async function loadNfaSettings(user) {
            try {
                const container = document.getElementById('nfaMethodsContainer');
                if (!container) return;
                
                // Получаем доступные методы пользователя
                const linkedMethods = getLinkedMethodsFromUser(user);
                
                // Убираем дубликаты, используя Set
                const uniqueMethods = [...new Set(linkedMethods)];
                
                // Получаем текущие настройки nFA
                console.log('🔍 [loadNfaSettings] User object:', user);
                console.log('🔍 [loadNfaSettings] user.mfaSettings:', user?.mfaSettings);
                const currentNfaMethods = user?.mfaSettings?.methods || [];
                const nfaEnabled = user?.mfaSettings?.enabled || false;
                console.log('🔍 [loadNfaSettings] currentNfaMethods:', currentNfaMethods);
                console.log('🔍 [loadNfaSettings] nfaEnabled:', nfaEnabled);
                
                const methodTitles = {
                    EMAIL: 'Email',
                    PHONE_TELEGRAM: 'Telegram',
                    GITHUB: 'GitHub'
                };
                
                // Показываем только привязанные методы (без дубликатов)
                const html = uniqueMethods
                    .filter(method => ['EMAIL', 'PHONE_TELEGRAM', 'GITHUB'].includes(method))
                    .map(method => {
                        const isSelected = currentNfaMethods.includes(method);
                        return `
                            <div class="security-item" style="margin-bottom: 0.75rem;">
                                <div class="security-info">
                                    <h3 style="margin: 0; font-size: 0.95rem;">${methodTitles[method] || method}</h3>
                                </div>
                                <div class="security-action">
                                    <label class="switch">
                                        <input type="checkbox" class="nfa-method-checkbox" data-method="${method}" ${isSelected ? 'checked' : ''}>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>
                        `;
                    }).join('');
                
                if (html) {
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<p style="color: #6b7280; font-size: 0.9rem;">Для использования nFA необходимо привязать хотя бы один способ входа</p>';
                }
                
            } catch (error) {
                console.error('Ошибка загрузки настроек nFA:', error);
            }
        }
        
        // Save nFA settings
        async function saveNfaSettings() {
            try {
                const checkboxes = document.querySelectorAll('.nfa-method-checkbox');
                const selectedMethods = Array.from(checkboxes)
                    .filter(cb => cb.checked)
                    .map(cb => cb.getAttribute('data-method'));
                
                if (selectedMethods.length === 0) {
                    // Если ничего не выбрано, отключаем nFA через пустой массив
                    await apiCall('/api/auth/nfa/configure', {
                        method: 'POST',
                        body: JSON.stringify({ methods: [] })
                    });
                    showNotification('nFA отключена', 'success');
                } else {
                    await apiCall('/api/auth/nfa/configure', {
                        method: 'POST',
                        body: JSON.stringify({ 
                            methods: selectedMethods,
                            requiredMethods: selectedMethods.length // Требуем подтверждения всех выбранных методов
                        })
                    });
                    showNotification(`nFA настроена: выбрано методов - ${selectedMethods.length}`, 'success');
                }
                
                // Перезагружаем настройки пользователя
                await loadCurrentUser();
                
            } catch (error) {
                console.error('Ошибка сохранения настроек nFA:', error);
                showNotification('Ошибка сохранения настроек nFA: ' + (error.message || 'Неизвестная ошибка'), 'error');
            }
        }
        
        // Update security setting (legacy, kept for backward compatibility)
        async function updateSecuritySetting(setting, value) {
            try {
                if (setting === 'twoFactorEnabled') {
                    if (value) {
                        // Enable 2FA
                        await apiCall('/api/two-factor-settings/enable', {
                    method: 'POST',
                            body: JSON.stringify({ methods: ['email'] })
                        });
                        showNotification('2FA включен', 'success');
                } else {
                        // Disable 2FA
                        await apiCall('/api/two-factor-settings/disable', {
                            method: 'POST'
                        });
                        showNotification('2FA отключен', 'success');
                    }
                    } else {
                    // For other settings, use the general endpoint
                    await apiCall('/api/users/me', {
                        method: 'PATCH',
                        body: JSON.stringify({ [setting]: value })
                    });
                    showNotification('Настройка обновлена', 'success');
                }
            } catch (error) {
                console.error('Ошибка обновления настройки:', error);
                showNotification('Ошибка обновления настройки: ' + error.message, 'error');
            }
        }

        // Hide admin-only sections for viewer role (keep Settings visible)
        function hideAdminOnlySections() {
            // Hide admin panel link
            const adminPanelLink = document.getElementById('adminPanelLink');
            if (adminPanelLink) {
                adminPanelLink.style.display = 'none';
            }
            
            // Hide user management sections (Сотрудники)
            const userManagementSection = document.querySelector('.section[data-section="users"]');
            if (userManagementSection) {
                userManagementSection.style.display = 'none';
            }
            
            // Hide organization management sections
            const orgManagementSection = document.querySelector('.section[data-section="organizations"]');
            if (orgManagementSection) {
                orgManagementSection.style.display = 'none';
            }
            
            // Hide team management sections
            const teamManagementSection = document.querySelector('.section[data-section="teams"]');
            if (teamManagementSection) {
                teamManagementSection.style.display = 'none';
            }
            
            // Keep invitation sections visible for viewer
            // const invitationSection = document.querySelector('.section[data-section="invitations"]');
            // if (invitationSection) {
            //     invitationSection.style.display = 'none';
            // }
            
            // Keep Settings visible for viewer
            // Do not hide settings section for viewer role
            
            // Update navigation to hide admin-only links, but keep invitations for viewer
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes('пользователи') || 
                    text.includes('организации') || 
                    text.includes('команды')) {
                    item.style.display = 'none';
                }
                // Keep invitations visible for viewer
                if (text.includes('приглашения')) {
                    item.style.display = 'flex';
                    }
                });
            }
            
        // Open admin panel
        function openAdminPanel() {
            // Перенаправляем на страницу микромодулей для админов
            window.location.href = '/test-micro-modules.html';
        }
    </script>
</body>
</html>



