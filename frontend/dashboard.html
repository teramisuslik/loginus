<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loginus - –î–∞—à–±–æ—Ä–¥</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8fafc;
            color: #1a202c;
            line-height: 1.6;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            position: fixed;
            height: 100vh;
            left: 0;
            top: 0;
            z-index: 1000;
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .sidebar-header {
            padding: 2rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo {
            font-size: 1.8rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(45deg, #ff6b6b, #ffa500);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .sidebar-nav {
            padding: 1rem 0;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: all 0.3s ease;
            position: relative;
            margin: 0.25rem 1rem;
            border-radius: 12px;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            transform: translateX(4px);
        }

        .nav-item.active {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .nav-item.active::before {
            content: '';
            position: absolute;
            left: -1rem;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 24px;
            background: #ff6b6b;
            border-radius: 2px;
        }

        .nav-icon {
            width: 24px;
            height: 24px;
            margin-right: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .user-info {
            padding: 1rem 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: auto;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff6b6b, #ffa500);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .user-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .user-role {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .logout-btn {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.8);
            cursor: pointer;
            font-size: 0.9rem;
            margin-top: 0.5rem;
            padding: 0.5rem;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        /* Main Content */
        .main-content {
            margin-left: 280px;
            flex: 1;
            background: #f8fafc;
            min-height: 100vh;
        }

        .content-header {
            background: white;
            padding: 2rem;
            border-bottom: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .page-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: #1a202c;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .notification-btn {
            position: relative;
            background: none;
            border: none;
            color: #64748b;
            cursor: pointer;
            padding: 0.75rem;
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .notification-btn:hover {
            background: #f1f5f9;
            color: #374151;
        }

        .notification-badge {
            position: absolute;
            top: 0.25rem;
            right: 0.25rem;
            width: 8px;
            height: 8px;
            background: #ef4444;
            border-radius: 50%;
        }

        .content-body {
            padding: 2rem;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
            margin-bottom: 2rem;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1a202c;
        }

        /* Statistics */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid #e2e8f0;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .stat-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            font-size: 1.5rem;
            color: white;
        }

        .stat-icon.users {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .stat-icon.security {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .stat-icon.invitations {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .stat-icon.articles {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        }

        .stat-value {
            font-size: 3rem;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #64748b;
            font-size: 1rem;
            font-weight: 500;
        }

        /* Tables */
        .table-container {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid #e2e8f0;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th {
            background: #f8fafc;
            padding: 1.5rem 2rem;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e2e8f0;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .table td {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid #f1f5f9;
            vertical-align: top;
        }

        .table tbody tr:hover {
            background: #f8fafc;
        }

        .user-info {
            display: flex;
            align-items: center;
        }

        .user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            margin-right: 1rem;
            font-size: 1.2rem;
        }

        .user-details h4 {
            font-weight: 600;
            color: #1a202c;
            margin-bottom: 0.25rem;
        }

        .user-details p {
            color: #64748b;
            font-size: 0.9rem;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .status-badge.active {
            background: #d1fae5;
            color: #065f46;
        }

        .status-badge.pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-badge.inactive {
            background: #fee2e2;
            color: #991b1b;
        }

        .role-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            background: #e0e7ff;
            color: #3730a3;
            margin-right: 0.5rem;
            margin-bottom: 0.25rem;
        }

        .role-badge.team-role {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        .role-badge.org-role {
            background: #f3e8ff;
            color: #7c3aed;
            border: 1px solid #c4b5fd;
        }

        .team-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
            margin-right: 0.5rem;
            margin-bottom: 0.25rem;
        }

        .org-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            background: #f3e8ff;
            color: #7c3aed;
            border: 1px solid #c4b5fd;
            margin-right: 0.5rem;
            margin-bottom: 0.25rem;
        }

        .member-details {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #f1f5f9;
            color: #64748b;
            border: 1px solid #e2e8f0;
        }

        .btn-secondary:hover {
            background: #e2e8f0;
            color: #374151;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        .btn:disabled:hover {
            transform: none !important;
            box-shadow: none !important;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid #e2e8f0;
        }

        .tab {
            padding: 1rem 2rem;
            background: none;
            border: none;
            color: #64748b;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            border-radius: 8px 8px 0 0;
        }

        .tab:hover {
            color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .tab.active {
            color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 2px;
        }

        /* Search */
        .search-container {
            position: relative;
            margin-bottom: 2rem;
        }

        .search-input {
            width: 100%;
            padding: 1rem 1rem 1rem 3rem;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #64748b;
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            border-left: 4px solid #10b981;
            z-index: 10000;
            max-width: 400px;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            border-left-color: #10b981;
        }

        .notification.error {
            border-left-color: #ef4444;
        }

        .notification.warning {
            border-left-color: #f59e0b;
        }

        /* Hidden sections */
        .section {
            display: none;
        }

        .section.active {
            display: block;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .table-container {
                overflow-x: auto;
            }
        }

        /* Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in-up {
            animation: fadeInUp 0.6s ease-out;
        }

        /* Settings Form Styles */
        .settings-form {
            max-width: 600px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #374151;
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group input[readonly] {
            background-color: #f9fafb;
            color: #6b7280;
        }

        .input-group {
            display: flex;
            gap: 0.5rem;
        }

        .input-group input {
            flex: 1;
        }

        .btn-outline {
            background: transparent;
            color: #667eea;
            border: 2px solid #667eea;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        .btn-outline:hover {
            background: #667eea;
            color: white;
        }

        .text-muted {
            color: #6b7280;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid #e5e7eb;
        }

        .security-settings {
            margin-top: 1rem;
        }

        .security-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .security-item:last-child {
            border-bottom: none;
        }

        .security-info h3 {
            margin: 0 0 0.25rem 0;
            font-size: 1rem;
            font-weight: 600;
            color: #374151;
        }

        .security-info p {
            margin: 0;
            font-size: 0.875rem;
            color: #6b7280;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #667eea;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background-color: #f3f4f6;
            color: #374151;
        }

        .modal form {
            padding: 1.5rem;
        }

        .modal .form-group {
            margin-bottom: 1rem;
        }

        .modal .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }

        .modal .form-group input,
        .modal .form-group textarea,
        .modal .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s ease;
        }

        .modal .form-group input:focus,
        .modal .form-group textarea:focus,
        .modal .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .modal .form-group small {
            display: block;
            margin-top: 0.25rem;
            color: #6b7280;
            font-size: 0.875rem;
        }

        .modal .form-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">
                        <i class="fas fa-brain"></i>
                    </div>
                    <div>Loginus</div>
                </div>
            </div>
            <div class="sidebar-nav">
                <a href="#" class="nav-item active" data-section="dashboard">
                    <div class="nav-icon">
                        <i class="fas fa-chart-pie"></i>
                    </div>
                    –î–∞—à–±–æ—Ä–¥
                </a>
                <!-- <a href="#" class="nav-item" data-section="knowledge">
                    <div class="nav-icon">
                        <i class="fas fa-book"></i>
                    </div>
                    –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π
                </a> -->
                <a href="#" class="nav-item" data-section="users">
                    <div class="nav-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏
                </a>
                <a href="#" class="nav-item" data-section="teams">
                    <div class="nav-icon">
                        <i class="fas fa-user-friends"></i>
                    </div>
                    –ö–æ–º–∞–Ω–¥—ã
                </a>
                <a href="#" class="nav-item" data-section="organizations">
                    <div class="nav-icon">
                        <i class="fas fa-building"></i>
                    </div>
                    –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
                </a>
                <!-- <a href="#" class="nav-item" data-section="support">
                    <div class="nav-icon">
                        <i class="fas fa-headset"></i>
                    </div>
                    –ü–æ–¥–¥–µ—Ä–∂–∫–∞
                </a> -->
                <!-- <a href="#" class="nav-item" data-section="statistics">
                    <div class="nav-icon">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                    –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                </a> -->
                <a href="#" class="nav-item" data-section="invitations" onclick="showSection('invitations'); return false;">
                    <div class="nav-icon">
                        <i class="fas fa-envelope"></i>
                    </div>
                    –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è
                </a>
                <a href="#" class="nav-item" data-section="settings">
                    <div class="nav-icon">
                        <i class="fas fa-cog"></i>
                    </div>
                    –ù–∞—Å—Ç—Ä–æ–π–∫–∏
                </a>
                <!-- Admin panel removed for regular admin users -->
            </div>
            
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="user-name" id="userName">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                <div class="user-role" id="userRole">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    –í—ã–π—Ç–∏
                </button>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <div class="content-header">
                <h1 class="page-title">–î–∞—à–±–æ—Ä–¥</h1>
                <div class="header-actions">
                    <button class="notification-btn" onclick="showNotifications()">
                        <i class="fas fa-bell"></i>
                        <div class="notification-badge" id="notificationBadge"></div>
                    </button>
                </div>
            </div>

            <div class="content-body">
                <!-- Dashboard Section -->
                <div id="dashboard" class="section active">
                    <!-- Statistics Cards -->
                    <div class="stats-grid">
                        <div class="stat-card fade-in-up">
                            <div class="stat-header">
                                <div class="stat-icon users">
                                    <i class="fas fa-users"></i>
                                </div>
                                <div>
                                    <div class="stat-value" id="totalUsers">0</div>
                                        <div class="stat-label" id="totalUsersLabel">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –≤ —Å–∏—Å—Ç–µ–º–µ</div>
                                </div>
                            </div>
                        </div>

                        <div class="stat-card fade-in-up">
                            <div class="stat-header">
                                <div class="stat-icon security">
                                    <i class="fas fa-shield-alt"></i>
                                </div>
                                <div>
                                    <div class="stat-value" id="activeUsers">0</div>
                                    <div class="stat-label" id="activeUsersLabel">–ê–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                                </div>
                            </div>
                        </div>

                        <div class="stat-card fade-in-up">
                            <div class="stat-header">
                                <div class="stat-icon invitations">
                                    <i class="fas fa-envelope"></i>
                                </div>
                                <div>
                                    <div class="stat-value" id="invitationsCount">0</div>
                                    <div class="stat-label" id="invitationsLabel">–û–∂–∏–¥–∞—é—â–∏—Ö –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π</div>
                                </div>
                            </div>
                        </div>

                        <div class="stat-card fade-in-up">
                            <div class="stat-header">
                                <div class="stat-icon articles">
                                    <i class="fas fa-book"></i>
                                </div>
                                <div>
                                    <div class="stat-value" id="articles">0</div>
                                    <div class="stat-label" id="articlesLabel">–°—Ç–∞—Ç–µ–π –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    

                    <!-- Recent Activity -->
                    <div class="card fade-in-up">
                        <div class="card-header">
                            <h2 class="card-title">–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h2>
                        </div>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                                        <th>–î–µ–π—Å—Ç–≤–∏–µ</th>
                                        <th>–í—Ä–µ–º—è</th>
                                        <th>–°—Ç–∞—Ç—É—Å</th>
                                    </tr>
                                </thead>
                                <tbody id="recentActivityBody">
                                    <tr>
                                        <td>
                                            <div class="user-info">
                                                <div class="user-avatar">A</div>
                                                <div class="user-details">
                                                    <h4>–ê–¥–º–∏–Ω –°–∏—Å—Ç–µ–º—ã</h4>
                                                    <p>admin@loginus.ru</p>
                                                </div>
                                            </div>
                                        </td>
                                        <td>–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</td>
                                        <td>–¢–æ–ª—å–∫–æ —á—Ç–æ</td>
                                        <td><span class="status-badge active">–£—Å–ø–µ—à–Ω–æ</span></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Users Section -->
                <div id="users" class="section">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</h2>
                            <button class="btn btn-primary" onclick="showInviteModal()">
                                <i class="fas fa-user-plus"></i>
                                –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
                            </button>
                        </div>
                        
                        <div class="tabs">
                            <button class="tab active" onclick="switchUserTab('active')">–ê–∫—Ç–∏–≤–Ω—ã–µ</button>
                            <button class="tab" onclick="switchUserTab('invited')">–ü—Ä–∏–≥–ª–∞—à–µ–Ω–Ω—ã–µ</button>
                        </div>

                        <div class="search-container">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" class="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏, email, —Ä–æ–ª–∏..." id="userSearch">
                        </div>

                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
                                        <th>–†–æ–ª—å</th>
                                        <th>–ö–æ–º–∞–Ω–¥–∞</th>
                                        <th>–°—Ç–∞—Ç—É—Å</th>
                                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                    <!-- Users will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Teams Section -->
                <div id="teams" class="section">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">–ö–æ–º–∞–Ω–¥—ã</h2>
                            <button class="btn btn-primary" onclick="showCreateTeamModal()">
                                <i class="fas fa-plus"></i>
                                –°–æ–∑–¥–∞—Ç—å –∫–æ–º–∞–Ω–¥—É
                            </button>
                        </div>
                        
                        <div class="search-container">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" class="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∫–æ–º–∞–Ω–¥—ã..." id="teamSearch">
                        </div>

                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>–ö–æ–º–∞–Ω–¥–∞</th>
                                        <th>–£—á–∞—Å—Ç–Ω–∏–∫–∏</th>
                                        <th>–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å</th>
                                        <th>–°–æ–∑–¥–∞–Ω–∞</th>
                                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                    </tr>
                                </thead>
                                <tbody id="teamsTableBody">
                                    <!-- Teams will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Organizations Section -->
                <div id="organizations" class="section">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏</h2>
                            <button class="btn btn-primary" onclick="showCreateOrgModal()">
                                <i class="fas fa-plus"></i>
                                –°–æ–∑–¥–∞—Ç—å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é
                            </button>
                        </div>
                        
                        <div class="search-container">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" class="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏..." id="orgSearch">
                        </div>

                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è</th>
                                        <th>–ö–æ–º–∞–Ω–¥—ã</th>
                                        <th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</th>
                                        <th>–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å</th>
                                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                    </tr>
                                </thead>
                                <tbody id="organizationsTableBody">
                                    <!-- Organizations will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Statistics Section -->
                <div id="statistics" class="section">
                    <div class="card">
                        <h2 class="card-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã</h2>
                        
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-header">
                                    <div class="stat-icon users">
                                        <i class="fas fa-users"></i>
                                    </div>
                                    <div>
                                        <div class="stat-value" id="statsTotalUsers">0</div>
                                        <div class="stat-label">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                                    </div>
                                </div>
                            </div>

                            <div class="stat-card">
                                <div class="stat-header">
                                    <div class="stat-icon security">
                                        <i class="fas fa-shield-alt"></i>
                                    </div>
                                    <div>
                                        <div class="stat-value" id="statsActiveUsers">0</div>
                                        <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π</div>
                                    </div>
                                </div>
                            </div>

                            <div class="stat-card">
                                <div class="stat-header">
                                    <div class="stat-icon invitations">
                                        <i class="fas fa-envelope"></i>
                                    </div>
                                    <div>
                                        <div class="stat-value" id="statsInvitations">0</div>
                                        <div class="stat-label">–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</div>
                                    </div>
                                </div>
                            </div>

                            <div class="stat-card">
                                <div class="stat-header">
                                    <div class="stat-icon articles">
                                        <i class="fas fa-book"></i>
                                    </div>
                                    <div>
                                        <div class="stat-value" id="statsArticles">0</div>
                                        <div class="stat-label">–°—Ç–∞—Ç–µ–π –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π</div>
                                    </div>
                                </div>
                            </div>

                            <div class="stat-card">
                                <div class="stat-header">
                                    <div class="stat-icon" style="background: linear-gradient(135deg, #06b6d4, #0891b2);">
                                        <i class="fas fa-headset"></i>
                                    </div>
                                    <div>
                                        <div class="stat-value" id="statsTickets">0</div>
                                        <div class="stat-label">–¢–∏–∫–µ—Ç–æ–≤ –ø–æ–¥–¥–µ—Ä–∂–∫–∏</div>
                                    </div>
                                </div>
                            </div>

                            <div class="stat-card">
                                <div class="stat-header">
                                    <div class="stat-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                                        <i class="fas fa-clock"></i>
                                    </div>
                                    <div>
                                        <div class="stat-value" id="statsAvgResponse">0—á</div>
                                        <div class="stat-label">–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Other sections -->
                <div id="knowledge" class="section">
                    <div class="card">
                        <h2 class="card-title">–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π</h2>
                        <p>–†–∞–∑–¥–µ–ª –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π –±—É–¥–µ—Ç –∑–¥–µ—Å—å...</p>
                    </div>
                </div>

                <div id="support" class="section">
                    <div class="card">
                        <h2 class="card-title">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</h2>
                        <p>–†–∞–∑–¥–µ–ª –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –±—É–¥–µ—Ç –∑–¥–µ—Å—å...</p>
                    </div>
                </div>


                <div id="invitations" class="section">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è</h2>
                            <button class="btn btn-primary" onclick="refreshInvitations()">
                                <i class="fas fa-sync-alt"></i>
                                –û–±–Ω–æ–≤–∏—Ç—å
                            </button>
                        </div>
                        
                        <div id="invitationsContainer">
                            <div class="loading-placeholder">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π...</div>
                        </div>
                    </div>
                </div>

                <div id="settings" class="section">
                    <div class="card">
                        <h2 class="card-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è</h2>
                        <form id="settingsForm" class="settings-form">
                            <div class="form-group">
                                <label for="firstName">–ò–º—è</label>
                                <input type="text" id="firstName" name="firstName" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è">
                            </div>
                            
                            <div class="form-group">
                                <label for="lastName">–§–∞–º–∏–ª–∏—è</label>
                                <input type="text" id="lastName" name="lastName" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à—É —Ñ–∞–º–∏–ª–∏—é">
                            </div>
                            
                            <div class="form-group">
                                <label for="email">Email</label>
                                <div class="input-group">
                                    <input type="email" id="email" name="email" readonly>
                                    <button type="button" id="verifyEmailBtn" class="btn btn-outline">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
                                </div>
                                <small class="text-muted" id="emailStatus">Email –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω</small>
                            </div>
                            
                            <div class="form-group" id="githubInfoGroup" style="display: none;">
                                <label>GitHub –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</label>
                                <div style="background: #f3f4f6; padding: 0.75rem; border-radius: 6px; margin-top: 0.5rem;">
                                    <div style="margin-bottom: 0.5rem;">
                                        <strong>GitHub Username:</strong> <span id="displayGithubUsername" style="font-family: monospace; background: white; padding: 0.25rem 0.5rem; border-radius: 4px;">-</span>
                                        <button type="button" onclick="copyToClipboard(document.getElementById('displayGithubUsername').textContent)" style="margin-left: 0.5rem; padding: 0.25rem 0.5rem; font-size: 0.85rem; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                            <i class="fas fa-copy"></i> –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                                        </button>
                                    </div>
                                    <div style="margin-bottom: 0.5rem;">
                                        <strong>GitHub ID:</strong> <span id="displayGithubId" style="font-family: monospace; background: white; padding: 0.25rem 0.5rem; border-radius: 4px;">-</span>
                                        <small class="text-muted" style="margin-left: 0.5rem;">(—Ç–æ–ª—å–∫–æ –¥–ª—è —Å–ø—Ä–∞–≤–∫–∏)</small>
                                    </div>
                                    <small class="text-muted" style="display: block; margin-top: 0.5rem;">
                                        üí° –í–∞—à GitHub username –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –°–∏—Å—Ç–µ–º–∞ –∏—â–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å—Ç—Ä–æ–≥–æ –ø–æ –ø–æ–ª—é GitHub username –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.
                                    </small>
                                </div>
                            </div>
                            
                            
                            
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                                <button type="button" id="cancelSettings" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</button>
                            </div>
                        </form>
                    </div>
                    
                    <div class="card">
                        <h2 class="card-title">–°–ø–æ—Å–æ–±—ã –≤—Ö–æ–¥–∞</h2>
                        <div id="authMethodsContainer">
                            <div class="loading-placeholder">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–æ—Å–æ–±–æ–≤ –≤—Ö–æ–¥–∞...</div>
                        </div>
                        <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥—É–ª—è–º–∏ –¥–ª—è super_admin -->
                        <div id="adminModuleControls" style="display: none; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #e5e7eb;">
                            <h3 style="margin-bottom: 1rem; font-size: 1.125rem; font-weight: 600;">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ø–æ—Å–æ–±–∞–º–∏ –≤—Ö–æ–¥–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω–∞)</h3>
                            <div id="moduleTogglesContainer">
                                <div class="loading-placeholder">–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥—É–ª–µ–π...</div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <h2 class="card-title">–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å</h2>
                        <div class="security-settings">
                            <div class="security-item">
                                <div class="security-info">
                                    <h3>nFA (–ú–Ω–æ–≥–æ—Ñ–∞–∫—Ç–æ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è)</h3>
                                    <p>–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Ç–æ–¥—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø—Ä–∏ –≤—Ö–æ–¥–µ. –ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –ª—é–±–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑ –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö —Å–ø–æ—Å–æ–±–æ–≤ –≤—Ö–æ–¥–∞.</p>
                                </div>
                            </div>
                            
                            <div id="nfaMethodsContainer" style="margin-top: 1rem;">
                                <!-- –ß–µ–∫–±–æ–∫—Å—ã –¥–ª—è –º–µ—Ç–æ–¥–æ–≤ nFA –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                            </div>
                            
                            <div style="margin-top: 1rem;">
                                <button type="button" class="btn btn-primary" id="saveNfaSettingsBtn">
                                    <i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ nFA
                                </button>
                            </div>
                            
                        </div>
                    </div>

                    <div class="card" id="referralCard">
                        <h2 class="card-title">–†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏</h2>
                        <div class="referral-settings">
                            <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π –¥–ª—è super_admin -->
                            <div id="referralModuleControl" style="display: none; margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid #e5e7eb;">
                                <div class="security-item">
                                    <div class="security-info">
                                        <h3>–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞</h3>
                                        <p>–í–∫–ª—é—á–∏—Ç—å/–æ—Ç–∫–ª—é—á–∏—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å–∏—Å—Ç–µ–º—É</p>
                                    </div>
                                    <div class="security-action">
                                        <label class="switch">
                                            <input type="checkbox" id="referralSystemToggle">
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-actions">
                                <button type="button" class="btn btn-primary" id="generateReferralLinkBtn">
                                    <i class="fas fa-link"></i>
                                    –°–æ–∑–¥–∞—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É
                                </button>
                            </div>
                            
                            <div id="referralLinksList" style="margin-top: 1.5rem;">
                                <h3 style="margin-bottom: 1rem;">–ú–æ–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏</h3>
                                <div id="referralLinksContainer">
                                    <div class="loading-placeholder">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Å—ã–ª–æ–∫...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer"></div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ -->
    <div id="createOrgModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–°–æ–∑–¥–∞—Ç—å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é</h2>
                <button class="modal-close" onclick="closeCreateOrgModal()">&times;</button>
            </div>
            <form id="createOrgForm" method="POST">
                <div class="form-group">
                    <label for="orgName">–ù–∞–∑–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ *</label>
                    <input type="text" id="orgName" name="name" required placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏">
                </div>
                <div class="form-group">
                    <label for="orgDescription">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea id="orgDescription" name="description" rows="3" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"></textarea>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" id="createOrgBtn">
                        <span id="createOrgText">–°–æ–∑–¥–∞—Ç—å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é</span>
                        <span id="createOrgLoading" class="loading hidden"></span>
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeCreateOrgModal()">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </form>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã -->
    <div id="createTeamModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–°–æ–∑–¥–∞—Ç—å –∫–æ–º–∞–Ω–¥—É</h2>
                <button class="modal-close" onclick="closeCreateTeamModal()">&times;</button>
            </div>
            <form id="createTeamForm" method="POST">
                <div class="form-group">
                    <label for="teamName">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã *</label>
                    <input type="text" id="teamName" name="name" required placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã">
                </div>
                <div class="form-group">
                    <label for="teamDescription">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea id="teamDescription" name="description" rows="3" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"></textarea>
                </div>
                <div class="form-group">
                    <label for="teamOrganization">–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è *</label>
                    <select id="teamOrganization" name="organizationId" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" id="createTeamBtn">
                        <span id="createTeamText">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–∞–Ω–¥—É</span>
                        <span id="createTeamLoading" class="loading hidden"></span>
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeCreateTeamModal()">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </form>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
    <div id="inviteUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</h2>
                <button class="modal-close" onclick="closeInviteUserModal()">&times;</button>
            </div>
            <form id="inviteUserForm" method="POST">
                <div class="form-group">
                    <label for="inviteIdentifierType">–°–ø–æ—Å–æ–± –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ *</label>
                    <select id="inviteIdentifierType" name="identifierType" required onchange="toggleInviteIdentifierType()">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–±</option>
                        <option value="email">Email</option>
                        <option value="github">GitHub username</option>
                        <option value="telegram">Telegram username</option>
                    </select>
                </div>
                <div class="form-group" id="inviteEmailGroup">
                    <label for="inviteEmail">Email —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ *</label>
                    <input type="email" id="inviteEmail" name="email" placeholder="user@example.com">
                </div>
                <div class="form-group" id="inviteGithubGroup" style="display: none;">
                    <label for="inviteGithubUsername">GitHub username *</label>
                    <input type="text" id="inviteGithubUsername" name="githubUsername" placeholder="username (–±–µ–∑ @)">
                    <small class="form-text text-muted">
                        –í–≤–µ–¥–∏—Ç–µ GitHub username –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–±–µ–∑ —Å–∏–º–≤–æ–ª–∞ @). 
                        <strong>üí° –°–æ–≤–µ—Ç:</strong> –°–≤–æ–π GitHub username –º–æ–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ø—Ä–æ—Ñ–∏–ª—è (—Ä–∞–∑–¥–µ–ª "–ù–∞—Å—Ç—Ä–æ–π–∫–∏" ‚Üí "GitHub –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è").
                        –°–∏—Å—Ç–µ–º–∞ –±—É–¥–µ—Ç –∏—Å–∫–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å—Ç—Ä–æ–≥–æ –ø–æ –ø–æ–ª—é GitHub username –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö, –ø–æ—ç—Ç–æ–º—É –≤–∞–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å —Ç–æ—á–Ω—ã–π username.
                    </small>
                </div>
                <div class="form-group" id="inviteTelegramGroup" style="display: none;">
                    <label for="inviteTelegramUsername">Telegram username *</label>
                    <input type="text" id="inviteTelegramUsername" name="telegramUsername" placeholder="username">
                    <small class="form-text text-muted">–í–≤–µ–¥–∏—Ç–µ Telegram username –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–±–µ–∑ @)</small>
                </div>
                <div class="form-group">
                    <label for="inviteType">–¢–∏–ø –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è *</label>
                    <select id="inviteType" name="type" required onchange="toggleInviteTarget()">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø</option>
                        <option value="organization">–í –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é</option>
                        <option value="team">–í –∫–æ–º–∞–Ω–¥—É</option>
                    </select>
                </div>
                <div class="form-group" id="inviteOrganizationGroup" style="display: none;">
                    <label for="inviteOrganization">–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è *</label>
                    <select id="inviteOrganization" name="organizationId" onchange="loadRolesForInvite('organization')">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é</option>
                    </select>
                </div>
                <div class="form-group" id="inviteTeamGroup" style="display: none;">
                    <label for="inviteTeam">–ö–æ–º–∞–Ω–¥–∞ *</label>
                    <select id="inviteTeam" name="teamId" onchange="loadRolesForInvite('team')">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É</option>
                    </select>
                </div>
                <div class="form-group" id="inviteRoleGroup" style="display: none;">
                    <label for="inviteRole">–†–æ–ª—å –≤ –∫–æ–º–∞–Ω–¥–µ/–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ *</label>
                    <select id="inviteRole" name="roleId">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" id="inviteUserBtn">
                        <span id="inviteUserText">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ</span>
                        <span id="inviteUserLoading" class="loading hidden"></span>
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeInviteUserModal()">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="editUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</h2>
                <button class="modal-close" onclick="closeEditUserModal()">&times;</button>
            </div>
                        <form id="editUserForm" method="POST">
                            <input type="hidden" id="editUserId" name="userId">
                            <div class="form-group">
                                <label for="editUserEmail">Email</label>
                                <input type="email" id="editUserEmail" name="email" readonly>
                            </div>
                            <div class="form-group">
                                <label for="editUserTargetType">–¢–∏–ø –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è</label>
                                <select id="editUserTargetType" name="targetType" onchange="toggleEditTarget()">
                                    <option value="team">–ö–æ–º–∞–Ω–¥–∞</option>
                                    <option value="organization">–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è</option>
                                </select>
                            </div>
                            <div class="form-group" id="editUserTeamGroup">
                                <label for="editUserTeam">–ö–æ–º–∞–Ω–¥–∞</label>
                                <select id="editUserTeam" name="teamId">
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É</option>
                                </select>
                            </div>
                            <div class="form-group" id="editUserOrgGroup" style="display: none;">
                                <label for="editUserOrganization">–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è</label>
                                <select id="editUserOrganization" name="organizationId">
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é</option>
                                </select>
                            </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" id="editUserBtn">
                        <span id="editUserText">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</span>
                        <span id="editUserLoading" class="loading hidden"></span>
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeEditUserModal()">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </form>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–µ—Ä–µ–Ω–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –º–µ–∂–¥—É –∫–æ–º–∞–Ω–¥–∞–º–∏ -->
    <div id="transferUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –º–µ–∂–¥—É –∫–æ–º–∞–Ω–¥–∞–º–∏</h2>
                <button class="modal-close" onclick="closeTransferUserModal()">&times;</button>
            </div>
            <form id="transferUserForm" method="POST">
                <input type="hidden" id="transferUserId" name="userId">
                <div class="form-group">
                    <label for="transferUserEmail">Email —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</label>
                    <input type="email" id="transferUserEmail" name="email" readonly>
                </div>
                <div class="form-group">
                    <label for="transferFromTeam">–ò–∑ –∫–æ–º–∞–Ω–¥—ã</label>
                    <select id="transferFromTeam" name="fromTeamId" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É</option>
                    </select>
                    <small class="form-text text-muted">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É, –∏–∑ –∫–æ—Ç–æ—Ä–æ–π –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—Å—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫</small>
                </div>
                <div class="form-group">
                    <label for="transferToTeam">–í –∫–æ–º–∞–Ω–¥—É</label>
                    <select id="transferToTeam" name="toTeamId" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="transferUserRole">–†–æ–ª—å –≤ –Ω–æ–≤–æ–π –∫–æ–º–∞–Ω–¥–µ</label>
                    <select id="transferUserRole" name="roleId" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" id="transferUserBtn">
                        <span id="transferUserText">–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏</span>
                        <span id="transferUserLoading" class="loading" style="display: none;">‚è≥</span>
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeTransferUserModal()">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Bind Email Modal -->
    <div id="bindEmailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–ü—Ä–∏–≤—è–∑–∞—Ç—å Email</h2>
                <button class="modal-close" onclick="closeBindEmailModal()">&times;</button>
            </div>
            <form id="bindEmailForm" onsubmit="handleBindEmail(event)">
                <div class="form-group">
                    <label for="bindEmailInput">Email</label>
                    <input type="email" id="bindEmailInput" name="email" placeholder="your@email.com" required>
                </div>
                <div class="form-group">
                    <label for="bindEmailPassword">–ü–∞—Ä–æ–ª—å –¥–ª—è —ç—Ç–æ–≥–æ email</label>
                    <input type="password" id="bindEmailPassword" name="password" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" required>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" id="bindEmailBtn">
                        <span id="bindEmailBtnText">–ü—Ä–∏–≤—è–∑–∞—Ç—å</span>
                        <span id="bindEmailLoading" class="loading hidden"></span>
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeBindEmailModal()">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Change User Role Modal -->
    <div id="changeUserRoleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>–ò–∑–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</h2>
                <button class="modal-close" onclick="closeChangeUserRoleModal()">&times;</button>
            </div>
            <form id="changeUserRoleForm" method="POST">
                <input type="hidden" id="changeUserRoleUserId" name="userId">
                <div class="form-group">
                    <label for="changeUserRoleEmail">Email —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</label>
                    <input type="email" id="changeUserRoleEmail" name="email" readonly>
                </div>
                <div class="form-group">
                    <label for="changeUserRoleContext">–ö–æ–Ω—Ç–µ–∫—Å—Ç</label>
                    <select id="changeUserRoleContext" name="context" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç</option>
                        <option value="organization">–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è</option>
                        <option value="team">–ö–æ–º–∞–Ω–¥–∞</option>
                    </select>
                </div>
                <div class="form-group" id="changeUserRoleOrganizationGroup" style="display: none;">
                    <label for="changeUserRoleOrganization">–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è</label>
                    <select id="changeUserRoleOrganization" name="organizationId">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é</option>
                    </select>
                </div>
                <div class="form-group" id="changeUserRoleTeamGroup" style="display: none;">
                    <label for="changeUserRoleTeam">–ö–æ–º–∞–Ω–¥–∞</label>
                    <select id="changeUserRoleTeam" name="teamId">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="changeUserRoleNewRole">–ù–æ–≤–∞—è —Ä–æ–ª—å</label>
                    <select id="changeUserRoleNewRole" name="roleId" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" id="changeUserRoleBtn">
                        <span id="changeUserRoleText">–ò–∑–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å</span>
                        <span id="changeUserRoleLoading" class="loading" style="display: none;">‚è≥</span>
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeChangeUserRoleModal()">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Define API_BASE_URL globally
        window.API_BASE_URL = (() => {
            const hostname = window.location.hostname;
            if (hostname === 'localhost' || hostname === '127.0.0.1') {
                return 'http://localhost:3001';
            }
            if (hostname.match(/^\d+\.\d+\.\d+\.\d+$/)) {
                return `${window.location.protocol}//${window.location.hostname}:3001`;
            }
            return `${window.location.protocol}//${window.location.hostname}`;
        })();
        console.log('API_BASE_URL defined:', window.API_BASE_URL);
    </script>
    <script>
        // Global variables
        let currentUser = null;
        let authToken = null;
        let currentUsersList = [];

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            
            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            setTimeout(() => {
                console.log('Force loading invitations...');
                loadInvitations();
            }, 1000);
        });

        // –§–ª–∞–≥ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–π
        let isAppInitializing = false;

        // Initialize application
        async function initializeApp() {
            // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
            if (isAppInitializing) {
                console.log('üö´ App already initializing, skipping');
                return;
            }
            isAppInitializing = true;
            
            // Check for tokens in URL parameters (from OAuth callbacks) - –ü–ï–†–í–´–ú –¥–µ–ª–æ–º!
            const urlParams = new URLSearchParams(window.location.search);
            const urlToken = urlParams.get('token');
            const urlRefreshToken = urlParams.get('refreshToken');
            
            if (urlToken) {
                console.log('üîë Token found in URL, saving to localStorage');
                authToken = urlToken;
                localStorage.setItem('authToken', urlToken);
                localStorage.setItem('accessToken', urlToken); // –¢–∞–∫–∂–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ accessToken –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
                if (urlRefreshToken) {
                    localStorage.setItem('refreshToken', urlRefreshToken);
                    console.log('‚úÖ Refresh token also saved');
                }
                console.log('‚úÖ Token saved to localStorage:', urlToken.substring(0, 20) + '...');
                console.log('‚úÖ Token length:', urlToken.length);
                
                // –ù–ï–ú–ï–î–õ–ï–ù–ù–û –æ—á–∏—â–∞–µ–º URL —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø—Ä–æ–±–ª–µ–º —Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º –ø–∞—Ä—Å–∏–Ω–≥–æ–º
                const cleanUrl = window.location.pathname;
                window.history.replaceState({}, document.title, cleanUrl);
                
                // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ localStorage —Å–æ—Ö—Ä–∞–Ω–µ–Ω
                await new Promise(resolve => setTimeout(resolve, 50));
            } else {
                // Check if user is logged in
                authToken = localStorage.getItem('authToken') || localStorage.getItem('accessToken');
            }
            
            if (!authToken) {
                console.log('‚ùå No token found, redirecting to login');
                window.location.href = 'index.html';
                return;
            }
            console.log('üîë Token found, proceeding with dashboard initialization. Token:', authToken.substring(0, 20) + '...');
            console.log('üîë AuthToken from localStorage:', localStorage.getItem('authToken')?.substring(0, 20) + '...');

            try {
                // Load user data
                await loadCurrentUser();
                
                // Load dashboard data
                await loadDashboardData();
                
                // Setup event listeners
                setupEventListeners();
                
                // Show welcome notification
                showNotification('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Å–∏—Å—Ç–µ–º—É!', 'success');
            } catch (error) {
                console.error('Error initializing app:', error);
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –æ—à–∏–±–∫–∞ 401 - —Ç–æ–≥–¥–∞ –≤–æ–∑–º–æ–∂–Ω–æ —Ç–æ–∫–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–µ–Ω
                if (error.message && error.message.includes('Unauthorized')) {
                    console.error('‚ùå Token validation failed, redirecting to login');
                    // –ù–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏–º —Å—Ä–∞–∑—É - –≤–æ–∑–º–æ–∂–Ω–æ —Ç–æ–∫–µ–Ω –µ—â–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω
                    // –î–∞–¥–∏–º –µ—â–µ –æ–¥–∏–Ω —à–∞–Ω—Å —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
                    setTimeout(() => {
                        const tokenCheck = localStorage.getItem('authToken');
                        if (!tokenCheck) {
                            console.error('‚ùå Token still not in localStorage, redirecting to login');
                            window.location.href = 'index.html';
                        } else {
                            console.log('‚úÖ Token found in localStorage, retrying initialization');
                            // –ü–æ–≤—Ç–æ—Ä—è–µ–º –ø–æ–ø—ã—Ç–∫—É –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
                            initializeApp();
                        }
                    }, 500);
                } else {
                    showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö', 'error');
                }
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', async function(e) {
                    e.preventDefault();
                    const section = this.dataset.section;

                    showSection(section);

                    // Update active nav item
                    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                    this.classList.add('active');
                });
            });

            // Search functionality
            document.getElementById('userSearch')?.addEventListener('input', function() {
                filterUsers(this.value);
            });

            document.getElementById('teamSearch')?.addEventListener('input', function() {
                filterTeams(this.value);
            });

            document.getElementById('orgSearch')?.addEventListener('input', function() {
                filterOrganizations(this.value);
            });

            
            // Initialize settings
            initializeSettings();
            
            // Initialize modals
            initializeModals();
        }

        // Show section
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });

            // Show selected section
            const section = document.getElementById(sectionId);
            if (section) {
                section.classList.add('active');
                
                // Update page title
                const pageTitle = document.querySelector('.page-title');
                const titles = {
                    'dashboard': '–î–∞—à–±–æ—Ä–¥',
                    'knowledge': '–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π',
                    'users': '–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏',
                    'teams': '–ö–æ–º–∞–Ω–¥—ã',
                    'organizations': '–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏',
                    'support': '–ü–æ–¥–¥–µ—Ä–∂–∫–∞',
                    'statistics': '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞',
                    'invitations': '–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è',
                    'settings': '–ù–∞—Å—Ç—Ä–æ–π–∫–∏'
                };
                pageTitle.textContent = titles[sectionId] || '–î–∞—à–±–æ—Ä–¥';
            }

            // Load section data
            loadSectionData(sectionId);
        }

        // Load section data
        async function loadSectionData(sectionId) {
            switch(sectionId) {
                case 'users':
                    await loadUsers();
                    break;
                case 'teams':
                    await loadTeams();
                    break;
                case 'organizations':
                    await loadOrganizations();
                    break;
                case 'statistics':
                    await loadStatistics();
                    break;
                case 'invitations':
                    console.log('Loading invitations section...');
                    await loadInvitations();
                    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é
                    const invitationsSection = document.getElementById('invitations');
                    if (invitationsSection) {
                        invitationsSection.style.display = 'block';
                        invitationsSection.style.visibility = 'visible';
                        invitationsSection.style.opacity = '1';
                        invitationsSection.classList.add('active');
                        console.log('Invitations section made visible');
                    }
                    break;
                case 'settings':
                    await loadSettings();
                    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤—ã–∑—ã–≤–∞–µ–º ensureReferralSection –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–∞–∑–¥–µ–ª–∞, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
                    setTimeout(() => {
                        if (typeof window.ensureReferralSection === 'function') {
                            window.ensureReferralSection();
                        }
                        // –ù–µ –ø—Ä–∏–Ω—É–∂–¥–∞–µ–º –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å - –ø–æ–∑–≤–æ–ª–∏–º loadModuleControls —É–ø—Ä–∞–≤–ª—è—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç—å—é –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ç–∞—Ç—É—Å–∞ –º–æ–¥—É–ª—è
                        const referralCard = document.getElementById('referralCard');
                        if (referralCard) {
                            console.log('‚úÖ Referral card exists in DOM');
                        }
                    }, 300);
                    setTimeout(() => {
                        if (typeof window.ensureReferralSection === 'function') {
                            window.ensureReferralSection();
                        }
                    }, 1000);
                    break;
            }
        }

        // Load current user
        async function loadCurrentUser() {
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø–µ–Ω –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–æ–º
                const tokenBeforeRequest = localStorage.getItem('authToken') || localStorage.getItem('accessToken');
                if (!tokenBeforeRequest) {
                    console.error('‚ùå No token available for loadCurrentUser');
                    throw new Error('No authentication token available');
                }
                console.log('üîë Making request to /api/auth/me with token:', tokenBeforeRequest.substring(0, 20) + '...');
                
                // Always load user data from API to get current user info
                const response = await apiCall('/api/auth/me', { method: 'GET' });
                console.log('‚úÖ User data loaded successfully:', response);
                currentUser = response;
                
                // Update localStorage with fresh user data
                localStorage.setItem('userData', JSON.stringify(currentUser));
                
                // Update user info in sidebar
                document.getElementById('userName').textContent = 
                    `${currentUser.firstName || ''} ${currentUser.lastName || ''}`.trim() || currentUser.email;
                
                // Get the highest priority role
                const rolePriority = {
                    'super_admin': 5,
                    'admin': 4,
                    'manager': 3,
                    'editor': 2,
                    'viewer': 1
                };
                
                // Handle both array of role objects and array of role names
                let roles = currentUser.roles || [];
                console.log('üîç Current user roles:', roles);
                console.log('üîç Current user:', currentUser);
                if (roles.length > 0 && typeof roles[0] === 'string') {
                    // If roles is array of strings, convert to objects
                    roles = roles.map(roleName => ({ name: roleName }));
                }
                
                const highestRole = roles.reduce((highest, current) => {
                    const currentPriority = rolePriority[current.name] || 0;
                    const highestPriority = rolePriority[highest?.name] || 0;
                    return currentPriority > highestPriority ? current : highest;
                }, null);
                
                document.getElementById('userRole').textContent = 
                    highestRole?.name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                
                // Handle role-based redirection and UI
                if (highestRole?.name === 'super_admin') {
                    // super_admin –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–æ–¥—É–ª—è–º–∏
                    if (!window.location.pathname.includes('test-micro-modules.html')) {
                        console.log('üîÑ Redirecting super_admin to test-micro-modules.html');
                        window.location.href = 'test-micro-modules.html';
                        return;
                    }
                    console.log('‚úÖ Super admin already on correct page');
                    
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥—É–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω–∞
                    await loadModuleControls();
                } else if (highestRole?.name === 'admin') {
                    // admin sees standard interface with all admin features
                    // No special handling needed
                } else {
                    // viewer sees simplified interface
                    // Hide admin-only sections for viewer
                    hideAdminOnlySections();
                }
                
                // Update avatar
                const avatar = document.getElementById('userAvatar');
                const initials = (currentUser.firstName?.[0] || '') + (currentUser.lastName?.[0] || '');
                if (initials) {
                    avatar.textContent = initials;
                } else {
                    avatar.innerHTML = '<i class="fas fa-user"></i>';
                }
            } catch (error) {
                console.error('Error loading current user:', error);
                throw error;
            }
        }

        // Load dashboard data
        async function loadDashboardData() {
            try {
                // Load statistics using the new function
                await loadStatistics();

                // Load recent activity
                await loadRecentActivity();
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        // Load users
        async function loadUsers() {
            try {
                console.log('Loading users in context...');
                const response = await apiCall('/api/users/in-context', { method: 'GET' });
                console.log('Users in context response:', response);
                const users = Array.isArray(response) ? response : (response.users || response.data || []);
                console.log('Users array:', users);
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–π –∫–µ—à –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏
                window.allUsersCache = users;
                
                displayUsers(users);
            } catch (error) {
                console.error('Error loading users in context:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', 'error');
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –º–æ–∂–µ—Ç –ª–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–ø—Ä–∞–≤–ª—è—Ç—å –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
        async function canManageUser(targetUserId, context = {}) {
            console.log('üîê canManageUser called for user:', targetUserId, 'context:', context);
            try {
                // –§–æ—Ä–º–∏—Ä—É–µ–º URL —Å query –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
                let url = `/api/users/${targetUserId}/can-manage`;
                const params = new URLSearchParams();
                if (context.organizationId) params.append('organizationId', context.organizationId);
                if (context.teamId) params.append('teamId', context.teamId);
                if (params.toString()) url += `?${params.toString()}`;
                
                const response = await apiCall(url, { method: 'GET' });
                console.log('üîê canManageUser response:', response);
                return response.canManage;
            } catch (error) {
                console.error('üîê Error checking permissions:', error);
                return false;
            }
        }

        // Display users
        async function displayUsers(users) {
            console.log('Displaying users:', users);
            const tbody = document.getElementById('usersTableBody');
            console.log('Table body element:', tbody);
            tbody.innerHTML = '';

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            currentUsersList = users;

            // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            users.forEach(user => {
                console.log(`üîç User ${user.email}:`, {
                    rolesByContext: user.rolesByContext,
                    globalRole: user.globalRole,
                    organizationMemberships: user.organizationMemberships,
                    teamMemberships: user.teamMemberships,
                    teams: user.teams,
                    organizations: user.organizations
                });
            });

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            for (const user of users) {
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤
                let context = {};
                
                // –ï—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å—Ç—å —á–ª–µ–Ω—Å—Ç–≤–æ –≤ –∫–æ–º–∞–Ω–¥–∞—Ö, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—É—é –∫–æ–º–∞–Ω–¥—É
                if (user.teamMemberships && user.teamMemberships.length > 0) {
                    context.teamId = user.teamMemberships[0].teamId;
                }
                // –ï—Å–ª–∏ –Ω–µ—Ç –∫–æ–º–∞–Ω–¥, –Ω–æ –µ—Å—Ç—å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—É—é –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é
                else if (user.organizationMemberships && user.organizationMemberships.length > 0) {
                    context.organizationId = user.organizationMemberships[0].organizationId;
                }
                
                console.log(`üîê Checking permissions for ${user.email} with context:`, context);
                const canManage = await canManageUser(user.id, context);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∞–º–∏–º —Å–æ–±–æ–π
                const isCurrentUser = currentUser && user.id === currentUser.id;
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–∏–µ –¥–µ–π—Å—Ç–≤–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω—ã
                const canChangeRole = canManage && !isCurrentUser; // –ù–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å —Å–≤–æ—é —Ä–æ–ª—å
                const canTransfer = canManage && !isCurrentUser;   // –ù–µ–ª—å–∑—è –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ —Å–µ–±—è
                const canDelete = canManage; // –ú–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å —Å–µ–±—è
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div class="user-info">
                            <div class="user-avatar">
                                ${user.firstName ? user.firstName[0] : user.email[0].toUpperCase()}
                            </div>
                            <div class="user-details">
                                <h4>${user.firstName || ''} ${user.lastName || ''}</h4>
                                <p>${user.email}</p>
                            </div>
                        </div>
                    </td>
                    <td>
                        ${(() => {
                            // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –í –∫–æ–ª–æ–Ω–∫–µ "–†–û–õ–¨" –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ì–õ–û–ë–ê–õ–¨–ù–£–Æ —Ä–æ–ª—å
                            const displayRole = user.globalRole || 'viewer';
                            const roleTitle = '–ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ä–æ–ª—å';
                            
                            return `<span class="role-badge global-role" title="${roleTitle}">
                                ${displayRole}
                            </span>`;
                        })()}
                    </td>
                            <td>
                                ${user.rolesByContext ? 
                                    [
                                        ...(user.rolesByContext.organizations || []).map(roleInfo => 
                                            `<span class="org-badge" title="–†–æ–ª—å –≤ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏">
                                                üè¢ ${roleInfo.organization} (${roleInfo.role})
                                            </span>`
                                        ),
                                        ...(user.rolesByContext.teams || []).map(roleInfo => 
                                            `<span class="team-badge" title="–†–æ–ª—å –≤ –∫–æ–º–∞–Ω–¥–µ">
                                                üë• ${roleInfo.team} (${roleInfo.role})
                                            </span>`
                                        )
                                    ].join(' ') :
                                    '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞'
                                }
                            </td>
                    <td>
                        <span class="status-badge ${user.isActive ? 'active' : 'inactive'}">
                            ${user.isActive ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-warning" onclick="changeUserRole('${user.id}')" title="${canChangeRole ? '–ò–∑–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å' : (isCurrentUser ? '–ù–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å —Å–≤–æ—é —Ä–æ–ª—å' : '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤')}" ${!canChangeRole ? 'disabled' : ''}>
                            <i class="fas fa-user-tag"></i>
                        </button>
                        <button class="btn btn-info" onclick="transferUser('${user.id}')" title="${canTransfer ? '–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –º–µ–∂–¥—É –∫–æ–º–∞–Ω–¥–∞–º–∏' : (isCurrentUser ? '–ù–µ–ª—å–∑—è –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ —Å–µ–±—è' : '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤')}" ${!canTransfer ? 'disabled' : ''}>
                            <i class="fas fa-exchange-alt"></i>
                        </button>
                        <button class="btn btn-danger" onclick="deleteUser('${user.id}')" title="${canDelete ? '–£–¥–∞–ª–∏—Ç—å' : '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤'}" ${!canDelete ? 'disabled' : ''}>
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            }
        }

        // Load teams
        async function loadTeams() {
            try {
                const response = await apiCall('/api/teams/accessible', { method: 'GET' });
                await displayTeams(response);
            } catch (error) {
                console.error('Error loading teams:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–∞–Ω–¥', 'error');
            }
        }

        // Display teams
        async function displayTeams(teams) {
            const tbody = document.getElementById('teamsTableBody');
            tbody.innerHTML = '';

            for (const team of teams) {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∫–æ–º–∞–Ω–¥—ã
                let membersCount = 0;
                try {
                    const membersResponse = await apiCall(`/api/teams/${team.id}/members`, { method: 'GET' });
                    // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –°–æ–∑–¥–∞—Ç–µ–ª—å –∫–æ–º–∞–Ω–¥—ã –ù–ï –≤–∫–ª—é—á–∞–µ—Ç—Å—è –≤ —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤, –ø–æ—ç—Ç–æ–º—É –Ω–µ –æ—Ç–Ω–∏–º–∞–µ–º 1
                    const members = membersResponse?.members || membersResponse || [];
                    membersCount = members.length;
                } catch (error) {
                    console.error('Error loading team members:', error);
                    membersCount = 0;
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div class="user-info">
                            <div class="user-avatar" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="user-details">
                                <h4>${team.name}</h4>
                                <p>${team.description || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}</p>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="status-badge active">${membersCount} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</span>
                    </td>
                    <td>${team.creator?.firstName || ''} ${team.creator?.lastName || ''}</td>
                    <td>${new Date(team.createdAt).toLocaleDateString('ru-RU')}</td>
                    <td>
                        <button class="btn btn-secondary" onclick="editTeam('${team.id}')" title="–ü—Ä–æ—Å–º–æ—Ç—Ä —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤">
                            <i class="fas fa-users"></i>
                        </button>
                        <button class="btn btn-danger" onclick="deleteTeam('${team.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            }
        }

        // Delete team
        async function deleteTeam(teamId) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∫–æ–º–∞–Ω–¥—É?')) {
                return;
            }

            try {
                await apiCall(`/api/teams/${teamId}`, {
                    method: 'DELETE'
                });
                
                showNotification('–ö–æ–º–∞–Ω–¥–∞ —É–¥–∞–ª–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!', 'success');
                await loadTeams();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã:', error);
                showNotification('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã: ' + error.message, 'error');
            }
        }

        // Edit team
        async function editTeam(teamId) {
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–º–∞–Ω–¥–µ –∏ –µ—ë —É—á–∞—Å—Ç–Ω–∏–∫–∞—Ö
                const [teamResponse, membersResponse] = await Promise.all([
                    apiCall(`/api/teams/${teamId}`, { method: 'GET' }),
                    apiCall(`/api/teams/${teamId}/members`, { method: 'GET' })
                ]);

                const team = teamResponse;
                const membersData = membersResponse || {};
                const members = membersData.members || membersData || [];
                const teamInfo = membersData.team || team;

                // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∫–æ–º–∞–Ω–¥—ã
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>–£—á–∞—Å—Ç–Ω–∏–∫–∏ –∫–æ–º–∞–Ω–¥—ã: ${team.name}</h2>
                            <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="members-list">
                                ${members.length > 0 ? 
                                    members
                                        .filter(member => member.id !== teamInfo.creator?.id) // –ò—Å–∫–ª—é—á–∞–µ–º —Å–æ–∑–¥–∞—Ç–µ–ª—è –∫–æ–º–∞–Ω–¥—ã
                                        .map(member => `
                                        <div class="member-item">
                                            <div class="user-avatar" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                                                <i class="fas fa-user"></i>
                                            </div>
                                            <div class="member-info">
                                                <h4>${member.firstName || ''} ${member.lastName || ''}</h4>
                                                <p>${member.email || ''}</p>
                                                <div class="member-details">
                                                    <span class="role-badge">${member.role?.name || 'viewer'}</span>
                                                    <span class="status-badge ${member.isActive ? 'active' : 'inactive'}">
                                                        ${member.isActive ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω'}
                                                    </span>
                                                </div>
                                            </div>
                                            <button class="btn btn-danger btn-sm" onclick="removeMemberFromTeam('${member.id}', '${teamId}', this)" title="–£–¥–∞–ª–∏—Ç—å –∏–∑ –∫–æ–º–∞–Ω–¥—ã" data-member-id="${member.id}">
                                                <i class="fas fa-user-minus"></i>
                                            </button>
                                        </div>
                                    `).join('') :
                                    '<p>–í –∫–æ–º–∞–Ω–¥–µ –ø–æ–∫–∞ –Ω–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</p>'
                                }
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-primary" onclick="this.closest('.modal').remove()">–ó–∞–∫—Ä—ã—Ç—å</button>
                        </div>
                    </div>
                `;

                // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
                const style = document.createElement('style');
                style.textContent = `
                    .members-list {
                        max-height: 400px;
                        overflow-y: auto;
                    }
                    .member-item {
                        display: flex;
                        align-items: center;
                        padding: 1rem;
                        border-bottom: 1px solid #e5e7eb;
                        gap: 1rem;
                    }
                    .member-item:last-child {
                        border-bottom: none;
                    }
                    .member-info h4 {
                        margin: 0 0 0.25rem 0;
                        font-size: 1rem;
                        font-weight: 600;
                    }
                    .member-info p {
                        margin: 0 0 0.5rem 0;
                        color: #6b7280;
                        font-size: 0.875rem;
                    }
                `;
                document.head.appendChild(style);

                document.body.appendChild(modal);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                modal.style.display = 'block';
            } catch (error) {
                console.error('Error loading team members:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∫–æ–º–∞–Ω–¥—ã', 'error');
            }
        }

        // Remove member from team
        async function removeMemberFromTeam(memberId, teamId, buttonElement) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –∏–∑ –∫–æ–º–∞–Ω–¥—ã?')) {
                return;
            }

            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –í –ö–û–ù–¢–ï–ö–°–¢–ï –ö–û–ú–ê–ù–î–´
                const permissionCheck = await canManageUser(memberId, { teamId });
                if (!permissionCheck) {
                    showNotification('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —ç—Ç–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –∏–∑ –∫–æ–º–∞–Ω–¥—ã', 'error');
                    return;
                }

                // –£–¥–∞–ª—è–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞ –∏–∑ –∫–æ–º–∞–Ω–¥—ã
                await apiCall(`/api/teams/${teamId}/members/${memberId}`, {
                    method: 'DELETE'
                });

                showNotification('–£—á–∞—Å—Ç–Ω–∏–∫ —É–¥–∞–ª—ë–Ω –∏–∑ –∫–æ–º–∞–Ω–¥—ã', 'success');
                
                // –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –∏–∑ DOM
                const memberItem = buttonElement.closest('.member-item');
                if (memberItem) {
                    memberItem.remove();
                }

                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥
                await loadTeams();
            } catch (error) {
                console.error('Error removing member from team:', error);
                showNotification('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–∞: ' + error.message, 'error');
            }
        }


        // Remove member from organization
        async function removeMemberFromOrganization(memberId, organizationId, buttonElement) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –∏–∑ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏?')) {
                return;
            }

            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –í –ö–û–ù–¢–ï–ö–°–¢–ï –û–†–ì–ê–ù–ò–ó–ê–¶–ò–ò
                const permissionCheck = await canManageUser(memberId, { organizationId });
                if (!permissionCheck) {
                    showNotification('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —ç—Ç–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –∏–∑ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏', 'error');
                    return;
                }

                // –£–¥–∞–ª—è–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞ –∏–∑ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
                await apiCall(`/api/organizations/${organizationId}/members/${memberId}`, {
                    method: 'DELETE'
                });

                showNotification('–£—á–∞—Å—Ç–Ω–∏–∫ —É–¥–∞–ª—ë–Ω –∏–∑ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏', 'success');
                
                // –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –∏–∑ DOM
                const memberItem = buttonElement.closest('.member-item');
                if (memberItem) {
                    memberItem.remove();
                }

                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π
                await loadOrganizations();
            } catch (error) {
                console.error('Error removing member from organization:', error);
                showNotification('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–∞: ' + error.message, 'error');
            }
        }


        // Load organizations
        async function loadOrganizations() {
            try {
                const response = await apiCall('/api/organizations', { method: 'GET' });
                displayOrganizations(response);
            } catch (error) {
                console.error('Error loading organizations:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π', 'error');
            }
        }

        // View organization members
        async function viewOrganizationMembers(organizationId) {
            try {
                const response = await apiCall(`/api/organizations/${organizationId}/members`, { method: 'GET' });
                const members = Array.isArray(response) ? response : (response.members || response.data || []);

                // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>–£—á–∞—Å—Ç–Ω–∏–∫–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏</h2>
                            <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="members-list">
                                ${(() => {
                                    const filteredMembers = members; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
                                    return filteredMembers.length > 0 ? 
                                        filteredMembers.map(member => `
                                        <div class="member-item">
                                            <div class="user-avatar" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                                                ${member.user?.firstName ? member.user.firstName[0] : member.user?.email[0].toUpperCase()}
                                            </div>
                                            <div class="member-details">
                                                <h4>${member.user?.firstName || ''} ${member.user?.lastName || ''}</h4>
                                                <p>${member.user?.email}</p>
                                                <span class="role-badge">${member.role?.name || 'viewer'}</span>
                                            </div>
                                            <button class="btn btn-danger btn-sm" onclick="removeMemberFromOrganization('${member.user?.id}', '${organizationId}', this)" title="–£–¥–∞–ª–∏—Ç—å –∏–∑ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏" data-member-id="${member.user?.id}">
                                                <i class="fas fa-user-minus"></i>
                                            </button>
                                        </div>
                                    `).join('') :
                                    '<p>–í –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ–∫–∞ –Ω–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</p>';
                                })()}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-primary" onclick="this.closest('.modal').remove()">–ó–∞–∫—Ä—ã—Ç—å</button>
                        </div>
                    </div>
                `;

                // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
                const style = document.createElement('style');
                style.textContent = `
                    .members-list {
                        max-height: 400px;
                        overflow-y: auto;
                    }
                    .member-item {
                        display: flex;
                        align-items: center;
                        padding: 1rem;
                        border-bottom: 1px solid #e5e7eb;
                    }
                    .member-item:last-child {
                        border-bottom: none;
                    }
                    .member-details {
                        margin-left: 1rem;
                        flex: 1;
                    }
                    .member-details h4 {
                        margin: 0 0 0.25rem 0;
                        font-size: 1rem;
                        font-weight: 600;
                    }
                    .member-details p {
                        margin: 0 0 0.5rem 0;
                        color: #6b7280;
                        font-size: 0.875rem;
                    }
                `;
                document.head.appendChild(style);

                document.body.appendChild(modal);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                modal.style.display = 'block';
            } catch (error) {
                console.error('Error loading organization members:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏', 'error');
            }
        }

        // Display organizations
        function displayOrganizations(organizations) {
            const tbody = document.getElementById('organizationsTableBody');
            tbody.innerHTML = '';

            organizations.forEach(org => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div class="user-info">
                            <div class="user-avatar" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                                <i class="fas fa-building"></i>
                            </div>
                            <div class="user-details">
                                <h4>${org.name}</h4>
                                <p>${org.slug}</p>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="status-badge active">${org.teams?.length || 0} –∫–æ–º–∞–Ω–¥</span>
                    </td>
                    <td>
                        <span class="status-badge active">${(org.members?.filter(member => !['creator', 'manager'].includes(member.role?.name)) || []).length} —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</span>
                    </td>
                    <td>${org.creator?.firstName || ''} ${org.creator?.lastName || ''}</td>
                    <td>
                        <button class="btn btn-info" onclick="viewOrganizationMembers('${org.id}')" title="–ü—Ä–æ—Å–º–æ—Ç—Ä —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤">
                            <i class="fas fa-users"></i>
                        </button>
                        <button class="btn btn-danger" onclick="deleteOrganization('${org.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Delete organization
        async function deleteOrganization(organizationId) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é?')) {
                return;
            }

            try {
                await apiCall(`/api/organizations/${organizationId}`, {
                    method: 'DELETE'
                });
                
                showNotification('–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è —É–¥–∞–ª–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!', 'success');
                await loadOrganizations();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏:', error);
                showNotification('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏: ' + error.message, 'error');
            }
        }

        // Edit organization
        function editOrganization(organizationId) {
            showNotification('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info');
        }

        // Load statistics
        async function loadStatistics() {
            try {
                console.log('Loading statistics...');
                // Load all data for statistics (only working endpoints)
                const [teamMembers, teams, organizations, invitations] = await Promise.all([
                    apiCall('/api/users/in-context', { method: 'GET' }).catch((err) => { console.error('Error loading team members:', err); return []; }),
                    apiCall('/api/teams', { method: 'GET' }).catch((err) => { console.error('Error loading teams:', err); return []; }),
                    apiCall('/api/organizations', { method: 'GET' }).catch((err) => { console.error('Error loading organizations:', err); return []; }),
                    apiCall('/api/invitations/my', { method: 'GET' }).catch((err) => { console.error('Error loading invitations:', err); return []; })
                ]);

                console.log('Statistics data loaded:', { teamMembers, teams, organizations, invitations });

                // Process data
                const usersList = Array.isArray(teamMembers) ? teamMembers : (teamMembers?.users || teamMembers?.data || []);
                const teamsList = Array.isArray(teams) ? teams : (teams?.teams || teams?.data || []);
                const orgsList = Array.isArray(organizations) ? organizations : (organizations?.organizations || organizations?.data || []);
                const invitationsList = Array.isArray(invitations) ? invitations : (invitations?.invitations || invitations?.data || []);

                // Calculate real statistics
                const totalUsers = usersList.length || 0;
                const activeUsers = usersList.filter(u => u.isActive !== false).length || 0;
                const totalTeams = teamsList.length || 0;
                const totalOrganizations = orgsList.length || 0;
                const pendingInvitations = invitationsList.filter(inv => inv.status === 'pending').length || 0;
                const totalInvitations = invitationsList.length || 0;
                
                // If no team members, show total teams and organizations as meaningful stats
                const displayUsers = totalUsers > 0 ? totalUsers : totalTeams;
                const displayActiveUsers = activeUsers > 0 ? activeUsers : totalOrganizations;

                        // Update statistics
                        console.log('Updating statistics:', { totalUsers, activeUsers, pendingInvitations, totalTeams, totalInvitations, totalOrganizations });
                        
                        // Update main dashboard statistics
                        const totalUsersEl = document.getElementById('totalUsers');
                        const activeUsersEl = document.getElementById('activeUsers');
                        const invitationsEl = document.getElementById('invitationsCount');
                        const articlesEl = document.getElementById('articles');
                        
                        // Update additional statistics
                        const statsTotalUsersEl = document.getElementById('statsTotalUsers');
                        const statsActiveUsersEl = document.getElementById('statsActiveUsers');
                        const statsInvitationsEl = document.getElementById('statsInvitations');
                        const statsArticlesEl = document.getElementById('statsArticles');
                        const statsTotalUsersLabelEl = document.getElementById('statsTotalUsersLabel');
                        
                        console.log('Statistics elements found:', { 
                            totalUsersEl: !!totalUsersEl, 
                            activeUsersEl: !!activeUsersEl, 
                            invitationsEl: !!invitationsEl, 
                            articlesEl: !!articlesEl,
                            statsTotalUsersEl: !!statsTotalUsersEl, 
                            statsActiveUsersEl: !!statsActiveUsersEl, 
                            statsInvitationsEl: !!statsInvitationsEl, 
                            statsArticlesEl: !!statsArticlesEl,
                            statsTotalUsersLabelEl: !!statsTotalUsersLabelEl
                        });
                        
                        // Update main dashboard statistics
                        console.log('Updating main dashboard:', { displayUsers, displayActiveUsers, pendingInvitations, totalTeams });
                        if (totalUsersEl) {
                            totalUsersEl.textContent = displayUsers;
                            console.log('Updated totalUsersEl to:', displayUsers);
                        }
                        if (activeUsersEl) {
                            activeUsersEl.textContent = displayActiveUsers;
                            console.log('Updated activeUsersEl to:', displayActiveUsers);
                        }
                        if (invitationsEl) {
                            invitationsEl.textContent = pendingInvitations;
                            console.log('Updated invitationsEl to:', pendingInvitations);
                        }
                        if (articlesEl) {
                            articlesEl.textContent = totalTeams; // Using teams as articles placeholder
                            console.log('Updated articlesEl to:', totalTeams);
                        }
                        
                        // Update additional statistics
                        if (statsTotalUsersEl) statsTotalUsersEl.textContent = displayUsers;
                        if (statsActiveUsersEl) statsActiveUsersEl.textContent = displayActiveUsers;
                        if (statsInvitationsEl) statsInvitationsEl.textContent = pendingInvitations;
                        if (statsArticlesEl) statsArticlesEl.textContent = totalTeams; // Using teams as articles placeholder
                        
                        // Update labels dynamically for main dashboard
                        const totalUsersLabelEl = document.getElementById('totalUsersLabel');
                        if (totalUsersLabelEl) {
                            totalUsersLabelEl.textContent = totalUsers > 0 ? '–°–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –≤ —Å–∏—Å—Ç–µ–º–µ' : '–ö–æ–º–∞–Ω–¥ –≤ —Å–∏—Å—Ç–µ–º–µ';
                        }
                        
                        const activeUsersLabelEl = document.getElementById('activeUsersLabel');
                        if (activeUsersLabelEl) {
                            activeUsersLabelEl.textContent = activeUsers > 0 ? '–ê–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π' : '–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π –≤ —Å–∏—Å—Ç–µ–º–µ';
                        }
                        
                        // Update labels dynamically for additional statistics
                        if (statsTotalUsersLabelEl) {
                            statsTotalUsersLabelEl.textContent = totalUsers > 0 ? '–°–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –≤ —Å–∏—Å—Ç–µ–º–µ' : '–ö–æ–º–∞–Ω–¥ –≤ —Å–∏—Å—Ç–µ–º–µ';
                        }
                        
                        const statsActiveUsersLabelEl = document.getElementById('statsActiveUsersLabel');
                        if (statsActiveUsersLabelEl) {
                            statsActiveUsersLabelEl.textContent = activeUsers > 0 ? '–ê–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π' : '–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π –≤ —Å–∏—Å—Ç–µ–º–µ';
                        }
                
                // Update additional stats if they exist
                const statsTicketsEl = document.getElementById('statsTickets');
                const statsAvgResponseEl = document.getElementById('statsAvgResponse');
                if (statsTicketsEl) statsTicketsEl.textContent = totalInvitations; // Using invitations as tickets placeholder
                if (statsAvgResponseEl) statsAvgResponseEl.textContent = totalOrganizations > 0 ? '1.5—á' : '–ù/–î'; // Dynamic based on data

                // Update additional stats if elements exist
                const statsContainer = document.getElementById('statistics');
                if (statsContainer) {
                    // Add more detailed statistics
                    const additionalStats = `
                        <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-top: 20px;">
                            <div class="stat-card" style="background: #F3F4F6; padding: 20px; border-radius: 12px; text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #1F2937;">${totalTeams}</div>
                                <div style="color: #6B7280; margin-top: 4px;">–ö–æ–º–∞–Ω–¥</div>
                            </div>
                            <div class="stat-card" style="background: #F3F4F6; padding: 20px; border-radius: 12px; text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #1F2937;">${totalOrganizations}</div>
                                <div style="color: #6B7280; margin-top: 4px;">–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π</div>
                            </div>
                            <div class="stat-card" style="background: #F3F4F6; padding: 20px; border-radius: 12px; text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #1F2937;">${totalInvitations}</div>
                                <div style="color: #6B7280; margin-top: 4px;">–í—Å–µ–≥–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π</div>
                            </div>
                            <div class="stat-card" style="background: #F3F4F6; padding: 20px; border-radius: 12px; text-align: center;">
                                <div style="font-size: 24px; font-weight: bold; color: #1F2937;">${pendingInvitations}</div>
                                <div style="color: #6B7280; margin-top: 4px;">–û–∂–∏–¥–∞—é—â–∏—Ö –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π</div>
                            </div>
                        </div>
                    `;
                    
                    // Add additional stats to the statistics section
                    const existingAdditional = statsContainer.querySelector('.additional-stats');
                    if (existingAdditional) {
                        existingAdditional.remove();
                    }
                    
                    const additionalDiv = document.createElement('div');
                    additionalDiv.className = 'additional-stats';
                    additionalDiv.innerHTML = additionalStats;
                    statsContainer.appendChild(additionalDiv);
                }

            } catch (error) {
                console.error('Error loading statistics:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏', 'error');
            }
        }

        // Switch user tab
        function switchUserTab(tab) {
            // Update tab styles
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            // Load appropriate data
            if (tab === 'active') {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–µ—à, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å, –∏–Ω–∞—á–µ –∑–∞–≥—Ä—É–∂–∞–µ–º —Å —Å–µ—Ä–≤–µ—Ä–∞
                if (window.allUsersCache) {
                    displayUsers(window.allUsersCache);
                } else {
                    loadUsers();
                }
            } else if (tab === 'invited') {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è
                loadSentInvitations();
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π
        async function loadSentInvitations() {
            try {
                console.log('Loading sent invitations...');
                const response = await apiCall('/api/invitations/sent', { method: 'GET' });
                console.log('Sent invitations response:', response);
                displaySentInvitations(response);
            } catch (error) {
                console.error('Error loading sent invitations:', error);
                displaySentInvitations([]);
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π
        function displaySentInvitations(invitations) {
            const tbody = document.getElementById('usersTableBody');
            if (!tbody) return;

            if (!invitations || invitations.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="no-data">–ù–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π</td></tr>';
                return;
            }

            let html = '';
            invitations.forEach(invitation => {
                const statusClass = invitation.status === 'pending' ? 'pending' : 
                                  invitation.status === 'accepted' ? 'accepted' : 'declined';
                const statusText = invitation.status === 'pending' ? '–û–∂–∏–¥–∞–µ—Ç –æ—Ç–≤–µ—Ç–∞' :
                                  invitation.status === 'accepted' ? '–ü—Ä–∏–Ω—è—Ç–æ' : '–û—Ç–∫–ª–æ–Ω–µ–Ω–æ';
                
                html += `
                    <tr>
                        <td>
                            <div class="user-info">
                                <div class="user-avatar">${invitation.email.charAt(0).toUpperCase()}</div>
                                <div class="user-details">
                                    <h4>${invitation.email}</h4>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="role-badge">${invitation.roleName || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</span>
                        </td>
                        <td>
                            <span class="team-badge">${invitation.targetName || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</span>
                        </td>
                        <td>
                            <span class="status ${statusClass}">${statusText}</span>
                        </td>
                        <td>
                            <span class="date">${new Date(invitation.createdAt).toLocaleDateString()}</span>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        // Load invited users (users who haven't accepted invitations yet)
        async function loadInvitedUsers() {
            try {
                // Get all users and filter those who are invited but not active
                const response = await apiCall('/api/users', { method: 'GET' });
                console.log('All users response for invited:', response);
                const users = Array.isArray(response) ? response : (response.users || response.data || []);
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–π –∫–µ—à
                window.allUsersCache = users;
                
                // Filter users who are invited but not active (you can customize this logic)
                const invitedUsers = users.filter(user => {
                    // Show users who are not active or don't have teams
                    return !user.isActive || !user.teams || user.teams.length === 0;
                });
                
                console.log('Filtered invited users:', invitedUsers);
                displayInvitedUsers(invitedUsers);
            } catch (error) {
                console.error('Error loading invited users:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', 'error');
            }
        }

        // Display invited users
        function displayInvitedUsers(users) {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';

            if (!users || !Array.isArray(users)) {
                return;
            }

            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div class="user-info">
                            <div class="user-avatar">
                                ${user.email[0].toUpperCase()}
                            </div>
                            <div class="user-details">
                                <h4>${user.firstName || ''} ${user.lastName || ''}</h4>
                                <p>${user.email}</p>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="status-badge pending">–ü—Ä–∏–≥–ª–∞—à–µ–Ω</span>
                    </td>
                    <td>${user.teams && user.teams.length > 0 ? user.teams[0].name : '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ'}</td>
                    <td>
                        <span class="status-badge ${user.isActive ? 'active' : 'pending'}">
                            ${user.isActive ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ü—Ä–∏–≥–ª–∞—à–µ–Ω'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-secondary" onclick="resendInvitation('${user.id}')">
                            <i class="fas fa-redo"></i>
                        </button>
                        <button class="btn btn-danger" onclick="cancelInvitation('${user.id}')">
                            <i class="fas fa-times"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Filter functions
        function filterUsers(query) {
            const rows = document.querySelectorAll('#usersTableBody tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(query.toLowerCase()) ? '' : 'none';
            });
        }

        function filterTeams(query) {
            const rows = document.querySelectorAll('#teamsTableBody tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(query.toLowerCase()) ? '' : 'none';
            });
        }

        function filterOrganizations(query) {
            const rows = document.querySelectorAll('#organizationsTableBody tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(query.toLowerCase()) ? '' : 'none';
            });
        }

        // API call function
        async function apiCall(endpoint, options = {}) {
            // –£–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ —Ç–æ–∫–µ–Ω –∞–∫—Ç—É–∞–ª–µ–Ω –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º –∑–∞–ø—Ä–æ—Å–æ–º
            let currentToken = authToken || localStorage.getItem('authToken') || localStorage.getItem('accessToken');
            
            // –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –≤—Å–µ –µ—â–µ –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–≤–µ—Ä—è–µ–º URL (–Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ –º—ã —Ç–æ–ª—å–∫–æ —á—Ç–æ –ø–µ—Ä–µ—à–ª–∏ —Å —Ç–æ–∫–µ–Ω–æ–º)
            if (!currentToken) {
                const urlParamsCheck = new URLSearchParams(window.location.search);
                const urlTokenCheck = urlParamsCheck.get('token');
                if (urlTokenCheck) {
                    console.log('üîë Found token in URL during API call, saving it');
                    currentToken = urlTokenCheck;
                    authToken = urlTokenCheck;
                    localStorage.setItem('authToken', urlTokenCheck);
                    localStorage.setItem('accessToken', urlTokenCheck);
                }
            }
            
            if (!currentToken) {
                console.error('‚ùå No token available for API call to:', endpoint);
                throw new Error('No authentication token available');
            }
            
            const url = `${window.API_BASE_URL}${endpoint}`;
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${currentToken}`
                }
            };
            
            // –û–±–Ω–æ–≤–ª—è–µ–º authToken –µ—Å–ª–∏ –æ–Ω –∏–∑–º–µ–Ω–∏–ª—Å—è
            if (currentToken !== authToken) {
                authToken = currentToken;
                console.log('üîÑ Updated authToken from localStorage/URL');
            }

            const response = await fetch(url, { ...defaultOptions, ...options });
            
            if (!response.ok) {
                if (response.status === 401) {
                    // Check if it's a 2FA requirement
                    const errorData = await response.json().catch(() => ({}));
                    if (errorData.message && errorData.message.includes('2FA')) {
                        // 2FA required, redirect to login with 2FA
                        localStorage.removeItem('authToken');
                        localStorage.removeItem('refreshToken');
                        localStorage.removeItem('userData');
                        window.location.href = 'index.html?require2fa=true';
                        throw new Error('2FA required');
                    } else {
                        // Token expired –∏–ª–∏ –Ω–µ–≤–∞–ª–∏–¥–µ–Ω - –ø—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–µ—Ç —Ç–æ–∫–µ–Ω –µ—â–µ –≤ URL
                        const urlParamsCheck = new URLSearchParams(window.location.search);
                        const urlTokenCheck = urlParamsCheck.get('token');
                        
                        if (urlTokenCheck) {
                            console.log('‚ö†Ô∏è 401 error, but token found in URL, saving and retrying');
                            authToken = urlTokenCheck;
                            localStorage.setItem('authToken', urlTokenCheck);
                            localStorage.setItem('accessToken', urlTokenCheck);
                            // –ü–æ–≤—Ç–æ—Ä—è–µ–º –∑–∞–ø—Ä–æ—Å —Å —Ç–æ–∫–µ–Ω–æ–º –∏–∑ URL
                            console.log('üîÑ Retrying request with token from URL');
                            const retryUrl = `${window.API_BASE_URL}${endpoint}`;
                            const retryOptions = {
                                ...defaultOptions,
                                ...options,
                                headers: {
                                    ...defaultOptions.headers,
                                    ...options.headers,
                                    'Authorization': `Bearer ${urlTokenCheck}`
                                }
                            };
                            const retryResponse = await fetch(retryUrl, retryOptions);
                            if (retryResponse.ok) {
                                const retryData = await retryResponse.json();
                                return retryData;
                            } else {
                                console.error('‚ùå Retry also failed with status:', retryResponse.status);
                            }
                        }
                        
                        // Token expired, redirect to login
                        console.error('‚ùå Token expired and no token in URL, redirecting to login');
                        localStorage.removeItem('authToken');
                        localStorage.removeItem('refreshToken');
                        localStorage.removeItem('userData');
                        window.location.href = 'index.html';
                        throw new Error('Unauthorized');
                    }
                }
                if (response.status === 403) {
                    const errorData = await response.json().catch(() => ({}));
                    const msg = errorData?.message || '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏—è';
                    // Show friendly permissions message instead of generic error
                    showNotification(msg, 'error');
                    throw new Error('Forbidden');
                }
                
                // Try to get error message from response
                let errorMessage = `HTTP error! status: ${response.status}`;
                try {
                    const errorData = await response.json();
                    if (errorData.message) {
                        errorMessage = errorData.message;
                    }
                } catch (e) {
                    // If JSON parsing fails, use default message
                }
                
                throw new Error(errorMessage);
            }

            return await response.json();
        }

        // Show notification
        function showNotification(message, type = 'success') {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            container.appendChild(notification);
            
            // Show notification
            setTimeout(() => notification.classList.add('show'), 100);
            
            // Hide notification after 5 seconds
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => container.removeChild(notification), 300);
            }, 5000);
        }

        // Logout function
        function logout() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?')) {
                console.log('üö™ Logging out...');
                localStorage.removeItem('authToken');
                localStorage.removeItem('accessToken'); // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –æ—á–∏—â–∞–µ–º accessToken
                localStorage.removeItem('refreshToken');
                localStorage.removeItem('userData');
                window.location.href = 'index.html';
            }
        }

        // Placeholder functions for actions
        function editUser(userId) {
            // –ù–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–µ–∫—É—â–µ–º —Å–ø–∏—Å–∫–µ
            const user = currentUsersList.find(u => u.id === userId);
            if (!user) {
                showNotification('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                return;
            }

            // –ó–∞–ø–æ–ª–Ω–∏—Ç—å —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            document.getElementById('editUserId').value = user.id;
            document.getElementById('editUserEmail').value = user.email;

            // –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–º–∞–Ω–¥—ã –∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞
            loadTeamsForEdit();
            loadOrganizationsForEdit();

            // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â—É—é –∫–æ–º–∞–Ω–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–µ—Å–ª–∏ –µ—Å—Ç—å)
            if (user.teams && user.teams.length > 0) {
                document.getElementById('editUserTargetType').value = 'team';
                document.getElementById('editUserTeam').value = user.teams[0].id;
                toggleEditTarget();
            } else if (user.organization && user.organization.id) {
                document.getElementById('editUserTargetType').value = 'organization';
                document.getElementById('editUserOrganization').value = user.organization.id;
                toggleEditTarget();
            } else {
                document.getElementById('editUserTargetType').value = 'team';
                toggleEditTarget();
            }

            // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            document.getElementById('editUserModal').style.display = 'block';
        }

        function transferUser(userId) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø—ã—Ç–∞–µ—Ç—Å—è –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ —Å–∞–º–æ–≥–æ —Å–µ–±—è
            if (currentUser && userId === currentUser.id) {
                showNotification('–í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ —Å–∞–º–æ–≥–æ —Å–µ–±—è –≤ –¥—Ä—É–≥—É—é –∫–æ–º–∞–Ω–¥—É', 'error');
                return;
            }

            // –ù–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–µ–∫—É—â–µ–º —Å–ø–∏—Å–∫–µ
            const user = currentUsersList.find(u => u.id === userId);
            if (!user) {
                showNotification('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                return;
            }

            // –ó–∞–ø–æ–ª–Ω–∏—Ç—å —Ñ–æ—Ä–º—É –ø–µ—Ä–µ–Ω–æ—Å–∞
            document.getElementById('transferUserId').value = user.id;
            document.getElementById('transferUserEmail').value = user.email;

            // –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞
            loadTeamsForTransfer();

            // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –∫–æ–º–∞–Ω–¥—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const currentTeams = user.teams || [];
            const teamSelect = document.getElementById('transferFromTeam');
            const toTeamSelect = document.getElementById('transferToTeam');
            
            // –û—á–∏—Å—Ç–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –æ–ø—Ü–∏–∏
            teamSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É</option>';
            toTeamSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É</option>';

            // –î–æ–±–∞–≤–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –∫–æ–º–∞–Ω–¥—ã –≤ "–û—Ç–∫—É–¥–∞"
            currentTeams.forEach(team => {
                const option = document.createElement('option');
                option.value = team.id;
                option.textContent = team.name;
                teamSelect.appendChild(option);
            });

            // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            document.getElementById('transferUserModal').style.display = 'block';
        }

        async function deleteUser(userId) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ–ª—å —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const isSuperAdmin = currentUser && currentUser.roles && 
                currentUser.roles.some(r => (typeof r === 'string' ? r : r.name) === 'super_admin');
            
            let confirmMessage;
            let successMessage;
            
            if (isSuperAdmin) {
                confirmMessage = '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Å–∏—Å—Ç–µ–º—ã? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!';
                successMessage = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª–µ–Ω –∏–∑ —Å–∏—Å—Ç–µ–º—ã';
            } else {
                confirmMessage = '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –≤–∞—à–∏—Ö –∫–æ–º–∞–Ω–¥/–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π?';
                successMessage = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª–µ–Ω –∏–∑ –≤–∞—à–∏—Ö –∫–æ–º–∞–Ω–¥/–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π';
            }
            
            if (!confirm(confirmMessage)) {
                return;
            }

            try {
                let endpoint;
                if (isSuperAdmin) {
                    // –°—É–ø–µ—Ä–∞–¥–º–∏–Ω - –ø–æ–ª–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    console.log('Super admin deleting user completely:', userId);
                    endpoint = `/api/users/${userId}`;
                } else {
                    // –û–±—ã—á–Ω—ã–π –∞–¥–º–∏–Ω - —É–¥–∞–ª–µ–Ω–∏–µ –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
                    console.log('Removing user from context:', userId);
                    endpoint = `/api/users/${userId}/from-context`;
                }
                
                await apiCall(endpoint, {
                    method: 'DELETE'
                });

                showNotification(successMessage, 'success');
                
                // –£–¥–∞–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞
                if (window.allUsersCache) {
                    window.allUsersCache = window.allUsersCache.filter(u => u.id !== userId);
                }
                
                // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É —Å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–º —Å–ø–∏—Å–∫–æ–º
                const activeUsersBtn = document.querySelector('.tab.active');
                if (activeUsersBtn && activeUsersBtn.textContent.includes('–ê–∫—Ç–∏–≤–Ω—ã–µ')) {
                    displayUsers(window.allUsersCache || []);
                } else {
                    displayInvitedUsers(window.allUsersCache || []);
                }
            } catch (error) {
                console.error('Error deleting user:', error);
                // Backend –≤–µ—Ä–Ω—ë—Ç 403 –µ—Å–ª–∏ –Ω–µ—Ç –ø—Ä–∞–≤
                showNotification('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ' + error.message, 'error');
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function closeEditUserModal() {
            document.getElementById('editUserModal').style.display = 'none';
        }

        async function loadTeamsForEdit() {
            try {
                const response = await apiCall('/api/teams/accessible', { method: 'GET' });
                const teams = Array.isArray(response) ? response : (response.teams || response.data || []);
                
                const teamSelect = document.getElementById('editUserTeam');
                teamSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É</option>';
                
                teams.forEach(team => {
                    const option = document.createElement('option');
                    option.value = team.id;
                    option.textContent = team.name;
                    teamSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading teams for edit:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–∞–Ω–¥', 'error');
            }
        }

        async function loadTeamsForTransfer() {
            try {
                const response = await apiCall('/api/teams/accessible', { method: 'GET' });
                const teams = Array.isArray(response) ? response : (response.teams || response.data || []);
                
                const toTeamSelect = document.getElementById('transferToTeam');
                toTeamSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É</option>';
                
                teams.forEach(team => {
                    const option = document.createElement('option');
                    option.value = team.id;
                    option.textContent = team.name;
                    toTeamSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading teams for transfer:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–∞–Ω–¥', 'error');
            }
        }

        async function loadOrganizationsForEdit() {
            try {
                const response = await apiCall('/api/organizations', { method: 'GET' });
                const organizations = Array.isArray(response) ? response : (response.organizations || response.data || []);
                
                const orgSelect = document.getElementById('editUserOrganization');
                orgSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é</option>';
                
                organizations.forEach(org => {
                    const option = document.createElement('option');
                    option.value = org.id;
                    option.textContent = org.name;
                    orgSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading organizations for edit:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π', 'error');
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–µ—Ä–µ–Ω–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function closeTransferUserModal() {
            document.getElementById('transferUserModal').style.display = 'none';
        }

        function transferUser(userId) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø—ã—Ç–∞–µ—Ç—Å—è –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ —Å–∞–º–æ–≥–æ —Å–µ–±—è
            if (currentUser && userId === currentUser.id) {
                showNotification('–í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ —Å–∞–º–æ–≥–æ —Å–µ–±—è –≤ –¥—Ä—É–≥—É—é –∫–æ–º–∞–Ω–¥—É', 'error');
                return;
            }

            const user = currentUsersList.find(u => u.id === userId);
            if (!user) {
                showNotification('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                return;
            }

            // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            document.getElementById('transferUserId').value = user.id;
            document.getElementById('transferUserEmail').value = user.email;

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–º–∞–Ω–¥—ã –∏ —Ä–æ–ª–∏
            loadTeamsForTransfer(user);
            loadRolesForTransfer();

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            document.getElementById('transferUserModal').style.display = 'block';
        }

        // Change User Role Functions
        function closeChangeUserRoleModal() {
            document.getElementById('changeUserRoleModal').style.display = 'none';
        }

        function changeUserRole(userId) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø—ã—Ç–∞–µ—Ç—Å—è –∏–∑–º–µ–Ω–∏—Ç—å —Å–≤–æ—é —Ä–æ–ª—å
            if (currentUser && userId === currentUser.id) {
                showNotification('–í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Å–≤–æ—é —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—É—é —Ä–æ–ª—å', 'error');
                return;
            }

            const user = currentUsersList.find(u => u.id === userId);
            if (!user) {
                showNotification('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                return;
            }

            // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            document.getElementById('changeUserRoleUserId').value = user.id;
            document.getElementById('changeUserRoleEmail').value = user.email;

            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–æ–ª–∏
            loadRolesForChangeRole();

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            document.getElementById('changeUserRoleModal').style.display = 'block';
        }

        async function loadTeamsForTransfer(user) {
            try {
                const response = await apiCall('/api/teams/accessible', { method: 'GET' });
                const teams = Array.isArray(response) ? response : (response.teams || response.data || []);
                
                const fromTeamSelect = document.getElementById('transferFromTeam');
                const toTeamSelect = document.getElementById('transferToTeam');
                
                // –û—á–∏—â–∞–µ–º —Å–µ–ª–µ–∫—Ç—ã
                fromTeamSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É</option>';
                toTeamSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É</option>';
                
                // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –∫–æ–º–∞–Ω–¥—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const userTeams = user.teams || [];
                const userTeamIds = userTeams.map(team => team.id);
                
                console.log(`üîç User ${user.email} is in teams:`, userTeamIds);
                
                teams.forEach(team => {
                    // –î–ª—è "–ò–∑ –∫–æ–º–∞–Ω–¥—ã" - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∫–æ–º–∞–Ω–¥—ã, –≥–¥–µ —Å–æ—Å—Ç–æ–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                    if (userTeamIds.includes(team.id)) {
                        const fromOption = document.createElement('option');
                        fromOption.value = team.id;
                        fromOption.textContent = team.name;
                        fromTeamSelect.appendChild(fromOption);
                    }
                    
                    // –î–ª—è "–í –∫–æ–º–∞–Ω–¥—É" - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–º–∞–Ω–¥—ã, –≥–¥–µ –ù–ï —Å–æ—Å—Ç–æ–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                    if (!userTeamIds.includes(team.id)) {
                        const toOption = document.createElement('option');
                        toOption.value = team.id;
                        toOption.textContent = team.name;
                        toTeamSelect.appendChild(toOption);
                    }
                });
                
                // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ—Å—Ç–æ–∏—Ç —Ç–æ–ª—å–∫–æ –≤ –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–µ - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ–º –µ—ë
                if (userTeamIds.length === 1) {
                    fromTeamSelect.value = userTeamIds[0];
                }
                // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ—Å—Ç–æ–∏—Ç –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∫–æ–º–∞–Ω–¥–∞—Ö - –Ω–µ –≤—ã–±–∏—Ä–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
                // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω —Å–∞–º –≤—ã–±—Ä–∞—Ç—å, –∏–∑ –∫–∞–∫–æ–π –∫–æ–º–∞–Ω–¥—ã –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å
                
                console.log(`‚úÖ Loaded ${fromTeamSelect.children.length - 1} source teams and ${toTeamSelect.children.length - 1} destination teams`);
            } catch (error) {
                console.error('Error loading teams for transfer:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–∞–Ω–¥', 'error');
            }
        }

        async function loadRolesForTransfer() {
            try {
                const response = await apiCall('/api/roles', { method: 'GET' });
                const roles = Array.isArray(response) ? response : (response.roles || response.data || []);
                
                const roleSelect = document.getElementById('transferUserRole');
                roleSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å</option>';
                
                roles.forEach(role => {
                    const option = document.createElement('option');
                    option.value = role.id;
                    option.textContent = `${role.name} - ${role.description || ''}`;
                    roleSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading roles for transfer:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–æ–ª–µ–π', 'error');
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–æ–ª–µ–π –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è/–∫–æ–º–∞–Ω–¥–∞)
        async function loadRolesForContext(contextType, contextId) {
            try {
                let url;
                if (contextType === 'organization') {
                    url = `/api/organizations/${contextId}/roles`;
                } else if (contextType === 'team') {
                    url = `/api/teams/${contextId}/roles`;
                } else {
                    console.error('Invalid context type:', contextType);
                    return;
                }

                const response = await apiCall(url, { method: 'GET' });
                const roles = Array.isArray(response) ? response : (response.roles || response.data || []);
                
                console.log(`üîç Loaded roles for ${contextType} ${contextId}:`, roles);
                
                const roleSelect = document.getElementById('changeUserRoleNewRole');
                roleSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å</option>';
                
                // –†–æ–ª–∏ —É–∂–µ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω—ã –Ω–∞ backend –ø–æ —É—Ä–æ–≤–Ω—é —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                roles.forEach(role => {
                    const option = document.createElement('option');
                    option.value = role.id;
                    option.textContent = `${role.name} - ${role.description || ''}`;
                    roleSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading roles for context:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–æ–ª–µ–π: ' + error.message, 'error');
            }
        }

        // –°—Ç–∞—Ä–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
        async function loadRolesForChangeRole() {
            console.warn('loadRolesForChangeRole is deprecated. Use loadRolesForContext instead.');
        }

        async function loadOrganizationsForChangeRole() {
            try {
                const response = await apiCall('/api/organizations', { method: 'GET' });
                const organizations = Array.isArray(response) ? response : (response.organizations || response.data || []);
                
                const orgSelect = document.getElementById('changeUserRoleOrganization');
                orgSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é</option>';
                
                organizations.forEach(org => {
                    const option = document.createElement('option');
                    option.value = org.id;
                    option.textContent = org.name;
                    orgSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading organizations for change role:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π', 'error');
            }
        }

        async function loadTeamsForChangeRole() {
            try {
                const response = await apiCall('/api/teams/accessible', { method: 'GET' });
                const teams = Array.isArray(response) ? response : (response.teams || response.data || []);
                
                const teamSelect = document.getElementById('changeUserRoleTeam');
                teamSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É</option>';
                
                teams.forEach(team => {
                    const option = document.createElement('option');
                    option.value = team.id;
                    option.textContent = team.name;
                    teamSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading teams for change role:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–∞–Ω–¥', 'error');
            }
        }

        async function transferUserSubmit() {
            const userId = document.getElementById('transferUserId').value;
            const fromTeamId = document.getElementById('transferFromTeam').value;
            const toTeamId = document.getElementById('transferToTeam').value;
            const roleId = document.getElementById('transferUserRole').value;

            if (!userId || !fromTeamId || !toTeamId || !roleId) {
                showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
                return;
            }

            if (fromTeamId === toTeamId) {
                showNotification('–ö–æ–º–∞–Ω–¥—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ä–∞–∑–Ω—ã–º–∏', 'error');
                return;
            }

            try {
                showLoading('transferUserBtn', 'transferUserText', 'transferUserLoading');

                await apiCall(`/api/users/${userId}/transfer-team`, {
                    method: 'PATCH',
                    body: JSON.stringify({
                        fromTeamId: fromTeamId,
                        toTeamId: toTeamId,
                        roleId: roleId
                    })
                });

                hideLoading('transferUserBtn', 'transferUserText', 'transferUserLoading');
                showNotification('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω', 'success');
                closeTransferUserModal();
                loadUsers(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            } catch (error) {
                hideLoading('transferUserBtn', 'transferUserText', 'transferUserLoading');
                console.error('Error transferring user:', error);
                showNotification('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–Ω–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ' + error.message, 'error');
            }
        }

        // Change User Role Submit
        async function changeUserRoleSubmit() {
            const userId = document.getElementById('changeUserRoleUserId').value;
            const context = document.getElementById('changeUserRoleContext').value;
            const organizationId = document.getElementById('changeUserRoleOrganization').value;
            const teamId = document.getElementById('changeUserRoleTeam').value;
            const roleId = document.getElementById('changeUserRoleNewRole').value;

            if (!userId || !context || !roleId) {
                showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', 'error');
                return;
            }

            if (context === 'organization' && !organizationId) {
                showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é', 'error');
                return;
            }

            if (context === 'team' && !teamId) {
                showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É', 'error');
                return;
            }

            try {
                showLoading('changeUserRoleBtn', 'changeUserRoleText', 'changeUserRoleLoading');

                const requestBody = {
                    roleId: roleId
                };

                if (context === 'organization') {
                    requestBody.organizationId = organizationId;
                } else if (context === 'team') {
                    requestBody.teamId = teamId;
                }

                await apiCall(`/api/users/${userId}/change-role`, {
                    method: 'PATCH',
                    body: JSON.stringify(requestBody)
                });

                hideLoading('changeUserRoleBtn', 'changeUserRoleText', 'changeUserRoleLoading');
                showNotification('–†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–∞', 'success');
                closeChangeUserRoleModal();
                loadUsers(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            } catch (error) {
                hideLoading('changeUserRoleBtn', 'changeUserRoleText', 'changeUserRoleLoading');
                console.error('Error changing user role:', error);
                showNotification('–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–æ–ª–∏: ' + error.message, 'error');
            }
        }

        function toggleEditTarget() {
            const targetType = document.getElementById('editUserTargetType').value;
            const teamGroup = document.getElementById('editUserTeamGroup');
            const orgGroup = document.getElementById('editUserOrgGroup');
            
            if (targetType === 'team') {
                teamGroup.style.display = 'block';
                orgGroup.style.display = 'none';
            } else {
                teamGroup.style.display = 'none';
                orgGroup.style.display = 'block';
            }
        }

        async function saveUserChanges() {
            const userId = document.getElementById('editUserId').value;
            const targetType = document.getElementById('editUserTargetType').value;
            const teamId = document.getElementById('editUserTeam').value;
            const organizationId = document.getElementById('editUserOrganization').value;

            if (!userId) {
                showNotification('–û—à–∏–±–∫–∞: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                return;
            }

            if (targetType === 'team' && !teamId) {
                showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É', 'error');
                return;
            }

            if (targetType === 'organization' && !organizationId) {
                showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é', 'error');
                return;
            }

            try {
                showLoading('editUserBtn', 'editUserText', 'editUserLoading');

                if (targetType === 'team' && teamId) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    console.log('Updating user team:', userId, teamId);
                    await apiCall(`/api/users/${userId}/team`, {
                        method: 'PATCH',
                        body: JSON.stringify({ teamId })
                    });
                } else if (targetType === 'organization' && organizationId) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    console.log('Updating user organization:', userId, organizationId);
                    await apiCall(`/api/users/${userId}/organization`, {
                        method: 'PATCH',
                        body: JSON.stringify({ organizationId })
                    });
                }

                hideLoading('editUserBtn', 'editUserText', 'editUserLoading');
                showNotification('–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ', 'success');
                closeEditUserModal();
                
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                console.log('Reloading users after change...');
                await loadUsers();
            } catch (error) {
                hideLoading('editUserBtn', 'editUserText', 'editUserLoading');
                console.error('Error saving user changes:', error);
                showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π: ' + error.message, 'error');
            }
        }

        async function transferUserSubmit() {
            const userId = document.getElementById('transferUserId').value;
            const fromTeamId = document.getElementById('transferFromTeam').value;
            const toTeamId = document.getElementById('transferToTeam').value;

            if (!userId) {
                showNotification('–û—à–∏–±–∫–∞: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                return;
            }

            if (!fromTeamId && !toTeamId) {
                showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞', 'error');
                return;
            }

            try {
                showLoading('transferUserBtn', 'transferUserText', 'transferUserLoading');

                console.log('Transferring user:', userId, 'from:', fromTeamId, 'to:', toTeamId);
                await apiCall(`/api/users/${userId}/transfer-team`, {
                    method: 'PATCH',
                    body: JSON.stringify({ 
                        fromTeamId: fromTeamId || null, 
                        toTeamId: toTeamId || null 
                    })
                });

                hideLoading('transferUserBtn', 'transferUserText', 'transferUserLoading');
                showNotification('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω', 'success');
                closeTransferUserModal();
                
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                console.log('Reloading users after transfer...');
                await loadUsers();
            } catch (error) {
                hideLoading('transferUserBtn', 'transferUserText', 'transferUserLoading');
                console.error('Error transferring user:', error);
                showNotification('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–Ω–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ' + error.message, 'error');
            }
        }

        function closeTransferUserModal() {
            document.getElementById('transferUserModal').style.display = 'none';
        }

        function editOrganization(orgId) {
            showNotification('–§—É–Ω–∫—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'warning');
        }

        function resendInvitation(invitationId) {
            showNotification('–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–≤—Ç–æ—Ä–Ω–æ', 'success');
        }

        function showInviteModal() {
            document.getElementById('inviteUserModal').style.display = 'block';
            // –û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É
            document.getElementById('inviteUserForm').reset();
            // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π –∏ –∫–æ–º–∞–Ω–¥
            loadOrganizationsForInvite();
            loadTeamsForInvite();
        }

        function closeInviteUserModal() {
            document.getElementById('inviteUserModal').style.display = 'none';
        }

        function showCreateTeamModal() {
            document.getElementById('createTeamModal').style.display = 'block';
            // –û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É
            document.getElementById('createTeamForm').reset();
            // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π
            loadOrganizationsForTeam();
        }

        function showCreateOrgModal() {
            document.getElementById('createOrgModal').style.display = 'block';
            // –û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É
            document.getElementById('createOrgForm').reset();
        }

        function closeCreateOrgModal() {
            document.getElementById('createOrgModal').style.display = 'none';
        }

        function showNotifications() {
            showNotification('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info');
        }

        // Initialize modals
        function initializeModals() {
            // Organization creation form
            document.getElementById('createOrgForm')?.addEventListener('submit', async function(e) {
                e.preventDefault();
                await createOrganization();
            });

            // Team creation form
            document.getElementById('createTeamForm')?.addEventListener('submit', async function(e) {
                e.preventDefault();
                await createTeam();
            });

            // Invite user form
            document.getElementById('inviteUserForm')?.addEventListener('submit', async function(e) {
                e.preventDefault();
                await sendInvitation();
            });

            // Edit user form
            document.getElementById('editUserForm')?.addEventListener('submit', async function(e) {
                e.preventDefault();
                await saveUserChanges();
            });

            // Transfer user form
            document.getElementById('transferUserForm')?.addEventListener('submit', async function(e) {
                e.preventDefault();
                await transferUserSubmit();
            });

            // Change user role form
            document.getElementById('changeUserRoleForm')?.addEventListener('submit', async function(e) {
                e.preventDefault();
                await changeUserRoleSubmit();
            });

            // Change User Role Context Handler
            document.getElementById('changeUserRoleContext')?.addEventListener('change', function() {
                const context = this.value;
                const orgGroup = document.getElementById('changeUserRoleOrganizationGroup');
                const teamGroup = document.getElementById('changeUserRoleTeamGroup');

                if (context === 'organization') {
                    orgGroup.style.display = 'block';
                    teamGroup.style.display = 'none';
                    loadOrganizationsForChangeRole();
                } else if (context === 'team') {
                    orgGroup.style.display = 'none';
                    teamGroup.style.display = 'block';
                    loadTeamsForChangeRole();
                } else {
                    orgGroup.style.display = 'none';
                    teamGroup.style.display = 'none';
                }
            });

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ - –∑–∞–≥—Ä—É–∂–∞–µ–º —Ä–æ–ª–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
            document.getElementById('changeUserRoleOrganization')?.addEventListener('change', function() {
                const organizationId = this.value;
                if (organizationId) {
                    loadRolesForContext('organization', organizationId);
                }
            });

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –∫–æ–º–∞–Ω–¥—ã - –∑–∞–≥—Ä—É–∂–∞–µ–º —Ä–æ–ª–∏ –∫–æ–º–∞–Ω–¥—ã
            document.getElementById('changeUserRoleTeam')?.addEventListener('change', function() {
                const teamId = this.value;
                if (teamId) {
                    loadRolesForContext('team', teamId);
                }
            });

            // Close modals when clicking outside
            window.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal')) {
                    e.target.style.display = 'none';
                }
            });
        }

        // Create organization
        async function createOrganization() {
            const formData = {
                name: document.getElementById('orgName').value,
                description: document.getElementById('orgDescription').value
            };

            const createBtn = document.getElementById('createOrgBtn');
            const createText = document.getElementById('createOrgText');
            const createLoading = document.getElementById('createOrgLoading');

            try {
                showLoading('createOrgBtn', 'createOrgText', 'createOrgLoading');

                const response = await apiCall('/api/organizations', {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });

                if (response) {
                    showNotification('–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ!', 'success');
                    closeCreateOrgModal();
                    // Reload organizations if we're on that page
                    const organizationsSection = document.getElementById('organizations');
                    if (organizationsSection && organizationsSection.style.display !== 'none') {
                        await loadOrganizations();
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏:', error);
                console.log('Error details:', error);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ
                const errorMessage = error.message || error.error || error.toString();
                if (errorMessage.includes('—É–∂–µ —Å–æ–∑–¥–∞–ª–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é') || 
                    errorMessage.includes('–û–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–Ω—É –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é')) {
                    showNotification('–í—ã —É–∂–µ —Å–æ–∑–¥–∞–ª–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é. –û–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–Ω—É –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é.', 'error');
                } else {
                    showNotification('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏: ' + errorMessage, 'error');
                }
            } finally {
                hideLoading('createOrgBtn', 'createOrgText', 'createOrgLoading');
            }
        }

        // Create team
        async function createTeam() {
            const formData = {
                name: document.getElementById('teamName').value,
                description: document.getElementById('teamDescription').value,
                organizationId: document.getElementById('teamOrganization').value
            };

            const createBtn = document.getElementById('createTeamBtn');
            const createText = document.getElementById('createTeamText');
            const createLoading = document.getElementById('createTeamLoading');

            try {
                showLoading('createTeamBtn', 'createTeamText', 'createTeamLoading');

                const response = await apiCall('/api/teams', {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });

                if (response) {
                    showNotification('–ö–æ–º–∞–Ω–¥–∞ —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ!', 'success');
                    closeCreateTeamModal();
                    // Reload teams if we're on that page
                    const teamsSection = document.getElementById('teams');
                    if (teamsSection && teamsSection.style.display !== 'none') {
                        await loadTeams();
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã:', error);
                showNotification('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã: ' + error.message, 'error');
            } finally {
                hideLoading('createTeamBtn', 'createTeamText', 'createTeamLoading');
            }
        }

        function closeCreateTeamModal() {
            document.getElementById('createTeamModal').style.display = 'none';
        }

        // Bind Email Modal
        function showBindEmailModal() {
            document.getElementById('bindEmailModal').style.display = 'block';
            document.getElementById('bindEmailInput').value = '';
            document.getElementById('bindEmailPassword').value = '';
            setTimeout(() => document.getElementById('bindEmailInput').focus(), 100);
        }

        function closeBindEmailModal() {
            document.getElementById('bindEmailModal').style.display = 'none';
            document.getElementById('bindEmailForm').reset();
        }

        async function handleBindEmail(event) {
            event.preventDefault();
            const email = document.getElementById('bindEmailInput').value;
            const password = document.getElementById('bindEmailPassword').value;
            
            if (!email || !password) {
                showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
                return;
            }

            const btn = document.getElementById('bindEmailBtn');
            const btnText = document.getElementById('bindEmailBtnText');
            const loading = document.getElementById('bindEmailLoading');
            
            btn.disabled = true;
            btnText.classList.add('hidden');
            loading.classList.remove('hidden');

            try {
                console.log('üîç [handleBindEmail] Sending bind request for email:', email);
                const result = await apiCall('/api/auth/multi/bind', {
                    method: 'POST',
                    body: JSON.stringify({ authMethod: 'EMAIL', identifier: email, password })
                });
                console.log('‚úÖ [handleBindEmail] Bind result:', result);
                
                if (result && result.success === false) {
                    showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏–≤—è–∑–∫–∏: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
                    return;
                }
                
                showNotification(result?.message || 'Email –ø—Ä–∏–≤—è–∑–∞–Ω', 'success');
                closeBindEmailModal();
                
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π, —á—Ç–æ–±—ã –ë–î –æ–±–Ω–æ–≤–∏–ª–∞—Å—å
                setTimeout(async () => {
                    await loadSettings();
                }, 500);
            } catch (e) {
                console.error('‚ùå [handleBindEmail] Error:', e);
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏–≤—è–∑–∫–∏: ' + (e.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
            } finally {
                btn.disabled = false;
                btnText.classList.remove('hidden');
                loading.classList.add('hidden');
            }
        }

        // Load organizations for team creation
        async function loadOrganizationsForTeam() {
            try {
                const response = await apiCall('/api/organizations', { method: 'GET' });
                const select = document.getElementById('teamOrganization');
                select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é</option>';
                
                // Handle both array and object responses
                const organizations = Array.isArray(response) ? response : (response?.organizations || []);
                
                if (organizations && Array.isArray(organizations)) {
                    organizations.forEach(org => {
                        const option = document.createElement('option');
                        option.value = org.id;
                        option.textContent = org.name;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π', 'error');
            }
        }

        // Load organizations for invite
        async function loadOrganizationsForInvite() {
            try {
                const response = await apiCall('/api/organizations', { method: 'GET' });
                const select = document.getElementById('inviteOrganization');
                select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é</option>';
                
                // Handle both array and object responses
                const organizations = Array.isArray(response) ? response : (response?.organizations || []);
                
                if (organizations && Array.isArray(organizations)) {
                    organizations.forEach(org => {
                        const option = document.createElement('option');
                        option.value = org.id;
                        option.textContent = org.name;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π', 'error');
            }
        }

        // Load teams for invite
        async function loadTeamsForInvite() {
            try {
                const response = await apiCall('/api/teams/accessible', { method: 'GET' });
                const select = document.getElementById('inviteTeam');
                select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É</option>';
                
                // Handle both array and object responses
                const teams = Array.isArray(response) ? response : (response?.teams || []);
                
                if (teams && Array.isArray(teams)) {
                    teams.forEach(team => {
                        const option = document.createElement('option');
                        option.value = team.id;
                        option.textContent = team.name;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–∞–Ω–¥:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–∞–Ω–¥', 'error');
            }
        }

        // Load roles for invitation
        async function loadRolesForInvite(type) {
            try {
                const roleSelect = document.getElementById('inviteRole');
                if (!roleSelect) {
                    console.error('Role select element not found');
                    return;
                }
                roleSelect.innerHTML = '<option value="">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–æ–ª–µ–π...</option>';
                roleSelect.disabled = true;
                
                if (type === 'team') {
                    // –î–ª—è –∫–æ–º–∞–Ω–¥—ã –∑–∞–≥—Ä—É–∂–∞–µ–º —Ä–æ–ª–∏ –∫–æ–º–∞–Ω–¥—ã
                    const teamId = document.getElementById('inviteTeam')?.value;
                    if (!teamId) {
                        roleSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É</option>';
                        roleSelect.disabled = false;
                        return;
                    }
                    
                    const response = await apiCall(`/api/teams/${teamId}/roles`, {
                        method: 'GET'
                    });
                    
                    // Handle different response formats
                    const roles = Array.isArray(response) ? response : (response?.roles || response?.data || []);
                    
                    roleSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å</option>';
                    roleSelect.disabled = false;
                    
                    if (roles && roles.length > 0) {
                        roles.forEach(role => {
                            const option = document.createElement('option');
                            option.value = role.id || role.value;
                            option.textContent = (role.name || role.label) + (role.description ? ' - ' + role.description : '');
                            roleSelect.appendChild(option);
                        });
                    } else {
                        roleSelect.innerHTML = '<option value="">–†–æ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</option>';
                    }
                } else if (type === 'organization') {
                    // –î–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º —Ä–æ–ª–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
                    const organizationId = document.getElementById('inviteOrganization')?.value;
                    if (!organizationId) {
                        roleSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é</option>';
                        roleSelect.disabled = false;
                        return;
                    }
                    
                    console.log(`üîç [loadRolesForInvite] Loading roles for organization ${organizationId}`);
                    const response = await apiCall(`/api/organizations/${organizationId}/roles`, {
                        method: 'GET'
                    });
                    console.log(`üîç [loadRolesForInvite] Response:`, response);
                    
                    // Handle different response formats
                    const roles = Array.isArray(response) ? response : (response?.roles || response?.data || []);
                    console.log(`üîç [loadRolesForInvite] Parsed ${roles.length} roles`);
                    
                    roleSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å</option>';
                    roleSelect.disabled = false;
                    
                    if (roles && roles.length > 0) {
                        console.log(`‚úÖ [loadRolesForInvite] Adding ${roles.length} roles to select`);
                        roles.forEach(role => {
                            const option = document.createElement('option');
                            option.value = role.id || role.value;
                            option.textContent = (role.name || role.label) + (role.description ? ' - ' + role.description : '');
                            roleSelect.appendChild(option);
                        });
                    } else {
                        console.warn(`‚ö†Ô∏è [loadRolesForInvite] No roles found, showing error message`);
                        roleSelect.innerHTML = '<option value="">–†–æ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</option>';
                    }
                }
            } catch (error) {
                console.error('Error loading roles:', error);
                const roleSelect = document.getElementById('inviteRole');
                if (roleSelect) {
                    roleSelect.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–æ–ª–µ–π</option>';
                    roleSelect.disabled = false;
                }
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–æ–ª–µ–π: ' + (error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
            }
        }

        // Toggle invite target based on type
        function toggleInviteTarget() {
            const type = document.getElementById('inviteType').value;
            const orgGroup = document.getElementById('inviteOrganizationGroup');
            const teamGroup = document.getElementById('inviteTeamGroup');
            const roleGroup = document.getElementById('inviteRoleGroup');
            
            if (type === 'organization') {
                orgGroup.style.display = 'block';
                teamGroup.style.display = 'none';
                roleGroup.style.display = 'block';
                document.getElementById('inviteOrganization').required = true;
                document.getElementById('inviteTeam').required = false;
                document.getElementById('inviteRole').required = true;
                loadOrganizationsForInvite();
                // –†–æ–ª–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
            } else if (type === 'team') {
                orgGroup.style.display = 'none';
                teamGroup.style.display = 'block';
                roleGroup.style.display = 'block';
                document.getElementById('inviteOrganization').required = false;
                document.getElementById('inviteTeam').required = true;
                document.getElementById('inviteRole').required = true;
                loadTeamsForInvite();
                // –†–æ–ª–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –∫–æ–º–∞–Ω–¥—ã
            } else {
                orgGroup.style.display = 'none';
                teamGroup.style.display = 'none';
                roleGroup.style.display = 'none';
                document.getElementById('inviteOrganization').required = false;
                document.getElementById('inviteTeam').required = false;
                document.getElementById('inviteRole').required = false;
            }
        }

        // Toggle invite identifier type
        function toggleInviteIdentifierType() {
            const identifierType = document.getElementById('inviteIdentifierType').value;
            const emailGroup = document.getElementById('inviteEmailGroup');
            const githubGroup = document.getElementById('inviteGithubGroup');
            const telegramGroup = document.getElementById('inviteTelegramGroup');
            const emailInput = document.getElementById('inviteEmail');
            const githubUsernameInput = document.getElementById('inviteGithubUsername');
            const telegramInput = document.getElementById('inviteTelegramUsername');

            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –≥—Ä—É–ø–ø—ã –∏ –æ—á–∏—â–∞–µ–º –ø–æ–ª—è
            if (emailGroup) emailGroup.style.display = 'none';
            if (githubGroup) githubGroup.style.display = 'none';
            if (telegramGroup) telegramGroup.style.display = 'none';
            if (emailInput) emailInput.required = false;
            if (githubUsernameInput) githubUsernameInput.required = false;
            if (telegramInput) telegramInput.required = false;

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—É—é –≥—Ä—É–ø–ø—É
            if (identifierType === 'email') {
                if (emailGroup) emailGroup.style.display = 'block';
                if (emailInput) emailInput.required = true;
            } else if (identifierType === 'github') {
                if (githubGroup) githubGroup.style.display = 'block';
                if (githubUsernameInput) githubUsernameInput.required = true;
            } else if (identifierType === 'telegram') {
                if (telegramGroup) telegramGroup.style.display = 'block';
                if (telegramInput) telegramInput.required = true;
            }
        }


        // Send invitation
        async function sendInvitation() {
            const identifierType = document.getElementById('inviteIdentifierType').value;
            const email = document.getElementById('inviteEmail').value;
            const githubUsername = document.getElementById('inviteGithubUsername').value;
            const telegramUsername = document.getElementById('inviteTelegramUsername').value;
            const targetType = document.getElementById('inviteType').value;

            if (!identifierType || !targetType) {
                showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', 'error');
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —É–∫–∞–∑–∞–Ω —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä
            if (identifierType === 'email' && !email) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ email', 'error');
                return;
            }
            if (identifierType === 'github' && !githubUsername) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ GitHub username', 'error');
                return;
            }
            if (identifierType === 'telegram' && !telegramUsername) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ Telegram username', 'error');
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø—Ä–∏–≥–ª–∞—à–∞–µ—Ç —Å–∞–º —Å–µ–±—è (—Ç–æ–ª—å–∫–æ –¥–ª—è email)
            if (identifierType === 'email') {
                const currentUser = JSON.parse(localStorage.getItem('userData') || '{}');
                if (email === currentUser.email) {
                    showNotification('–í—ã –Ω–µ –º–æ–∂–µ—Ç–µ –ø—Ä–∏–≥–ª–∞—Å–∏—Ç—å —Å–∞–º–æ–≥–æ —Å–µ–±—è', 'error');
                    return;
                }
            }

            const formData = {
                type: targetType
            };

            // –î–æ–±–∞–≤–ª—è–µ–º –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
            if (identifierType === 'email') {
                formData.email = email;
            } else if (identifierType === 'github') {
                formData.githubUsername = githubUsername;
            } else if (identifierType === 'telegram') {
                formData.telegramUsername = telegramUsername;
            }

            // Add target based on type
            if (targetType === 'organization') {
                const organizationId = document.getElementById('inviteOrganization').value;
                if (!organizationId) {
                    showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é', 'error');
                    return;
                }
                formData.organizationId = organizationId;
            } else if (targetType === 'team') {
                const teamId = document.getElementById('inviteTeam').value;
                if (!teamId) {
                    showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É', 'error');
                    return;
                }
                formData.teamId = teamId;
            }

            // Add role
            const roleId = document.getElementById('inviteRole').value;
            if (!roleId) {
                showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å', 'error');
                return;
            }
            formData.roleId = roleId;

            try {
                showLoading('inviteUserBtn', 'inviteUserText', 'inviteUserLoading');

                const response = await apiCall('/api/invitations', {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });

                if (response) {
                    // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É –ü–ï–†–ï–î –∑–∞–∫—Ä—ã—Ç–∏–µ–º –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
                    document.getElementById('inviteIdentifierType').value = '';
                    document.getElementById('inviteEmail').value = '';
                    document.getElementById('inviteGithubUsername').value = '';
                    document.getElementById('inviteTelegramUsername').value = '';
                    document.getElementById('inviteType').value = '';
                    toggleInviteIdentifierType(); // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –ø–æ–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
                    const teamGroup = document.getElementById('inviteTeamGroup');
                    const orgGroup = document.getElementById('inviteOrgGroup');
                    if (teamGroup) {
                        document.getElementById('inviteTeam').value = '';
                        teamGroup.style.display = 'none';
                    }
                    if (orgGroup) {
                        document.getElementById('inviteOrganization').value = '';
                        orgGroup.style.display = 'none';
                    }
                    document.getElementById('inviteRoleGroup').style.display = 'none';
                    document.getElementById('inviteRole').value = '';
                    
                    showNotification('–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!', 'success');
                    closeInviteUserModal();
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π –ò –ø—Ä–∏–≥–ª–∞—à–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                    console.log('üîÑ –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–∫–∏ –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏...');
                    await loadInvitations();
                    await loadInvitedUsers(); // –î–æ–±–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                    console.log('‚úÖ –°–ø–∏—Å–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è:', error);
                showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è: ' + error.message, 'error');
            } finally {
                hideLoading('inviteUserBtn', 'inviteUserText', 'inviteUserLoading');
            }
        }

        // Load invitations
        async function loadInvitations() {
            console.log('loadInvitations called');
            try {
                // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π
                const container = document.getElementById('invitationsContainer');
                if (container) {
                    container.innerHTML = '<div class="loading-placeholder">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π...</div>';
                }
                
                const response = await apiCall('/api/invitations/my', { method: 'GET' });
                console.log('Invitations response:', response);
                console.log('Response type:', typeof response);
                console.log('Response length:', response ? response.length : 'null');
                displayInvitations(response);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π:', error);
                document.getElementById('invitationsContainer').innerHTML = 
                    '<p style="color: #EF4444; text-align: center; padding: 20px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π</p>';
            }
        }

        // Display invitations
        function displayInvitations(invitations) {
            console.log('üé® DISPLAY_INVITATIONS –≤—ã–∑–≤–∞–Ω–∞ —Å:', invitations);
            console.log('üìä –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π:', invitations ? invitations.length : 'null');
            const container = document.getElementById('invitationsContainer');
            console.log('üì¶ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–∞–π–¥–µ–Ω:', !!container);
            console.log('üì¶ –¢–µ–∫—É—â–µ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:', container ? container.innerHTML.length : 'null');
            
            // Handle different response formats
            let invitationList = invitations;
            if (invitations && typeof invitations === 'object' && !Array.isArray(invitations)) {
                // If it's an object, try to extract the array
                invitationList = invitations.invitations || invitations.data || invitations;
            }
            
            console.log('Processed invitationList:', invitationList);
            console.log('Is array:', Array.isArray(invitationList));
            console.log('Length:', invitationList ? invitationList.length : 'null');
            
            if (!invitationList || !Array.isArray(invitationList) || invitationList.length === 0) {
                console.log('No invitations found, showing empty state');
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6B7280;">
                        <i class="fas fa-envelope-open" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                        <h3>–ù–µ—Ç –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π</h3>
                        <p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π –≤ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –∏–ª–∏ –∫–æ–º–∞–Ω–¥—ã</p>
                    </div>
                `;
                return;
            }
            
            console.log('Rendering invitations...');
            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            container.style.display = 'block';
            container.style.visibility = 'visible';
            container.style.opacity = '1';

            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
            container.innerHTML = '';
            
            // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è DOM
            setTimeout(() => {
                console.log('üé® –†–µ–Ω–¥–µ—Ä–∏–º –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ:', invitationList.length);
                container.innerHTML = invitationList.map(invitation => `
                <div class="invitation-item" style="
                    border: 1px solid #E5E7EB;
                    border-radius: 12px;
                    padding: 20px;
                    margin-bottom: 16px;
                    background: #F9FAFB;
                    transition: all 0.3s ease;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                        <div>
                            <h3 style="margin: 0 0 8px 0; color: #1F2937; font-size: 1.1rem;">
                                ${invitation.type === 'organization' ? '–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è' : '–ö–æ–º–∞–Ω–¥–∞'}: ${invitation.targetName || (invitation.teamId ? '–ö–æ–º–∞–Ω–¥–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∞' : '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ')}
                            </h3>
                            <p style="margin: 0; color: #6B7280; font-size: 0.9rem;">
                                –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –æ—Ç: ${invitation.inviterName || invitation.inviterEmail}
                            </p>
                        </div>
                        <span class="status-badge ${getInvitationStatusClass(invitation.status)}">
                            ${getInvitationStatusText(invitation.status)}
                        </span>
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <p style="margin: 0; color: #374151; line-height: 1.5;">
                            ${invitation.message || '–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –≤ ' + (invitation.type === 'organization' ? '–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é' : '–∫–æ–º–∞–Ω–¥—É')}
                        </p>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="font-size: 0.875rem; color: #6B7280;">
                            <i class="fas fa-clock"></i>
                            ${new Date(invitation.createdAt).toLocaleDateString('ru-RU', {
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            })}
                        </div>
                        
                        ${invitation.status === 'pending' ? `
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-success btn-sm" onclick="respondToInvitation('${invitation.id}', 'accepted')">
                                    <i class="fas fa-check"></i>
                                    –ü—Ä–∏–Ω—è—Ç—å
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="respondToInvitation('${invitation.id}', 'declined')">
                                    <i class="fas fa-times"></i>
                                    –û—Ç–∫–ª–æ–Ω–∏—Ç—å
                                </button>
                                <button class="btn btn-warning btn-sm" onclick="cancelInvitation('${invitation.id}')">
                                    <i class="fas fa-ban"></i>
                                    –û—Ç–º–µ–Ω–∏—Ç—å
                                </button>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');
                console.log('‚úÖ –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –æ—Ç—Ä–µ–Ω–¥–µ—Ä–µ–Ω—ã, –¥–ª–∏–Ω–∞ HTML:', container.innerHTML.length);
            }, 10); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è DOM
        }

        // Get invitation status class
        function getInvitationStatusClass(status) {
            switch (status) {
                case 'pending': return 'pending';
                case 'accepted': return 'active';
                case 'declined': return 'inactive';
                case 'expired': return 'inactive';
                default: return 'inactive';
            }
        }

        // Get invitation status text
        function getInvitationStatusText(status) {
            switch (status) {
                case 'pending': return '–û–∂–∏–¥–∞–µ—Ç –æ—Ç–≤–µ—Ç–∞';
                case 'accepted': return '–ü—Ä–∏–Ω—è—Ç–æ';
                case 'declined': return '–û—Ç–∫–ª–æ–Ω–µ–Ω–æ';
                case 'expired': return '–ò—Å—Ç–µ–∫–ª–æ';
                default: return '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
            }
        }

        // Respond to invitation
        async function respondToInvitation(invitationId, response) {
            try {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ endpoints –¥–ª—è –ø—Ä–∏–Ω—è—Ç–∏—è/–æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è
                const endpoint = response === 'accepted' 
                    ? `/api/invitations/accept-notification/${invitationId}`
                    : `/api/invitations/decline-notification/${invitationId}`;

                await apiCall(endpoint, {
                    method: 'POST'
                });

                const actionText = response === 'accepted' ? '–ø—Ä–∏–Ω—è—Ç–æ' : '–æ—Ç–∫–ª–æ–Ω–µ–Ω–æ';
                showNotification(`–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ ${actionText}`, 'success');
                
                // Reload invitations
                await loadInvitations();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ:', error);
                showNotification('–û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ: ' + error.message, 'error');
            }
        }

        // Cancel invitation
        async function cancelInvitation(invitationId) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å —ç—Ç–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ?')) {
                return;
            }

            try {
                console.log('üö® –û–¢–ú–ï–ù–ê –ü–†–ò–ì–õ–ê–®–ï–ù–ò–Ø:', invitationId);
                console.log('üìß –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–æ —É–¥–∞–ª–µ–Ω–∏—è:', document.getElementById('invitationsContainer').innerHTML.length);
                
                await apiCall(`/api/invitations/${invitationId}`, {
                    method: 'DELETE'
                });

                console.log('‚úÖ –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ —Å —Å–µ—Ä–≤–µ—Ä–∞');
                showNotification('–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ', 'success');
                
                // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º
                const container = document.getElementById('invitationsContainer');
                if (container) {
                    console.log('üßπ –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä...');
                    container.innerHTML = '<div class="loading-placeholder">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞...</div>';
                    console.log('üìß –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏:', container.innerHTML);
                }
                
                // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–æ–π
                setTimeout(async () => {
                    console.log('üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –∏ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...');
                    await loadInvitations();
                    await loadInvitedUsers(); // –î–æ–±–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                    console.log('‚úÖ –°–ø–∏—Å–∫–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω—ã');
                }, 100);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è:', error);
                showNotification('–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è: ' + error.message, 'error');
            }
        }

        // Refresh invitations
        function refreshInvitations() {
            loadInvitations();
        }

        // Show loading state
        function showLoading(buttonId, textId, loadingId) {
            const button = document.getElementById(buttonId);
            const text = document.getElementById(textId);
            const loading = document.getElementById(loadingId);
            
            if (button) button.disabled = true;
            if (text) text.classList.add('hidden');
            if (loading) loading.classList.remove('hidden');
        }

        // Hide loading state
        function hideLoading(buttonId, textId, loadingId) {
            const button = document.getElementById(buttonId);
            const text = document.getElementById(textId);
            const loading = document.getElementById(loadingId);
            
            if (button) button.disabled = false;
            if (text) text.classList.remove('hidden');
            if (loading) loading.classList.add('hidden');
        }

        // Load recent activity
        async function loadRecentActivity() {
            try {
                // Load recent data from working sources only
                const [teamMembers, invitations] = await Promise.all([
                    apiCall('/api/users/in-context', { method: 'GET' }).catch(() => []),
                    apiCall('/api/invitations/my', { method: 'GET' }).catch(() => [])
                ]);

                const usersList = Array.isArray(teamMembers) ? teamMembers : (teamMembers?.users || teamMembers?.data || []);
                const invitationsList = Array.isArray(invitations) ? invitations : (invitations?.invitations || invitations?.data || []);

                // Create activity items
                const activities = [];

                // Add recent user activities
                usersList.slice(0, 3).forEach(user => {
                    activities.push({
                        user: user,
                        action: '–ê–∫—Ç–∏–≤–µ–Ω –≤ —Å–∏—Å—Ç–µ–º–µ',
                        time: user.updatedAt || user.createdAt,
                        status: 'success',
                        type: 'activity'
                    });
                });

                // Add recent invitation activities
                invitationsList.slice(0, 2).forEach(invitation => {
                    activities.push({
                        user: { firstName: invitation.inviterName?.split(' ')[0] || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', lastName: invitation.inviterName?.split(' ')[1] || '', email: invitation.inviterEmail },
                        action: `–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –≤ ${invitation.type === 'organization' ? '–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—é' : '–∫–æ–º–∞–Ω–¥—É'}`,
                        time: invitation.createdAt,
                        status: invitation.status === 'pending' ? 'warning' : (invitation.status === 'accepted' ? 'success' : 'error'),
                        type: 'invitation'
                    });
                });

                // Add recent notification activities (placeholder - notifications not implemented yet)
                // notificationsList.slice(0, 2).forEach(notification => {
                //     activities.push({
                //         user: currentUser,
                //         action: notification.title || '–ù–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ',
                //         time: notification.createdAt,
                //         status: notification.isRead ? 'success' : 'warning',
                //         type: 'notification'
                //     });
                // });

                // Sort by time (most recent first)
                activities.sort((a, b) => new Date(b.time) - new Date(a.time));

                // Display activities
                displayRecentActivity(activities.slice(0, 5)); // Show only 5 most recent

            } catch (error) {
                console.error('Error loading recent activity:', error);
                // Show placeholder if error
                displayRecentActivity([]);
            }
        }

        // Display recent activity
        function displayRecentActivity(activities) {
            const tbody = document.getElementById('recentActivityBody');
            
            if (!activities || activities.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 20px; color: #6B7280;">
                            <i class="fas fa-clock" style="font-size: 24px; margin-bottom: 8px; opacity: 0.5;"></i>
                            <div>–ù–µ—Ç –Ω–µ–¥–∞–≤–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = activities.map(activity => {
                const user = activity.user;
                const initials = (user.firstName?.[0] || '') + (user.lastName?.[0] || '');
                const fullName = `${user.firstName || ''} ${user.lastName || ''}`.trim() || user.email;
                const timeAgo = getTimeAgo(activity.time);
                const statusClass = getActivityStatusClass(activity.status);

                return `
                    <tr>
                        <td>
                            <div class="user-info">
                                <div class="user-avatar">${initials || 'U'}</div>
                                <div class="user-details">
                                    <h4>${fullName}</h4>
                                    <p>${user.email || ''}</p>
                                </div>
                            </div>
                        </td>
                        <td>${activity.action}</td>
                        <td>${timeAgo}</td>
                        <td>
                            <span class="status-badge ${statusClass}">
                                ${getActivityStatusText(activity.status)}
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Get time ago string
        function getTimeAgo(dateString) {
            const now = new Date();
            const date = new Date(dateString);
            const diffInMinutes = Math.floor((now - date) / (1000 * 60));

            if (diffInMinutes < 1) return '–¢–æ–ª—å–∫–æ —á—Ç–æ';
            if (diffInMinutes < 60) return `${diffInMinutes} –º–∏–Ω –Ω–∞–∑–∞–¥`;
            
            const diffInHours = Math.floor(diffInMinutes / 60);
            if (diffInHours < 24) return `${diffInHours} —á –Ω–∞–∑–∞–¥`;
            
            const diffInDays = Math.floor(diffInHours / 24);
            if (diffInDays < 7) return `${diffInDays} –¥–Ω –Ω–∞–∑–∞–¥`;
            
            return date.toLocaleDateString('ru-RU');
        }

        // Get activity status class
        function getActivityStatusClass(status) {
            switch (status) {
                case 'success': return 'active';
                case 'warning': return 'pending';
                case 'error': return 'inactive';
                default: return 'inactive';
            }
        }

        // Get activity status text
        function getActivityStatusText(status) {
            switch (status) {
                case 'success': return '–£—Å–ø–µ—à–Ω–æ';
                case 'warning': return '–í –æ–∂–∏–¥–∞–Ω–∏–∏';
                case 'error': return '–û—à–∏–±–∫–∞';
                default: return '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
            }
        }

        // Ensure referral section exists in DOM - defined globally for proper hoisting
        window.ensureReferralSection = function ensureReferralSection() {
            const referralCard = document.getElementById('referralCard');
            const settingsSection = document.getElementById('settings');
            
            if (!settingsSection) {
                console.warn('‚ö†Ô∏è Settings section not found');
                return;
            }
            
            // –ï—Å–ª–∏ –∫–∞—Ä—Ç–æ—á–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, —Å–æ–∑–¥–∞–µ–º –µ—ë
            if (!referralCard) {
                console.log('üîß Referral card not found in DOM, creating dynamically...');
                
                // –ò—â–µ–º –∫–∞—Ä—Ç–æ—á–∫—É "–°–ø–æ—Å–æ–±—ã –≤—Ö–æ–¥–∞"
                const authMethodsCard = Array.from(settingsSection.querySelectorAll('.card')).find(c => {
                    const title = c.querySelector('h2.card-title');
                    return title && title.textContent.includes('–°–ø–æ—Å–æ–±—ã –≤—Ö–æ–¥–∞');
                });
                
                // –ò—â–µ–º –∫–∞—Ä—Ç–æ—á–∫—É "–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å"
                const securityCard = Array.from(settingsSection.querySelectorAll('.card')).find(c => {
                    const title = c.querySelector('h2.card-title');
                    return title && title.textContent.includes('–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å');
                });
                
                if (authMethodsCard && securityCard) {
                    // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö —Å—Å—ã–ª–æ–∫
                    const referralCardHTML = `
                    <div class="card" id="referralCard">
                        <h2 class="card-title">–†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏</h2>
                        <div class="referral-settings">
                            <div class="form-group">
                                <label for="referralExpiresInDays">–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è (–¥–Ω–∏)</label>
                                <input type="number" id="referralExpiresInDays" name="expiresInDays" placeholder="30" min="1" max="365" value="30">
                                <small class="text-muted">–ß–µ—Ä–µ–∑ —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π —Å—Å—ã–ª–∫–∞ –∏—Å—Ç–µ—á–µ—Ç (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 30)</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="referralUsageLimit">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π</label>
                                <input type="number" id="referralUsageLimit" name="usageLimit" placeholder="–ù–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ" min="1">
                                <small class="text-muted">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π —Å—Å—ã–ª–∫–∏ (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)</small>
                            </div>
                            
                            <div class="form-actions">
                                <button type="button" class="btn btn-primary" onclick="generateReferralLink(event)">
                                    <i class="fas fa-link"></i>
                                    –°–æ–∑–¥–∞—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É
                                </button>
                            </div>
                            
                            <div id="referralLinksList" style="margin-top: 1.5rem;">
                                <h3 style="margin-bottom: 1rem;">–ú–æ–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏</h3>
                                <div id="referralLinksContainer">
                                    <div class="loading-placeholder">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Å—ã–ª–æ–∫...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    `;
                    
                    // –í—Å—Ç–∞–≤–ª—è–µ–º –º–µ–∂–¥—É "–°–ø–æ—Å–æ–±—ã –≤—Ö–æ–¥–∞" –∏ "–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å"
                    authMethodsCard.insertAdjacentHTML('afterend', referralCardHTML);
                    console.log('‚úÖ Referral section created dynamically');
                    
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏
                    if (typeof loadReferralLinks === 'function') {
                        loadReferralLinks();
                    }
                } else {
                    console.warn('‚ö†Ô∏è Cannot find authMethodsCard or securityCard to insert referral section');
                }
            } else {
                console.log('‚úÖ Referral card already exists in DOM');
            }
        };

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–∞–∑–¥–µ–ª–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö —Å—Å—ã–ª–æ–∫ - —Å–¥–µ–ª–∞–Ω–∞ –≥–ª–æ–±–∞–ª—å–Ω–æ–π
        window.ensureReferralSection = function ensureReferralSection() {
            console.log('üîß ensureReferralSection called');
            const referralCard = document.getElementById('referralCard');
            const settingsSection = document.getElementById('settings');
            
            if (!settingsSection) {
                console.warn('‚ö†Ô∏è Settings section not found');
                return false;
            }
            
            if (referralCard) {
                // –†–∞–∑–¥–µ–ª —É–∂–µ –µ—Å—Ç—å, –Ω–æ –Ω–µ –ø—Ä–∏–Ω—É–∂–¥–∞–µ–º –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å - –ø–æ–∑–≤–æ–ª–∏–º loadModuleControls —É–ø—Ä–∞–≤–ª—è—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç—å—é
                console.log('‚úÖ Referral card already exists in DOM');
                return true;
            }
            
            // –°–æ–∑–¥–∞–µ–º —Ä–∞–∑–¥–µ–ª
            const authMethodsCard = Array.from(settingsSection.querySelectorAll('.card')).find(c => {
                const title = c.querySelector('h2.card-title');
                return title && title.textContent.includes('–°–ø–æ—Å–æ–±—ã –≤—Ö–æ–¥–∞');
            });
            
            const securityCard = Array.from(settingsSection.querySelectorAll('.card')).find(c => {
                const title = c.querySelector('h2.card-title');
                return title && title.textContent.includes('–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å');
            });
            
            console.log('üîç Cards found:', { 
                authMethodsCard: !!authMethodsCard, 
                securityCard: !!securityCard 
            });
            
            if (!authMethodsCard || !securityCard) {
                console.warn('‚ö†Ô∏è Cannot find authMethodsCard or securityCard');
                return false;
            }
            
            const referralCardHTML = `
                <div class="card" id="referralCard">
                    <h2 class="card-title">–†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏</h2>
                    <div class="referral-settings">
                        <div class="form-group">
                            <label for="referralExpiresInDays">–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è (–¥–Ω–∏)</label>
                            <input type="number" id="referralExpiresInDays" name="expiresInDays" placeholder="30" min="1" max="365" value="30">
                            <small class="text-muted">–ß–µ—Ä–µ–∑ —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π —Å—Å—ã–ª–∫–∞ –∏—Å—Ç–µ—á–µ—Ç (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 30)</small>
                        </div>
                        <div class="form-group">
                            <label for="referralUsageLimit">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π</label>
                            <input type="number" id="referralUsageLimit" name="usageLimit" placeholder="–ù–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ" min="1">
                            <small class="text-muted">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π —Å—Å—ã–ª–∫–∏ (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)</small>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="btn btn-primary" id="generateReferralLinkBtn">
                                <i class="fas fa-link"></i>
                                –°–æ–∑–¥–∞—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É
                            </button>
                        </div>
                        <div id="referralLinksList" style="margin-top: 1.5rem;">
                            <h3 style="margin-bottom: 1rem;">–ú–æ–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏</h3>
                            <div id="referralLinksContainer">
                                <div class="loading-placeholder">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Å—ã–ª–æ–∫...</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            authMethodsCard.insertAdjacentHTML('afterend', referralCardHTML);
            console.log('‚úÖ Referral card created dynamically');
            return true;
        };
        
        // Load settings
        async function loadSettings() {
            console.log('üîß loadSettings called');
            // –°–æ–∑–¥–∞–µ–º —Ä–∞–∑–¥–µ–ª —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö —Å—Å—ã–ª–æ–∫ (—Å –∑–∞–¥–µ—Ä–∂–∫–æ–π –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏)
            setTimeout(() => window.ensureReferralSection(), 100);
            setTimeout(() => window.ensureReferralSection(), 300);
            setTimeout(() => window.ensureReferralSection(), 500);
            setTimeout(() => window.ensureReferralSection(), 1000);
            window.ensureReferralSection();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏
            await loadReferralLinks();
            
            // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫ –∫–Ω–æ–ø–∫–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å—Å—ã–ª–æ–∫
            setTimeout(() => {
                const generateBtn = document.getElementById('generateReferralLinkBtn');
                if (generateBtn && !generateBtn.hasAttribute('data-listener-attached')) {
                    generateBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        if (typeof window.generateReferralLink === 'function') {
                            window.generateReferralLink(e);
                        } else {
                            console.error('‚ùå generateReferralLink function not available');
                            showNotification('–û—à–∏–±–∫–∞: —Ñ—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞', 'error');
                        }
                    });
                    generateBtn.setAttribute('data-listener-attached', 'true');
                    console.log('‚úÖ Generate referral link button event listener attached');
                }
                
                // –ù–µ –ø—Ä–∏–Ω—É–∂–¥–∞–µ–º –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å - –ø–æ–∑–≤–æ–ª–∏–º loadModuleControls —É–ø—Ä–∞–≤–ª—è—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç—å—é –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ç–∞—Ç—É—Å–∞ –º–æ–¥—É–ª—è
                const finalReferralCard = document.getElementById('referralCard');
                if (finalReferralCard) {
                    console.log('‚úÖ Referral card exists in DOM');
                }
            }, 200);
            
            try {
                const response = await apiCall('/api/auth/me', { method: 'GET' });
                const user = response;
                
                // Fill form with current user data
                document.getElementById('firstName').value = user.firstName || '';
                document.getElementById('lastName').value = user.lastName || '';
                document.getElementById('email').value = user.email || '';
                
                // Update status indicators
                const emailStatus = document.getElementById('emailStatus');
                
                if (user.emailVerified) {
                    emailStatus.textContent = 'Email –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω';
                    emailStatus.style.color = '#10b981';
                } else {
                    emailStatus.textContent = 'Email –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω';
                    emailStatus.style.color = '#ef4444';
                }
                
                // Load auth methods section
                await renderAuthMethods(user);
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥—É–ª–∏ –¥–ª—è —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω–∞ - —ç—Ç–æ —Ç–∞–∫–∂–µ —Å–∫—Ä—ã–≤–∞–µ—Ç –æ—Ç–∫–ª—é—á–µ–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ–ª–∏ –≤ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–∞—Ö (–æ–±—ä–µ–∫—Ç—ã –∏–ª–∏ —Å—Ç—Ä–æ–∫–∏)
                const isSuperAdmin = user.roles && user.roles.some(r => {
                    const roleName = typeof r === 'string' ? r : r.name;
                    return roleName === 'super_admin';
                });
                
                if (isSuperAdmin) {
                    console.log('‚úÖ User is super_admin, loading module controls');
                    await loadModuleControls();
                } else {
                    console.log('‚ÑπÔ∏è User is not super_admin, checking module status');
                    // –î–∞–∂–µ –µ—Å–ª–∏ –Ω–µ —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –º–æ–¥—É–ª–µ–π –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                    await checkModuleStatusAndHide();
                }
                
                // Load nFA settings
                await loadNfaSettings(user);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º GitHub –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω —á–µ—Ä–µ–∑ GitHub
                if (user.githubId || user.githubUsername) {
                    const githubInfoGroup = document.getElementById('githubInfoGroup');
                    const displayGithubId = document.getElementById('displayGithubId');
                    const displayGithubUsername = document.getElementById('displayGithubUsername');
                    
                    if (githubInfoGroup) {
                        githubInfoGroup.style.display = 'block';
                    }
                    if (displayGithubId && user.githubId) {
                        displayGithubId.textContent = user.githubId;
                    }
                    if (displayGithubUsername && user.githubUsername) {
                        displayGithubUsername.textContent = user.githubUsername;
                    }
                } else {
                    const githubInfoGroup = document.getElementById('githubInfoGroup');
                    if (githubInfoGroup) {
                        githubInfoGroup.style.display = 'none';
                    }
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫', 'error');
            }
        }

        // Initialize settings event listeners
        function initializeSettings() {
            // Settings form submission
            document.getElementById('settingsForm')?.addEventListener('submit', async function(e) {
                e.preventDefault();
                await saveSettings();
            });

            // Email verification
            document.getElementById('verifyEmailBtn')?.addEventListener('click', async function() {
                await verifyEmail();
            });

            // Init auth methods actions
            initializeAuthMethodsUI();

            // Cancel settings
            document.getElementById('cancelSettings')?.addEventListener('click', function() {
                loadSettings(); // Reload original data
            });

            // nFA settings button
            document.getElementById('saveNfaSettingsBtn')?.addEventListener('click', async function() {
                await saveNfaSettings();
            });
        }

        // Save settings
        async function saveSettings() {
            try {
                const formData = {
                    firstName: document.getElementById('firstName').value,
                    lastName: document.getElementById('lastName').value
                };

                const response = await apiCall('/api/users/me', {
                    method: 'PATCH',
                    body: JSON.stringify(formData)
                });

                showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫:', error);
                showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫: ' + error.message, 'error');
            }
        }

        // Verify email
        async function verifyEmail() {
            try {
                console.log('üéØ DASHBOARD: –í—ã–∑—ã–≤–∞–µ–º –Ω–æ–≤—ã–π endpoint –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–∏—Å—å–º–∞ —Å –∫–Ω–æ–ø–∫–æ–π');
                console.log('üìß Email:', document.getElementById('email').value);
                
                const response = await apiCall('/api/auth/email-verification/send', {
                    method: 'POST',
                    body: JSON.stringify({ email: document.getElementById('email').value })
                });
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞
                if (response.success) {
                    if (response.message === 'Email —É–∂–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω') {
                        showNotification('Email —É–∂–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω', 'info');
                    } else {
                        showNotification('–ü–∏—Å—å–º–æ —Å –∫–Ω–æ–ø–∫–æ–π –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –≤–∞—à—É –ø–æ—á—Ç—É', 'success');
                    }
                } else {
                    showNotification(response.message || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–∏—Å—å–º–∞', 'error');
                }
                
                // –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥ –≤–≤–æ–¥–∞ –∫–æ–¥–∞ - –ø–∏—Å—å–º–æ —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–Ω–æ–ø–∫—É
                // const code = prompt('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è, –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –Ω–∞ –≤–∞—à—É –ø–æ—á—Ç—É:');
                // if (code) {
                //     await verifyEmailCode(code);
                // }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–¥–∞:', error);
                showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–¥–∞: ' + error.message, 'error');
            }
        }

        // Verify email code
        async function verifyEmailCode(code) {
            try {
                await apiCall('/api/auth/2fa/email/verify-code', {
                    method: 'POST',
                    body: JSON.stringify({ 
                        email: document.getElementById('email').value,
                        code: code
                    })
                });
                
                showNotification('Email —É—Å–ø–µ—à–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω', 'success');
                loadSettings(); // Reload to update status
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è email:', error);
                showNotification('–û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è email: ' + error.message, 'error');
            }
        }

        // Auth methods UI
        function initializeAuthMethodsUI() {
            // No-op for now; actions are bound via buttons when rendered
        }

        async function fetchAvailableAuthMethods() {
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –º–æ–¥—É–ª–µ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                const statusResult = await apiCall('/api/micro-modules/auth/status', { method: 'GET' });
                const enabledMethods = [];
                
                // Email –≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–µ–Ω (—Å–∏—Å—Ç–µ–º–Ω—ã–π –º–æ–¥—É–ª—å)
                if (statusResult?.email?.enabled !== false) {
                    enabledMethods.push('EMAIL');
                }
                
                // GitHub –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –º–æ–¥—É–ª—å –≤–∫–ª—é—á–µ–Ω
                if (statusResult?.github?.enabled === true) {
                    enabledMethods.push('GITHUB');
                }
                
                // Telegram –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –º–æ–¥—É–ª—å –≤–∫–ª—é—á–µ–Ω
                if (statusResult?.telegram?.enabled === true) {
                    enabledMethods.push('PHONE_TELEGRAM');
                }
                
                return enabledMethods;
            } catch (e) {
                console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å –º–æ–¥—É–ª–µ–π, –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π', e);
                // Fallback –∫ –ø—Ä–æ–≤–µ—Ä–∫–µ —á–µ—Ä–µ–∑ —Å—Ç–∞—Ä—ã–π API
                try {
                    const result = await apiCall('/api/auth/multi/methods', { method: 'GET' });
                    return result?.methods || ['EMAIL', 'GITHUB'];
                } catch (e2) {
                    return ['EMAIL', 'GITHUB'];
                }
            }
        }

        function getLinkedMethodsFromUser(user) {
            const methods = user?.availableAuthMethods || [];
            // Normalize to array of strings
            const normalized = Array.isArray(methods) ? methods : [];
            console.log('üîç User availableAuthMethods:', normalized);
            // Also check primaryAuthMethod
            if (user?.primaryAuthMethod) {
                normalized.push(user.primaryAuthMethod);
            }
            console.log('üîç All linked methods:', normalized);
            return normalized;
        }

        async function renderAuthMethods(user) {
            const container = document.getElementById('authMethodsContainer');
            if (!container) return;
            
            const allMethods = await fetchAvailableAuthMethods();
            const linked = new Set(getLinkedMethodsFromUser(user));

            const methodTitles = {
                EMAIL: 'Email',
                GITHUB: 'GitHub',
                PHONE_TELEGRAM: 'Telegram OAuth',
                PHONE_WHATSAPP: '–¢–µ–ª–µ—Ñ–æ–Ω (WhatsApp)',
                GOSUSLUGI: '–ì–æ—Å—É—Å–ª—É–≥–∏',
                VKONTAKTE: '–í–ö–æ–Ω—Ç–∞–∫—Ç–µ'
            };

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –≤–∫–ª—é—á–µ–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã
            const shown = allMethods.filter(m => ['EMAIL', 'PHONE_TELEGRAM', 'GITHUB'].includes(m));

            const rows = shown.map(m => {
                const isLinked = linked.has(m);
                const status = isLinked ? '<span class="status-badge active">–ø—Ä–∏–≤—è–∑–∞–Ω</span>' : '<span class="status-badge inactive">–Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω</span>';
                const actionBtn = isLinked
                    ? `<button class="btn btn-secondary" data-unbind="${m}">–û—Ç–≤—è–∑–∞—Ç—å</button>`
                    : `<button class="btn btn-primary" data-bind="${m}">–ü—Ä–∏–≤—è–∑–∞—Ç—å</button>`;
                return `
                    <div class="security-item">
                        <div class="security-info">
                            <h3>${methodTitles[m] || m}</h3>
                            <p>–°—Ç–∞—Ç—É—Å: ${status}</p>
                        </div>
                        <div class="security-action">
                            ${actionBtn}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `<div class="security-settings">${rows || '<p>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤</p>'}</div>`;

            // Bind actions
            container.querySelectorAll('[data-bind]').forEach(btn => {
                btn.addEventListener('click', async () => {
                    await bindAuthMethod(btn.getAttribute('data-bind'));
                });
            });
            container.querySelectorAll('[data-unbind]').forEach(btn => {
                btn.addEventListener('click', async () => {
                    await unbindAuthMethod(btn.getAttribute('data-unbind'));
                });
            });
        }

        async function bindAuthMethod(method) {
            try {
                if (method === 'GITHUB') {
                    // Redirect to GitHub OAuth with bind params
                    const userId = (currentUser && (currentUser.id || currentUser.userId)) || null;
                    const resp = await apiCall(`/api/auth/multi/oauth/github/url?bind=true&userId=${encodeURIComponent(userId || '')}`, { method: 'GET' });
                    if (resp?.url) {
                        window.location.href = resp.url;
                        return;
                    }
                }
                if (method === 'PHONE_TELEGRAM') {
                    const userId = (currentUser && (currentUser.id || currentUser.userId)) || '';
                    window.location.href = `telegram-login.html?bind=true&userId=${encodeURIComponent(userId)}`;
                    return;
                }
                if (method === 'EMAIL') {
                    // Show modal for email binding
                    showBindEmailModal();
                    return;
                }
                // Fallback generic
                await apiCall('/api/auth/multi/bind', {
                    method: 'POST',
                    body: JSON.stringify({ authMethod: method })
                });
                showNotification('–ú–µ—Ç–æ–¥ –ø—Ä–∏–≤—è–∑–∞–Ω', 'success');
                await loadSettings();
            } catch (e) {
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏–≤—è–∑–∫–∏: ' + e.message, 'error');
            }
        }

        async function unbindAuthMethod(method) {
            try {
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –º–µ—Ç–æ–¥–æ–≤ —Ç–µ–ø–µ—Ä—å –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –Ω–∞ backend
                // Frontend –ø—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å, –∞ backend –ø—Ä–æ–≤–µ—Ä–∏—Ç —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã
                const response = await apiCall('/api/auth/multi/unbind', {
                    method: 'POST',
                    body: JSON.stringify({ authMethod: method })
                });
                
                if (response?.success) {
                    showNotification('–ú–µ—Ç–æ–¥ –æ—Ç–≤—è–∑–∞–Ω', 'success');
                    await loadSettings();
                } else {
                    showNotification(response?.error || '–û—à–∏–±–∫–∞ –æ—Ç–≤—è–∑–∫–∏', 'error');
                }
            } catch (e) {
                showNotification('–û—à–∏–±–∫–∞ –æ—Ç–≤—è–∑–∫–∏: ' + (e.message || e.error || e), 'error');
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥—É–ª–µ–π –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω–æ–º
        async function loadModuleControls() {
            try {
                const modules = await apiCall('/api/micro-modules', { method: 'GET' });
                const authModules = modules.filter(m => 
                    m.name === 'email-auth' || 
                    m.name === 'github-auth' || 
                    m.name === 'telegram-auth'
                );
                
                const referralModule = modules.find(m => m.name === 'referral-system');
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏ –¥–ª—è –º–æ–¥—É–ª–µ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
                const moduleTogglesContainer = document.getElementById('moduleTogglesContainer');
                const adminModuleControls = document.getElementById('adminModuleControls');
                
                if (moduleTogglesContainer && adminModuleControls) {
                    const moduleTitles = {
                        'email-auth': 'Email –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è',
                        'github-auth': 'GitHub –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è',
                        'telegram-auth': 'Telegram –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è'
                    };
                    
                    const togglesHtml = authModules.map(module => `
                        <div class="security-item">
                            <div class="security-info">
                                <h3>${moduleTitles[module.name] || module.displayName || module.name}</h3>
                                <p>${module.description || ''}</p>
                                ${module.isSystem ? '<small style="color: #f59e0b;">(–°–∏—Å—Ç–µ–º–Ω—ã–π –º–æ–¥—É–ª—å - –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –ø—Ä–æ–±–ª–µ–º–∞–º)</small>' : ''}
                            </div>
                            <div class="security-action">
                                <label class="switch">
                                    <input type="checkbox" 
                                           id="moduleToggle_${module.name}" 
                                           ${module.isEnabled ? 'checked' : ''}
                                           data-module-name="${module.name}">
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>
                    `).join('');
                    
                    moduleTogglesContainer.innerHTML = togglesHtml || '<p>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–æ–¥—É–ª–µ–π</p>';
                    adminModuleControls.style.display = 'block';
                    
                    // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
                    authModules.forEach(module => {
                        const toggle = document.getElementById(`moduleToggle_${module.name}`);
                        if (toggle) {
                            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫, –µ—Å–ª–∏ –µ—Å—Ç—å
                            const newToggle = toggle.cloneNode(true);
                            toggle.parentNode.replaceChild(newToggle, toggle);
                            
                            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
                            newToggle.addEventListener('change', async (e) => {
                                if (module.isSystem && !e.target.checked) {
                                    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–∫–ª—é—á–∏—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–π –º–æ–¥—É–ª—å? –≠—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –ø—Ä–æ–±–ª–µ–º–∞–º —Å —Ä–∞–±–æ—Ç–æ–π —Å–∏—Å—Ç–µ–º—ã.')) {
                                        e.target.checked = true;
                                        return;
                                    }
                                }
                                await toggleModule(module.name, e.target.checked);
                            });
                        }
                    });
                }
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –¥–ª—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã
                const referralModuleControl = document.getElementById('referralModuleControl');
                const referralCard = document.getElementById('referralCard');
                
                if (referralModuleControl && referralModule) {
                    const referralSystemToggle = document.getElementById('referralSystemToggle');
                    
                    if (referralSystemToggle) {
                        referralSystemToggle.checked = referralModule.isEnabled || false;
                        referralModuleControl.style.display = 'block';
                        
                        // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å—é –∫–∞—Ä—Ç–æ—á–∫—É —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö —Å—Å—ã–ª–æ–∫, –µ—Å–ª–∏ –º–æ–¥—É–ª—å –æ—Ç–∫–ª—é—á–µ–Ω
                        if (referralCard) {
                            if (referralModule.isEnabled === false) {
                                referralCard.style.display = 'none';
                                referralCard.style.visibility = 'hidden';
                                referralCard.setAttribute('data-hidden-by-module', 'true');
                            } else {
                                referralCard.style.display = '';
                                referralCard.style.visibility = '';
                                referralCard.removeAttribute('data-hidden-by-module');
                            }
                        }
                        
                        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫, –µ—Å–ª–∏ –µ—Å—Ç—å
                        const newToggle = referralSystemToggle.cloneNode(true);
                        referralSystemToggle.parentNode.replaceChild(newToggle, referralSystemToggle);
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
                        newToggle.addEventListener('change', async (e) => {
                            await toggleModule('referral-system', e.target.checked);
                        });
                    }
                } else if (referralModuleControl && !referralModule) {
                    // –ú–æ–¥—É–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–∫—Ä—ã–≤–∞–µ–º –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –∏ –∫–∞—Ä—Ç–æ—á–∫—É
                    referralModuleControl.style.display = 'none';
                    if (referralCard) {
                        referralCard.style.display = 'none';
                    }
                } else if (referralCard && !referralModule) {
                    // –ï—Å–ª–∏ –º–æ–¥—É–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –∏ –Ω–µ—Ç –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è, –ø—Ä–æ—Å—Ç–æ —Å–∫—Ä—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É
                    referralCard.style.display = 'none';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥—É–ª–µ–π:', error);
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –º–æ–¥—É–ª–µ–π –∏ —Å–∫—Ä—ã—Ç–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        async function checkModuleStatusAndHide() {
            try {
                const modules = await apiCall('/api/micro-modules', { method: 'GET' });
                const referralModule = modules.find(m => m.name === 'referral-system');
                const referralCard = document.getElementById('referralCard');
                
                if (referralCard && referralModule) {
                    if (referralModule.isEnabled === false) {
                        referralCard.style.display = 'none';
                        referralCard.style.visibility = 'hidden';
                        referralCard.setAttribute('data-hidden-by-module', 'true');
                    } else {
                        referralCard.style.display = '';
                        referralCard.style.visibility = '';
                        referralCard.removeAttribute('data-hidden-by-module');
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –º–æ–¥—É–ª–µ–π:', error);
            }
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–æ–¥—É–ª—è
        async function toggleModule(moduleName, enable) {
            try {
                const action = enable ? 'enable' : 'disable';
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–µ
                const toggle = document.getElementById(`moduleToggle_${moduleName}`);
                const referralToggle = document.getElementById('referralSystemToggle');
                const targetToggle = toggle || (moduleName === 'referral-system' ? referralToggle : null);
                
                if (targetToggle) {
                    targetToggle.disabled = true;
                }
                
                const response = await apiCall(`/api/micro-modules/${moduleName}/${action}`, {
                    method: 'POST'
                });
                
                if (response?.success) {
                    showNotification(response.message || `–ú–æ–¥—É–ª—å ${moduleName} ${enable ? '–≤–∫–ª—é—á–µ–Ω' : '–æ—Ç–∫–ª—é—á–µ–Ω'}`, 'success');
                    
                    // –°–∫—Ä—ã–≤–∞–µ–º/–ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–æ–¥—É–ª—è
                    if (moduleName === 'referral-system') {
                        const referralCard = document.getElementById('referralCard');
                        if (referralCard) {
                            if (enable === false) {
                                referralCard.style.display = 'none';
                                referralCard.style.visibility = 'hidden';
                                referralCard.setAttribute('data-hidden-by-module', 'true');
                            } else {
                                referralCard.style.display = '';
                                referralCard.style.visibility = '';
                                referralCard.removeAttribute('data-hidden-by-module');
                            }
                        }
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º UI
                    await loadModuleControls();
                    
                    // –ï—Å–ª–∏ —ç—Ç–æ –º–æ–¥—É–ª—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏, –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –º–µ—Ç–æ–¥–æ–≤
                    if (moduleName.includes('auth')) {
                        await loadSettings();
                    }
                } else {
                    throw new Error(response.message || '–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º–æ–¥—É–ª—è');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º–æ–¥—É–ª—è:', error);
                showNotification('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º–æ–¥—É–ª—è: ' + error.message, 'error');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º UI, —á—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è
                await loadModuleControls();
            }
        }

        // –†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ —Å—Å—ã–ª–∫–∏
        window.generateReferralLink = async function generateReferralLink(event) {
            try {
                // –õ–∏–º–∏—Ç—ã —É–±—Ä–∞–Ω—ã - –ø—Ä–æ—Å—Ç–æ —Å–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
                const button = event?.target?.closest('button') || document.querySelector('button[id="generateReferralLinkBtn"]');
                const originalText = button?.innerHTML;
                if (button) {
                    button.disabled = true;
                    button.innerHTML = '<span class="loading"></span> –°–æ–∑–¥–∞–Ω–∏–µ...';
                }

                const response = await apiCall('/api/auth/referrals/generate', {
                    method: 'POST',
                    body: JSON.stringify({})
                });

                if (response?.success && response?.referral) {
                    showNotification('–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞', 'success');
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å—Å—ã–ª–æ–∫
                    await loadReferralLinks();
                } else {
                    showNotification('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å—Å—ã–ª–∫–∏', 'error');
                }
            } catch (e) {
                showNotification('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–∏: ' + e.message, 'error');
            } finally {
                const button = event?.target?.closest('button') || document.querySelector('button[onclick*="generateReferralLink"]');
                if (button) {
                    button.disabled = false;
                    button.innerHTML = '<i class="fas fa-link"></i> –°–æ–∑–¥–∞—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É';
                }
            }
        }

        async function loadReferralLinks() {
            try {
                const container = document.getElementById('referralLinksContainer');
                if (!container) return;

                container.innerHTML = '<div class="loading-placeholder">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Å—ã–ª–æ–∫...</div>';

                const response = await apiCall('/api/auth/referrals/my-codes', { method: 'GET' });

                if (response?.success && response?.codes) {
                    const links = response.codes;
                    
                    if (links.length === 0) {
                        container.innerHTML = '<p class="text-muted">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã—Ö —Å—Å—ã–ª–æ–∫</p>';
                        return;
                    }

                    const linksHtml = links.map(link => {
                        const expiresAt = link.expiresAt ? new Date(link.expiresAt).toLocaleDateString('ru-RU') : '–ù–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ';
                        const usageInfo = link.usageLimit ? `${link.usageCount || 0}/${link.usageLimit}` : `${link.usageCount || 0} –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π`;
                        const isExpired = link.expiresAt && new Date(link.expiresAt) < new Date();
                        const isUsedUp = link.usageLimit && (link.usageCount || 0) >= link.usageLimit;

                        return `
                            <div class="referral-link-item" style="padding: 1rem; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 0.75rem; background: ${isExpired || isUsedUp ? '#fef2f2' : '#f8fafc'};">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; margin-bottom: 0.25rem; word-break: break-all;">
                                            <a href="${link.link}" target="_blank" style="color: #667eea; text-decoration: none;">${link.link}</a>
                                        </div>
                                        <div style="font-size: 0.875rem; color: #64748b;">
                                            <div>–ö–æ–¥: <code style="background: #e2e8f0; padding: 0.125rem 0.375rem; border-radius: 4px;">${link.code}</code></div>
                                            <div>–ò—Å—Ç–µ–∫–∞–µ—Ç: ${expiresAt}</div>
                                            <div>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π: ${usageInfo}</div>
                                            ${isExpired ? '<span style="color: #ef4444;">–ò—Å—Ç–µ–∫–ª–∞</span>' : ''}
                                            ${isUsedUp ? '<span style="color: #ef4444;">–ò—Å—á–µ—Ä–ø–∞–Ω–∞</span>' : ''}
                                        </div>
                                    </div>
                                    <button onclick="copyReferralLink('${link.link}')" class="btn btn-sm btn-secondary" style="margin-left: 0.5rem;">
                                        <i class="fas fa-copy"></i> –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('');

                    container.innerHTML = linksHtml;
                } else {
                    container.innerHTML = '<p class="text-muted">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Å—ã–ª–æ–∫</p>';
                }
            } catch (e) {
                const container = document.getElementById('referralLinksContainer');
                if (container) {
                    container.innerHTML = '<p class="text-muted">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Å—ã–ª–æ–∫: ' + e.message + '</p>';
                }
            }
        }

        function copyReferralLink(link) {
            navigator.clipboard.writeText(link).then(() => {
                showNotification('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞', 'success');
            }).catch(err => {
                console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
                showNotification('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Å—ã–ª–∫–∏', 'error');
            });
        }

        // Load and render nFA methods
        async function loadNfaSettings(user) {
            try {
                const container = document.getElementById('nfaMethodsContainer');
                if (!container) return;
                
                // –ü–æ–ª—É—á–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –º–µ—Ç–æ–¥—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const linkedMethods = getLinkedMethodsFromUser(user);
                
                // –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã, –∏—Å–ø–æ–ª—å–∑—É—è Set
                const uniqueMethods = [...new Set(linkedMethods)];
                
                // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ nFA
                console.log('üîç [loadNfaSettings] User object:', user);
                console.log('üîç [loadNfaSettings] user.mfaSettings:', user?.mfaSettings);
                const currentNfaMethods = user?.mfaSettings?.methods || [];
                const nfaEnabled = user?.mfaSettings?.enabled || false;
                console.log('üîç [loadNfaSettings] currentNfaMethods:', currentNfaMethods);
                console.log('üîç [loadNfaSettings] nfaEnabled:', nfaEnabled);
                
                const methodTitles = {
                    EMAIL: 'Email',
                    PHONE_TELEGRAM: 'Telegram',
                    GITHUB: 'GitHub'
                };
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã (–±–µ–∑ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤)
                const html = uniqueMethods
                    .filter(method => ['EMAIL', 'PHONE_TELEGRAM', 'GITHUB'].includes(method))
                    .map(method => {
                        const isSelected = currentNfaMethods.includes(method);
                        return `
                            <div class="security-item" style="margin-bottom: 0.75rem;">
                                <div class="security-info">
                                    <h3 style="margin: 0; font-size: 0.95rem;">${methodTitles[method] || method}</h3>
                                </div>
                                <div class="security-action">
                                    <label class="switch">
                                        <input type="checkbox" class="nfa-method-checkbox" data-method="${method}" ${isSelected ? 'checked' : ''}>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>
                        `;
                    }).join('');
                
                if (html) {
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<p style="color: #6b7280; font-size: 0.9rem;">–î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è nFA –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–∏–≤—è–∑–∞—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Å–ø–æ—Å–æ–± –≤—Ö–æ–¥–∞</p>';
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ nFA:', error);
            }
        }
        
        // Save nFA settings
        async function saveNfaSettings() {
            try {
                const checkboxes = document.querySelectorAll('.nfa-method-checkbox');
                const selectedMethods = Array.from(checkboxes)
                    .filter(cb => cb.checked)
                    .map(cb => cb.getAttribute('data-method'));
                
                if (selectedMethods.length === 0) {
                    // –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ, –æ—Ç–∫–ª—é—á–∞–µ–º nFA —á–µ—Ä–µ–∑ –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤
                    await apiCall('/api/auth/nfa/configure', {
                        method: 'POST',
                        body: JSON.stringify({ methods: [] })
                    });
                    showNotification('nFA –æ—Ç–∫–ª—é—á–µ–Ω–∞', 'success');
                } else {
                    await apiCall('/api/auth/nfa/configure', {
                        method: 'POST',
                        body: JSON.stringify({ 
                            methods: selectedMethods,
                            requiredMethods: selectedMethods.length // –¢—Ä–µ–±—É–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤—Å–µ—Ö –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤
                        })
                    });
                    showNotification(`nFA –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞: –≤—ã–±—Ä–∞–Ω–æ –º–µ—Ç–æ–¥–æ–≤ - ${selectedMethods.length}`, 'success');
                }
                
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                await loadCurrentUser();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ nFA:', error);
                showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ nFA: ' + (error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
            }
        }
        
        // Update security setting (legacy, kept for backward compatibility)
        async function updateSecuritySetting(setting, value) {
            try {
                if (setting === 'twoFactorEnabled') {
                    if (value) {
                        // Enable 2FA
                        await apiCall('/api/two-factor-settings/enable', {
                    method: 'POST',
                            body: JSON.stringify({ methods: ['email'] })
                        });
                        showNotification('2FA –≤–∫–ª—é—á–µ–Ω', 'success');
                } else {
                        // Disable 2FA
                        await apiCall('/api/two-factor-settings/disable', {
                            method: 'POST'
                        });
                        showNotification('2FA –æ—Ç–∫–ª—é—á–µ–Ω', 'success');
                    }
                    } else {
                    // For other settings, use the general endpoint
                    await apiCall('/api/users/me', {
                        method: 'PATCH',
                        body: JSON.stringify({ [setting]: value })
                    });
                    showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞', 'success');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:', error);
                showNotification('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏: ' + error.message, 'error');
            }
        }

        // Hide admin-only sections for viewer role (keep Settings visible)
        function hideAdminOnlySections() {
            // Hide admin panel link
            const adminPanelLink = document.getElementById('adminPanelLink');
            if (adminPanelLink) {
                adminPanelLink.style.display = 'none';
            }
            
            // Hide user management sections (–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏)
            const userManagementSection = document.querySelector('.section[data-section="users"]');
            if (userManagementSection) {
                userManagementSection.style.display = 'none';
            }
            
            // Hide organization management sections
            const orgManagementSection = document.querySelector('.section[data-section="organizations"]');
            if (orgManagementSection) {
                orgManagementSection.style.display = 'none';
            }
            
            // Hide team management sections
            const teamManagementSection = document.querySelector('.section[data-section="teams"]');
            if (teamManagementSection) {
                teamManagementSection.style.display = 'none';
            }
            
            // Keep invitation sections visible for viewer
            // const invitationSection = document.querySelector('.section[data-section="invitations"]');
            // if (invitationSection) {
            //     invitationSection.style.display = 'none';
            // }
            
            // Keep Settings visible for viewer
            // Do not hide settings section for viewer role
            
            // Update navigation to hide admin-only links, but keep invitations for viewer
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes('–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏') || 
                    text.includes('–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏') || 
                    text.includes('–∫–æ–º–∞–Ω–¥—ã')) {
                    item.style.display = 'none';
                }
                // Keep invitations visible for viewer
                if (text.includes('–ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è')) {
                    item.style.display = 'flex';
                    }
                });
            }
            
        // Open admin panel
        function openAdminPanel() {
            // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –º–∏–∫—Ä–æ–º–æ–¥—É–ª–µ–π –¥–ª—è –∞–¥–º–∏–Ω–æ–≤
            window.location.href = '/test-micro-modules.html';
        }
    </script>
</body>
</html>



