<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="version" content="2.0.7">
    <title>Loginus - –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–Ω–∞–Ω–∏—è–º–∏</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #1a202c;
        }

        .auth-container {
            background: white;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            width: 100%;
            max-width: 1200px;
            min-height: 600px;
            display: flex;
            position: relative;
        }

        .auth-left {
            flex: 1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 3rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .auth-left::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="75" cy="75" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="50" cy="10" r="0.5" fill="rgba(255,255,255,0.05)"/><circle cx="10" cy="60" r="0.5" fill="rgba(255,255,255,0.05)"/><circle cx="90" cy="40" r="0.5" fill="rgba(255,255,255,0.05)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            opacity: 0.3;
            animation: float 20s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            z-index: 1;
        }

        .logo-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(45deg, #ff6b6b, #ffa500);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.3);
        }

        .logo-text {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(45deg, #fff, #e2e8f0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .auth-left h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            text-align: center;
            z-index: 1;
        }

        .auth-left p {
            font-size: 1.2rem;
            opacity: 0.9;
            text-align: center;
            margin-bottom: 2rem;
            z-index: 1;
        }

        .features {
            list-style: none;
            z-index: 1;
        }

        .features li {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .features i {
            width: 24px;
            height: 24px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
        }

        .auth-right {
            flex: 1;
            padding: 3rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
        }

        .auth-form {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
        }

        .form-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .form-title {
            font-size: 2rem;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 0.5rem;
        }

        .form-subtitle {
            color: #64748b;
            font-size: 1rem;
        }

        .email-display {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 1rem;
            margin: 1rem 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .email-display i {
            color: #667eea;
            font-size: 1.1rem;
        }

        .email-display span {
            flex: 1;
            font-weight: 500;
            color: #1a202c;
        }

        .email-display .btn-link {
            color: #667eea;
            font-size: 0.9rem;
            text-decoration: none;
            border: none;
            background: none;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .email-display .btn-link:hover {
            background: #e2e8f0;
            color: #4c51bf;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #374151;
        }

        .form-input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            transition: none !important;
            background: #f8fafc !important;
            /* –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–∫–ª—é—á–∞–µ–º –≤—Å–µ –±—Ä–∞—É–∑–µ—Ä–Ω—ã–µ —Å—Ç–∏–ª–∏ */
            -webkit-appearance: none !important;
            -moz-appearance: none !important;
            appearance: none !important;
            /* –û—Ç–∫–ª—é—á–∞–µ–º –≤—Å–µ –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ */
            -webkit-autofill: none !important;
            -webkit-box-shadow: 0 0 0 1000px #f8fafc inset !important;
            /* –û—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ */
            animation: none !important;
            -webkit-animation: none !important;
            /* –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∏–ª–∏ */
            color: #1a202c !important;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important;
        }

        .form-input:focus {
            outline: none !important;
            border-color: #667eea !important;
            background: white !important;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1) !important;
            transition: none !important;
            animation: none !important;
            -webkit-animation: none !important;
        }

        /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –º–µ—Ä—Ü–∞–Ω–∏–µ –ø—Ä–∏ –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–∏ */
        .form-input:-webkit-autofill,
        .form-input:-webkit-autofill:hover,
        .form-input:-webkit-autofill:focus,
        .form-input:-webkit-autofill:active {
            -webkit-box-shadow: 0 0 0 1000px #f8fafc inset !important;
            -webkit-text-fill-color: #1a202c !important;
            transition: none !important;
            animation: none !important;
            -webkit-animation: none !important;
        }

        /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –º–µ—Ä—Ü–∞–Ω–∏—è */
        .form-input,
        .form-input:focus,
        .form-input:active,
        .form-input:hover {
            transition: none !important;
            animation: none !important;
            -webkit-animation: none !important;
            -webkit-transition: none !important;
            -moz-transition: none !important;
            -o-transition: none !important;
        }

        .form-input.error {
            border-color: #ef4444;
            background: #fef2f2;
        }

        .input-group {
            position: relative;
        }

        .input-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #64748b;
            z-index: 1;
        }

        .input-group .form-input {
            padding-left: 3rem;
        }

        .password-toggle {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #64748b;
            cursor: pointer;
            z-index: 1;
        }

        .btn {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            margin-bottom: 1rem;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #f1f5f9;
            color: #64748b;
            border: 2px solid #e2e8f0;
        }

        .btn-secondary:hover {
            background: #e2e8f0;
            color: #374151;
        }

        .btn-link {
            background: none;
            color: #667eea;
            text-decoration: none;
            padding: 0.5rem;
            font-size: 0.9rem;
        }

        .btn-link:hover {
            text-decoration: underline;
        }

        .form-footer {
            text-align: center;
            margin-top: 2rem;
        }

        .form-footer p {
            color: #64748b;
            margin-bottom: 1rem;
        }

        .divider {
            display: flex;
            align-items: center;
            margin: 2rem 0;
            color: #64748b;
        }

        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #e2e8f0;
        }

        .divider span {
            padding: 0 1rem;
            font-size: 0.9rem;
        }

        .auth-tabs {
            display: flex;
            background: #f1f5f9;
            border-radius: 12px;
            padding: 0.5rem;
            margin-bottom: 2rem;
        }

        .auth-tab {
            flex: 1;
            padding: 0.75rem 1rem;
            background: none;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #64748b;
        }

        .auth-tab.active {
            background: white;
            color: #667eea;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .auth-header {
            text-align: center;
            margin-bottom: 2rem;
            font-weight: 600;
            color: #667eea;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 1.1rem;
        }

        .auth-step {
            display: none;
        }

        .auth-step.active {
            display: block;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
        }

        .step {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin: 0 0.5rem;
            transition: all 0.3s ease;
        }

        .step.completed {
            background: #10b981;
            color: white;
        }

        .step.current {
            background: #667eea;
            color: white;
        }

        .step.pending {
            background: #e2e8f0;
            color: #64748b;
        }

        .step-line {
            width: 40px;
            height: 2px;
            background: #e2e8f0;
            margin-top: 19px;
        }

        .step-line.completed {
            background: #10b981;
        }

        .otp-inputs {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin: 2rem 0;
        }

        .otp-input {
            width: 50px;
            height: 50px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            text-align: center;
            font-size: 1.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
            background: #f8fafc;
        }

        .otp-input:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .otp-input.filled {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .resend-code {
            text-align: center;
            margin-top: 1rem;
        }

        .resend-code button {
            background: none;
            border: none;
            color: #667eea;
            cursor: pointer;
            text-decoration: underline;
        }

        .resend-code button:disabled {
            color: #64748b;
            cursor: not-allowed;
            text-decoration: none;
        }

        .countdown {
            color: #ef4444;
            font-weight: 600;
        }

        .security-info {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .security-info h4 {
            color: #0c4a6e;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .security-info p {
            color: #075985;
            font-size: 0.9rem;
        }

        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .success-message {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            color: #16a34a;
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .slide-in {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        /* Multi-Auth Styles */
        .auth-methods-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }

        .auth-method-card {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            pointer-events: auto;
            z-index: 1;
        }
        
        /* –û—Ç–∫–ª—é—á–µ–Ω–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –º–µ—Ç–æ–¥–æ–≤ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ */
        .auth-method-card.auth-method-disabled,
        .auth-method-card[data-disabled="true"] {
            opacity: 0.5 !important;
            pointer-events: none !important;
            cursor: not-allowed !important;
            filter: grayscale(50%);
        }
        
        .auth-method-card.auth-method-disabled:hover,
        .auth-method-card[data-disabled="true"]:hover {
            transform: none !important;
            box-shadow: none !important;
        }

        .auth-method-card:hover {
            border-color: #667eea;
            background: #f0f4ff;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
        }

        .auth-method-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .auth-method-card.selected .method-icon {
            transform: scale(1.1);
        }

        .method-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            transition: transform 0.3s ease;
        }

        .method-name {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }

        .method-description {
            font-size: 0.8rem;
            opacity: 0.8;
            line-height: 1.3;
        }

        .selected-method-info {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1rem;
            text-align: center;
        }

        .selected-method-info p {
            margin-bottom: 1rem;
            color: #0c4a6e;
            font-weight: 500;
        }

        .phone-auth-form {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
        }

        .messenger-selector {
            display: flex;
            gap: 1rem;
            margin: 1rem 0;
        }

        .messenger-option {
            flex: 1;
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .messenger-option:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .messenger-option.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .oauth-buttons {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin: 1rem 0;
        }

        .oauth-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            background: white;
            color: #374151;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .oauth-btn:hover {
            border-color: #667eea;
            background: #f0f4ff;
            transform: translateY(-1px);
        }

        .oauth-btn.github {
            border-color: #24292e;
            color: #24292e;
        }

        .oauth-btn.github:hover {
            background: #24292e;
            color: white;
        }

        .oauth-btn.vkontakte {
            border-color: #0077ff;
            color: #0077ff;
        }

        .oauth-btn.vkontakte:hover {
            background: #0077ff;
            color: white;
        }

        .oauth-btn.gosuslugi {
            border-color: #00a651;
            color: #00a651;
        }

        .oauth-btn.gosuslugi:hover {
            background: #00a651;
            color: white;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .auth-container {
                flex-direction: column;
                margin: 1rem;
                border-radius: 16px;
            }

            .auth-left {
                padding: 2rem;
                min-height: 300px;
            }

            .auth-right {
                padding: 2rem;
            }

            .logo-text {
                font-size: 2rem;
            }

            .auth-left h1 {
                font-size: 2rem;
            }

            .otp-inputs {
                gap: 0.5rem;
            }

            .otp-input {
                width: 40px;
                height: 40px;
                font-size: 1.2rem;
            }

            /* Multi-Auth Mobile Styles */
            .auth-methods-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
            }

            .auth-method-card {
                padding: 1rem;
            }

            .method-icon {
                font-size: 1.5rem;
            }

            .method-name {
                font-size: 0.9rem;
            }

            .method-description {
                font-size: 0.7rem;
            }

            .messenger-selector {
                flex-direction: column;
            }

            .oauth-buttons {
                gap: 0.5rem;
            }

            .oauth-btn {
                padding: 0.75rem;
                font-size: 0.9rem;
            }
        }

        @media (max-width: 480px) {
            .auth-methods-grid {
                grid-template-columns: 1fr;
            }

            .auth-method-card {
                padding: 1.25rem;
            }

            .method-icon {
                font-size: 1.75rem;
            }
        }
    </style>
</head>
<body>
    <div class="auth-container">
        <!-- Left Side - Branding -->
        <div class="auth-left">
        <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-brain"></i>
        </div>
                <div class="logo-text">Loginus</div>
        </div>

            <h1>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h1>
            <p>–°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–Ω–∞–Ω–∏—è–º–∏ –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π</p>
            
            <ul class="features">
                <li>
                    <i class="fas fa-shield-alt"></i>
                    <span>–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Å 2FA</span>
                </li>
                <li>
                    <i class="fas fa-users"></i>
                    <span>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥–∞–º–∏ –∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è–º–∏</span>
                </li>
                <li>
                    <i class="fas fa-book"></i>
                    <span>–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è</span>
                </li>
                <li>
                    <i class="fas fa-headset"></i>
                    <span>–°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤</span>
                </li>
                <li>
                    <i class="fas fa-chart-bar"></i>
                    <span>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –æ—Ç—á–µ—Ç—ã</span>
                </li>
            </ul>
            </div>

        <!-- Right Side - Auth Forms -->
        <div class="auth-right">
            <div class="auth-form">
                <!-- Auth Header -->
                <div class="auth-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-shield-alt"></i>
                        <span>–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –≤—Ö–æ–¥–∞</span>
                    </div>
                    <button id="switchAccountBtn" onclick="switchAccount()" style="display: none; background: transparent; border: 1px solid #667eea; color: #667eea; padding: 0.4rem 0.8rem; border-radius: 6px; font-size: 0.85rem; cursor: pointer; transition: all 0.3s ease;">
                        <i class="fas fa-exchange-alt"></i> –°–º–µ–Ω–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç
                    </button>
                </div>

                <!-- Method Selection Step -->
                <div id="methodStep" class="auth-step active">
                    <div class="form-header">
                        <h2 class="form-title">–ö–∞–∫ –≤—ã —Ö–æ—Ç–∏—Ç–µ –≤–æ–π—Ç–∏?</h2>
                        <p class="form-subtitle">–í—ã–±–µ—Ä–∏—Ç–µ —É–¥–æ–±–Ω—ã–π –¥–ª—è –≤–∞—Å —Å–ø–æ—Å–æ–± –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏</p>
                    </div>

                    <div class="auth-methods-grid">
                        <!-- Email -->
                        <div class="auth-method-card" data-method="EMAIL" id="emailAuthCard">
                            <div class="method-icon">üìß</div>
                            <div class="method-name">Email</div>
                            <div class="method-description">–í—Ö–æ–¥ –ø–æ email –∏ –ø–∞—Ä–æ–ª—é</div>
                        </div>

                        
                        <!-- Telegram Login Widget -->
                        <div class="auth-method-card" data-method="TELEGRAM_OAUTH" id="telegramAuthCard">
                            <div class="method-icon">üöÄ</div>
                            <div class="method-name">Telegram OAuth</div>
                            <div class="method-description">–ë—ã—Å—Ç—Ä—ã–π –≤—Ö–æ–¥ —á–µ—Ä–µ–∑ Telegram</div>
                        </div>
                        

                        <!-- GitHub -->
                        <div class="auth-method-card" data-method="GITHUB" id="githubAuthCard">
                            <div class="method-icon">üêô</div>
                            <div class="method-name">GitHub</div>
                            <div class="method-description">–í—Ö–æ–¥ —á–µ—Ä–µ–∑ GitHub</div>
                        </div>
                    </div>

                    <div class="selected-method-info" id="selectedMethodInfo" style="display: none;">
                        <p>–í—ã–±—Ä–∞–Ω–Ω—ã–π –º–µ—Ç–æ–¥: <span id="selectedMethodName">Email</span></p>
                        <button type="button" class="btn btn-primary" onclick="proceedWithSelectedMethod()">
                            <span id="proceedBtnText">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</span>
                        </button>
                    </div>
                </div>

                <!-- Email Input Step -->
                <div id="emailStep" class="auth-step">
                    <div class="form-header">
                        <h2 class="form-title">–í–≤–µ–¥–∏—Ç–µ –≤–∞—à email</h2>
                        <p class="form-subtitle">–ú—ã –æ–ø—Ä–µ–¥–µ–ª–∏–º, –µ—Å—Ç—å –ª–∏ —É –≤–∞—Å –∞–∫–∫–∞—É–Ω—Ç –≤ —Å–∏—Å—Ç–µ–º–µ</p>
                    </div>

                    <form id="emailStepForm" onsubmit="handleEmailStep(event)">
                        <div class="form-group">
                            <label class="form-label" for="emailInput">Email</label>
                            <div class="input-group">
                                <i class="fas fa-envelope input-icon"></i>
                                <input type="email" id="emailInput" class="form-input" placeholder="your@email.com" required autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary" id="emailStepBtn">
                            <span id="emailStepBtnText">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</span>
                            <div class="loading hidden" id="emailStepLoading"></div>
                        </button>
                    </form>

                    <div class="form-footer">
                        <button class="btn-link" onclick="goBackToMethodStep()">
                            <i class="fas fa-arrow-left"></i>
                            –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –≤—ã–±–æ—Ä—É –º–µ—Ç–æ–¥–∞
                        </button>
                    </div>
                </div>

                <!-- Login Form -->
                <div id="loginForm" class="auth-step">
                    <div class="form-header">
                        <h2 class="form-title">–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h2>
                        <p class="form-subtitle">–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è –≤—Ö–æ–¥–∞</p>
                        <div class="email-display">
                            <i class="fas fa-envelope"></i>
                            <span id="loginEmailDisplay"></span>
                            <button type="button" class="btn-link" onclick="goBackToEmailStep()">–ò–∑–º–µ–Ω–∏—Ç—å email</button>
                        </div>
        </div>

                    <form id="loginFormElement" method="post" onsubmit="handleLogin(event)">
            <div class="form-group">
                            <label class="form-label" for="loginPassword">–ü–∞—Ä–æ–ª—å</label>
                            <div class="input-group">
                                <i class="fas fa-lock input-icon"></i>
                                <input type="password" id="loginPassword" class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" required autofocus>
                                <button type="button" class="password-toggle" onclick="togglePassword('loginPassword')">
                                    <i class="fas fa-eye"></i>
            </button>
            </div>
        </div>

            <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" id="rememberMe" style="margin-right: 0.5rem;">
                                –ó–∞–ø–æ–º–Ω–∏—Ç—å –º–µ–Ω—è
                            </label>
            </div>

                        <button type="submit" class="btn btn-primary" id="loginBtn">
                            <span id="loginBtnText">–í–æ–π—Ç–∏</span>
                            <div class="loading hidden" id="loginLoading"></div>
            </button>
                    </form>

                    <div class="divider">
                        <span>–∏–ª–∏</span>
                    </div>

                    <button type="button" class="btn btn-secondary" onclick="showEmailCodeForm()">
                        <i class="fas fa-envelope"></i>
                        –í–æ–π—Ç–∏ –ø–æ –∫–æ–¥—É —Å –ø–æ—á—Ç—ã
                    </button>

                    <div class="form-footer">
                        <button class="btn-link" onclick="showForgotPassword()">
                            –ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?
            </button>
                    </div>
        </div>

                <!-- Email Code Form -->
                <div id="emailCodeForm" class="auth-step">
                    <div class="form-header">
                        <h2 class="form-title">–í—Ö–æ–¥ –ø–æ –∫–æ–¥—É —Å –ø–æ—á—Ç—ã</h2>
                        <p class="form-subtitle">–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥, –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –Ω–∞ –≤–∞—à—É –ø–æ—á—Ç—É</p>
                    </div>

                    <div class="security-info">
                        <h4>
                            <i class="fas fa-envelope"></i>
                            –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—á—Ç—É
                        </h4>
                        <p>–ú—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –Ω–∞ –≤–∞—à—É –ø–æ—á—Ç—É. –í–≤–µ–¥–∏—Ç–µ 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥ –¥–ª—è –≤—Ö–æ–¥–∞ –≤ —Å–∏—Å—Ç–µ–º—É.</p>
                    </div>

                    <form id="emailCodeFormElement" onsubmit="handleEmailCode(event)">
                        <div class="form-group">
                            <label class="form-label" for="emailCodeEmail">Email</label>
                            <div class="input-group">
                                <i class="fas fa-envelope input-icon"></i>
                                <input type="email" id="emailCodeEmail" class="form-input" placeholder="your@email.com" required autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">–ö–æ–¥ —Å –ø–æ—á—Ç—ã</label>
                            <div class="otp-inputs">
                                <input type="text" class="otp-input" maxlength="1" oninput="moveToNext(this, 0)">
                                <input type="text" class="otp-input" maxlength="1" oninput="moveToNext(this, 1)">
                                <input type="text" class="otp-input" maxlength="1" oninput="moveToNext(this, 2)">
                                <input type="text" class="otp-input" maxlength="1" oninput="moveToNext(this, 3)">
                                <input type="text" class="otp-input" maxlength="1" oninput="moveToNext(this, 4)">
                                <input type="text" class="otp-input" maxlength="1" oninput="moveToNext(this, 5)">
                            </div>
                        </div>

                        <button type="button" class="btn btn-primary" id="sendCodeBtn" onclick="sendEmailCode()">
                            <span id="sendCodeBtnText">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥</span>
                            <div class="loading hidden" id="sendCodeLoading"></div>
                        </button>

                        <button type="submit" class="btn btn-primary hidden" id="emailCodeBtn">
                            <span id="emailCodeBtnText">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</span>
                            <div class="loading hidden" id="emailCodeLoading"></div>
                        </button>
                    </form>

                    <div class="resend-code">
                        <button type="button" onclick="resendEmailCode()" id="resendBtn">
                            <span id="resendBtnText">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ</span>
                            <span class="countdown hidden" id="resendCountdown"></span>
                        </button>
                    </div>

                    <div class="form-footer">
                        <button class="btn-link" onclick="showLoginForm()">
                            <i class="fas fa-arrow-left"></i>
                            –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –≤—Ö–æ–¥—É
                        </button>
                    </div>
                </div>

                <!-- 2FA Form -->
                <div id="twoFactorForm" class="auth-step">
                    <div class="form-header">
                        <h2 class="form-title">–î–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è</h2>
                        <p class="form-subtitle">–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞</p>
            </div>

                    <div class="security-info">
                        <h4>
                            <i class="fas fa-shield-alt"></i>
                            –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
                        </h4>
                        <p>–î–ª—è –∑–∞—â–∏—Ç—ã –≤–∞—à–µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ –≤–∫–ª—é—á–µ–Ω–∞ –¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è. –í–≤–µ–¥–∏—Ç–µ 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥ –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Google Authenticator –∏–ª–∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ–≥–æ.</p>
        </div>

                    <form id="twoFactorFormElement" onsubmit="handle2FA(event)">
            <div class="form-group">
                            <label class="form-label">–ö–æ–¥ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞</label>
                            <div class="otp-inputs">
                                <input type="text" class="otp-input" maxlength="1" oninput="moveToNext2FA(this, 0)">
                                <input type="text" class="otp-input" maxlength="1" oninput="moveToNext2FA(this, 1)">
                                <input type="text" class="otp-input" maxlength="1" oninput="moveToNext2FA(this, 2)">
                                <input type="text" class="otp-input" maxlength="1" oninput="moveToNext2FA(this, 3)">
                                <input type="text" class="otp-input" maxlength="1" oninput="moveToNext2FA(this, 4)">
                                <input type="text" class="otp-input" maxlength="1" oninput="moveToNext2FA(this, 5)">
            </div>
            </div>

                        <button type="submit" class="btn btn-primary" id="twoFactorBtn">
                            <span id="twoFactorBtnText">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</span>
                            <div class="loading hidden" id="twoFactorLoading"></div>
            </button>
                    </form>

            </div>
            
            <!-- nFA Form -->
            <div id="nfaForm" class="auth-step">
                <div class="form-header">
                    <h2 class="form-title">–ú–Ω–æ–≥–æ—Ñ–∞–∫—Ç–æ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (nFA)</h2>
                    <p class="form-subtitle">–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥—ã —Å–æ –≤—Å–µ—Ö –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤ –∑–∞—â–∏—Ç—ã</p>
                </div>

                <div class="security-info">
                    <h4>
                        <i class="fas fa-shield-alt"></i>
                        –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
                    </h4>
                    <p>–î–ª—è –∑–∞—â–∏—Ç—ã –≤–∞—à–µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ –≤–∫–ª—é—á–µ–Ω–∞ –º–Ω–æ–≥–æ—Ñ–∞–∫—Ç–æ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è. –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥—ã —Å–æ –≤—Å–µ—Ö –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤ –∑–∞—â–∏—Ç—ã.</p>
                </div>

                <div id="nfaMethodsForms" style="margin-bottom: 1.5rem;">
                    <!-- –ú–µ—Ç–æ–¥—ã nFA –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>

                <form id="nfaFormElement" onsubmit="handleNFA(event)">
                    <button type="submit" class="btn btn-primary" id="nfaBtn">
                        <span id="nfaBtnText">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—Å–µ –º–µ—Ç–æ–¥—ã</span>
                        <div class="loading hidden" id="nfaLoading"></div>
                    </button>
                </form>
            </div>
            
                <!-- –£–±—Ä–∞–Ω–∞ –æ—Ç–¥–µ–ª—å–Ω–∞—è —Ñ–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ - —Ç–æ–ª—å–∫–æ —É–º–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è -->

                <!-- Forgot Password Form -->
                <div id="forgotPasswordForm" class="auth-step">
                    <div class="form-header">
                        <h2 class="form-title">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è</h2>
                        <p class="form-subtitle">–í–≤–µ–¥–∏—Ç–µ email –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞</p>
                </div>
                
                    <form id="forgotPasswordFormElement" onsubmit="handleForgotPassword(event)">
                    <div class="form-group">
                            <label class="form-label" for="forgotEmail">Email</label>
                            <div class="input-group">
                                <i class="fas fa-envelope input-icon"></i>
                                <input type="email" id="forgotEmail" class="form-input" placeholder="your@email.com" required autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
                    </div>
                </div>
                
                        <button type="submit" class="btn btn-primary" id="forgotBtn">
                            <span id="forgotBtnText">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É</span>
                            <div class="loading hidden" id="forgotLoading"></div>
                </button>
                    </form>

                    <div class="form-footer">
                        <button class="btn-link" onclick="showLoginForm()">
                            <i class="fas fa-arrow-left"></i>
                            –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –≤—Ö–æ–¥—É
                </button>
                    </div>
            </div>
            
                <!-- Reset Password Form -->
                <div id="resetPasswordForm" class="auth-step">
                    <div class="form-header">
                        <h2 class="form-title">–°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è</h2>
                        <p class="form-subtitle">–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –¥–ª—è –≤–∞—à–µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞</p>
                </div>
                
                    <form id="resetPasswordFormElement" onsubmit="handleResetPassword(event)">
                        <div class="form-group">
                            <label class="form-label" for="resetNewPassword">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
                            <div class="input-group">
                                <i class="fas fa-lock input-icon"></i>
                                <input type="password" id="resetNewPassword" class="form-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å" required>
                                <button type="button" class="password-toggle" onclick="togglePassword('resetNewPassword')">
                                    <i class="fas fa-eye"></i>
                    </button>
                </div>
            </div>
            
                <div class="form-group">
                            <label class="form-label" for="resetConfirmPassword">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å</label>
                            <div class="input-group">
                                <i class="fas fa-lock input-icon"></i>
                                <input type="password" id="resetConfirmPassword" class="form-input" placeholder="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å" required>
                                <button type="button" class="password-toggle" onclick="togglePassword('resetConfirmPassword')">
                                    <i class="fas fa-eye"></i>
                                </button>
                </div>
                </div>

                        <button type="submit" class="btn btn-primary" id="resetBtn">
                            <span id="resetBtnText">–°–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å</span>
                            <div class="loading hidden" id="resetLoading"></div>
                </button>
                    </form>

                    <div class="form-footer">
                        <button class="btn-link" onclick="showLoginForm()">
                            <i class="fas fa-arrow-left"></i>
                            –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –≤—Ö–æ–¥—É
                        </button>
                </div>
            </div>
            
                <!-- Complete Registration Form -->
                <div id="completeRegistrationForm" class="auth-step">
                    <div class="form-header">
                        <h2 class="form-title">–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</h2>
                        <p class="form-subtitle">–î–æ–ø–æ–ª–Ω–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ–±–µ</p>
                    </div>

                    <form id="completeRegistrationFormElement" onsubmit="handleCompleteRegistration(event)">
                <div class="form-group">
                            <label class="form-label" for="completeFirstName">–ò–º—è</label>
                            <div class="input-group">
                                <i class="fas fa-user input-icon"></i>
                                <input type="text" id="completeFirstName" class="form-input" placeholder="–í–∞—à–µ –∏–º—è" required>
                </div>
                        </div>

                <div class="form-group">
                            <label class="form-label" for="completeLastName">–§–∞–º–∏–ª–∏—è</label>
                            <div class="input-group">
                                <i class="fas fa-user input-icon"></i>
                                <input type="text" id="completeLastName" class="form-input" placeholder="–í–∞—à–∞ —Ñ–∞–º–∏–ª–∏—è" required>
                </div>
                        </div>

                <div class="form-group">
                            <label class="form-label" for="completePhone">–¢–µ–ª–µ—Ñ–æ–Ω (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                            <div class="input-group">
                                <i class="fas fa-phone input-icon"></i>
                                <input type="tel" id="completePhone" class="form-input" placeholder="+7 (999) 123-45-67">
                </div>
                        </div>

                        <button type="submit" class="btn btn-primary" id="completeBtn">
                            <span id="completeBtnText">–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é</span>
                            <div class="loading hidden" id="completeLoading"></div>
                </button>
                    </form>
                </div>

                <!-- Smart Registration Form (when user doesn't exist during login) -->
                <div id="smartRegistrationForm" class="auth-step">
                    <div class="form-header">
                        <h2 class="form-title" id="smartFormTitle">–ó–∞–≤–µ—Ä—à–∏—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é</h2>
                        <p class="form-subtitle" id="smartFormSubtitle">–ú—ã –∑–∞–ø–æ–º–Ω–∏–ª–∏ –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ. –î–æ–±–∞–≤—å—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é:</p>
                </div>

                    <div class="security-info">
                        <h4>
                            <i class="fas fa-info-circle"></i>
                            –£–º–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
                        </h4>
                        <p>–ú—ã –æ–±–Ω–∞—Ä—É–∂–∏–ª–∏, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Ç–∞–∫–∏–º email –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞.</p>
            </div>
            
                    <form id="smartRegistrationFormElement" onsubmit="handleSmartRegistration(event)">
                <div class="form-group">
                            <label class="form-label" for="smartEmail">Email</label>
                            <div class="input-group">
                                <i class="fas fa-envelope input-icon"></i>
                                <input type="email" id="smartEmail" class="form-input" placeholder="your@email.com" required readonly>
                            </div>
                            <small style="color: #64748b; font-size: 0.8rem;">Email —É–∂–µ –∑–∞–ø–æ–ª–Ω–µ–Ω –∏–∑ —Ñ–æ—Ä–º—ã –≤—Ö–æ–¥–∞</small>
                </div>
                
                <div class="form-group">
                            <label class="form-label" for="smartPassword">–ü–∞—Ä–æ–ª—å</label>
                            <div class="input-group">
                                <i class="fas fa-lock input-icon"></i>
                                <input type="password" id="smartPassword" class="form-input" placeholder="–°–æ–∑–¥–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å" required>
                                <button type="button" class="password-toggle" onclick="togglePassword('smartPassword')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                </div>
                
                <div class="form-group">
                            <label class="form-label" for="smartConfirmPassword">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å</label>
                            <div class="input-group">
                                <i class="fas fa-lock input-icon"></i>
                                <input type="password" id="smartConfirmPassword" class="form-input" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å" required>
                                <button type="button" class="password-toggle" onclick="togglePassword('smartConfirmPassword')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                </div>
                
                <div class="form-group">
                            <label class="form-label" for="smartFirstName">–ò–º—è *</label>
                            <div class="input-group">
                                <i class="fas fa-user input-icon"></i>
                                <input type="text" id="smartFirstName" class="form-input" placeholder="–í–∞—à–µ –∏–º—è" required>
                </div>
                </div>
                
                        <div class="form-group">
                            <label class="form-label" for="smartLastName">–§–∞–º–∏–ª–∏—è *</label>
                            <div class="input-group">
                                <i class="fas fa-user input-icon"></i>
                                <input type="text" id="smartLastName" class="form-input" placeholder="–í–∞—à–∞ —Ñ–∞–º–∏–ª–∏—è" required>
                </div>
           </div>
                
                        <div class="form-group">
                            <label class="form-label" for="smartPhone">–¢–µ–ª–µ—Ñ–æ–Ω (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                            <div class="input-group">
                                <i class="fas fa-phone input-icon"></i>
                                <input type="tel" id="smartPhone" class="form-input" placeholder="+7 (999) 123-45-67">
                </div>
            </div>
            
                <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" id="smartAgreeTerms" required style="margin-right: 0.5rem;">
                                –Ø —Å–æ–≥–ª–∞—Å–µ–Ω —Å <a href="#" style="color: #667eea;">—É—Å–ª–æ–≤–∏—è–º–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</a> –∏ <a href="#" style="color: #667eea;">–ø–æ–ª–∏—Ç–∏–∫–æ–π –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</a>
                            </label>
                </div>

                        <button type="submit" class="btn btn-primary" id="smartBtn">
                            <span id="smartBtnText">–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é</span>
                            <div class="loading hidden" id="smartLoading"></div>
                </button>
                    </form>

                    <div class="form-footer">
                        <button class="btn-link" onclick="goBackToEmailStep()">
                            <i class="fas fa-arrow-left"></i>
                            –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –≤–≤–æ–¥—É email
                        </button>
                </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Version –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–µ—à–∞
        const VERSION = '2.0.7';
        console.log('üöÄ Loginus Frontend v' + VERSION + ' –∑–∞–≥—Ä—É–∂–µ–Ω');
        
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–µ—à–∞
        if (localStorage.getItem('frontendVersion') !== VERSION) {
            localStorage.setItem('frontendVersion', VERSION);
            console.log('üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–µ—à–∞ –¥–æ –≤–µ—Ä—Å–∏–∏ ' + VERSION);
        }
        
        // Define API_BASE_URL globally
        window.API_BASE_URL = (() => {
                const hostname = window.location.hostname;
                if (hostname === 'localhost' || hostname === '127.0.0.1') {
                    return 'http://localhost:3001';
                }
                if (hostname.match(/^\d+\.\d+\.\d+\.\d+$/)) {
                    return `${window.location.protocol}//${window.location.hostname}:3001`;
                }
                return `${window.location.protocol}//${window.location.hostname}`;
            })();
            console.log('API_BASE_URL defined:', window.API_BASE_URL);
        
        // Global variables
        let currentUser = null;
        let authToken = null;
        let pending2FAUserId = null;
        let pending2FAEmail = null;
        let pendingNFAUserId = null;
        let pendingNFAMethods = [];
        let pendingNFAEmail = null;
        let selectedAuthMethod = null;
        
        // –ö–†–ò–¢–ò–ß–ù–û: –û–ø—Ä–µ–¥–µ–ª—è–µ–º selectAuthMethod –°–†–ê–ó–£, —á—Ç–æ–±—ã –æ–Ω–∞ –±—ã–ª–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è inline onclick
        // –î–µ–ª–∞–µ–º –µ—ë –≥–ª–æ–±–∞–ª—å–Ω–æ–π –î–û —Ç–æ–≥–æ, –∫–∞–∫ HTML –ø–∞—Ä—Å–∏—Ç—Å—è —Å onclick –∞—Ç—Ä–∏–±—É—Ç–∞–º–∏
        window.selectAuthMethod = function selectAuthMethod(method) {
            console.log('üìû selectAuthMethod called with:', method);
            selectedAuthMethod = method;
            
            // Remove previous selection
            document.querySelectorAll('.auth-method-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Add selection to clicked card
            const selectedCard = document.querySelector(`[data-method="${method}"]`);
            if (selectedCard) {
                selectedCard.classList.add('selected');
                console.log('‚úÖ Card selected:', selectedCard.id);
            }
            
            // Show method info
            const methodNames = {
                'EMAIL': 'Email',
                'TELEGRAM_OAUTH': 'Telegram OAuth',
                'GITHUB': 'GitHub'
            };
            
            const methodNameEl = document.getElementById('selectedMethodName');
            const methodInfoEl = document.getElementById('selectedMethodInfo');
            
            if (methodNameEl) {
                methodNameEl.textContent = methodNames[method] || method;
            }
            if (methodInfoEl) {
                methodInfoEl.style.display = 'block';
                console.log('‚úÖ Method info shown');
            } else {
                console.error('‚ùå selectedMethodInfo element not found');
            }
            
            console.log('‚úÖ selectAuthMethod completed for:', method);
        };

        // –û—Ç–∫–ª—é—á–∏—Ç—å –Ω–µ–∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ—Å—Ç—å –æ—Ç–∫–ª—é—á–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ - –æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∑–∞—Ä–∞–Ω–µ–µ
        async function disableDisabledAuthMethods() {
            try {
                console.log('üîç [disableDisabledAuthMethods] Starting...');
                
                const emailCard = document.getElementById('emailAuthCard');
                const githubCard = document.getElementById('githubAuthCard');
                const telegramCard = document.getElementById('telegramAuthCard');
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π endpoint –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ –º–æ–¥—É–ª–µ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
                let statusResult;
                try {
                    console.log('üåê Calling /api/micro-modules/auth/status...');
                    const response = await apiCall('/api/micro-modules/auth/status', { method: 'GET' });
                    console.log('‚úÖ Successfully got response from /api/micro-modules/auth/status:', JSON.stringify(response));
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–≤–µ—Ç –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
                    if (response && typeof response === 'object') {
                        // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ - –º–æ–∂–µ—Ç –±—ã—Ç—å {email: {enabled: true}} –∏–ª–∏ {email: true}
                        statusResult = {
                            email: typeof response.email === 'object' ? response.email : { enabled: response.email !== false },
                            github: typeof response.github === 'object' ? response.github : { enabled: response.github !== false },
                            telegram: typeof response.telegram === 'object' ? response.telegram : { enabled: response.telegram !== false }
                        };
                        console.log('‚úÖ Response format normalized:', JSON.stringify(statusResult));
                    } else {
                        console.error('‚ùå Invalid response format:', response);
                        throw new Error('Invalid response format');
                    }
                } catch (e) {
                    console.error('‚ùå [disableDisabledAuthMethods] Error getting auth status from /api/micro-modules/auth/status:', e);
                    console.error('‚ùå [disableDisabledAuthMethods] Error details:', e.message);
                    console.warn('‚ö†Ô∏è [disableDisabledAuthMethods] Failed to get status, using default: ALL ENABLED');
                    // –ü—Ä–∏ –æ—à–∏–±–∫–µ —Å—á–∏—Ç–∞–µ–º —á—Ç–æ –≤—Å–µ –≤–∫–ª—é—á–µ–Ω–æ
                    statusResult = {
                        email: { enabled: true },
                        github: { enabled: true },
                        telegram: { enabled: true }
                    };
                    console.log('‚úÖ [disableDisabledAuthMethods] Using default: all enabled due to error');
                }
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–∂–µ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –∏–ª–∏ –Ω–∞—Ö–æ–¥–∏–º –∑–∞–Ω–æ–≤–æ
                const emailCardEl = document.getElementById('emailAuthCard');
                const githubCardEl = document.getElementById('githubAuthCard');
                const telegramCardEl = document.getElementById('telegramAuthCard');
                
                console.log('üîç Email card element:', emailCardEl);
                console.log('üîç Email enabled status:', statusResult?.email?.enabled);
                
                // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏
                function disableCard(cardEl, methodName) {
                    if (!cardEl) {
                        console.warn(`‚ö†Ô∏è [disableCard] Card element not found for ${methodName}`);
                        return;
                    }
                    console.log(`‚ùå [disableCard] ${methodName} auth is disabled, making card non-clickable`);
                    console.log(`‚ùå [disableCard] Card before:`, {
                        id: cardEl.id,
                        hasMethod: cardEl.hasAttribute('data-method'),
                        hasDisabled: cardEl.hasAttribute('data-disabled'),
                        hasClass: cardEl.classList.contains('auth-method-disabled')
                    });
                    
                    cardEl.style.setProperty('opacity', '0.5', 'important');
                    cardEl.style.setProperty('pointer-events', 'none', 'important');
                    cardEl.style.setProperty('cursor', 'not-allowed', 'important');
                    cardEl.classList.add('auth-method-disabled');
                    cardEl.setAttribute('data-disabled', 'true');
                    cardEl.removeAttribute('data-method'); // –£–¥–∞–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä "–æ—Ç–∫–ª—é—á–µ–Ω–æ"
                    let disabledBadge = cardEl.querySelector('.auth-disabled-badge');
                    if (!disabledBadge) {
                        disabledBadge = document.createElement('div');
                        disabledBadge.className = 'auth-disabled-badge';
                        disabledBadge.textContent = '–û—Ç–∫–ª—é—á–µ–Ω–æ';
                        disabledBadge.style.cssText = 'position: absolute; top: 8px; right: 8px; background: #ef4444; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; z-index: 10;';
                        cardEl.appendChild(disabledBadge);
                        console.log(`‚úÖ [disableCard] Added disabled badge to ${methodName} card`);
                    }
                    
                    console.log(`‚úÖ [disableCard] ${methodName} card disabled successfully`);
                    console.log(`‚úÖ [disableCard] Card after:`, {
                        id: cardEl.id,
                        opacity: cardEl.style.opacity,
                        pointerEvents: cardEl.style.pointerEvents,
                        cursor: cardEl.style.cursor,
                        hasMethod: cardEl.hasAttribute('data-method'),
                        hasDisabled: cardEl.hasAttribute('data-disabled'),
                        hasClass: cardEl.classList.contains('auth-method-disabled'),
                        hasBadge: !!cardEl.querySelector('.auth-disabled-badge')
                    });
                }
                
                // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏
                function enableCard(cardEl, methodName, methodValue) {
                    if (!cardEl) return;
                    console.log(`‚úÖ ${methodName} auth is enabled, making card clickable`);
                    cardEl.style.setProperty('opacity', '1', 'important');
                    cardEl.style.setProperty('pointer-events', 'auto', 'important');
                    cardEl.style.setProperty('cursor', 'pointer', 'important');
                    cardEl.classList.remove('auth-method-disabled');
                    cardEl.removeAttribute('data-disabled');
                    cardEl.setAttribute('data-method', methodValue);
                    
                    // –£–¥–∞–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä "–æ—Ç–∫–ª—é—á–µ–Ω–æ"
                    const disabledBadge = cardEl.querySelector('.auth-disabled-badge');
                    if (disabledBadge) {
                        disabledBadge.remove();
                    }
                }
                
                if (emailCardEl) {
                    const emailEnabled = statusResult?.email?.enabled;
                    if (emailEnabled === false) {
                        disableCard(emailCardEl, 'Email');
                    } else {
                        enableCard(emailCardEl, 'Email', 'EMAIL');
                    }
                } else {
                    console.warn('‚ö†Ô∏è Email card element not found!');
                }
                
                if (githubCardEl) {
                    const githubEnabled = statusResult?.github?.enabled;
                    if (githubEnabled === false) {
                        disableCard(githubCardEl, 'GitHub');
                    } else {
                        enableCard(githubCardEl, 'GitHub', 'GITHUB');
                    }
                }
                
                if (telegramCardEl) {
                    const telegramEnabled = statusResult?.telegram?.enabled;
                    if (telegramEnabled === false) {
                        disableCard(telegramCardEl, 'Telegram');
                    } else {
                        enableCard(telegramCardEl, 'Telegram', 'TELEGRAM_OAUTH');
                    }
                }
                
                // –ï—Å–ª–∏ email-auth –æ—Ç–∫–ª—é—á–µ–Ω, —Å–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Ñ–æ—Ä–º—ã, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å email
                if (statusResult?.email?.enabled === false) {
                    const emailStep = document.getElementById('emailStep');
                    const loginForm = document.getElementById('loginForm');
                    const emailCodeForm = document.getElementById('emailCodeForm');
                    const smartRegistrationForm = document.getElementById('smartRegistrationForm');
                    
                    [emailStep, loginForm, emailCodeForm, smartRegistrationForm].forEach(el => {
                        if (el) {
                            el.style.display = 'none';
                            el.style.visibility = 'hidden';
                            el.setAttribute('data-hidden-by-module', 'true');
                        }
                    });
                } else {
                    const emailStep = document.getElementById('emailStep');
                    const loginForm = document.getElementById('loginForm');
                    const emailCodeForm = document.getElementById('emailCodeForm');
                    const smartRegistrationForm = document.getElementById('smartRegistrationForm');
                    
                    [emailStep, loginForm, emailCodeForm, smartRegistrationForm].forEach(el => {
                        if (el) {
                            el.style.display = '';
                            el.style.visibility = '';
                            el.removeAttribute('data-hidden-by-module');
                        }
                    });
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –º–æ–¥—É–ª–µ–π:', error);
                // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –Ω–µ —Å–∫—Ä—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã
            }
        }
        

        // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –æ–¥–∏–Ω —Ä–∞–∑ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
        // –í–ê–ñ–ù–û: –í—ã–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑, —á—Ç–æ–±—ã –∫–∞—Ä—Ç–æ—á–∫–∏ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª–∏—Å—å –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ
        let disableDisabledAuthMethodsCalled = false;
        function callDisableDisabledAuthMethodsOnce() {
            if (disableDisabledAuthMethodsCalled) {
                console.log('‚ö†Ô∏è disableDisabledAuthMethods already called, skipping (use forceRefresh=true to override)');
                return;
            }
            disableDisabledAuthMethodsCalled = true;
            console.log('üîÑ [callDisableDisabledAuthMethodsOnce] Calling disableDisabledAuthMethods...');
            disableDisabledAuthMethods().catch(e => console.error('Error in disableDisabledAuthMethods:', e));
        }
        
        // –ü—É–±–ª–∏—á–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
        window.forceRefreshAuthMethods = function() {
            console.log('üîÑ [forceRefreshAuthMethods] Forcing refresh of auth methods status...');
            disableDisabledAuthMethodsCalled = false;
            callDisableDisabledAuthMethodsOnce();
        };
        
        // –í—ã–∑—ã–≤–∞–µ–º —Å—Ä–∞–∑—É –∏ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
        console.log('üìã [Script init] Setting up disableDisabledAuthMethods calls...');
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                console.log('üìã [DOMContentLoaded] DOM ready, scheduling disableDisabledAuthMethods...');
                setTimeout(() => {
                    console.log('üìã [setTimeout] Executing disableDisabledAuthMethods...');
                    callDisableDisabledAuthMethodsOnce();
                }, 500);
            });
        } else {
            console.log('üìã [Script init] DOM already ready, scheduling disableDisabledAuthMethods...');
            setTimeout(() => {
                console.log('üìã [setTimeout] Executing disableDisabledAuthMethods...');
                callDisableDisabledAuthMethodsOnce();
            }, 500);
        }

        // Show method selection step
        async function showMethodStep() {
            console.log('üîµ showMethodStep called');
            document.querySelectorAll('.auth-step').forEach(step => step.classList.remove('active'));
            document.getElementById('methodStep').classList.add('active');
            // –°–∫—Ä—ã–≤–∞–µ–º –æ—Ç–∫–ª—é—á–µ–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ - –≤—ã–∑—ã–≤–∞–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ —Å –∑–∞–¥–µ—Ä–∂–∫–∞–º–∏
            console.log('üîµ Calling disableDisabledAuthMethods');
            // –£–±—Ä–∞–Ω–æ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –≤—ã–∑–æ–≤ - –≤—ã–∑—ã–≤–∞–µ–º –æ–¥–∏–Ω —Ä–∞–∑ –≥–¥–µ –Ω—É–∂–Ω–æ
            callDisableDisabledAuthMethodsOnce();
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // ‚úÖ –°–ë–†–û–° –°–û–°–¢–û–Ø–ù–ò–ô: –û—á–∏—â–∞–µ–º –≤—Å–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            // –≠—Ç–æ –≤–∞–∂–Ω–æ –ø–æ—Å–ª–µ –≤—ã—Ö–æ–¥–∞, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∫–Ω–æ–ø–æ–∫
            isRedirecting = false;
            selectedAuthMethod = null;
            
            // –û—á–∏—â–∞–µ–º –≤—Å–µ –∫–ª–∞—Å—Å—ã selected —Å –∫–∞—Ä—Ç–æ—á–µ–∫
            document.querySelectorAll('.auth-method-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // –°–∫—Ä—ã–≤–∞–µ–º info –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –º–µ—Ç–æ–¥–µ
            const methodInfoEl = document.getElementById('selectedMethodInfo');
            if (methodInfoEl) {
                methodInfoEl.style.display = 'none';
            }
            
            console.log('üîÑ States reset on page load');
            
            // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–Ω–æ–ø–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            // –í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º addEventListener –≤–º–µ—Å—Ç–æ inline onclick –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
            const authMethodCards = document.querySelectorAll('.auth-method-card');
            authMethodCards.forEach(card => {
                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: —É–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ –∫–∞—Ä—Ç–æ—á–∫–∞ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–∞
                card.style.cursor = 'pointer';
                card.style.pointerEvents = 'auto';
                
                // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å (–¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è)
                const newCard = card.cloneNode(true);
                card.parentNode.replaceChild(newCard, card);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —á–µ—Ä–µ–∑ addEventListener - —ç—Ç–æ –Ω–∞–¥–µ–∂–Ω–µ–µ —á–µ–º inline onclick
                newCard.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ª–∏ –∫–ª–∏–∫
                    if (isRedirecting) {
                        console.log('üö´ Click blocked - redirect in progress');
                        return;
                    }
                    
                    const method = this.getAttribute('data-method');
                    console.log('üñ±Ô∏è Card clicked via addEventListener, method:', method, 'Card ID:', this.id);
                    if (method) {
                        if (typeof window.selectAuthMethod === 'function') {
                            window.selectAuthMethod(method);
                        } else {
                            console.error('‚ùå window.selectAuthMethod not available, type:', typeof window.selectAuthMethod);
                        }
                    } else {
                        console.error('‚ùå No method attribute found on card:', this.id);
                    }
                }, true); // –ò—Å–ø–æ–ª—å–∑—É–µ–º capture –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
                
                // –¢–∞–∫–∂–µ –¥–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —á–µ—Ä–µ–∑ touchstart –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
                newCard.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ª–∏ –∫–ª–∏–∫
                    if (isRedirecting) {
                        console.log('üö´ Touch blocked - redirect in progress');
                        return;
                    }
                    
                    const method = this.getAttribute('data-method');
                    if (method && typeof window.selectAuthMethod === 'function') {
                        window.selectAuthMethod(method);
                    }
                }, { passive: false });
            });
            
            // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å"
            const proceedBtn = document.querySelector('#selectedMethodInfo button');
            if (proceedBtn) {
                proceedBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    proceedWithSelectedMethod();
                });
            }
            
            // –û—Ç–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–µ–π email
            const emailInputs = document.querySelectorAll('input[type="email"]');
            emailInputs.forEach(input => {
                input.setAttribute('autocomplete', 'off');
                input.setAttribute('autocorrect', 'off');
                input.setAttribute('autocapitalize', 'off');
                input.setAttribute('spellcheck', 'false');
                input.setAttribute('data-lpignore', 'true');
                input.setAttribute('data-form-type', 'other');
                
                // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Ç–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ
                input.addEventListener('focus', function() {
                    this.setAttribute('autocomplete', 'off');
                });
            });
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥ –∏–∑ URL –≤ localStorage, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
            const urlParams = new URLSearchParams(window.location.search);
            const referralCodeFromUrl = urlParams.get('ref') || urlParams.get('referral') || urlParams.get('referralCode');
            if (referralCodeFromUrl) {
                localStorage.setItem('pendingReferralCode', referralCodeFromUrl);
                console.log('üîó –†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω: ' + referralCodeFromUrl);
            }
            
            // Check if nFA is required from URL parameter (for GitHub/Telegram OAuth)
            // –í–ê–ñ–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º nFA –ü–ï–†–ï–î –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Ç–æ–∫–µ–Ω–∞, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ –Ω–∞ dashboard
            const nfaParam = urlParams.get('nfa');
            const nfaUserId = urlParams.get('userId');
            const nfaMethodsStr = urlParams.get('methods');
            
            // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ª–∏ —ç—Ç–æ –Ω–æ–≤–∞—è –ø–æ–ø—ã—Ç–∫–∞ nFA
            // –ï—Å–ª–∏ userId –∏–∑ URL –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ –≤ sessionStorage, —ç—Ç–æ –Ω–æ–≤–∞—è –ø–æ–ø—ã—Ç–∫–∞
            const savedNfaUserId = sessionStorage.getItem('nfaUserId');
            const nfaCodesSent = sessionStorage.getItem('nfaCodesSent');
            const isNewNfaAttempt = nfaUserId && nfaUserId !== savedNfaUserId;
            
            // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –û—á–∏—â–∞–µ–º —Ñ–ª–∞–≥–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–¥–æ–≤ –ø—Ä–∏ –Ω–æ–≤–æ–π –ø–æ–ø—ã—Ç–∫–µ –∏–ª–∏ –µ—Å–ª–∏ –ø—Ä–æ—à–ª–æ –º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
            // –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –∫–æ–¥—ã –≤—Å–µ–≥–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –ø—Ä–∏ –Ω–æ–≤–æ–π –ø–æ–ø—ã—Ç–∫–µ –≤—Ö–æ–¥–∞
            if (isNewNfaAttempt && savedNfaUserId) {
                console.log('üîÑ [DOMContentLoaded] New nFA attempt detected, clearing old flags');
                const oldCodesSentKey = `nfaCodesSent_${savedNfaUserId}`;
                sessionStorage.removeItem(oldCodesSentKey);
                sessionStorage.removeItem('nfaCodesSent');
            }
            
            console.log('üîç [DOMContentLoaded] nFA check:', { 
                nfaParam, 
                nfaUserId, 
                savedNfaUserId,
                nfaCodesSent, 
                isNewNfaAttempt,
                condition: nfaParam === 'true' && (isNewNfaAttempt || !nfaCodesSent)
            });
            
            if (nfaParam === 'true' && nfaUserId && nfaMethodsStr && (isNewNfaAttempt || !nfaCodesSent)) {
                const nfaUserId = urlParams.get('userId');
                const nfaMethodsStr = urlParams.get('methods');
                console.log('üîç [DOMContentLoaded] nFA params:', { nfaUserId, nfaMethodsStr });
                
                // ‚úÖ –°–û–•–†–ê–ù–ï–ù–ò–ï OAuth –ü–ê–†–ê–ú–ï–¢–†–û–í: –ï—Å–ª–∏ –º—ã –≤ OAuth flow, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ sessionStorage
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL (–º–æ–≥—É—Ç –±—ã—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ø—Ä–∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç–µ –Ω–∞ nFA)
                const oauthFlow = urlParams.get('oauth_flow') === 'true';
                const returnTo = urlParams.get('return_to');
                const clientId = urlParams.get('client_id');
                
                if (oauthFlow && returnTo) {
                    console.log('üîÑ [DOMContentLoaded] Saving OAuth flow params to sessionStorage before nFA:', { oauthFlow, returnTo, clientId });
                    sessionStorage.setItem('oauth_flow', 'true');
                    sessionStorage.setItem('return_to', returnTo);
                    if (clientId) {
                        sessionStorage.setItem('oauth_client_id', clientId);
                    }
                }
                
                // –¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º cookies –Ω–∞ –Ω–∞–ª–∏—á–∏–µ OAuth –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (–º–æ–≥—É—Ç –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –±—ç–∫–µ–Ω–¥–æ–º)
                const cookies = document.cookie.split(';');
                const oauthClientIdCookie = cookies.find(c => c.trim().startsWith('oauth_client_id='));
                const oauthRedirectUriCookie = cookies.find(c => c.trim().startsWith('oauth_redirect_uri='));
                const oauthStateCookie = cookies.find(c => c.trim().startsWith('oauth_state_param='));
                
                if (oauthClientIdCookie || oauthRedirectUriCookie) {
                    console.log('üîÑ [DOMContentLoaded] Found OAuth cookies, saving to sessionStorage');
                    if (oauthClientIdCookie) {
                        const clientIdFromCookie = oauthClientIdCookie.split('=')[1];
                        sessionStorage.setItem('oauth_client_id', clientIdFromCookie);
                    }
                    if (oauthRedirectUriCookie) {
                        const redirectUriFromCookie = oauthRedirectUriCookie.split('=')[1];
                        sessionStorage.setItem('oauth_redirect_uri', redirectUriFromCookie);
                        // –ï—Å–ª–∏ return_to –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º redirect_uri –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è return_to
                        if (!returnTo) {
                            sessionStorage.setItem('return_to', '/api/oauth/authorize');
                            sessionStorage.setItem('oauth_flow', 'true');
                        }
                    }
                    if (oauthStateCookie) {
                        const stateFromCookie = oauthStateCookie.split('=')[1];
                        sessionStorage.setItem('oauth_state_param', stateFromCookie);
                    }
                }
                
                if (nfaUserId && nfaMethodsStr) {
                    try {
                        const nfaMethods = JSON.parse(decodeURIComponent(nfaMethodsStr));
                        console.log('‚úÖ [DOMContentLoaded] Parsed nFA methods:', nfaMethods);
                        pendingNFAUserId = nfaUserId;
                        pendingNFAMethods = nfaMethods;
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏—Å—å –ª–∏ —É–∂–µ –∫–æ–¥—ã –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                        const codesSentKey = `nfaCodesSent_${nfaUserId}`;
                        const codesAlreadySent = sessionStorage.getItem(codesSentKey);
                        console.log('üîç [DOMContentLoaded] Codes sent check:', { codesSentKey, codesAlreadySent });
                        
                        // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –°–æ—Ö—Ä–∞–Ω—è–µ–º userId –ü–ï–†–ï–î –ø—Ä–æ–≤–µ—Ä–∫–æ–π codesAlreadySent
                        // –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –ø—Ä–∏ –Ω–æ–≤–æ–π –ø–æ–ø—ã—Ç–∫–µ –º—ã —Ä–∞—Å–ø–æ–∑–Ω–∞–µ–º –µ–µ –∫–∞–∫ –Ω–æ–≤—É—é
                        sessionStorage.setItem('nfaUserId', nfaUserId);
                        
                        if (!codesAlreadySent || isNewNfaAttempt) {
                            console.log('üì§ [DOMContentLoaded] Sending nFA codes for userId:', nfaUserId);
                            console.log('üì§ [DOMContentLoaded] About to call sendNFACodes with userId:', nfaUserId);
                            // –ü–æ–º–µ—á–∞–µ–º, —á—Ç–æ –∫–æ–¥—ã —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
                            sessionStorage.setItem(codesSentKey, 'true');
                            sessionStorage.setItem('nfaCodesSent', 'true');
                            // Send nFA codes
                            console.log('üì§ [DOMContentLoaded] Calling sendNFACodes now...');
                            sendNFACodes(nfaUserId).then((result) => {
                                console.log('‚úÖ [DOMContentLoaded] nFA codes sent successfully, result:', result);
                                // Show nFA form
                                showNFAForm(nfaMethods);
                                showMessage('–ö–æ–¥—ã –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ –≤—Å–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã –∑–∞—â–∏—Ç—ã. –í–≤–µ–¥–∏—Ç–µ –∏—Ö –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Ö–æ–¥–∞.', 'info');
                            }).catch(err => {
                                console.error('‚ùå [DOMContentLoaded] Error sending nFA codes:', err);
                                console.error('‚ùå [DOMContentLoaded] Error details:', err);
                                // –£–±–∏—Ä–∞–µ–º —Ñ–ª–∞–≥ –ø—Ä–∏ –æ—à–∏–±–∫–µ, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å
                                sessionStorage.removeItem(codesSentKey);
                                sessionStorage.removeItem('nfaCodesSent');
                                // –ü–û–ö–ê–ó–´–í–ê–ï–ú –§–û–†–ú–£ –î–ê–ñ–ï –ü–†–ò –û–®–ò–ë–ö–ï - –≤–æ–∑–º–æ–∂–Ω–æ –∫–æ–¥—ã —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã —Å –±—ç–∫–µ–Ω–¥–∞
                                showNFAForm(nfaMethods);
                                showMessage('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–¥–æ–≤ nFA: ' + (err?.message || 'Unknown error') + '. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤–≤–µ—Å—Ç–∏ –∫–æ–¥—ã, –µ—Å–ª–∏ –æ–Ω–∏ —É–∂–µ –±—ã–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã.', 'error');
                            });
                        } else {
                            console.log('‚ÑπÔ∏è [DOMContentLoaded] Codes already sent, showing form only');
                            // –ö–æ–¥—ã —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã, –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
                            showNFAForm(nfaMethods);
                            showMessage('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥—ã –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Ö–æ–¥–∞.', 'info');
                        }
                        return; // ‚úÖ –ö–†–ò–¢–ò–ß–ù–û: –ü—Ä–µ—Ä—ã–≤–∞–µ–º –¥–∞–ª—å–Ω–µ–π—à—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É, —á—Ç–æ–±—ã –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª verifyTokenAndRedirect
                    } catch (e) {
                        console.error('‚ùå [DOMContentLoaded] Error parsing nFA parameters:', e);
                        sessionStorage.removeItem('nfaCodesSent');
                    }
                } else {
                    console.error('‚ùå [DOMContentLoaded] Missing nFA parameters:', { nfaUserId, nfaMethodsStr });
                }
            } else if (nfaParam === 'true') {
                // –ï—Å–ª–∏ –∫–æ–¥—ã —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã, –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
                const nfaUserId = urlParams.get('userId');
                const nfaMethodsStr = urlParams.get('methods');
                if (nfaUserId && nfaMethodsStr) {
                    try {
                        const nfaMethods = JSON.parse(decodeURIComponent(nfaMethodsStr));
                        pendingNFAUserId = nfaUserId;
                        pendingNFAMethods = nfaMethods;
                        // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –°–æ—Ö—Ä–∞–Ω—è–µ–º userId –¥–∞–∂–µ –µ—Å–ª–∏ –∫–æ–¥—ã —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã
                        sessionStorage.setItem('nfaUserId', nfaUserId);
                        showNFAForm(nfaMethods);
                        return; // ‚úÖ –ö–†–ò–¢–ò–ß–ù–û: –ü—Ä–µ—Ä—ã–≤–∞–µ–º –¥–∞–ª—å–Ω–µ–π—à—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É
                    } catch (e) {
                        console.error('Error parsing nFA parameters:', e);
                    }
                }
            }
            
            // Check if 2FA is required from URL parameter
            if (urlParams.get('require2fa') === 'true') {
                // Show 2FA form directly
                show2FAForm();
                return;
            }

            // Check if this is email verification
            if (urlParams.get('verify-email') === 'true') {
                const token = urlParams.get('token');
                if (token) {
                    verifyEmailToken(token);
                    return;
                }
            }

            // Check if this is a password reset page
            if (urlParams.get('reset-password') === 'true' || window.location.pathname.includes('reset-password')) {
                // Show password reset form directly
                showResetPasswordForm();
                return;
            }

            // ‚úÖ –ü–†–û–í–ï–†–ö–ê: –ï—Å–ª–∏ –º—ã –Ω–∞ API endpoint, –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —ç—Ç–æ –∫–∞–∫ frontend —Å—Ç—Ä–∞–Ω–∏—Ü—É
            const currentPath = window.location.pathname;
            if (currentPath.startsWith('/api/') || currentPath.startsWith('/oauth/')) {
                console.log('‚ö†Ô∏è On API endpoint, skipping frontend processing:', currentPath);
                return;
            }
            
            // Check if user is already logged in
            // –í–ê–ñ–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω –≤ URL –ü–ï–†–í–´–ú –¥–µ–ª–æ–º (–ø–æ—Å–ª–µ nFA –∏ –¥—Ä—É–≥–∏—Ö —Å–ø–µ—Ü. —Å–ª—É—á–∞–µ–≤)
            const urlParamsCheck = new URLSearchParams(window.location.search);
            const nfaParamCheck = urlParamsCheck.get('nfa');
            const urlTokenFromParams = urlParamsCheck.get('token');
            
            // –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –≤ URL - —ç—Ç–æ –∑–Ω–∞—á–∏—Ç –º—ã –Ω–∞ index.html –ø–æ –æ—à–∏–±–∫–µ, –Ω—É–∂–Ω–æ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç—å –Ω–∞ dashboard
            if (urlTokenFromParams && nfaParamCheck !== 'true') {
                console.log('üîë Token found in URL params on index.html - redirecting to dashboard');
                localStorage.setItem('authToken', urlTokenFromParams);
                localStorage.setItem('accessToken', urlTokenFromParams);
                const urlRefreshToken = urlParamsCheck.get('refreshToken');
                if (urlRefreshToken) {
                    localStorage.setItem('refreshToken', urlRefreshToken);
                }
                // –£–¥–∞–ª—è–µ–º —Ç–æ–∫–µ–Ω –∏–∑ URL –∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏–º –Ω–∞ dashboard
                const isSuperAdminCheck = urlParamsCheck.get('superAdmin') === 'true';
                const redirectTarget = isSuperAdminCheck ? 'test-micro-modules.html' : 'dashboard.html';
                console.log('üîÑ Redirecting from index.html to:', redirectTarget);
                window.location.replace(redirectTarget);
                return;
            }
            
            if (nfaParamCheck === 'true') {
                console.log('üîç nFA in progress, skipping token check to avoid redirect loop');
                // Show method selection by default
                showMethodStep().catch(e => console.error('Error in showMethodStep:', e));
            } else {
            console.log('üîç [DOMContentLoaded] Entering OAuth flow check block, nFA param:', nfaParamCheck);
            // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –°–ù–ê–ß–ê–õ–ê –ø—Ä–æ–≤–µ—Ä—è–µ–º OAuth flow, –ü–û–¢–û–ú —Ç–æ–∫–µ–Ω
            // –≠—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ - –ø—Ä–∏ OAuth flow –º—ã –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –≤—Ö–æ–¥–∞
            const urlParams = new URLSearchParams(window.location.search);
            const cookies = document.cookie.split(';');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º OAuth flow –∏–∑ URL, sessionStorage –ò cookies (–∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –±—ç–∫–µ–Ω–¥–æ–º)
            const oauthClientIdCookie = cookies.find(c => c.trim().startsWith('oauth_client_id='));
            const oauthRedirectUriCookie = cookies.find(c => c.trim().startsWith('oauth_redirect_uri='));
            const hasOAuthCookies = !!(oauthClientIdCookie || oauthRedirectUriCookie);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º URL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–∞–ø—Ä—è–º—É—é (–±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–æ)
            const urlOAuthFlow = window.location.search.includes('oauth_flow=true') || window.location.search.includes('oauth_flow=1');
            const urlHasClientId = window.location.search.includes('client_id=');
            const urlHasReturnTo = window.location.search.includes('return_to=');
            
            const isOAuthFlow = urlOAuthFlow || urlHasClientId || urlHasReturnTo ||
                                urlParams.get('oauth_flow') === 'true' || urlParams.get('oauth_flow') === '1' || 
                                sessionStorage.getItem('oauth_flow') === 'true' || 
                                sessionStorage.getItem('return_to')?.includes('/oauth/authorize') ||
                                hasOAuthCookies; // –ï—Å–ª–∏ –µ—Å—Ç—å OAuth cookies - —ç—Ç–æ OAuth flow
            
            console.log('üîç OAuth flow check (BEFORE token check):', {
                urlOAuthFlow,
                urlHasClientId,
                urlHasReturnTo,
                urlParamsOAuthFlow: urlParams.get('oauth_flow'),
                sessionStorageOAuthFlow: sessionStorage.getItem('oauth_flow'),
                sessionStorageReturnTo: sessionStorage.getItem('return_to'),
                hasOAuthCookies,
                isOAuthFlow,
                currentUrl: window.location.href
            });
            
            // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–∏ OAuth flow –í–°–ï–ì–î–ê –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –≤—Ö–æ–¥–∞, –¥–∞–∂–µ –µ—Å–ª–∏ –µ—Å—Ç—å —Ç–æ–∫–µ–Ω
            if (isOAuthFlow) {
                console.log('üîÑ OAuth flow detected - showing login form (allows switching accounts, ignoring token)');
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –≤—Ö–æ–¥–∞, –¥–∞–∂–µ –µ—Å–ª–∏ –µ—Å—Ç—å —Ç–æ–∫–µ–Ω
                showMethodStep().catch(e => console.error('Error in showMethodStep:', e));
                return; // –í—ã—Ö–æ–¥–∏–º —Ä–∞–Ω—å—à–µ, –Ω–µ –ø—Ä–æ–≤–µ—Ä—è—è —Ç–æ–∫–µ–Ω
            }
            
            // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ —Ç–æ–ª—å–∫–æ localStorage, –Ω–æ –∏ cookies (temp_access_token)
            // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ç–æ–ª—å–∫–æ —á—Ç–æ –≤—ã—à–µ–ª, —Ç–æ–∫–µ–Ω—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ—á–∏—â–µ–Ω—ã
            authToken = localStorage.getItem('authToken') || localStorage.getItem('accessToken');
            
            // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä URL _logout=1, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–µ—Ä–µ–¥–∞–Ω –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ AI Aggregator
            // –ï—Å–ª–∏ –µ—Å—Ç—å —ç—Ç–æ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä, –æ—á–∏—â–∞–µ–º –≤—Å–µ —Ç–æ–∫–µ–Ω—ã –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –≤—Ö–æ–¥–∞
            const logoutParam = urlParams.get('_logout');
            if (logoutParam === '1' || logoutParam === 'true') {
                console.log('üßπ Logout parameter detected, clearing all tokens and cookies');
                localStorage.removeItem('authToken');
                localStorage.removeItem('accessToken');
                localStorage.removeItem('refreshToken');
                localStorage.removeItem('userData');
                sessionStorage.clear();
                
                // –û—á–∏—â–∞–µ–º –≤—Å–µ cookies
                const cookiesToClear = [
                    'temp_access_token',
                    'oauth_client_id',
                    'oauth_redirect_uri',
                    'oauth_scope',
                    'oauth_state_param'
                ];
                cookiesToClear.forEach(cookieName => {
                    document.cookie = `${cookieName}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; SameSite=Lax`;
                    document.cookie = `${cookieName}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/`;
                });
                
                // –£–¥–∞–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä –∏–∑ URL
                urlParams.delete('_logout');
                const newUrl = window.location.pathname + (urlParams.toString() ? '?' + urlParams.toString() : '');
                window.history.replaceState({}, document.title, newUrl);
                
                authToken = null;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º cookies –Ω–∞ –Ω–∞–ª–∏—á–∏–µ temp_access_token (–º–æ–∂–µ—Ç –æ—Å—Ç–∞—Ç—å—Å—è –ø–æ—Å–ª–µ OAuth flow)
            const tempTokenCookie = cookies.find(c => c.trim().startsWith('temp_access_token='));
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–æ–ª—å–∫–æ temp_access_token –≤ cookies, –Ω–æ –Ω–µ—Ç –≤ localStorage - —ç—Ç–æ –æ—Å—Ç–∞—Ç–æ–∫ –æ—Ç OAuth flow
            // –û—á–∏—â–∞–µ–º –µ–≥–æ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –≤—Ö–æ–¥–∞
            if (!authToken && tempTokenCookie) {
                console.log('üßπ Found temp_access_token cookie but no localStorage token - clearing cookie');
                document.cookie = 'temp_access_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; SameSite=Lax';
                authToken = null;
            }
            
            if (authToken) {
                console.log('üîë Found token, verifying...');
                // Verify token and redirect to dashboard
                verifyTokenAndRedirect();
            } else {
                console.log('‚ùå No token found, showing method selection');
                // Show method selection by default
                    showMethodStep().catch(e => console.error('Error in showMethodStep:', e));
            }
            }
        });

        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –≤—ã–∑–æ–≤ disableDisabledAuthMethods –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        // –í–ê–ñ–ù–û: –í—ã–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑, —á—Ç–æ–±—ã –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫–∏ –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ
        window.addEventListener('load', function() {
            console.log('üü° Window loaded, calling disableDisabledAuthMethods');
            callDisableDisabledAuthMethodsOnce();
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –ø–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É "–°–º–µ–Ω–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç"
            checkShowSwitchAccountButton();
        });

        // Show method selection step
        async function showMethodStep() {
            console.log('üîµ showMethodStep called');
            document.querySelectorAll('.auth-step').forEach(step => step.classList.remove('active'));
            document.getElementById('methodStep').classList.add('active');
            // –°–∫—Ä—ã–≤–∞–µ–º –æ—Ç–∫–ª—é—á–µ–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ - –≤—ã–∑—ã–≤–∞–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ —Å –∑–∞–¥–µ—Ä–∂–∫–∞–º–∏
            console.log('üîµ Calling disableDisabledAuthMethods');
            // –£–±—Ä–∞–Ω–æ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –≤—ã–∑–æ–≤ - –≤—ã–∑—ã–≤–∞–µ–º –æ–¥–∏–Ω —Ä–∞–∑ –≥–¥–µ –Ω—É–∂–Ω–æ
            callDisableDisabledAuthMethodsOnce();
        }

        // Handle auth method card click
        function handleAuthMethodClick(event) {
            event.preventDefault();
            event.stopPropagation();
            const card = event.currentTarget;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ—Ç–∫–ª—é—á–µ–Ω–∞ –ª–∏ –∫–∞—Ä—Ç–æ—á–∫–∞
            if (card.hasAttribute('data-disabled') || card.classList.contains('auth-method-disabled')) {
                console.log('‚ö†Ô∏è Auth method card is disabled, ignoring click');
                return;
            }
            
            const method = card.getAttribute('data-method');
            console.log('üñ±Ô∏è Auth method card clicked:', method, 'Card:', card.id);
            if (method) {
                console.log('‚úÖ Calling selectAuthMethod with method:', method);
                try {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º window.selectAuthMethod –Ω–∞–ø—Ä—è–º—É—é
                    if (typeof window.selectAuthMethod === 'function') {
                        window.selectAuthMethod(method);
                    } else {
                        console.error('‚ùå window.selectAuthMethod not available, type:', typeof window.selectAuthMethod);
                        console.error('‚ùå Available window keys:', Object.keys(window).filter(k => k.includes('select') || k.includes('Auth')));
                    }
                } catch (e) {
                    console.error('‚ùå Error calling selectAuthMethod:', e);
                }
            } else {
                console.error('‚ùå No method attribute found on card:', card);
            }
        }

        // Select authentication method
        // –§—É–Ω–∫—Ü–∏—è –£–ñ–ï –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –≤—ã—à–µ –≤ –Ω–∞—á–∞–ª–µ —Å–∫—Ä–∏–ø—Ç–∞ (—Å—Ç—Ä–æ–∫–∞ ~1441)
        // –ù–µ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –µ—ë –ø–æ–≤—Ç–æ—Ä–Ω–æ - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é window.selectAuthMethod
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–º–µ–Ω—ã –∞–∫–∫–∞—É–Ω—Ç–∞ - –æ—á–∏—â–∞–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏ –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤–æ–π—Ç–∏ –∑–∞–Ω–æ–≤–æ
        function switchAccount() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏ –∏ –≤–æ–π—Ç–∏ —Å –¥—Ä—É–≥–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞? –í—Å–µ —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.')) {
                console.log('üîÑ Switching account - clearing all session data...');
            
                // –û—á–∏—â–∞–µ–º –≤—Å–µ —Ç–æ–∫–µ–Ω—ã –∏ –¥–∞–Ω–Ω—ã–µ
                localStorage.removeItem('authToken');
                localStorage.removeItem('accessToken');
                localStorage.removeItem('refreshToken');
                localStorage.removeItem('userData');
                
                // –û—á–∏—â–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ sessionStorage
                sessionStorage.clear();
                
                // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –û—á–∏—â–∞–µ–º –≤—Å–µ cookies, –≤–∫–ª—é—á–∞—è temp_access_token –∏ OAuth cookies
                const cookiesToClear = [
                    'temp_access_token',
                    'oauth_client_id',
                    'oauth_redirect_uri',
                    'oauth_scope',
                    'oauth_state_param'
                ];
                
                // –û—á–∏—â–∞–µ–º —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ cookies
                cookiesToClear.forEach(cookieName => {
                    document.cookie = `${cookieName}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; SameSite=Lax`;
                    document.cookie = `${cookieName}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/`;
                });
                
                // –û—á–∏—â–∞–µ–º –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ cookies –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –¥–æ–º–µ–Ω–∞
                document.cookie.split(";").forEach(function(c) { 
                    document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
                });
                
                // –û—á–∏—â–∞–µ–º URL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
                window.history.replaceState({}, document.title, window.location.pathname);
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–ª–∞–≥ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π —Å–º–µ–Ω—ã –∞–∫–∫–∞—É–Ω—Ç–∞
                sessionStorage.setItem('forceSwitchAccount', 'true');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                showMessage('–°–µ—Å—Å–∏—è –æ—á–∏—â–µ–Ω–∞. –¢–µ–ø–µ—Ä—å –ø—Ä–∏ –≤—ã–±–æ—Ä–µ GitHub –∏–ª–∏ Telegram –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω —ç–∫—Ä–∞–Ω –≤—ã–±–æ—Ä–∞ –∞–∫–∫–∞—É–Ω—Ç–∞.', 'info');
                
                // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–º–µ–Ω—ã –∞–∫–∫–∞—É–Ω—Ç–∞
                const switchBtn = document.getElementById('switchAccountBtn');
                if (switchBtn) {
                    switchBtn.style.display = 'none';
                }
                
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            }
        }
        
        // –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –≥–ª–æ–±–∞–ª—å–Ω–æ–π
        window.switchAccount = switchAccount;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –ø–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É "–°–º–µ–Ω–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç"
        function checkShowSwitchAccountButton() {
            const switchBtn = document.getElementById('switchAccountBtn');
            if (!switchBtn) return;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É, –µ—Å–ª–∏ –µ—Å—Ç—å —Ç–æ–∫–µ–Ω—ã –≤ localStorage –∏–ª–∏ URL
            const hasToken = localStorage.getItem('authToken') || 
                           localStorage.getItem('accessToken') || 
                           new URLSearchParams(window.location.search).get('token') ||
                           new URLSearchParams(window.location.search).get('accessToken');
            
            if (hasToken) {
                switchBtn.style.display = 'block';
            } else {
                switchBtn.style.display = 'none';
            }
        }

        // Proceed with selected method
        function proceedWithSelectedMethod() {
            if (!selectedAuthMethod) {
                showMessage('–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –≤—Ö–æ–¥–∞', 'error');
                return;
            }
            
            switch (selectedAuthMethod) {
                case 'EMAIL':
                    showEmailStep();
                    break;
                case 'TELEGRAM_OAUTH':
                    // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –û—á–∏—â–∞–µ–º —Ñ–ª–∞–≥–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ nFA –∫–æ–¥–æ–≤ –ø—Ä–∏ –Ω–æ–≤–æ–π –ø–æ–ø—ã—Ç–∫–µ –≤—Ö–æ–¥–∞
                    // –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –∫–æ–¥—ã –≤—Å–µ–≥–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è, –¥–∞–∂–µ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—ã—Ç–∞–ª—Å—è –≤–æ–π—Ç–∏ —Ä–∞–Ω–µ–µ
                    const nfaUserIdToClearTelegram = sessionStorage.getItem('nfaUserId');
                    if (nfaUserIdToClearTelegram) {
                        console.log('üîÑ [proceedWithSelectedMethod] Clearing nFA flags for new login attempt');
                        const codesSentKeyToClearTelegram = `nfaCodesSent_${nfaUserIdToClearTelegram}`;
                        sessionStorage.removeItem(codesSentKeyToClearTelegram);
                        sessionStorage.removeItem('nfaCodesSent');
                        sessionStorage.removeItem('nfaUserId');
                    }
                    
                    // ‚úÖ –°–û–•–†–ê–ù–ï–ù–ò–ï OAuth –ü–ê–†–ê–ú–ï–¢–†–û–í: –ï—Å–ª–∏ –º—ã –≤ OAuth flow, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ sessionStorage
                    const urlParamsTelegram = new URLSearchParams(window.location.search);
                    const oauthFlowTelegram = urlParamsTelegram.get('oauth_flow') === 'true';
                    const returnToTelegram = urlParamsTelegram.get('return_to');
                    const clientIdTelegram = urlParamsTelegram.get('client_id');
                    
                    if (oauthFlowTelegram && returnToTelegram) {
                        console.log('üîÑ Saving OAuth flow params to sessionStorage:', { oauthFlow: oauthFlowTelegram, returnTo: returnToTelegram, clientId: clientIdTelegram });
                        sessionStorage.setItem('oauth_flow', 'true');
                        sessionStorage.setItem('return_to', returnToTelegram);
                        if (clientIdTelegram) {
                            sessionStorage.setItem('oauth_client_id', clientIdTelegram);
                        }
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –≤—ã–±–æ—Ä –∞–∫–∫–∞—É–Ω—Ç–∞
                    const forceTelegram = sessionStorage.getItem('forceSwitchAccount') === 'true';
                    const telegramUrl = forceTelegram 
                        ? 'telegram-login.html?forceLogin=true'
                        : 'telegram-login.html';
                    if (forceTelegram) {
                        sessionStorage.removeItem('forceSwitchAccount');
                        console.log('üîµ [proceedWithSelectedMethod] Redirecting to Telegram login with forceLogin=true (switching account)');
                    } else {
                        console.log('üîµ [proceedWithSelectedMethod] Redirecting to Telegram login (normal flow)');
                    }
                    window.location.href = telegramUrl;
                    break;
                case 'GITHUB':
                    // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É github-login.html, –æ—Ç–∫—É–¥–∞ –º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç
                    console.log('üîµ [proceedWithSelectedMethod] GitHub selected, redirecting to github-login.html...');
                    
                    // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –û—á–∏—â–∞–µ–º —Ñ–ª–∞–≥–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ nFA –∫–æ–¥–æ–≤ –ø—Ä–∏ –Ω–æ–≤–æ–π –ø–æ–ø—ã—Ç–∫–µ –≤—Ö–æ–¥–∞
                    // –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –∫–æ–¥—ã –≤—Å–µ–≥–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è, –¥–∞–∂–µ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—ã—Ç–∞–ª—Å—è –≤–æ–π—Ç–∏ —Ä–∞–Ω–µ–µ
                    const nfaUserIdToClear = sessionStorage.getItem('nfaUserId');
                    if (nfaUserIdToClear) {
                        console.log('üîÑ [proceedWithSelectedMethod] Clearing nFA flags for new login attempt');
                        const codesSentKeyToClear = `nfaCodesSent_${nfaUserIdToClear}`;
                        sessionStorage.removeItem(codesSentKeyToClear);
                        sessionStorage.removeItem('nfaCodesSent');
                        sessionStorage.removeItem('nfaUserId');
                    }
                    
                    // ‚úÖ –°–û–•–†–ê–ù–ï–ù–ò–ï OAuth –ü–ê–†–ê–ú–ï–¢–†–û–í: –ï—Å–ª–∏ –º—ã –≤ OAuth flow, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ sessionStorage
                    const urlParamsGitHub = new URLSearchParams(window.location.search);
                    const oauthFlowGitHub = urlParamsGitHub.get('oauth_flow') === 'true';
                    const returnToGitHub = urlParamsGitHub.get('return_to');
                    const clientIdGitHub = urlParamsGitHub.get('client_id');
                    
                    if (oauthFlowGitHub && returnToGitHub) {
                        console.log('üîÑ Saving OAuth flow params to sessionStorage:', { oauthFlow: oauthFlowGitHub, returnTo: returnToGitHub, clientId: clientIdGitHub });
                        sessionStorage.setItem('oauth_flow', 'true');
                        sessionStorage.setItem('return_to', returnToGitHub);
                        if (clientIdGitHub) {
                            sessionStorage.setItem('oauth_client_id', clientIdGitHub);
                        }
                    }
                    
                    const forceLoginGitHub = sessionStorage.getItem('forceSwitchAccount') === 'true';
                    let githubUrl = 'github-login.html';
                    if (forceLoginGitHub) {
                        sessionStorage.removeItem('forceSwitchAccount');
                        githubUrl += '?forceLogin=true';
                    }
                    window.location.href = githubUrl;
                    break;
                default:
                    showMessage('–í—ã–±—Ä–∞–Ω–Ω—ã–π –º–µ—Ç–æ–¥ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è', 'error');
            }
        }

        // Show email step
        function showEmailStep() {
            document.querySelectorAll('.auth-step').forEach(step => step.classList.remove('active'));
            document.getElementById('emailStep').classList.add('active');
        }

        // Show phone auth step
        function showPhoneAuthStep() {
            // For now, redirect to multi-auth page
            window.location.href = 'multi-auth-login.html?method=' + selectedAuthMethod;
        }

        // Show OAuth step
        function showOAuthStep() {
            // For now, redirect to multi-auth page
            window.location.href = 'multi-auth-login.html?method=' + selectedAuthMethod;
        }


        // Go back to method step
        function goBackToMethodStep() {
            document.querySelectorAll('.auth-step').forEach(step => step.classList.remove('active'));
            const methodStepEl = document.getElementById('methodStep');
            if (methodStepEl) {
                methodStepEl.classList.add('active');
            }
            
            // Clear selection
            selectedAuthMethod = null;
            document.querySelectorAll('.auth-method-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.getElementById('selectedMethodInfo').style.display = 'none';
            
            // –°–∫—Ä—ã–≤–∞–µ–º –æ—Ç–∫–ª—é—á–µ–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            callDisableDisabledAuthMethodsOnce();
        }

        // Switch between login and register modes (—É–ø—Ä–æ—â–µ–Ω–æ - —Ç–æ–ª—å–∫–æ —É–º–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è)
        function switchAuthMode(mode) {
            // Hide all forms
            document.querySelectorAll('.auth-step').forEach(step => step.classList.remove('active'));

            // Show login form
            document.getElementById('loginForm').classList.add('active');
        }

        // Global variable to store current email
        let currentEmail = '';

        // Handle email step form submission
        async function handleEmailStep(event) {
            event.preventDefault();
            
            const email = document.getElementById('emailInput').value;
            currentEmail = email;

            // Show loading
            showLoading('emailStepBtn', 'emailStepBtnText', 'emailStepLoading');

            try {
                // Check if user exists
                const response = await apiCall('/api/users/check-email', {
                    method: 'POST',
                    body: JSON.stringify({ email })
                });

                // User exists - show login form
                showLoginFormWithEmail(email);
                
            } catch (error) {
                console.error('Email check error:', error);
                
                // User doesn't exist - show registration form
                showSmartRegistration(email, '');
                showMessage('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏', 'info');
            } finally {
                hideLoading('emailStepBtn', 'emailStepBtnText', 'emailStepLoading');
            }
        }

        // Show login form with pre-filled email
        function showLoginFormWithEmail(email) {
            document.querySelectorAll('.auth-step').forEach(step => step.classList.remove('active'));
            document.getElementById('loginForm').classList.add('active');
            
            // Update email display
            document.getElementById('loginEmailDisplay').textContent = email;
            
            // Focus on password field
            setTimeout(() => {
                document.getElementById('loginPassword').focus();
            }, 100);
        }

        // Go back to email step
        function goBackToEmailStep() {
            document.querySelectorAll('.auth-step').forEach(step => step.classList.remove('active'));
            document.getElementById('emailStep').classList.add('active');
            
            // Clear password field
            document.getElementById('loginPassword').value = '';
        }

        // Show login form
        function showLoginForm() {
            document.querySelectorAll('.auth-step').forEach(step => step.classList.remove('active'));
            document.getElementById('loginForm').classList.add('active');
            
            // Update header (no longer needed as it's just text)
            // const loginHeader = document.querySelector('.auth-header');
            
            // Pre-fill email if available
            if (currentEmail) {
                document.getElementById('loginEmailDisplay').textContent = currentEmail;
            }
        }

        // Show email code form
        function showEmailCodeForm() {
            document.querySelectorAll('.auth-step').forEach(step => step.classList.remove('active'));
            document.getElementById('emailCodeForm').classList.add('active');
            
            // Pre-fill email if available
            if (currentEmail) {
                document.getElementById('emailCodeEmail').value = currentEmail;
            } else {
                document.getElementById('emailCodeEmail').value = '';
            }
            document.querySelectorAll('#emailCodeForm .otp-input').forEach(input => input.value = '');
            
            // Show send code button, hide confirm button
            document.getElementById('sendCodeBtn').classList.remove('hidden');
            document.getElementById('emailCodeBtn').classList.add('hidden');
            
            // Focus email input
            document.getElementById('emailCodeEmail').focus();
        }

        // Show 2FA form
        function show2FAForm() {
            document.querySelectorAll('.auth-step').forEach(step => step.classList.remove('active'));
            document.getElementById('twoFactorForm').classList.add('active');
        }

        // Show forgot password form
        function showForgotPassword() {
            document.querySelectorAll('.auth-step').forEach(step => step.classList.remove('active'));
            document.getElementById('forgotPasswordForm').classList.add('active');
            
            // Pre-fill email if available
            if (currentEmail) {
                document.getElementById('forgotEmail').value = currentEmail;
            }
        }

        // Show reset password form
        function showResetPasswordForm() {
            document.querySelectorAll('.auth-step').forEach(step => step.classList.remove('active'));
            document.getElementById('resetPasswordForm').classList.add('active');
            
            // Pre-fill email if available
            if (currentEmail) {
                document.getElementById('resetEmail').value = currentEmail;
            }
        }

        // Show complete registration form
        function showCompleteRegistration() {
            document.querySelectorAll('.auth-step').forEach(step => step.classList.remove('active'));
            document.getElementById('completeRegistrationForm').classList.add('active');
            
            // Pre-fill email if available
            if (currentEmail) {
                document.getElementById('completeEmail').value = currentEmail;
            }
        }

        // Show smart registration (when user doesn't exist during login)
        function showSmartRegistration(email, password) {
            // Hide all forms
            document.querySelectorAll('.auth-step').forEach(step => step.classList.remove('active'));
            
            // Show smart registration form
            document.getElementById('smartRegistrationForm').classList.add('active');
            
            // Update current email
            currentEmail = email;
            
            // Pre-fill email and password
            document.getElementById('smartEmail').value = email;
            document.getElementById('smartPassword').value = password;
            document.getElementById('smartConfirmPassword').value = password;
            
            // Update form title
            document.getElementById('smartFormTitle').textContent = '–ó–∞–≤–µ—Ä—à–∏—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é';
            document.getElementById('smartFormSubtitle').textContent = '–ú—ã –∑–∞–ø–æ–º–Ω–∏–ª–∏ –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ. –î–æ–±–∞–≤—å—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é:';
        }

        // Toggle password visibility
        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const button = input.nextElementSibling;
            const icon = button.querySelector('i');

            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        // Move to next OTP input
        function moveToNext(current, index) {
            const inputs = document.querySelectorAll('.otp-input');
            
            if (current.value.length === 1 && index < inputs.length - 1) {
                inputs[index + 1].focus();
            }
            
            // Check if all inputs are filled
            checkOTPComplete();
        }

        // Move to next 2FA input
        function moveToNext2FA(current, index) {
            const inputs = document.querySelectorAll('#twoFactorForm .otp-input');
            
            if (current.value.length === 1 && index < inputs.length - 1) {
                inputs[index + 1].focus();
            }
            
            // Check if all inputs are filled
            check2FAComplete();
        }

        // Check if OTP is complete
        function checkOTPComplete() {
            const inputs = document.querySelectorAll('.otp-input');
            const allFilled = Array.from(inputs).every(input => input.value.length === 1);
            
            if (allFilled) {
                // Auto-submit form
                document.getElementById('emailCodeFormElement').dispatchEvent(new Event('submit'));
            }
        }

        // Check if 2FA is complete
        function check2FAComplete() {
            const inputs = document.querySelectorAll('#twoFactorForm .otp-input');
            const allFilled = Array.from(inputs).every(input => input.value.length === 1);
            
            if (allFilled) {
                // Auto-submit form
                document.getElementById('twoFactorFormElement').dispatchEvent(new Event('submit'));
            }
        }

        // Handle login form submission
        async function handleLogin(event) {
            event.preventDefault();
            
            const email = currentEmail; // Use stored email from email step
            const password = document.getElementById('loginPassword').value;
            const rememberMe = document.getElementById('rememberMe').checked;

            // Show loading
            showLoading('loginBtn', 'loginBtnText', 'loginLoading');

            try {
                const response = await apiCall('/api/auth/login', {
                method: 'POST',
                    body: JSON.stringify({ email, password })
                });

                if (response.requiresNFA) {
                    // Save userId and methods for nFA completion
                    pendingNFAUserId = response.userId;
                    pendingNFAMethods = response.methods || [];
                    pendingNFAEmail = email;
                    console.log('üìã [EMAIL Login] nFA required, methods from response:', response.methods);
                    console.log('üìã [EMAIL Login] pendingNFAMethods:', pendingNFAMethods);
                    // Send nFA codes to all selected methods (only once)
                    if (!sessionStorage.getItem(`nfaCodesSent_${response.userId}`)) {
                        sessionStorage.setItem(`nfaCodesSent_${response.userId}`, 'true');
                        await sendNFACodes(response.userId);
                    }
                    // Show nFA form
                    console.log('üìã [EMAIL Login] Calling showNFAForm with methods:', pendingNFAMethods);
                    showNFAForm(pendingNFAMethods);
                    showMessage('–ö–æ–¥—ã –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ –≤—Å–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã –∑–∞—â–∏—Ç—ã. –í–≤–µ–¥–∏—Ç–µ –∏—Ö –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Ö–æ–¥–∞.', 'info');
                } else if (response.requires2FA) {
                    // Save userId and email for 2FA completion
                    pending2FAUserId = response.userId;
                    pending2FAEmail = email;
                    // Send 2FA code to email
                    await send2FACode(email);
                    // Show 2FA form
                    show2FAForm();
                    showMessage('–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –≤–∞—à—É –ø–æ—á—Ç—É. –í–≤–µ–¥–∏—Ç–µ –µ–≥–æ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Ö–æ–¥–∞.', 'info');
                } else {
                    // Login successful
                    authToken = response.accessToken;
                    localStorage.setItem('authToken', authToken);
                    
                    if (response.refreshToken) {
                        localStorage.setItem('refreshToken', response.refreshToken);
                    }

                    // ‚úÖ –ù–ï –°–ö–†–´–í–ê–ï–ú –§–û–†–ú–£: –û—Å—Ç–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É –≤–∏–¥–∏–º–æ–π –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞
                    hideLoading('loginBtn', 'loginBtnText', 'loginLoading');
                    showMessage('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!', 'success');
                    
                    // ‚úÖ –ü–†–û–í–ï–†–ö–ê OAuth FLOW: –ï—Å–ª–∏ –º—ã –≤ OAuth flow, —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏–º –Ω–∞ /api/oauth/authorize
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL (–∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥–ª–∏ –±—ã—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ø—Ä–∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ª–æ–≥–∏–Ω–∞)
                    const urlParamsEmail = new URLSearchParams(window.location.search);
                    const oauthFlowEmail = urlParamsEmail.get('oauth_flow') === 'true';
                    const returnToEmail = urlParamsEmail.get('return_to');
                    
                    if (oauthFlowEmail && (returnToEmail === '/oauth/authorize' || returnToEmail === '/api/oauth/authorize')) {
                        console.log('üîÑ OAuth flow detected after Email login, redirecting to /api/oauth/authorize');
                        console.log('üîÑ OAuth params:', { oauthFlow: oauthFlowEmail, returnTo: returnToEmail, apiBaseUrl: window.API_BASE_URL });
                        
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω –≤ cookie –¥–ª—è /oauth/authorize (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ GitHub/Telegram)
                        document.cookie = `temp_access_token=${authToken}; path=/; max-age=60; SameSite=Lax`;
                        console.log('‚úÖ Token saved to temp_access_token cookie');
                        
                        setTimeout(() => {
                            isRedirecting = true;
                            // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: API_BASE_URL –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç /api, –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å
                            const apiBaseUrl = window.API_BASE_URL || 'https://vselena.ldmco.ru';
                            const redirectUrl = `${apiBaseUrl}/api/oauth/authorize`;
                            console.log('üîÑ Redirecting to:', redirectUrl);
                            console.log('üîÑ API_BASE_URL:', apiBaseUrl);
                            window.location.href = redirectUrl;
                        }, 1000);
                        return;
                    }
                    
                    // Redirect based on role (–æ–±—ã—á–Ω—ã–π flow)
                    setTimeout(() => {
                        redirectBasedOnRole(response.user);
                    }, 1000);
                }
            } catch (error) {
                console.error('Login error:', error);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –¢–û–õ–¨–ö–û –µ—Å–ª–∏ backend —è–≤–Ω–æ —Å–æ–æ–±—â–∏–ª, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç
                if (error.message.includes('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω') || error.message.includes('User not found')) {
                    showSmartRegistration(email, password);
                    showMessage('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏', 'info');
                } else if (error.message.includes('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å')) {
                    // User exists but wrong password
                    showMessage('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –≤–≤–µ–¥–µ–Ω–Ω–æ–≥–æ –ø–∞—Ä–æ–ª—è.', 'error');
                } else {
                    showMessage('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + error.message, 'error');
                }
            } finally {
                hideLoading('loginBtn', 'loginBtnText', 'loginLoading');
            }
        }

        // Send 2FA code to email
        async function send2FACode(email) {
            console.log('üö® –§–†–û–ù–¢–ï–ù–î v' + VERSION + ': –í–´–ó–í–ê–ù–ê –§–£–ù–ö–¶–ò–Ø send2FACode (2FA)');
            console.log('üìß Email:', email);
            try {
                await apiCall('/api/two-factor/send-code', {
                    method: 'POST',
                    body: JSON.stringify({ 
                        type: 'email',
                        contact: email 
                    })
                });
                console.log('2FA code sent to email:', email);
            } catch (error) {
                console.error('Error sending 2FA code:', error);
                showMessage('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–¥–∞: ' + error.message, 'error');
            }
        }

        // Send nFA codes to all selected methods
        // –†–∞–∑—Ä–µ—à–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫–æ–¥–æ–≤ - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–∏—Ç—å –∫–æ–¥—ã –ø–æ–≤—Ç–æ—Ä–Ω–æ
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ (5 —Å–µ–∫—É–Ω–¥) –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç —Å–ø–∞–º–∞
        let lastSendTime = 0;
        const MIN_SEND_INTERVAL = 5000; // –ú–∏–Ω–∏–º—É–º 5 —Å–µ–∫—É–Ω–¥ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
        
        async function sendNFACodes(userId) {
            const now = Date.now();
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ (5 —Å–µ–∫—É–Ω–¥), –Ω–æ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–ª–Ω–æ—Å—Ç—å—é
            if (now - lastSendTime < MIN_SEND_INTERVAL) {
                const waitTime = Math.ceil((MIN_SEND_INTERVAL - (now - lastSendTime)) / 1000);
                console.log(`‚è≥ –ü–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–ø—Ä–æ—Å –±—ã–ª ${waitTime} —Å–µ–∫ –Ω–∞–∑–∞–¥, —Ä–∞–∑—Ä–µ—à–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å (–±–µ–∑ –∑–∞–¥–µ—Ä–∂–∫–∏)`);
            }
            
            lastSendTime = now;
            console.log('üö® –§–†–û–ù–¢–ï–ù–î v' + VERSION + ': –í–´–ó–í–ê–ù–ê –§–£–ù–ö–¶–ò–Ø sendNFACodes (nFA)');
            console.log('üë§ UserId:', userId);
            console.log('üåê API_BASE_URL:', window.API_BASE_URL);
            console.log('üîë authToken:', authToken ? 'present' : 'not present');
            
            try {
                const url = `${window.API_BASE_URL}/api/auth/nfa/send-codes/public`;
                const body = JSON.stringify({ userId });
                console.log('üì§ Sending POST request to:', url);
                console.log('üì§ Request body:', body);
                
                const response = await apiCall('/api/auth/nfa/send-codes/public', {
                    method: 'POST',
                    body: body
                });
                console.log('‚úÖ nFA codes sent, response:', response);
                return response;
            } catch (error) {
                console.error('‚ùå Error sending nFA codes:', error);
                console.error('‚ùå Error details:', {
                    message: error.message,
                    stack: error.stack,
                    name: error.name
                });
                showMessage('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–¥–æ–≤ nFA: ' + error.message, 'error');
                throw error;
            }
        }

        // Show nFA form with code inputs for each method
        function showNFAForm(methods) {
            console.log('üìã Showing nFA form for methods:', methods);
            document.querySelectorAll('.auth-step').forEach(step => step.classList.remove('active'));
            document.getElementById('nfaForm').classList.add('active');
            
            const methodsFormsContainer = document.getElementById('nfaMethodsForms');
            if (!methodsFormsContainer) return;
            
            const methodTitles = {
                EMAIL: 'Email',
                PHONE_TELEGRAM: 'Telegram',
                GITHUB: 'GitHub'
            };
            
            const methodIcons = {
                EMAIL: 'fas fa-envelope',
                PHONE_TELEGRAM: 'fab fa-telegram',
                GITHUB: 'fab fa-github'
            };
            
            // –°–æ–∑–¥–∞–µ–º –ø–æ–ª—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º–µ—Ç–æ–¥–∞
            methodsFormsContainer.innerHTML = methods.map((method, index) => `
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label class="form-label">
                        <i class="${methodIcons[method] || 'fas fa-shield-alt'}"></i>
                        –ö–æ–¥ —Å ${methodTitles[method] || method}
                    </label>
                    <div class="otp-inputs">
                        <input type="text" class="otp-input nfa-code-input" data-method="${method}" data-index="0" maxlength="1" oninput="moveToNextNFA(this, '${method}', 0)">
                        <input type="text" class="otp-input nfa-code-input" data-method="${method}" data-index="1" maxlength="1" oninput="moveToNextNFA(this, '${method}', 1)">
                        <input type="text" class="otp-input nfa-code-input" data-method="${method}" data-index="2" maxlength="1" oninput="moveToNextNFA(this, '${method}', 2)">
                        <input type="text" class="otp-input nfa-code-input" data-method="${method}" data-index="3" maxlength="1" oninput="moveToNextNFA(this, '${method}', 3)">
                        <input type="text" class="otp-input nfa-code-input" data-method="${method}" data-index="4" maxlength="1" oninput="moveToNextNFA(this, '${method}', 4)">
                        <input type="text" class="otp-input nfa-code-input" data-method="${method}" data-index="5" maxlength="1" oninput="moveToNextNFA(this, '${method}', 5)">
                    </div>
                </div>
            `).join('');
            
            // –§–æ–∫—É—Å–∏—Ä—É–µ–º—Å—è –Ω–∞ –ø–µ—Ä–≤—ã–π input –ø–µ—Ä–≤–æ–≥–æ –º–µ—Ç–æ–¥–∞
            const firstInput = methodsFormsContainer.querySelector('.otp-input');
            if (firstInput) {
                setTimeout(() => firstInput.focus(), 100);
            }
        }

        // Move to next input in nFA form
        function moveToNextNFA(input, method, currentIndex) {
            const inputs = Array.from(document.querySelectorAll(`.nfa-code-input[data-method="${method}"]`));
            if (input.value && currentIndex < inputs.length - 1) {
                inputs[currentIndex + 1].focus();
            }
        }

        // Handle nFA codes submission
        async function handleNFA(event) {
            event.preventDefault();
            
            if (!pendingNFAUserId) {
                showMessage('–û—à–∏–±–∫–∞: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                return;
            }
            
            // –°–æ–±–∏—Ä–∞–µ–º –∫–æ–¥—ã –¥–ª—è –≤—Å–µ—Ö –º–µ—Ç–æ–¥–æ–≤
            const methodCodes = {};
            pendingNFAMethods.forEach(method => {
                const inputs = Array.from(document.querySelectorAll(`.nfa-code-input[data-method="${method}"]`));
                const code = inputs.map(input => input.value).join('');
                if (code.length === 6) {
                    methodCodes[method] = code;
                }
            });
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ –º–µ—Ç–æ–¥—ã –∏–º–µ—é—Ç –∫–æ–¥—ã
            if (Object.keys(methodCodes).length !== pendingNFAMethods.length) {
                showMessage('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥—ã –¥–ª—è –≤—Å–µ—Ö –º–µ—Ç–æ–¥–æ–≤ –∑–∞—â–∏—Ç—ã', 'error');
                return;
            }
            
            // Show loading
            showLoading('nfaBtn', 'nfaBtnText', 'nfaLoading');
            
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–π –º–µ—Ç–æ–¥
                const verificationResults = [];
                for (const method of pendingNFAMethods) {
                    const code = methodCodes[method];
                    if (!code) {
                        console.warn(`‚ö†Ô∏è No code provided for method ${method}`);
                        continue;
                    }
                    
                    console.log(`üîç Verifying code for method: ${method}, code: ${code.substring(0, 2)}...`);
                    
                    try {
                        const response = await apiCall('/api/auth/nfa/verify-method/public', {
                            method: 'POST',
                            body: JSON.stringify({
                                userId: pendingNFAUserId,
                                method: method,
                                code: code
                            })
                        });
                        
                        console.log(`üìã Verification result for ${method}:`, response);
                        verificationResults.push({ method, success: response.success, response });
                        
                        if (!response.success) {
                            showMessage(`–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –¥–ª—è –º–µ—Ç–æ–¥–∞ ${method}: ${response.message || '–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥'}`, 'error');
                            hideLoading('nfaBtn', 'nfaBtnText', 'nfaLoading');
                            return;
                        }
                    } catch (error) {
                        console.error(`‚ùå Error verifying method ${method}:`, error);
                        showMessage(`–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–¥–∞ –¥–ª—è –º–µ—Ç–æ–¥–∞ ${method}: ${error.message}`, 'error');
                        hideLoading('nfaBtn', 'nfaBtnText', 'nfaLoading');
                        return;
                    }
                }
                
                console.log('‚úÖ All methods verified:', verificationResults);
                
                // ‚úÖ –ü–†–û–í–ï–†–ö–ê: –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ, —á—Ç–æ–±—ã backend —É—Å–ø–µ–ª –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å—ã –∫–æ–¥–æ–≤
                // –≠—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã getVerificationStatus
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // –í—Å–µ –∫–æ–¥—ã –≤–µ—Ä–Ω—ã - –∑–∞–≤–µ—Ä—à–∞–µ–º –≤—Ö–æ–¥
                let loginResponse;
                try {
                    loginResponse = await apiCall('/api/auth/nfa/complete', {
                        method: 'POST',
                        body: JSON.stringify({ userId: pendingNFAUserId })
                    });
                } catch (error) {
                    // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –æ —Ç–æ–º, —á—Ç–æ –Ω–µ –≤—Å–µ –º–µ—Ç–æ–¥—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω—ã, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
                    if (error.message && error.message.includes('–ù–µ –≤—Å–µ nFA –º–µ—Ç–æ–¥—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω—ã')) {
                        console.error('‚ùå nFA complete error:', error.message);
                        console.log('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏...');
                        
                        // –ü—Ä–æ–±—É–µ–º –µ—â–µ —Ä–∞–∑ —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        try {
                            loginResponse = await apiCall('/api/auth/nfa/complete', {
                                method: 'POST',
                                body: JSON.stringify({ userId: pendingNFAUserId })
                            });
                        } catch (retryError) {
                            console.error('‚ùå Retry failed:', retryError);
                            showMessage(`–û—à–∏–±–∫–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ nFA: ${error.message}`, 'error');
                            hideLoading('nfaBtn', 'nfaBtnText', 'nfaLoading');
                            return;
                        }
                    } else {
                        throw error;
                    }
                }
                
                // nFA successful
                authToken = loginResponse.accessToken;
                console.log('‚úÖ nFA completed, saving token:', authToken?.substring(0, 20) + '...');
                localStorage.setItem('authToken', authToken);
                
                if (loginResponse.refreshToken) {
                    localStorage.setItem('refreshToken', loginResponse.refreshToken);
                }
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è dashboard
                if (loginResponse.user) {
                    localStorage.setItem('userData', JSON.stringify(loginResponse.user));
                    console.log('‚úÖ User data saved:', loginResponse.user);
                }
                
                // Clear nFA variables
                pendingNFAUserId = null;
                pendingNFAMethods = [];
                pendingNFAEmail = null;
                
                // –û—á–∏—â–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã nFA –∏–∑ URL
                const cleanUrl = window.location.pathname;
                window.history.replaceState({}, document.title, cleanUrl);
                
                showMessage('–ú–Ω–æ–≥–æ—Ñ–∞–∫—Ç–æ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø—Ä–æ–π–¥–µ–Ω–∞!', 'success');
                
                // ‚úÖ –ü–†–û–í–ï–†–ö–ê OAuth FLOW: –ï—Å–ª–∏ –º—ã –≤ OAuth flow, —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏–º –Ω–∞ /api/oauth/authorize
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL, sessionStorage –∏ cookies (–≤ –ø–æ—Ä—è–¥–∫–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞)
                const urlParams = new URLSearchParams(window.location.search);
                const oauthFlowFromUrl = urlParams.get('oauth_flow') === 'true';
                const returnToFromUrl = urlParams.get('return_to');
                
                const oauthFlowFromStorage = sessionStorage.getItem('oauth_flow') === 'true';
                const returnToFromStorage = sessionStorage.getItem('return_to');
                const clientIdFromStorage = sessionStorage.getItem('oauth_client_id');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º cookies –Ω–∞ –Ω–∞–ª–∏—á–∏–µ OAuth –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
                const cookies = document.cookie.split(';');
                const oauthClientIdCookie = cookies.find(c => c.trim().startsWith('oauth_client_id='));
                const oauthRedirectUriCookie = cookies.find(c => c.trim().startsWith('oauth_redirect_uri='));
                
                // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: URL > sessionStorage > cookies
                const oauthFlow = oauthFlowFromUrl || oauthFlowFromStorage || (oauthClientIdCookie || oauthRedirectUriCookie ? true : false);
                const returnTo = returnToFromUrl || returnToFromStorage || (oauthRedirectUriCookie ? '/api/oauth/authorize' : null);
                
                console.log('üîç [handleNFA] OAuth flow check:', {
                    oauthFlowFromUrl,
                    returnToFromUrl,
                    oauthFlowFromStorage,
                    returnToFromStorage,
                    clientIdFromStorage,
                    hasOAuthCookies: !!(oauthClientIdCookie || oauthRedirectUriCookie),
                    finalOAuthFlow: oauthFlow,
                    finalReturnTo: returnTo
                });
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∫ —Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç (/oauth/authorize), —Ç–∞–∫ –∏ –Ω–æ–≤—ã–π (/api/oauth/authorize)
                if (oauthFlow && (returnTo === '/oauth/authorize' || returnTo === '/api/oauth/authorize')) {
                    console.log('üîÑ OAuth flow detected after nFA, redirecting to /api/oauth/authorize');
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω –≤ cookie –¥–ª—è /oauth/authorize (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ Email/Telegram/GitHub)
                    document.cookie = `temp_access_token=${authToken}; path=/; max-age=60; SameSite=Lax`;
                    console.log('‚úÖ Token saved to temp_access_token cookie for OAuth flow');
                    
                    setTimeout(() => {
                        isRedirecting = true;
                        // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: API_BASE_URL –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç /api, –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å
                        const apiBaseUrl = window.API_BASE_URL || 'https://vselena.ldmco.ru';
                        window.location.href = `${apiBaseUrl}/api/oauth/authorize`;
                    }, 500);
                    return;
                }
                
                // Redirect based on role - –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä—è–º–æ–π —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ dashboard —Å —Ç–æ–∫–µ–Ω–æ–º –≤ URL
                // —á—Ç–æ–±—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å, —á—Ç–æ —Ç–æ–∫–µ–Ω –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω (–∫–∞–∫ –ø—Ä–∏ OAuth callback)
                setTimeout(() => {
                    console.log('üîÑ Redirecting after nFA, user:', loginResponse.user);
                    console.log('üîÑ User roles:', loginResponse.user?.roles);
                    
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    const roles = loginResponse.user?.roles || [];
                    const isSuperAdmin = roles.some(function(r) {
                        if (typeof r === 'string') {
                            return r === 'super_admin';
                        }
                        if (r && typeof r === 'object' && r.name) {
                            return r.name === 'super_admin';
                        }
                        return false;
                    });
                    
                    const refreshTokenValue = loginResponse.refreshToken || '';
                    // –£–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ —Ç–æ–∫–µ–Ω –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –µ—Å—Ç—å
                    if (!authToken) {
                        console.error('‚ùå No authToken available for redirect!');
                        showMessage('–û—à–∏–±–∫–∞: —Ç–æ–∫–µ–Ω –Ω–µ –±—ã–ª –ø–æ–ª—É—á–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤–æ–π—Ç–∏ —Å–Ω–æ–≤–∞.', 'error');
                        return;
                    }
                    
                    const redirectUrl = isSuperAdmin
                        ? 'test-micro-modules.html?token=' + encodeURIComponent(authToken) + '&refreshToken=' + encodeURIComponent(refreshTokenValue)
                        : 'dashboard.html?token=' + encodeURIComponent(authToken) + '&refreshToken=' + encodeURIComponent(refreshTokenValue);
                    
                    console.log('üîÑ Redirecting to:', redirectUrl);
                    console.log('üîÑ AuthToken length:', authToken.length);
                    console.log('üîÑ RefreshToken length:', refreshTokenValue.length);
                    isRedirecting = true;
                    window.location.href = redirectUrl;
                }, 500);
            } catch (error) {
                console.error('nFA verification error:', error);
                showMessage('–û—à–∏–±–∫–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ nFA: ' + error.message, 'error');
            } finally {
                hideLoading('nfaBtn', 'nfaBtnText', 'nfaLoading');
            }
        }

        // Send email code for login (2FA)
        async function sendEmailCode() {
            const email = document.getElementById('emailCodeEmail').value;
            
            if (!email) {
                showMessage('–í–≤–µ–¥–∏—Ç–µ email', 'error');
                return;
            }

            console.log('üö® –§–†–û–ù–¢–ï–ù–î v' + VERSION + ': –í–´–ó–í–ê–ù–ê –§–£–ù–ö–¶–ò–Ø sendEmailCode (2FA LOGIN)');
            console.log('üìß Email:', email);

            // Show loading
            showLoading('sendCodeBtn', 'sendCodeBtnText', 'sendCodeLoading');

            try {
                await apiCall('/api/auth/email-code/send', {
                    method: 'POST',
                    body: JSON.stringify({ email })
                });

                showMessage('–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –≤–∞—à—É –ø–æ—á—Ç—É', 'success');
                
                // Hide send button, show confirm button
                document.getElementById('sendCodeBtn').classList.add('hidden');
                document.getElementById('emailCodeBtn').classList.remove('hidden');
                
                // Focus first OTP input
                document.querySelector('#emailCodeForm .otp-input').focus();
            } catch (error) {
                console.error('Send email code error:', error);
                showMessage('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–¥–∞: ' + error.message, 'error');
            } finally {
                hideLoading('sendCodeBtn', 'sendCodeBtnText', 'sendCodeLoading');
            }
        }

        // Handle email code login (2FA)
        async function handleEmailCode(event) {
            event.preventDefault();
            
            const email = document.getElementById('emailCodeEmail').value;
            const code = Array.from(document.querySelectorAll('#emailCodeForm .otp-input')).map(input => input.value).join('');

            if (!email) {
                showMessage('–í–≤–µ–¥–∏—Ç–µ email', 'error');
                return;
            }

            if (code.length !== 6) {
                showMessage('–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–Ω—ã–π –∫–æ–¥ –∏–∑ 6 —Ü–∏—Ñ—Ä', 'error');
                return;
            }

            console.log('üö® –§–†–û–ù–¢–ï–ù–î v' + VERSION + ': –í–´–ó–í–ê–ù–ê –§–£–ù–ö–¶–ò–Ø handleEmailCode (2FA LOGIN)');
            console.log('üìß Email:', email);
            console.log('üî¢ Code:', code);

            // Show loading
            showLoading('emailCodeBtn', 'emailCodeBtnText', 'emailCodeLoading');

            try {
                const response = await apiCall('/api/auth/email-code/login', {
                    method: 'POST',
                    body: JSON.stringify({ email, code })
                });

                // Email code login successful
                authToken = response.accessToken;
                localStorage.setItem('authToken', authToken);
                
                if (response.refreshToken) {
                    localStorage.setItem('refreshToken', response.refreshToken);
                }

                showMessage('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!', 'success');
                
                // Redirect based on role
                setTimeout(() => {
                    redirectBasedOnRole(response.user);
                }, 1000);
            } catch (error) {
                console.error('Email code login error:', error);
                showMessage('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + error.message, 'error');
            } finally {
                hideLoading('emailCodeBtn', 'emailCodeBtnText', 'emailCodeLoading');
            }
        }

        // Resend email code for login (2FA)
        async function resendEmailCode() {
            const email = document.getElementById('emailCodeEmail').value;
            
            if (!email) {
                showMessage('–í–≤–µ–¥–∏—Ç–µ email', 'error');
                return;
            }

            console.log('üö® –§–†–û–ù–¢–ï–ù–î v' + VERSION + ': –í–´–ó–í–ê–ù–ê –§–£–ù–ö–¶–ò–Ø resendEmailCode (2FA LOGIN)');
            console.log('üìß Email:', email);

            // Show loading
            const resendBtn = document.getElementById('resendBtn');
            const resendBtnText = document.getElementById('resendBtnText');
            const resendCountdown = document.getElementById('resendCountdown');
            
            resendBtn.disabled = true;
            resendBtnText.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';

            try {
                await apiCall('/api/auth/email-code/send', {
                    method: 'POST',
                    body: JSON.stringify({ email })
                });

                showMessage('–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–≤—Ç–æ—Ä–Ω–æ', 'success');
                
                // Start countdown
                let countdown = 60;
                resendBtnText.classList.add('hidden');
                resendCountdown.classList.remove('hidden');
                resendCountdown.textContent = `–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ ${countdown}—Å`;
                
                const countdownInterval = setInterval(() => {
                    countdown--;
                    resendCountdown.textContent = `–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ ${countdown}—Å`;
                    
                    if (countdown <= 0) {
                        clearInterval(countdownInterval);
                        resendBtn.disabled = false;
                        resendBtnText.classList.remove('hidden');
                        resendCountdown.classList.add('hidden');
                    }
                }, 1000);
            } catch (error) {
                console.error('Resend email code error:', error);
                showMessage('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–¥–∞: ' + error.message, 'error');
                resendBtn.disabled = false;
                resendBtnText.classList.remove('hidden');
                resendCountdown.classList.add('hidden');
            }
        }

        // Handle 2FA
        async function handle2FA(event) {
            event.preventDefault();
            
            const code = Array.from(document.querySelectorAll('#twoFactorForm .otp-input')).map(input => input.value).join('');

            if (code.length !== 6) {
                showMessage('–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–Ω—ã–π –∫–æ–¥ –∏–∑ 6 —Ü–∏—Ñ—Ä', 'error');
                return;
            }
            
            if (!pending2FAUserId) {
                showMessage('–û—à–∏–±–∫–∞: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                return;
            }

            // Show loading
            showLoading('twoFactorBtn', 'twoFactorBtnText', 'twoFactorLoading');

            try {
                const response = await apiCall('/api/two-factor/verify-code', {
                    method: 'POST',
                    body: JSON.stringify({
                        type: 'email',
                        contact: pending2FAEmail,
                        code: code 
                    })
                });

                // 2FA successful
                authToken = response.accessToken;
                localStorage.setItem('authToken', authToken);
                
                if (response.refreshToken) {
                    localStorage.setItem('refreshToken', response.refreshToken);
                }

                // Clear pending 2FA data
                pending2FAUserId = null;
                pending2FAEmail = null;

                showMessage('–î–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø—Ä–æ–π–¥–µ–Ω–∞!', 'success');
                
                // ‚úÖ –ü–†–û–í–ï–†–ö–ê OAuth FLOW: –ï—Å–ª–∏ –º—ã –≤ OAuth flow, —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏–º –Ω–∞ /api/oauth/authorize
                const urlParams2FA = new URLSearchParams(window.location.search);
                const oauthFlow2FA = urlParams2FA.get('oauth_flow') === 'true';
                const returnTo2FA = urlParams2FA.get('return_to');
                
                if (oauthFlow2FA && (returnTo2FA === '/oauth/authorize' || returnTo2FA === '/api/oauth/authorize')) {
                    console.log('üîÑ OAuth flow detected after 2FA, redirecting to /api/oauth/authorize');
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω –≤ cookie –¥–ª—è /oauth/authorize (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ GitHub/Telegram)
                    document.cookie = `temp_access_token=${authToken}; path=/; max-age=60; SameSite=Lax`;
                    
                    setTimeout(() => {
                        isRedirecting = true;
                        // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: API_BASE_URL –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç /api, –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å
                        const apiBaseUrl = window.API_BASE_URL || 'https://vselena.ldmco.ru';
                        window.location.href = `${apiBaseUrl}/api/oauth/authorize`;
                    }, 1000);
                    return;
                }
                
                // Redirect based on role (–æ–±—ã—á–Ω—ã–π flow)
                setTimeout(() => {
                    redirectBasedOnRole(response.user);
                }, 1000);
            } catch (error) {
                console.error('2FA error:', error);
                showMessage('–û—à–∏–±–∫–∞ 2FA: ' + error.message, 'error');
            } finally {
                hideLoading('twoFactorBtn', 'twoFactorBtnText', 'twoFactorLoading');
            }
        }

        // Handle registration
        async function handleRegister(event) {
            event.preventDefault();
            
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const confirmPassword = document.getElementById('regConfirmPassword').value;
            const firstName = document.getElementById('regFirstName').value;
            const lastName = document.getElementById('regLastName').value;

            // Validate passwords match
            if (password !== confirmPassword) {
                showMessage('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç', 'error');
                return;
            }

            // Validate password strength
            if (password.length < 8) {
                showMessage('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
                return;
            }

            // Show loading
            showLoading('registerBtn', 'registerBtnText', 'registerLoading');

            try {
                // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥ –∏–∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏–ª–∏ localStorage
                const urlParams = new URLSearchParams(window.location.search);
                const referralCodeFromUrl = urlParams.get('ref') || urlParams.get('referral') || urlParams.get('referralCode');
                const referralCodeFromStorage = localStorage.getItem('pendingReferralCode');
                const referralCode = referralCodeFromUrl || referralCodeFromStorage;
                
                const requestBody = { 
                        email, 
                        password, 
                        firstName, 
                        lastName 
                };
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
                if (referralCode) {
                    requestBody.referralCode = referralCode;
                    console.log('üîó –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥: ' + referralCode);
                    localStorage.removeItem('pendingReferralCode');
                }
                
                const response = await apiCall('/api/auth/register', {
                    method: 'POST',
                    body: JSON.stringify(requestBody)
                });

                showMessage('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!', 'success');
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω –∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                if (response.accessToken) {
                    localStorage.setItem('authToken', response.accessToken);
                    localStorage.setItem('refreshToken', response.refreshToken);
                    
                    // Redirect based on role
                    setTimeout(() => {
                        redirectBasedOnRole(response.user);
                    }, 1000);
                }
            } catch (error) {
                console.error('Registration error:', error);
                showMessage('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + error.message, 'error');
            } finally {
                hideLoading('registerBtn', 'registerBtnText', 'registerLoading');
            }
        }

        // Handle complete registration
        async function handleCompleteRegistration(event) {
            event.preventDefault();
            
            const email = currentEmail; // Use stored email
            const password = document.getElementById('completePassword').value;
            const confirmPassword = document.getElementById('completeConfirmPassword').value;
            const firstName = document.getElementById('completeFirstName').value;
            const lastName = document.getElementById('completeLastName').value;
            const phone = document.getElementById('completePhone').value;

            // Validate passwords match
            if (password !== confirmPassword) {
                showMessage('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç', 'error');
                return;
            }

            // Validate password strength
            if (password.length < 8) {
                showMessage('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
                return;
            }

            // Show loading
            showLoading('completeBtn', 'completeBtnText', 'completeLoading');

            try {
                const response = await apiCall('/api/auth/register', {
                    method: 'POST',
                    body: JSON.stringify({ 
                        email,
                        password,
                        firstName, 
                        lastName,
                        phone 
                    })
                });

                showMessage('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!', 'success');
                
                // Save tokens
                if (response.accessToken) {
                    localStorage.setItem('authToken', response.accessToken);
                    localStorage.setItem('refreshToken', response.refreshToken);
                }
                
                // Redirect based on role
                setTimeout(() => {
                    redirectBasedOnRole(response.user);
                }, 1000);
            } catch (error) {
                console.error('Complete registration error:', error);
                showMessage('–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + error.message, 'error');
            } finally {
                hideLoading('completeBtn', 'completeBtnText', 'completeLoading');
            }
        }

        // Handle smart registration (when user doesn't exist during login)
        async function handleSmartRegistration(event) {
            event.preventDefault();
            
            const email = currentEmail; // Use stored email
            const password = document.getElementById('smartPassword').value;
            const confirmPassword = document.getElementById('smartConfirmPassword').value;
            const firstName = document.getElementById('smartFirstName').value;
            const lastName = document.getElementById('smartLastName').value;
            const phone = document.getElementById('smartPhone').value;

            // Validate passwords match
            if (password !== confirmPassword) {
                showMessage('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç', 'error');
                        return;
                    }

            // Validate password strength
            if (password.length < 8) {
                showMessage('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
                        return;
                    }

            // Show loading
            showLoading('smartBtn', 'smartBtnText', 'smartLoading');

            try {
                // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥ –∏–∑ URL –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏–ª–∏ localStorage
                const urlParams = new URLSearchParams(window.location.search);
                const referralCodeFromUrl = urlParams.get('ref') || urlParams.get('referral') || urlParams.get('referralCode');
                const referralCodeFromStorage = localStorage.getItem('pendingReferralCode');
                const referralCode = referralCodeFromUrl || referralCodeFromStorage;
                
                // Use smart auth endpoint that handles both login and registration
                const requestBody = { 
                        email, 
                        password,
                        firstName, 
                        lastName
                };
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
                if (referralCode) {
                    requestBody.referralCode = referralCode;
                    console.log('üîó –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥: ' + referralCode);
                    // –£–¥–∞–ª—è–µ–º –∏–∑ localStorage –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
                    localStorage.removeItem('pendingReferralCode');
                }
                
                const response = await apiCall('/api/auth/smart-auth', {
                    method: 'POST',
                    body: JSON.stringify(requestBody)
                });

                // Registration successful
                authToken = response.accessToken;
                localStorage.setItem('authToken', authToken);
                
                if (response.refreshToken) {
                    localStorage.setItem('refreshToken', response.refreshToken);
                }

                showMessage('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!', 'success');
                
                // Redirect based on role
                setTimeout(() => {
                    redirectBasedOnRole(response.user);
                }, 1000);
                    } catch (error) {
                console.error('Smart registration error:', error);
                showMessage('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + error.message, 'error');
                    } finally {
                hideLoading('smartBtn', 'smartBtnText', 'smartLoading');
            }
        }

        // Handle forgot password
        async function handleForgotPassword(event) {
            event.preventDefault();
            
            const email = document.getElementById('forgotEmail').value;

            // Show loading
            showLoading('forgotBtn', 'forgotBtnText', 'forgotLoading');

            try {
                await apiCall('/api/password-reset/forgot', {
                    method: 'POST',
                    body: JSON.stringify({ email })
                });

                showMessage('–°—Å—ã–ª–∫–∞ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ –≤–∞—à—É –ø–æ—á—Ç—É', 'success');
                
                // Return to login
                setTimeout(() => {
                    showLoginForm();
                }, 2000);
                    } catch (error) {
                console.error('Forgot password error:', error);
                showMessage('–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è: ' + error.message, 'error');
                    } finally {
                hideLoading('forgotBtn', 'forgotBtnText', 'forgotLoading');
            }
        }

        // Handle reset password
        async function handleResetPassword(event) {
            event.preventDefault();
            
            const newPassword = document.getElementById('resetNewPassword').value;
            const confirmPassword = document.getElementById('resetConfirmPassword').value;

                    if (newPassword !== confirmPassword) {
                showMessage('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç', 'error');
                        return;
                    }

                    if (newPassword.length < 6) {
                showMessage('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
                        return;
                    }

            // Get token from URL
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');

            if (!token) {
                showMessage('–¢–æ–∫–µ–Ω –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç', 'error');
                        return;
                    }

            // Show loading
            showLoading('resetBtn', 'resetBtnText', 'resetLoading');

            try {
                await apiCall('/api/password-reset/reset', {
                    method: 'POST',
                    body: JSON.stringify({ 
                        token: token,
                        newPassword: newPassword 
                    })
                });

                showMessage('–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω. –í—ã –±—É–¥–µ—Ç–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞.', 'success');
                
                // Return to login
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 3000);
                    } catch (error) {
                console.error('Reset password error:', error);
                showMessage('–û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è: ' + error.message, 'error');
                    } finally {
                hideLoading('resetBtn', 'resetBtnText', 'resetLoading');
            }
        }

        // –§–ª–∞–≥ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π
        let isRedirecting = false;

        // Redirect based on user role
        function redirectBasedOnRole(user) {
            // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            if (isRedirecting) {
                console.log('üö´ Redirect already in progress, skipping');
                return;
            }
            
            // ‚úÖ –ü–†–û–í–ï–†–ö–ê: –ï—Å–ª–∏ –º—ã –Ω–∞ API endpoint, –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —ç—Ç–æ –∫–∞–∫ frontend —Å—Ç—Ä–∞–Ω–∏—Ü—É
            const currentPath = window.location.pathname;
            if (currentPath.startsWith('/api/') || currentPath.startsWith('/oauth/')) {
                console.log('‚ö†Ô∏è On API endpoint, skipping redirectBasedOnRole:', currentPath);
                return;
            }
            
            // ‚úÖ –ü–†–û–í–ï–†–ö–ê OAuth FLOW: –ï—Å–ª–∏ –º—ã –≤ OAuth flow, —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏–º –Ω–∞ /api/oauth/authorize
            const urlParams = new URLSearchParams(window.location.search);
            const cookies = document.cookie.split(';');
            const oauthClientIdCookie = cookies.find(c => c.trim().startsWith('oauth_client_id='));
            const oauthRedirectUriCookie = cookies.find(c => c.trim().startsWith('oauth_redirect_uri='));
            const hasOAuthCookies = !!(oauthClientIdCookie || oauthRedirectUriCookie);
            const urlOAuthFlow = window.location.search.includes('oauth_flow=true') || window.location.search.includes('oauth_flow=1');
            const urlHasClientId = window.location.search.includes('client_id=');
            const urlHasReturnTo = window.location.search.includes('return_to=');
            const oauthFlow = urlParams.get('oauth_flow') === 'true' || urlParams.get('oauth_flow') === '1';
            const returnTo = urlParams.get('return_to');
            
            // –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ OAuth flow - –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è OAuth flow
            const isOAuthFlow = urlOAuthFlow || urlHasClientId || urlHasReturnTo ||
                                oauthFlow || 
                                sessionStorage.getItem('oauth_flow') === 'true' || 
                                sessionStorage.getItem('return_to')?.includes('/oauth/authorize') ||
                                hasOAuthCookies;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∫ —Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç (/oauth/authorize), —Ç–∞–∫ –∏ –Ω–æ–≤—ã–π (/api/oauth/authorize)
            if (isOAuthFlow) {
                console.log('üîÑ OAuth flow detected, redirecting to /api/oauth/authorize');
                console.log('üîÑ OAuth params:', { oauthFlow, returnTo });
                console.log('üîç Current page:', currentPath);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ç–æ–∫–µ–Ω –≤ localStorage (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–≥ —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è)
                const storedToken = localStorage.getItem('authToken') || localStorage.getItem('accessToken');
                if (storedToken) {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω –≤ cookie –¥–ª—è /oauth/authorize
                    document.cookie = `temp_access_token=${storedToken}; path=/; max-age=60; SameSite=Lax`;
                }
                
                // OAuth –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —É–∂–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ cookies –Ω–∞ –±—ç–∫–µ–Ω–¥–µ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—Ä–æ—Å–µ
                // –†–µ–¥–∏—Ä–µ–∫—Ç–∏–º –Ω–∞ /api/oauth/authorize (backend endpoint) –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è flow
                isRedirecting = true;
                // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: API_BASE_URL –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç /api, –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å
                const apiBaseUrl = window.API_BASE_URL || 'https://vselena.ldmco.ru';
                window.location.href = `${apiBaseUrl}/api/oauth/authorize`;
                return;
            }
            
            const rolePriority = {
                'super_admin': 5,
                'admin': 4,
                'manager': 3,
                'editor': 2,
                'viewer': 1
            };
            
            // Get the highest priority role
            let roles = user.roles || [];
            if (roles.length > 0 && typeof roles[0] === 'string') {
                roles = roles.map(roleName => ({ name: roleName }));
            }
            
            const highestRole = roles.reduce((highest, current) => {
                const currentPriority = rolePriority[current.name] || 0;
                const highestPriority = rolePriority[highest?.name] || 0;
                return currentPriority > highestPriority ? current : highest;
            }, null);
            
            console.log('üîç User roles:', roles);
            console.log('üîç Highest role:', highestRole);
            console.log('üîç Current page:', window.location.pathname);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –Ω–∞—Ö–æ–¥–∏–º—Å—è –ª–∏ –º—ã —É–∂–µ –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
            const currentPage = window.location.pathname;
            
            // Redirect based on role
            if (highestRole?.name === 'super_admin') {
                if (!currentPage.includes('test-micro-modules.html')) {
                    console.log('üîÑ Redirecting super_admin to test-micro-modules.html');
                    isRedirecting = true;
                    window.location.href = 'test-micro-modules.html';
                } else {
                    console.log('‚úÖ Super admin already on correct page');
                }
            } else {
                // –ï—Å–ª–∏ —Ä–æ–ª–∏ –Ω–µ—Ç –∏–ª–∏ –æ–Ω–∞ –ø—É—Å—Ç–∞—è, —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏–º –Ω–∞ dashboard –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                if (!highestRole || !highestRole.name) {
                    console.log('‚ö†Ô∏è No role found, redirecting to dashboard.html by default');
                    isRedirecting = true;
                    window.location.href = 'dashboard.html';
                    return;
                }
                
                if (!currentPage.includes('dashboard.html')) {
                    console.log('üîÑ Redirecting to dashboard.html');
                    isRedirecting = true;
                    window.location.href = 'dashboard.html';
                } else {
                    console.log('‚úÖ User already on correct page');
                }
            }
        }

        // Verify token and redirect
        async function verifyTokenAndRedirect() {
            // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
            if (isRedirecting) {
                console.log('üö´ Redirect in progress, skipping token verification');
                return;
            }
            
            // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–∏ OAuth flow –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ - –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –≤—Ö–æ–¥–∞
            // –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤–æ–π—Ç–∏ —Å –¥—Ä—É–≥–∏–º –∞–∫–∫–∞—É–Ω—Ç–æ–º –ø–æ—Å–ª–µ –≤—ã—Ö–æ–¥–∞
            const urlParams = new URLSearchParams(window.location.search);
            // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –û–ø—Ä–µ–¥–µ–ª—è–µ–º cookies –ü–ï–†–ï–î –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º
            const cookies = document.cookie.split(';');
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º OAuth flow –∏–∑ URL, sessionStorage –ò cookies (–∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –±—ç–∫–µ–Ω–¥–æ–º)
            const oauthClientIdCookie = cookies.find(c => c.trim().startsWith('oauth_client_id='));
            const oauthRedirectUriCookie = cookies.find(c => c.trim().startsWith('oauth_redirect_uri='));
            const hasOAuthCookies = !!(oauthClientIdCookie || oauthRedirectUriCookie);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º URL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–∞–ø—Ä—è–º—É—é (–±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–æ)
            const urlOAuthFlow = window.location.search.includes('oauth_flow=true') || window.location.search.includes('oauth_flow=1');
            const urlHasClientId = window.location.search.includes('client_id=');
            const urlHasReturnTo = window.location.search.includes('return_to=');
            
            const isOAuthFlow = urlOAuthFlow || urlHasClientId || urlHasReturnTo ||
                                urlParams.get('oauth_flow') === 'true' || urlParams.get('oauth_flow') === '1' || 
                                sessionStorage.getItem('oauth_flow') === 'true' || 
                                sessionStorage.getItem('return_to')?.includes('/oauth/authorize') ||
                                hasOAuthCookies; // –ï—Å–ª–∏ –µ—Å—Ç—å OAuth cookies - —ç—Ç–æ OAuth flow
            
            if (isOAuthFlow) {
                console.log('üîÑ OAuth flow detected in verifyTokenAndRedirect - skipping automatic token verification (allows switching accounts)');
                return; // –ù–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω –ø—Ä–∏ OAuth flow - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –≤—Ö–æ–¥–∞
            }
            
            // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —Ç–æ–ª—å–∫–æ temp_access_token –≤ cookies –±–µ–∑ localStorage —Ç–æ–∫–µ–Ω–∞
            // –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Å—Ç–∞—Ç–æ–∫ –æ—Ç OAuth flow, –∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–Ω–æ –æ—á–∏—Å—Ç–∏—Ç—å
            const tempTokenCookie = cookies.find(c => c.trim().startsWith('temp_access_token='));
            const authToken = localStorage.getItem('authToken') || localStorage.getItem('accessToken');
            
            if (!authToken && tempTokenCookie) {
                console.log('üßπ Found temp_access_token cookie but no localStorage token - clearing and aborting redirect');
                document.cookie = 'temp_access_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; SameSite=Lax';
                return; // –ù–µ –¥–µ–ª–∞–µ–º —Ä–µ–¥–∏—Ä–µ–∫—Ç, –µ—Å–ª–∏ –Ω–µ—Ç –≤–∞–ª–∏–¥–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞
            }
            
            try {
                const response = await apiCall('/api/auth/me', { method: 'GET' });
                currentUser = response;
                
                // Redirect based on role
                redirectBasedOnRole(currentUser);
                    } catch (error) {
                console.error('Token verification failed:', error);
                localStorage.removeItem('authToken');
                localStorage.removeItem('accessToken');
                localStorage.removeItem('refreshToken');
                // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –û—á–∏—â–∞–µ–º —Ç–∞–∫–∂–µ cookies –ø—Ä–∏ –æ—à–∏–±–∫–µ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
                document.cookie = 'temp_access_token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; SameSite=Lax';
            }
        }

        // Verify email token
        async function verifyEmailToken(token) {
            try {
                console.log('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è email:', token);
                
                const response = await apiCall('/api/auth/email-verification/verify', {
                    method: 'POST',
                    body: JSON.stringify({ token })
                });

                if (response.success) {
                    showMessage('Email —É—Å–ø–µ—à–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω! –í—ã –±—É–¥–µ—Ç–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞.', 'success');
                    
                    // Redirect to login after 3 seconds
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 3000);
                } else {
                    showMessage('–û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è email: ' + response.message, 'error');
                    
                    // Redirect to login after 5 seconds
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 5000);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è email:', error);
                showMessage('–û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è email: ' + error.message, 'error');
                
                // Redirect to login after 5 seconds
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 5000);
            }
        }

        // API call function
        async function apiCall(endpoint, options = {}) {
            const url = `${window.API_BASE_URL}${endpoint}`;
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    ...(authToken && { 'Authorization': `Bearer ${authToken}` })
                }
            };

            const response = await fetch(url, { ...defaultOptions, ...options });
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
            }

            return await response.json();
        }

        // Show loading state
        function showLoading(btnId, textId, loadingId) {
            document.getElementById(btnId).disabled = true;
            document.getElementById(textId).classList.add('hidden');
            document.getElementById(loadingId).classList.remove('hidden');
        }

        // Hide loading state
        function hideLoading(btnId, textId, loadingId) {
            document.getElementById(btnId).disabled = false;
            document.getElementById(textId).classList.remove('hidden');
            document.getElementById(loadingId).classList.add('hidden');
        }

        // Show message
        function showMessage(message, type) {
            // Remove existing messages
            const existingMessages = document.querySelectorAll('.error-message, .success-message');
            existingMessages.forEach(msg => msg.remove());

            // Create new message
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'error' ? 'error-message' : 'success-message';
            messageDiv.innerHTML = `
                <i class="fas fa-${type === 'error' ? 'exclamation-circle' : 'check-circle'}"></i>
                <span>${message}</span>
            `;

            // Insert message
            const form = document.querySelector('.auth-step.active form');
            if (form) {
                form.insertBefore(messageDiv, form.firstChild);
            }

            // Auto-hide after 5 seconds
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

    </script>
</body>
</html>
