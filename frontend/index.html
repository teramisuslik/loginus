<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="version" content="2.0.7">
    <title>Loginus - Система управления знаниями</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #1a202c;
        }

        .auth-container {
            background: white;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            width: 100%;
            max-width: 1200px;
            min-height: 600px;
            display: flex;
            position: relative;
        }

        .auth-left {
            flex: 1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 3rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .auth-left::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="75" cy="75" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="50" cy="10" r="0.5" fill="rgba(255,255,255,0.05)"/><circle cx="10" cy="60" r="0.5" fill="rgba(255,255,255,0.05)"/><circle cx="90" cy="40" r="0.5" fill="rgba(255,255,255,0.05)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            opacity: 0.3;
            animation: float 20s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            z-index: 1;
        }

        .logo-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(45deg, #ff6b6b, #ffa500);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.3);
        }

        .logo-text {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(45deg, #fff, #e2e8f0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .auth-left h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            text-align: center;
            z-index: 1;
        }

        .auth-left p {
            font-size: 1.2rem;
            opacity: 0.9;
            text-align: center;
            margin-bottom: 2rem;
            z-index: 1;
        }

        .features {
            list-style: none;
            z-index: 1;
        }

        .features li {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .features i {
            width: 24px;
            height: 24px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
        }

        .auth-right {
            flex: 1;
            padding: 3rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
        }

        .auth-form {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
        }

        .form-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .form-title {
            font-size: 2rem;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 0.5rem;
        }

        .form-subtitle {
            color: #64748b;
            font-size: 1rem;
        }

        .email-display {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 1rem;
            margin: 1rem 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .email-display i {
            color: #667eea;
            font-size: 1.1rem;
        }

        .email-display span {
            flex: 1;
            font-weight: 500;
            color: #1a202c;
        }

        .email-display .btn-link {
            color: #667eea;
            font-size: 0.9rem;
            text-decoration: none;
            border: none;
            background: none;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .email-display .btn-link:hover {
            background: #e2e8f0;
            color: #4c51bf;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #374151;
        }

        .form-input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            transition: none !important;
            background: #f8fafc !important;
            /* Полностью отключаем все браузерные стили */
            -webkit-appearance: none !important;
            -moz-appearance: none !important;
            appearance: none !important;
            /* Отключаем все автозаполнение */
            -webkit-autofill: none !important;
            -webkit-box-shadow: 0 0 0 1000px #f8fafc inset !important;
            /* Отключаем анимации */
            animation: none !important;
            -webkit-animation: none !important;
            /* Принудительно устанавливаем стили */
            color: #1a202c !important;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important;
        }

        .form-input:focus {
            outline: none !important;
            border-color: #667eea !important;
            background: white !important;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1) !important;
            transition: none !important;
            animation: none !important;
            -webkit-animation: none !important;
        }

        /* Предотвращаем мерцание при автозаполнении */
        .form-input:-webkit-autofill,
        .form-input:-webkit-autofill:hover,
        .form-input:-webkit-autofill:focus,
        .form-input:-webkit-autofill:active {
            -webkit-box-shadow: 0 0 0 1000px #f8fafc inset !important;
            -webkit-text-fill-color: #1a202c !important;
            transition: none !important;
            animation: none !important;
            -webkit-animation: none !important;
        }

        /* Дополнительные правила для предотвращения мерцания */
        .form-input,
        .form-input:focus,
        .form-input:active,
        .form-input:hover {
            transition: none !important;
            animation: none !important;
            -webkit-animation: none !important;
            -webkit-transition: none !important;
            -moz-transition: none !important;
            -o-transition: none !important;
        }

        .form-input.error {
            border-color: #ef4444;
            background: #fef2f2;
        }

        .input-group {
            position: relative;
        }

        .input-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #64748b;
            z-index: 1;
        }

        .input-group .form-input {
            padding-left: 3rem;
        }

        .password-toggle {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #64748b;
            cursor: pointer;
            z-index: 1;
        }

        .btn {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            margin-bottom: 1rem;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #f1f5f9;
            color: #64748b;
            border: 2px solid #e2e8f0;
        }

        .btn-secondary:hover {
            background: #e2e8f0;
            color: #374151;
        }

        .btn-link {
            background: none;
            color: #667eea;
            text-decoration: none;
            padding: 0.5rem;
            font-size: 0.9rem;
        }

        .btn-link:hover {
            text-decoration: underline;
        }

        .form-footer {
            text-align: center;
            margin-top: 2rem;
        }

        .form-footer p {
            color: #64748b;
            margin-bottom: 1rem;
        }

        .divider {
            display: flex;
            align-items: center;
            margin: 2rem 0;
            color: #64748b;
        }

        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #e2e8f0;
        }

        .divider span {
            padding: 0 1rem;
            font-size: 0.9rem;
        }

        .auth-tabs {
            display: flex;
            background: #f1f5f9;
            border-radius: 12px;
            padding: 0.5rem;
            margin-bottom: 2rem;
        }

        .auth-tab {
            flex: 1;
            padding: 0.75rem 1rem;
            background: none;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #64748b;
        }

        .auth-tab.active {
            background: white;
            color: #667eea;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .auth-header {
            text-align: center;
            margin-bottom: 2rem;
            font-weight: 600;
            color: #667eea;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 1.1rem;
        }

        .auth-step {
            display: none;
        }

        .auth-step.active {
            display: block;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
        }

        .step {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin: 0 0.5rem;
            transition: all 0.3s ease;
        }

        .step.completed {
            background: #10b981;
            color: white;
        }

        .step.current {
            background: #667eea;
            color: white;
        }

        .step.pending {
            background: #e2e8f0;
            color: #64748b;
        }

        .step-line {
            width: 40px;
            height: 2px;
            background: #e2e8f0;
            margin-top: 19px;
        }

        .step-line.completed {
            background: #10b981;
        }

        .otp-inputs {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin: 2rem 0;
        }

        .otp-input {
            width: 50px;
            height: 50px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            text-align: center;
            font-size: 1.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
            background: #f8fafc;
        }

        .otp-input:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .otp-input.filled {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .resend-code {
            text-align: center;
            margin-top: 1rem;
        }

        .resend-code button {
            background: none;
            border: none;
            color: #667eea;
            cursor: pointer;
            text-decoration: underline;
        }

        .resend-code button:disabled {
            color: #64748b;
            cursor: not-allowed;
            text-decoration: none;
        }

        .countdown {
            color: #ef4444;
            font-weight: 600;
        }

        .security-info {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .security-info h4 {
            color: #0c4a6e;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .security-info p {
            color: #075985;
            font-size: 0.9rem;
        }

        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .success-message {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            color: #16a34a;
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .slide-in {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        /* Multi-Auth Styles */
        .auth-methods-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }

        .auth-method-card {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            pointer-events: auto;
            z-index: 1;
        }
        
        /* Скрытие карточек отключенных методов авторизации */
        .auth-method-card[data-hidden-by-module="true"],
        .auth-method-card.hidden-by-module {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
        }

        .auth-method-card:hover {
            border-color: #667eea;
            background: #f0f4ff;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
        }

        .auth-method-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .auth-method-card.selected .method-icon {
            transform: scale(1.1);
        }

        .method-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            transition: transform 0.3s ease;
        }

        .method-name {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }

        .method-description {
            font-size: 0.8rem;
            opacity: 0.8;
            line-height: 1.3;
        }

        .selected-method-info {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1rem;
            text-align: center;
        }

        .selected-method-info p {
            margin-bottom: 1rem;
            color: #0c4a6e;
            font-weight: 500;
        }

        .phone-auth-form {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
        }

        .messenger-selector {
            display: flex;
            gap: 1rem;
            margin: 1rem 0;
        }

        .messenger-option {
            flex: 1;
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .messenger-option:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .messenger-option.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .oauth-buttons {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin: 1rem 0;
        }

        .oauth-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            background: white;
            color: #374151;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .oauth-btn:hover {
            border-color: #667eea;
            background: #f0f4ff;
            transform: translateY(-1px);
        }

        .oauth-btn.github {
            border-color: #24292e;
            color: #24292e;
        }

        .oauth-btn.github:hover {
            background: #24292e;
            color: white;
        }

        .oauth-btn.vkontakte {
            border-color: #0077ff;
            color: #0077ff;
        }

        .oauth-btn.vkontakte:hover {
            background: #0077ff;
            color: white;
        }

        .oauth-btn.gosuslugi {
            border-color: #00a651;
            color: #00a651;
        }

        .oauth-btn.gosuslugi:hover {
            background: #00a651;
            color: white;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .auth-container {
                flex-direction: column;
                margin: 1rem;
                border-radius: 16px;
            }

            .auth-left {
                padding: 2rem;
                min-height: 300px;
            }

            .auth-right {
                padding: 2rem;
            }

            .logo-text {
                font-size: 2rem;
            }

            .auth-left h1 {
                font-size: 2rem;
            }

            .otp-inputs {
                gap: 0.5rem;
            }

            .otp-input {
                width: 40px;
                height: 40px;
                font-size: 1.2rem;
            }

            /* Multi-Auth Mobile Styles */
            .auth-methods-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
            }

            .auth-method-card {
                padding: 1rem;
            }

            .method-icon {
                font-size: 1.5rem;
            }

            .method-name {
                font-size: 0.9rem;
            }

            .method-description {
                font-size: 0.7rem;
            }

            .messenger-selector {
                flex-direction: column;
            }

            .oauth-buttons {
                gap: 0.5rem;
            }

            .oauth-btn {
                padding: 0.75rem;
                font-size: 0.9rem;
            }
        }

        @media (max-width: 480px) {
            .auth-methods-grid {
                grid-template-columns: 1fr;
            }

            .auth-method-card {
                padding: 1.25rem;
            }

            .method-icon {
                font-size: 1.75rem;
            }
        }
    </style>
</head>
<body>
    <div class="auth-container">
        <!-- Left Side - Branding -->
        <div class="auth-left">
        <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-brain"></i>
        </div>
                <div class="logo-text">Loginus</div>
        </div>

            <h1>Добро пожаловать!</h1>
            <p>Современная система управления знаниями и поддержкой</p>
            
            <ul class="features">
                <li>
                    <i class="fas fa-shield-alt"></i>
                    <span>Безопасная авторизация с 2FA</span>
                </li>
                <li>
                    <i class="fas fa-users"></i>
                    <span>Управление командами и организациями</span>
                </li>
                <li>
                    <i class="fas fa-book"></i>
                    <span>База знаний и документация</span>
                </li>
                <li>
                    <i class="fas fa-headset"></i>
                    <span>Система поддержки клиентов</span>
                </li>
                <li>
                    <i class="fas fa-chart-bar"></i>
                    <span>Аналитика и отчеты</span>
                </li>
            </ul>
            </div>

        <!-- Right Side - Auth Forms -->
        <div class="auth-right">
            <div class="auth-form">
                <!-- Auth Header -->
                <div class="auth-header">
                    <i class="fas fa-shield-alt"></i>
                    Выберите способ входа
                </div>

                <!-- Method Selection Step -->
                <div id="methodStep" class="auth-step active">
                    <div class="form-header">
                        <h2 class="form-title">Как вы хотите войти?</h2>
                        <p class="form-subtitle">Выберите удобный для вас способ аутентификации</p>
                    </div>

                    <div class="auth-methods-grid">
                        <!-- Email -->
                        <div class="auth-method-card" data-method="EMAIL" id="emailAuthCard" onclick="selectAuthMethod('EMAIL')">
                            <div class="method-icon">📧</div>
                            <div class="method-name">Email</div>
                            <div class="method-description">Вход по email и паролю</div>
                        </div>

                        
                        <!-- Telegram Login Widget -->
                        <div class="auth-method-card" data-method="TELEGRAM_OAUTH" id="telegramAuthCard" onclick="selectAuthMethod('TELEGRAM_OAUTH')">
                            <div class="method-icon">🚀</div>
                            <div class="method-name">Telegram OAuth</div>
                            <div class="method-description">Быстрый вход через Telegram</div>
                        </div>
                        

                        <!-- GitHub -->
                        <div class="auth-method-card" data-method="GITHUB" id="githubAuthCard" onclick="selectAuthMethod('GITHUB')">
                            <div class="method-icon">🐙</div>
                            <div class="method-name">GitHub</div>
                            <div class="method-description">Вход через GitHub</div>
                        </div>
                    </div>

                    <div class="selected-method-info" id="selectedMethodInfo" style="display: none;">
                        <p>Выбранный метод: <span id="selectedMethodName">Email</span></p>
                        <button type="button" class="btn btn-primary" onclick="proceedWithSelectedMethod()">
                            <span id="proceedBtnText">Продолжить</span>
                        </button>
                    </div>
                </div>

                <!-- Email Input Step -->
                <div id="emailStep" class="auth-step">
                    <div class="form-header">
                        <h2 class="form-title">Введите ваш email</h2>
                        <p class="form-subtitle">Мы определим, есть ли у вас аккаунт в системе</p>
                    </div>

                    <form id="emailStepForm" onsubmit="handleEmailStep(event)">
                        <div class="form-group">
                            <label class="form-label" for="emailInput">Email</label>
                            <div class="input-group">
                                <i class="fas fa-envelope input-icon"></i>
                                <input type="email" id="emailInput" class="form-input" placeholder="your@email.com" required autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary" id="emailStepBtn">
                            <span id="emailStepBtnText">Продолжить</span>
                            <div class="loading hidden" id="emailStepLoading"></div>
                        </button>
                    </form>

                    <div class="form-footer">
                        <button class="btn-link" onclick="goBackToMethodStep()">
                            <i class="fas fa-arrow-left"></i>
                            Вернуться к выбору метода
                        </button>
                    </div>
                </div>

                <!-- Login Form -->
                <div id="loginForm" class="auth-step">
                    <div class="form-header">
                        <h2 class="form-title">Вход в систему</h2>
                        <p class="form-subtitle">Введите пароль для входа</p>
                        <div class="email-display">
                            <i class="fas fa-envelope"></i>
                            <span id="loginEmailDisplay"></span>
                            <button type="button" class="btn-link" onclick="goBackToEmailStep()">Изменить email</button>
                        </div>
        </div>

                    <form id="loginFormElement" method="post" onsubmit="handleLogin(event)">
            <div class="form-group">
                            <label class="form-label" for="loginPassword">Пароль</label>
                            <div class="input-group">
                                <i class="fas fa-lock input-icon"></i>
                                <input type="password" id="loginPassword" class="form-input" placeholder="Введите пароль" required autofocus>
                                <button type="button" class="password-toggle" onclick="togglePassword('loginPassword')">
                                    <i class="fas fa-eye"></i>
            </button>
            </div>
        </div>

            <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" id="rememberMe" style="margin-right: 0.5rem;">
                                Запомнить меня
                            </label>
            </div>

                        <button type="submit" class="btn btn-primary" id="loginBtn">
                            <span id="loginBtnText">Войти</span>
                            <div class="loading hidden" id="loginLoading"></div>
            </button>
                    </form>

                    <div class="divider">
                        <span>или</span>
                    </div>

                    <button type="button" class="btn btn-secondary" onclick="showEmailCodeForm()">
                        <i class="fas fa-envelope"></i>
                        Войти по коду с почты
                    </button>

                    <div class="form-footer">
                        <button class="btn-link" onclick="showForgotPassword()">
                            Забыли пароль?
            </button>
                    </div>
        </div>

                <!-- Email Code Form -->
                <div id="emailCodeForm" class="auth-step">
                    <div class="form-header">
                        <h2 class="form-title">Вход по коду с почты</h2>
                        <p class="form-subtitle">Введите код, отправленный на вашу почту</p>
                    </div>

                    <div class="security-info">
                        <h4>
                            <i class="fas fa-envelope"></i>
                            Проверьте почту
                        </h4>
                        <p>Мы отправили код подтверждения на вашу почту. Введите 6-значный код для входа в систему.</p>
                    </div>

                    <form id="emailCodeFormElement" onsubmit="handleEmailCode(event)">
                        <div class="form-group">
                            <label class="form-label" for="emailCodeEmail">Email</label>
                            <div class="input-group">
                                <i class="fas fa-envelope input-icon"></i>
                                <input type="email" id="emailCodeEmail" class="form-input" placeholder="your@email.com" required autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Код с почты</label>
                            <div class="otp-inputs">
                                <input type="text" class="otp-input" maxlength="1" oninput="moveToNext(this, 0)">
                                <input type="text" class="otp-input" maxlength="1" oninput="moveToNext(this, 1)">
                                <input type="text" class="otp-input" maxlength="1" oninput="moveToNext(this, 2)">
                                <input type="text" class="otp-input" maxlength="1" oninput="moveToNext(this, 3)">
                                <input type="text" class="otp-input" maxlength="1" oninput="moveToNext(this, 4)">
                                <input type="text" class="otp-input" maxlength="1" oninput="moveToNext(this, 5)">
                            </div>
                        </div>

                        <button type="button" class="btn btn-primary" id="sendCodeBtn" onclick="sendEmailCode()">
                            <span id="sendCodeBtnText">Отправить код</span>
                            <div class="loading hidden" id="sendCodeLoading"></div>
                        </button>

                        <button type="submit" class="btn btn-primary hidden" id="emailCodeBtn">
                            <span id="emailCodeBtnText">Подтвердить</span>
                            <div class="loading hidden" id="emailCodeLoading"></div>
                        </button>
                    </form>

                    <div class="resend-code">
                        <button type="button" onclick="resendEmailCode()" id="resendBtn">
                            <span id="resendBtnText">Отправить код повторно</span>
                            <span class="countdown hidden" id="resendCountdown"></span>
                        </button>
                    </div>

                    <div class="form-footer">
                        <button class="btn-link" onclick="showLoginForm()">
                            <i class="fas fa-arrow-left"></i>
                            Вернуться к входу
                        </button>
                    </div>
                </div>

                <!-- 2FA Form -->
                <div id="twoFactorForm" class="auth-step">
                    <div class="form-header">
                        <h2 class="form-title">Двухфакторная аутентификация</h2>
                        <p class="form-subtitle">Введите код из приложения аутентификатора</p>
            </div>

                    <div class="security-info">
                        <h4>
                            <i class="fas fa-shield-alt"></i>
                            Безопасность
                        </h4>
                        <p>Для защиты вашего аккаунта включена двухфакторная аутентификация. Введите 6-значный код из приложения Google Authenticator или аналогичного.</p>
        </div>

                    <form id="twoFactorFormElement" onsubmit="handle2FA(event)">
            <div class="form-group">
                            <label class="form-label">Код аутентификатора</label>
                            <div class="otp-inputs">
                                <input type="text" class="otp-input" maxlength="1" oninput="moveToNext2FA(this, 0)">
                                <input type="text" class="otp-input" maxlength="1" oninput="moveToNext2FA(this, 1)">
                                <input type="text" class="otp-input" maxlength="1" oninput="moveToNext2FA(this, 2)">
                                <input type="text" class="otp-input" maxlength="1" oninput="moveToNext2FA(this, 3)">
                                <input type="text" class="otp-input" maxlength="1" oninput="moveToNext2FA(this, 4)">
                                <input type="text" class="otp-input" maxlength="1" oninput="moveToNext2FA(this, 5)">
            </div>
            </div>

                        <button type="submit" class="btn btn-primary" id="twoFactorBtn">
                            <span id="twoFactorBtnText">Подтвердить</span>
                            <div class="loading hidden" id="twoFactorLoading"></div>
            </button>
                    </form>

            </div>
            
                <!-- Убрана отдельная форма регистрации - только умная регистрация -->

                <!-- Forgot Password Form -->
                <div id="forgotPasswordForm" class="auth-step">
                    <div class="form-header">
                        <h2 class="form-title">Восстановление пароля</h2>
                        <p class="form-subtitle">Введите email для восстановления доступа</p>
                </div>
                
                    <form id="forgotPasswordFormElement" onsubmit="handleForgotPassword(event)">
                    <div class="form-group">
                            <label class="form-label" for="forgotEmail">Email</label>
                            <div class="input-group">
                                <i class="fas fa-envelope input-icon"></i>
                                <input type="email" id="forgotEmail" class="form-input" placeholder="your@email.com" required autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
                    </div>
                </div>
                
                        <button type="submit" class="btn btn-primary" id="forgotBtn">
                            <span id="forgotBtnText">Отправить ссылку</span>
                            <div class="loading hidden" id="forgotLoading"></div>
                </button>
                    </form>

                    <div class="form-footer">
                        <button class="btn-link" onclick="showLoginForm()">
                            <i class="fas fa-arrow-left"></i>
                            Вернуться к входу
                </button>
                    </div>
            </div>
            
                <!-- Reset Password Form -->
                <div id="resetPasswordForm" class="auth-step">
                    <div class="form-header">
                        <h2 class="form-title">Сброс пароля</h2>
                        <p class="form-subtitle">Введите новый пароль для вашего аккаунта</p>
                </div>
                
                    <form id="resetPasswordFormElement" onsubmit="handleResetPassword(event)">
                        <div class="form-group">
                            <label class="form-label" for="resetNewPassword">Новый пароль</label>
                            <div class="input-group">
                                <i class="fas fa-lock input-icon"></i>
                                <input type="password" id="resetNewPassword" class="form-input" placeholder="Введите новый пароль" required>
                                <button type="button" class="password-toggle" onclick="togglePassword('resetNewPassword')">
                                    <i class="fas fa-eye"></i>
                    </button>
                </div>
            </div>
            
                <div class="form-group">
                            <label class="form-label" for="resetConfirmPassword">Подтвердите пароль</label>
                            <div class="input-group">
                                <i class="fas fa-lock input-icon"></i>
                                <input type="password" id="resetConfirmPassword" class="form-input" placeholder="Подтвердите новый пароль" required>
                                <button type="button" class="password-toggle" onclick="togglePassword('resetConfirmPassword')">
                                    <i class="fas fa-eye"></i>
                                </button>
                </div>
                </div>

                        <button type="submit" class="btn btn-primary" id="resetBtn">
                            <span id="resetBtnText">Сбросить пароль</span>
                            <div class="loading hidden" id="resetLoading"></div>
                </button>
                    </form>

                    <div class="form-footer">
                        <button class="btn-link" onclick="showLoginForm()">
                            <i class="fas fa-arrow-left"></i>
                            Вернуться к входу
                        </button>
                </div>
            </div>
            
                <!-- Complete Registration Form -->
                <div id="completeRegistrationForm" class="auth-step">
                    <div class="form-header">
                        <h2 class="form-title">Завершение регистрации</h2>
                        <p class="form-subtitle">Дополните информацию о себе</p>
                    </div>

                    <form id="completeRegistrationFormElement" onsubmit="handleCompleteRegistration(event)">
                <div class="form-group">
                            <label class="form-label" for="completeFirstName">Имя</label>
                            <div class="input-group">
                                <i class="fas fa-user input-icon"></i>
                                <input type="text" id="completeFirstName" class="form-input" placeholder="Ваше имя" required>
                </div>
                        </div>

                <div class="form-group">
                            <label class="form-label" for="completeLastName">Фамилия</label>
                            <div class="input-group">
                                <i class="fas fa-user input-icon"></i>
                                <input type="text" id="completeLastName" class="form-input" placeholder="Ваша фамилия" required>
                </div>
                        </div>

                <div class="form-group">
                            <label class="form-label" for="completePhone">Телефон (необязательно)</label>
                            <div class="input-group">
                                <i class="fas fa-phone input-icon"></i>
                                <input type="tel" id="completePhone" class="form-input" placeholder="+7 (999) 123-45-67">
                </div>
                        </div>

                        <button type="submit" class="btn btn-primary" id="completeBtn">
                            <span id="completeBtnText">Завершить регистрацию</span>
                            <div class="loading hidden" id="completeLoading"></div>
                </button>
                    </form>
                </div>

                <!-- Smart Registration Form (when user doesn't exist during login) -->
                <div id="smartRegistrationForm" class="auth-step">
                    <div class="form-header">
                        <h2 class="form-title" id="smartFormTitle">Завершите регистрацию</h2>
                        <p class="form-subtitle" id="smartFormSubtitle">Мы запомнили ваши данные. Добавьте дополнительную информацию:</p>
                </div>

                    <div class="security-info">
                        <h4>
                            <i class="fas fa-info-circle"></i>
                            Умная регистрация
                        </h4>
                        <p>Мы обнаружили, что пользователя с таким email не существует. Заполните дополнительные поля для создания аккаунта.</p>
            </div>
            
                    <form id="smartRegistrationFormElement" onsubmit="handleSmartRegistration(event)">
                <div class="form-group">
                            <label class="form-label" for="smartEmail">Email</label>
                            <div class="input-group">
                                <i class="fas fa-envelope input-icon"></i>
                                <input type="email" id="smartEmail" class="form-input" placeholder="your@email.com" required readonly>
                            </div>
                            <small style="color: #64748b; font-size: 0.8rem;">Email уже заполнен из формы входа</small>
                </div>
                
                <div class="form-group">
                            <label class="form-label" for="smartPassword">Пароль</label>
                            <div class="input-group">
                                <i class="fas fa-lock input-icon"></i>
                                <input type="password" id="smartPassword" class="form-input" placeholder="Создайте пароль" required>
                                <button type="button" class="password-toggle" onclick="togglePassword('smartPassword')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                </div>
                
                <div class="form-group">
                            <label class="form-label" for="smartConfirmPassword">Подтвердите пароль</label>
                            <div class="input-group">
                                <i class="fas fa-lock input-icon"></i>
                                <input type="password" id="smartConfirmPassword" class="form-input" placeholder="Повторите пароль" required>
                                <button type="button" class="password-toggle" onclick="togglePassword('smartConfirmPassword')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                </div>
                
                <div class="form-group">
                            <label class="form-label" for="smartFirstName">Имя *</label>
                            <div class="input-group">
                                <i class="fas fa-user input-icon"></i>
                                <input type="text" id="smartFirstName" class="form-input" placeholder="Ваше имя" required>
                </div>
                </div>
                
                        <div class="form-group">
                            <label class="form-label" for="smartLastName">Фамилия *</label>
                            <div class="input-group">
                                <i class="fas fa-user input-icon"></i>
                                <input type="text" id="smartLastName" class="form-input" placeholder="Ваша фамилия" required>
                </div>
           </div>
                
                        <div class="form-group">
                            <label class="form-label" for="smartPhone">Телефон (необязательно)</label>
                            <div class="input-group">
                                <i class="fas fa-phone input-icon"></i>
                                <input type="tel" id="smartPhone" class="form-input" placeholder="+7 (999) 123-45-67">
                </div>
            </div>
            
                <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" id="smartAgreeTerms" required style="margin-right: 0.5rem;">
                                Я согласен с <a href="#" style="color: #667eea;">условиями использования</a> и <a href="#" style="color: #667eea;">политикой конфиденциальности</a>
                            </label>
                </div>

                        <button type="submit" class="btn btn-primary" id="smartBtn">
                            <span id="smartBtnText">Завершить регистрацию</span>
                            <div class="loading hidden" id="smartLoading"></div>
                </button>
                    </form>

                    <div class="form-footer">
                        <button class="btn-link" onclick="goBackToEmailStep()">
                            <i class="fas fa-arrow-left"></i>
                            Вернуться к вводу email
                        </button>
                </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Version для принудительного обновления кеша
        const VERSION = '2.0.7';
        console.log('🚀 Loginus Frontend v' + VERSION + ' загружен');
        
        // Принудительное обновление кеша
        if (localStorage.getItem('frontendVersion') !== VERSION) {
            localStorage.setItem('frontendVersion', VERSION);
            console.log('🔄 Обновление кеша до версии ' + VERSION);
        }
        
        // Define API_BASE_URL globally
        window.API_BASE_URL = (() => {
                const hostname = window.location.hostname;
                if (hostname === 'localhost' || hostname === '127.0.0.1') {
                    return 'http://localhost:3001';
                }
                if (hostname.match(/^\d+\.\d+\.\d+\.\d+$/)) {
                    return `${window.location.protocol}//${window.location.hostname}:3001`;
                }
                return `${window.location.protocol}//${window.location.hostname}`;
            })();
            console.log('API_BASE_URL defined:', window.API_BASE_URL);
        
        // Global variables
        let currentUser = null;
        let authToken = null;
        let pending2FAUserId = null;
        let pending2FAEmail = null;
        let selectedAuthMethod = null;

        // Скрыть отключенные методы авторизации - определяем функцию заранее
        async function hideDisabledAuthMethods() {
            try {
                console.log('🔍 Checking auth modules status...');
                // Проверяем статус модулей аутентификации через правильный endpoint
                const modulesResult = await apiCall('/api/micro-modules', { method: 'GET' });
                console.log('📊 All modules result:', modulesResult);
                
                // Ищем модули auth по имени
                const emailModule = Array.isArray(modulesResult) ? modulesResult.find(m => m.name === 'email-auth') : null;
                const githubModule = Array.isArray(modulesResult) ? modulesResult.find(m => m.name === 'github-auth') : null;
                const telegramModule = Array.isArray(modulesResult) ? modulesResult.find(m => m.name === 'telegram-auth') : null;
                
                // Формируем статус в том же формате для совместимости
                // Если модуль найден - используем его isEnabled, иначе false (модуль отключен если отсутствует)
                const statusResult = {
                    email: { enabled: emailModule ? (emailModule.isEnabled === true) : false },
                    github: { enabled: githubModule ? (githubModule.isEnabled === true) : false },
                    telegram: { enabled: telegramModule ? (telegramModule.isEnabled === true) : false }
                };
                console.log('📊 Auth modules status result:', statusResult);
                
                // Скрываем/показываем карточки методов авторизации на основе статуса модулей
                const emailCard = document.getElementById('emailAuthCard');
                const githubCard = document.getElementById('githubAuthCard');
                const telegramCard = document.getElementById('telegramAuthCard');
                
                console.log('🔍 Email card element:', emailCard);
                console.log('🔍 Email enabled status:', statusResult?.email?.enabled);
                
                if (emailCard) {
                    const emailEnabled = statusResult?.email?.enabled;
                    console.log('🔍 Email enabled value:', emailEnabled, 'Type:', typeof emailEnabled, 'Is false?', emailEnabled === false);
                    
                    if (emailEnabled === false) {
                        console.log('❌ Email auth is disabled, hiding email card');
                        emailCard.style.setProperty('display', 'none', 'important');
                        emailCard.style.setProperty('visibility', 'hidden', 'important');
                        emailCard.style.setProperty('opacity', '0', 'important');
                        emailCard.style.setProperty('pointer-events', 'none', 'important');
                        emailCard.removeAttribute('onclick');
                        emailCard.setAttribute('data-hidden-by-module', 'true');
                        emailCard.classList.add('hidden-by-module');
                        
                        // Дополнительная проверка через секунду
                        setTimeout(() => {
                            if (emailCard && emailCard.style.display !== 'none') {
                                console.error('⚠️ Email card still visible! Forcing hide...');
                                emailCard.style.setProperty('display', 'none', 'important');
                                emailCard.style.setProperty('visibility', 'hidden', 'important');
                                emailCard.style.setProperty('opacity', '0', 'important');
                                emailCard.style.setProperty('pointer-events', 'none', 'important');
                            }
                        }, 1000);
                    } else {
                        console.log('✅ Email auth is enabled, showing email card');
                        emailCard.style.removeProperty('display');
                        emailCard.style.removeProperty('visibility');
                        emailCard.style.removeProperty('opacity');
                        emailCard.style.removeProperty('pointer-events');
                        emailCard.setAttribute('onclick', "selectAuthMethod('EMAIL')");
                        emailCard.removeAttribute('data-hidden-by-module');
                        emailCard.classList.remove('hidden-by-module');
                    }
                } else {
                    console.warn('⚠️ Email card element not found!');
                }
                
                if (githubCard) {
                    if (statusResult?.github?.enabled === false) {
                        githubCard.style.cssText = 'display: none !important; visibility: hidden !important; opacity: 0 !important; pointer-events: none !important;';
                        githubCard.removeAttribute('onclick');
                        githubCard.setAttribute('data-hidden-by-module', 'true');
                    } else {
                        githubCard.style.display = '';
                        githubCard.style.visibility = '';
                        githubCard.style.opacity = '';
                        githubCard.style.pointerEvents = '';
                        githubCard.setAttribute('onclick', "selectAuthMethod('GITHUB')");
                        githubCard.removeAttribute('data-hidden-by-module');
                    }
                }
                
                if (telegramCard) {
                    if (statusResult?.telegram?.enabled === false) {
                        telegramCard.style.cssText = 'display: none !important; visibility: hidden !important; opacity: 0 !important; pointer-events: none !important;';
                        telegramCard.removeAttribute('onclick');
                        telegramCard.setAttribute('data-hidden-by-module', 'true');
                    } else {
                        telegramCard.style.display = '';
                        telegramCard.style.visibility = '';
                        telegramCard.style.opacity = '';
                        telegramCard.style.pointerEvents = '';
                        telegramCard.setAttribute('onclick', "selectAuthMethod('TELEGRAM_OAUTH')");
                        telegramCard.removeAttribute('data-hidden-by-module');
                    }
                }
                
                // Если email-auth отключен, скрываем все формы, связанные с email
                if (statusResult?.email?.enabled === false) {
                    const emailStep = document.getElementById('emailStep');
                    const loginForm = document.getElementById('loginForm');
                    const emailCodeForm = document.getElementById('emailCodeForm');
                    const smartRegistrationForm = document.getElementById('smartRegistrationForm');
                    
                    [emailStep, loginForm, emailCodeForm, smartRegistrationForm].forEach(el => {
                        if (el) {
                            el.style.display = 'none';
                            el.style.visibility = 'hidden';
                            el.setAttribute('data-hidden-by-module', 'true');
                        }
                    });
                } else {
                    const emailStep = document.getElementById('emailStep');
                    const loginForm = document.getElementById('loginForm');
                    const emailCodeForm = document.getElementById('emailCodeForm');
                    const smartRegistrationForm = document.getElementById('smartRegistrationForm');
                    
                    [emailStep, loginForm, emailCodeForm, smartRegistrationForm].forEach(el => {
                        if (el) {
                            el.style.display = '';
                            el.style.visibility = '';
                            el.removeAttribute('data-hidden-by-module');
                        }
                    });
                }
            } catch (error) {
                console.error('Ошибка проверки статуса модулей:', error);
                // В случае ошибки не скрываем элементы
            }
        }
        

        // Вызываем функцию немедленно после определения
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                setTimeout(hideDisabledAuthMethods, 300);
                setTimeout(hideDisabledAuthMethods, 800);
                setTimeout(hideDisabledAuthMethods, 1500);
            });
        } else {
            setTimeout(hideDisabledAuthMethods, 300);
            setTimeout(hideDisabledAuthMethods, 800);
            setTimeout(hideDisabledAuthMethods, 1500);
        }

        // Show method selection step
        async function showMethodStep() {
            console.log('🔵 showMethodStep called');
            document.querySelectorAll('.auth-step').forEach(step => step.classList.remove('active'));
            document.getElementById('methodStep').classList.add('active');
            // Скрываем отключенные методы авторизации - вызываем несколько раз с задержками
            console.log('🔵 Calling hideDisabledAuthMethods');
            hideDisabledAuthMethods().catch(e => console.error('Error:', e));
            setTimeout(() => hideDisabledAuthMethods().catch(e => console.error('Error:', e)), 200);
            setTimeout(() => hideDisabledAuthMethods().catch(e => console.error('Error:', e)), 500);
            setTimeout(() => hideDisabledAuthMethods().catch(e => console.error('Error:', e)), 1000);
            setTimeout(() => hideDisabledAuthMethods().catch(e => console.error('Error:', e)), 2000);
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Привязываем обработчики событий для кнопок авторизации
            const authMethodCards = document.querySelectorAll('.auth-method-card');
            authMethodCards.forEach(card => {
                // Удаляем старые обработчики (если есть)
                card.removeEventListener('click', handleAuthMethodClick);
                // Добавляем новый обработчик
                card.addEventListener('click', handleAuthMethodClick);
                // Также добавляем обработчик через touchstart для мобильных устройств
                card.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    handleAuthMethodClick(e);
                }, { passive: false });
            });
            
            // Привязываем обработчик для кнопки "Продолжить"
            const proceedBtn = document.querySelector('#selectedMethodInfo button');
            if (proceedBtn) {
                proceedBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    proceedWithSelectedMethod();
                });
            }
            
            // Отключаем автозаполнение для всех полей email
            const emailInputs = document.querySelectorAll('input[type="email"]');
            emailInputs.forEach(input => {
                input.setAttribute('autocomplete', 'off');
                input.setAttribute('autocorrect', 'off');
                input.setAttribute('autocapitalize', 'off');
                input.setAttribute('spellcheck', 'false');
                input.setAttribute('data-lpignore', 'true');
                input.setAttribute('data-form-type', 'other');
                
                // Принудительно отключаем автозаполнение
                input.addEventListener('focus', function() {
                    this.setAttribute('autocomplete', 'off');
                });
            });
            
            // Сохраняем реферальный код из URL в localStorage, если он есть
            const urlParams = new URLSearchParams(window.location.search);
            const referralCodeFromUrl = urlParams.get('ref') || urlParams.get('referral') || urlParams.get('referralCode');
            if (referralCodeFromUrl) {
                localStorage.setItem('pendingReferralCode', referralCodeFromUrl);
                console.log('🔗 Реферальный код сохранен: ' + referralCodeFromUrl);
            }
            
            // Check if 2FA is required from URL parameter
            if (urlParams.get('require2fa') === 'true') {
                // Show 2FA form directly
                show2FAForm();
                return;
            }

            // Check if this is email verification
            if (urlParams.get('verify-email') === 'true') {
                const token = urlParams.get('token');
                if (token) {
                    verifyEmailToken(token);
                    return;
                }
            }

            // Check if this is a password reset page
            if (urlParams.get('reset-password') === 'true' || window.location.pathname.includes('reset-password')) {
                // Show password reset form directly
                showResetPasswordForm();
                return;
            }

            // Check if user is already logged in
            authToken = localStorage.getItem('authToken') || localStorage.getItem('accessToken');
            if (authToken) {
                console.log('🔑 Found token, verifying...');
                // Verify token and redirect to dashboard
                verifyTokenAndRedirect();
            } else {
                console.log('❌ No token found, showing method selection');
                // Show method selection by default
                showMethodStep().catch(e => console.error('Error in showMethodStep:', e));
            }
        });

        // Дополнительный вызов hideDisabledAuthMethods после полной загрузки страницы
        window.addEventListener('load', function() {
            console.log('🟡 Window loaded, calling hideDisabledAuthMethods');
            // Вызываем с несколькими задержками для надежности
            setTimeout(() => hideDisabledAuthMethods().catch(e => console.error('Error:', e)), 100);
            setTimeout(() => hideDisabledAuthMethods().catch(e => console.error('Error:', e)), 500);
            setTimeout(() => hideDisabledAuthMethods().catch(e => console.error('Error:', e)), 1000);
            setTimeout(() => hideDisabledAuthMethods().catch(e => console.error('Error:', e)), 2000);
        });

        // Show method selection step
        async function showMethodStep() {
            console.log('🔵 showMethodStep called');
            document.querySelectorAll('.auth-step').forEach(step => step.classList.remove('active'));
            document.getElementById('methodStep').classList.add('active');
            // Скрываем отключенные методы авторизации - вызываем несколько раз с задержками
            console.log('🔵 Calling hideDisabledAuthMethods');
            hideDisabledAuthMethods().catch(e => console.error('Error:', e));
            setTimeout(() => hideDisabledAuthMethods().catch(e => console.error('Error:', e)), 200);
            setTimeout(() => hideDisabledAuthMethods().catch(e => console.error('Error:', e)), 500);
            setTimeout(() => hideDisabledAuthMethods().catch(e => console.error('Error:', e)), 1000);
            setTimeout(() => hideDisabledAuthMethods().catch(e => console.error('Error:', e)), 2000);
        }

        // Handle auth method card click
        function handleAuthMethodClick(event) {
            event.preventDefault();
            event.stopPropagation();
            const card = event.currentTarget;
            const method = card.getAttribute('data-method');
            console.log('🖱️ Auth method card clicked:', method);
            if (method) {
                selectAuthMethod(method);
            }
        }

        // Select authentication method
        function selectAuthMethod(method) {
            selectedAuthMethod = method;
            
            // Remove previous selection
            document.querySelectorAll('.auth-method-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Add selection to clicked card
            const selectedCard = document.querySelector(`[data-method="${method}"]`);
            if (selectedCard) {
                selectedCard.classList.add('selected');
            }
            
            // Show method info
            const methodNames = {
                'EMAIL': 'Email',
                'TELEGRAM_OAUTH': 'Telegram OAuth',
                'GITHUB': 'GitHub'
            };
            
            document.getElementById('selectedMethodName').textContent = methodNames[method];
            document.getElementById('selectedMethodInfo').style.display = 'block';
        }

        // Proceed with selected method
        function proceedWithSelectedMethod() {
            if (!selectedAuthMethod) {
                showMessage('Выберите способ входа', 'error');
                return;
            }
            
            switch (selectedAuthMethod) {
                case 'EMAIL':
                    showEmailStep();
                    break;
                case 'TELEGRAM_OAUTH':
                    window.location.href = 'telegram-login.html';
                    break;
                case 'GITHUB':
                    // Request GitHub OAuth URL from backend and redirect
                    (async () => {
                        try {
                            const resp = await apiCall('/api/auth/multi/oauth/github/url', { method: 'GET' });
                            if (resp && resp.url) {
                                window.location.href = resp.url;
                            } else {
                                showOAuthStep();
                            }
                        } catch (e) {
                            console.error('GitHub OAuth URL error:', e);
                            showOAuthStep();
                        }
                    })();
                    break;
                default:
                    showMessage('Выбранный метод не поддерживается', 'error');
            }
        }

        // Show email step
        function showEmailStep() {
            document.querySelectorAll('.auth-step').forEach(step => step.classList.remove('active'));
            document.getElementById('emailStep').classList.add('active');
        }

        // Show phone auth step
        function showPhoneAuthStep() {
            // For now, redirect to multi-auth page
            window.location.href = 'multi-auth-login.html?method=' + selectedAuthMethod;
        }

        // Show OAuth step
        function showOAuthStep() {
            // For now, redirect to multi-auth page
            window.location.href = 'multi-auth-login.html?method=' + selectedAuthMethod;
        }


        // Go back to method step
        function goBackToMethodStep() {
            document.querySelectorAll('.auth-step').forEach(step => step.classList.remove('active'));
            const methodStepEl = document.getElementById('methodStep');
            if (methodStepEl) {
                methodStepEl.classList.add('active');
            }
            
            // Clear selection
            selectedAuthMethod = null;
            document.querySelectorAll('.auth-method-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.getElementById('selectedMethodInfo').style.display = 'none';
            
            // Скрываем отключенные методы авторизации
            hideDisabledAuthMethods().catch(e => console.error('Error:', e));
        }

        // Switch between login and register modes (упрощено - только умная регистрация)
        function switchAuthMode(mode) {
            // Hide all forms
            document.querySelectorAll('.auth-step').forEach(step => step.classList.remove('active'));

            // Show login form
            document.getElementById('loginForm').classList.add('active');
        }

        // Global variable to store current email
        let currentEmail = '';

        // Handle email step form submission
        async function handleEmailStep(event) {
            event.preventDefault();
            
            const email = document.getElementById('emailInput').value;
            currentEmail = email;

            // Show loading
            showLoading('emailStepBtn', 'emailStepBtnText', 'emailStepLoading');

            try {
                // Check if user exists
                const response = await apiCall('/api/users/check-email', {
                    method: 'POST',
                    body: JSON.stringify({ email })
                });

                // User exists - show login form
                showLoginFormWithEmail(email);
                
            } catch (error) {
                console.error('Email check error:', error);
                
                // User doesn't exist - show registration form
                showSmartRegistration(email, '');
                showMessage('Пользователь не найден. Заполните форму регистрации', 'info');
            } finally {
                hideLoading('emailStepBtn', 'emailStepBtnText', 'emailStepLoading');
            }
        }

        // Show login form with pre-filled email
        function showLoginFormWithEmail(email) {
            document.querySelectorAll('.auth-step').forEach(step => step.classList.remove('active'));
            document.getElementById('loginForm').classList.add('active');
            
            // Update email display
            document.getElementById('loginEmailDisplay').textContent = email;
            
            // Focus on password field
            setTimeout(() => {
                document.getElementById('loginPassword').focus();
            }, 100);
        }

        // Go back to email step
        function goBackToEmailStep() {
            document.querySelectorAll('.auth-step').forEach(step => step.classList.remove('active'));
            document.getElementById('emailStep').classList.add('active');
            
            // Clear password field
            document.getElementById('loginPassword').value = '';
        }

        // Show login form
        function showLoginForm() {
            document.querySelectorAll('.auth-step').forEach(step => step.classList.remove('active'));
            document.getElementById('loginForm').classList.add('active');
            
            // Update header (no longer needed as it's just text)
            // const loginHeader = document.querySelector('.auth-header');
            
            // Pre-fill email if available
            if (currentEmail) {
                document.getElementById('loginEmailDisplay').textContent = currentEmail;
            }
        }

        // Show email code form
        function showEmailCodeForm() {
            document.querySelectorAll('.auth-step').forEach(step => step.classList.remove('active'));
            document.getElementById('emailCodeForm').classList.add('active');
            
            // Pre-fill email if available
            if (currentEmail) {
                document.getElementById('emailCodeEmail').value = currentEmail;
            } else {
                document.getElementById('emailCodeEmail').value = '';
            }
            document.querySelectorAll('#emailCodeForm .otp-input').forEach(input => input.value = '');
            
            // Show send code button, hide confirm button
            document.getElementById('sendCodeBtn').classList.remove('hidden');
            document.getElementById('emailCodeBtn').classList.add('hidden');
            
            // Focus email input
            document.getElementById('emailCodeEmail').focus();
        }

        // Show 2FA form
        function show2FAForm() {
            document.querySelectorAll('.auth-step').forEach(step => step.classList.remove('active'));
            document.getElementById('twoFactorForm').classList.add('active');
        }

        // Show forgot password form
        function showForgotPassword() {
            document.querySelectorAll('.auth-step').forEach(step => step.classList.remove('active'));
            document.getElementById('forgotPasswordForm').classList.add('active');
            
            // Pre-fill email if available
            if (currentEmail) {
                document.getElementById('forgotEmail').value = currentEmail;
            }
        }

        // Show reset password form
        function showResetPasswordForm() {
            document.querySelectorAll('.auth-step').forEach(step => step.classList.remove('active'));
            document.getElementById('resetPasswordForm').classList.add('active');
            
            // Pre-fill email if available
            if (currentEmail) {
                document.getElementById('resetEmail').value = currentEmail;
            }
        }

        // Show complete registration form
        function showCompleteRegistration() {
            document.querySelectorAll('.auth-step').forEach(step => step.classList.remove('active'));
            document.getElementById('completeRegistrationForm').classList.add('active');
            
            // Pre-fill email if available
            if (currentEmail) {
                document.getElementById('completeEmail').value = currentEmail;
            }
        }

        // Show smart registration (when user doesn't exist during login)
        function showSmartRegistration(email, password) {
            // Hide all forms
            document.querySelectorAll('.auth-step').forEach(step => step.classList.remove('active'));
            
            // Show smart registration form
            document.getElementById('smartRegistrationForm').classList.add('active');
            
            // Update current email
            currentEmail = email;
            
            // Pre-fill email and password
            document.getElementById('smartEmail').value = email;
            document.getElementById('smartPassword').value = password;
            document.getElementById('smartConfirmPassword').value = password;
            
            // Update form title
            document.getElementById('smartFormTitle').textContent = 'Завершите регистрацию';
            document.getElementById('smartFormSubtitle').textContent = 'Мы запомнили ваши данные. Добавьте дополнительную информацию:';
        }

        // Toggle password visibility
        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const button = input.nextElementSibling;
            const icon = button.querySelector('i');

            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        // Move to next OTP input
        function moveToNext(current, index) {
            const inputs = document.querySelectorAll('.otp-input');
            
            if (current.value.length === 1 && index < inputs.length - 1) {
                inputs[index + 1].focus();
            }
            
            // Check if all inputs are filled
            checkOTPComplete();
        }

        // Move to next 2FA input
        function moveToNext2FA(current, index) {
            const inputs = document.querySelectorAll('#twoFactorForm .otp-input');
            
            if (current.value.length === 1 && index < inputs.length - 1) {
                inputs[index + 1].focus();
            }
            
            // Check if all inputs are filled
            check2FAComplete();
        }

        // Check if OTP is complete
        function checkOTPComplete() {
            const inputs = document.querySelectorAll('.otp-input');
            const allFilled = Array.from(inputs).every(input => input.value.length === 1);
            
            if (allFilled) {
                // Auto-submit form
                document.getElementById('emailCodeFormElement').dispatchEvent(new Event('submit'));
            }
        }

        // Check if 2FA is complete
        function check2FAComplete() {
            const inputs = document.querySelectorAll('#twoFactorForm .otp-input');
            const allFilled = Array.from(inputs).every(input => input.value.length === 1);
            
            if (allFilled) {
                // Auto-submit form
                document.getElementById('twoFactorFormElement').dispatchEvent(new Event('submit'));
            }
        }

        // Handle login form submission
        async function handleLogin(event) {
            event.preventDefault();
            
            const email = currentEmail; // Use stored email from email step
            const password = document.getElementById('loginPassword').value;
            const rememberMe = document.getElementById('rememberMe').checked;

            // Show loading
            showLoading('loginBtn', 'loginBtnText', 'loginLoading');

            try {
                const response = await apiCall('/api/auth/login', {
                method: 'POST',
                    body: JSON.stringify({ email, password })
                });

                if (response.requires2FA) {
                    // Save userId and email for 2FA completion
                    pending2FAUserId = response.userId;
                    pending2FAEmail = email;
                    // Send 2FA code to email
                    await send2FACode(email);
                    // Show 2FA form
                    show2FAForm();
                    showMessage('Код отправлен на вашу почту. Введите его для завершения входа.', 'info');
                } else {
                    // Login successful
                    authToken = response.accessToken;
                    localStorage.setItem('authToken', authToken);
                    
                    if (response.refreshToken) {
                        localStorage.setItem('refreshToken', response.refreshToken);
                    }

                    showMessage('Вход выполнен успешно!', 'success');
                    
                    // Redirect based on role
                    setTimeout(() => {
                        redirectBasedOnRole(response.user);
                    }, 1000);
                }
            } catch (error) {
                console.error('Login error:', error);
                
                // Показываем регистрацию ТОЛЬКО если backend явно сообщил, что пользователя нет
                if (error.message.includes('Пользователь не найден') || error.message.includes('User not found')) {
                    showSmartRegistration(email, password);
                    showMessage('Пользователь не найден. Заполните дополнительную информацию для регистрации', 'info');
                } else if (error.message.includes('Неверный пароль')) {
                    // User exists but wrong password
                    showMessage('Неверный пароль. Проверьте правильность введенного пароля.', 'error');
                } else {
                    showMessage('Ошибка входа: ' + error.message, 'error');
                }
            } finally {
                hideLoading('loginBtn', 'loginBtnText', 'loginLoading');
            }
        }

        // Send 2FA code to email
        async function send2FACode(email) {
            console.log('🚨 ФРОНТЕНД v' + VERSION + ': ВЫЗВАНА ФУНКЦИЯ send2FACode (2FA)');
            console.log('📧 Email:', email);
            try {
                await apiCall('/api/two-factor/send-code', {
                    method: 'POST',
                    body: JSON.stringify({ 
                        type: 'email',
                        contact: email 
                    })
                });
                console.log('2FA code sent to email:', email);
            } catch (error) {
                console.error('Error sending 2FA code:', error);
                showMessage('Ошибка отправки кода: ' + error.message, 'error');
            }
        }

        // Send email code for login (2FA)
        async function sendEmailCode() {
            const email = document.getElementById('emailCodeEmail').value;
            
            if (!email) {
                showMessage('Введите email', 'error');
                return;
            }

            console.log('🚨 ФРОНТЕНД v' + VERSION + ': ВЫЗВАНА ФУНКЦИЯ sendEmailCode (2FA LOGIN)');
            console.log('📧 Email:', email);

            // Show loading
            showLoading('sendCodeBtn', 'sendCodeBtnText', 'sendCodeLoading');

            try {
                await apiCall('/api/auth/email-code/send', {
                    method: 'POST',
                    body: JSON.stringify({ email })
                });

                showMessage('Код отправлен на вашу почту', 'success');
                
                // Hide send button, show confirm button
                document.getElementById('sendCodeBtn').classList.add('hidden');
                document.getElementById('emailCodeBtn').classList.remove('hidden');
                
                // Focus first OTP input
                document.querySelector('#emailCodeForm .otp-input').focus();
            } catch (error) {
                console.error('Send email code error:', error);
                showMessage('Ошибка отправки кода: ' + error.message, 'error');
            } finally {
                hideLoading('sendCodeBtn', 'sendCodeBtnText', 'sendCodeLoading');
            }
        }

        // Handle email code login (2FA)
        async function handleEmailCode(event) {
            event.preventDefault();
            
            const email = document.getElementById('emailCodeEmail').value;
            const code = Array.from(document.querySelectorAll('#emailCodeForm .otp-input')).map(input => input.value).join('');

            if (!email) {
                showMessage('Введите email', 'error');
                return;
            }

            if (code.length !== 6) {
                showMessage('Введите полный код из 6 цифр', 'error');
                return;
            }

            console.log('🚨 ФРОНТЕНД v' + VERSION + ': ВЫЗВАНА ФУНКЦИЯ handleEmailCode (2FA LOGIN)');
            console.log('📧 Email:', email);
            console.log('🔢 Code:', code);

            // Show loading
            showLoading('emailCodeBtn', 'emailCodeBtnText', 'emailCodeLoading');

            try {
                const response = await apiCall('/api/auth/email-code/login', {
                    method: 'POST',
                    body: JSON.stringify({ email, code })
                });

                // Email code login successful
                authToken = response.accessToken;
                localStorage.setItem('authToken', authToken);
                
                if (response.refreshToken) {
                    localStorage.setItem('refreshToken', response.refreshToken);
                }

                showMessage('Вход выполнен успешно!', 'success');
                
                // Redirect based on role
                setTimeout(() => {
                    redirectBasedOnRole(response.user);
                }, 1000);
            } catch (error) {
                console.error('Email code login error:', error);
                showMessage('Ошибка входа: ' + error.message, 'error');
            } finally {
                hideLoading('emailCodeBtn', 'emailCodeBtnText', 'emailCodeLoading');
            }
        }

        // Resend email code for login (2FA)
        async function resendEmailCode() {
            const email = document.getElementById('emailCodeEmail').value;
            
            if (!email) {
                showMessage('Введите email', 'error');
                return;
            }

            console.log('🚨 ФРОНТЕНД v' + VERSION + ': ВЫЗВАНА ФУНКЦИЯ resendEmailCode (2FA LOGIN)');
            console.log('📧 Email:', email);

            // Show loading
            const resendBtn = document.getElementById('resendBtn');
            const resendBtnText = document.getElementById('resendBtnText');
            const resendCountdown = document.getElementById('resendCountdown');
            
            resendBtn.disabled = true;
            resendBtnText.textContent = 'Отправка...';

            try {
                await apiCall('/api/auth/email-code/send', {
                    method: 'POST',
                    body: JSON.stringify({ email })
                });

                showMessage('Код отправлен повторно', 'success');
                
                // Start countdown
                let countdown = 60;
                resendBtnText.classList.add('hidden');
                resendCountdown.classList.remove('hidden');
                resendCountdown.textContent = `Повторная отправка через ${countdown}с`;
                
                const countdownInterval = setInterval(() => {
                    countdown--;
                    resendCountdown.textContent = `Повторная отправка через ${countdown}с`;
                    
                    if (countdown <= 0) {
                        clearInterval(countdownInterval);
                        resendBtn.disabled = false;
                        resendBtnText.classList.remove('hidden');
                        resendCountdown.classList.add('hidden');
                    }
                }, 1000);
            } catch (error) {
                console.error('Resend email code error:', error);
                showMessage('Ошибка отправки кода: ' + error.message, 'error');
                resendBtn.disabled = false;
                resendBtnText.classList.remove('hidden');
                resendCountdown.classList.add('hidden');
            }
        }

        // Handle 2FA
        async function handle2FA(event) {
            event.preventDefault();
            
            const code = Array.from(document.querySelectorAll('#twoFactorForm .otp-input')).map(input => input.value).join('');

            if (code.length !== 6) {
                showMessage('Введите полный код из 6 цифр', 'error');
                return;
            }
            
            if (!pending2FAUserId) {
                showMessage('Ошибка: ID пользователя не найден', 'error');
                return;
            }

            // Show loading
            showLoading('twoFactorBtn', 'twoFactorBtnText', 'twoFactorLoading');

            try {
                const response = await apiCall('/api/two-factor/verify-code', {
                    method: 'POST',
                    body: JSON.stringify({
                        type: 'email',
                        contact: pending2FAEmail,
                        code: code 
                    })
                });

                // 2FA successful
                authToken = response.accessToken;
                localStorage.setItem('authToken', authToken);
                
                if (response.refreshToken) {
                    localStorage.setItem('refreshToken', response.refreshToken);
                }

                // Clear pending 2FA data
                pending2FAUserId = null;
                pending2FAEmail = null;

                showMessage('Двухфакторная аутентификация пройдена!', 'success');
                
                // Redirect based on role
                setTimeout(() => {
                    redirectBasedOnRole(response.user);
                }, 1000);
            } catch (error) {
                console.error('2FA error:', error);
                showMessage('Ошибка 2FA: ' + error.message, 'error');
            } finally {
                hideLoading('twoFactorBtn', 'twoFactorBtnText', 'twoFactorLoading');
            }
        }

        // Handle registration
        async function handleRegister(event) {
            event.preventDefault();
            
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const confirmPassword = document.getElementById('regConfirmPassword').value;
            const firstName = document.getElementById('regFirstName').value;
            const lastName = document.getElementById('regLastName').value;

            // Validate passwords match
            if (password !== confirmPassword) {
                showMessage('Пароли не совпадают', 'error');
                return;
            }

            // Validate password strength
            if (password.length < 8) {
                showMessage('Пароль должен содержать минимум 8 символов', 'error');
                return;
            }

            // Show loading
            showLoading('registerBtn', 'registerBtnText', 'registerLoading');

            try {
                // Извлекаем реферальный код из URL параметров или localStorage
                const urlParams = new URLSearchParams(window.location.search);
                const referralCodeFromUrl = urlParams.get('ref') || urlParams.get('referral') || urlParams.get('referralCode');
                const referralCodeFromStorage = localStorage.getItem('pendingReferralCode');
                const referralCode = referralCodeFromUrl || referralCodeFromStorage;
                
                const requestBody = { 
                    email, 
                    password, 
                    firstName, 
                    lastName 
                };
                
                // Добавляем реферальный код, если он есть
                if (referralCode) {
                    requestBody.referralCode = referralCode;
                    console.log('🔗 Используется реферальный код: ' + referralCode);
                    localStorage.removeItem('pendingReferralCode');
                }
                
                const response = await apiCall('/api/auth/register', {
                    method: 'POST',
                    body: JSON.stringify(requestBody)
                });

                showMessage('Регистрация успешна! Добро пожаловать!', 'success');
                
                // Сохраняем токен и перенаправляем пользователя
                if (response.accessToken) {
                    localStorage.setItem('authToken', response.accessToken);
                    localStorage.setItem('refreshToken', response.refreshToken);
                    
                    // Redirect based on role
                    setTimeout(() => {
                        redirectBasedOnRole(response.user);
                    }, 1000);
                }
            } catch (error) {
                console.error('Registration error:', error);
                showMessage('Ошибка регистрации: ' + error.message, 'error');
            } finally {
                hideLoading('registerBtn', 'registerBtnText', 'registerLoading');
            }
        }

        // Handle complete registration
        async function handleCompleteRegistration(event) {
            event.preventDefault();
            
            const email = currentEmail; // Use stored email
            const password = document.getElementById('completePassword').value;
            const confirmPassword = document.getElementById('completeConfirmPassword').value;
            const firstName = document.getElementById('completeFirstName').value;
            const lastName = document.getElementById('completeLastName').value;
            const phone = document.getElementById('completePhone').value;

            // Validate passwords match
            if (password !== confirmPassword) {
                showMessage('Пароли не совпадают', 'error');
                return;
            }

            // Validate password strength
            if (password.length < 8) {
                showMessage('Пароль должен содержать минимум 8 символов', 'error');
                return;
            }

            // Show loading
            showLoading('completeBtn', 'completeBtnText', 'completeLoading');

            try {
                const response = await apiCall('/api/auth/register', {
                    method: 'POST',
                    body: JSON.stringify({ 
                        email,
                        password,
                        firstName, 
                        lastName,
                        phone 
                    })
                });

                showMessage('Регистрация завершена! Добро пожаловать!', 'success');
                
                // Save tokens
                if (response.accessToken) {
                    localStorage.setItem('authToken', response.accessToken);
                    localStorage.setItem('refreshToken', response.refreshToken);
                }
                
                // Redirect based on role
                setTimeout(() => {
                    redirectBasedOnRole(response.user);
                }, 1000);
            } catch (error) {
                console.error('Complete registration error:', error);
                showMessage('Ошибка завершения регистрации: ' + error.message, 'error');
            } finally {
                hideLoading('completeBtn', 'completeBtnText', 'completeLoading');
            }
        }

        // Handle smart registration (when user doesn't exist during login)
        async function handleSmartRegistration(event) {
            event.preventDefault();
            
            const email = currentEmail; // Use stored email
            const password = document.getElementById('smartPassword').value;
            const confirmPassword = document.getElementById('smartConfirmPassword').value;
            const firstName = document.getElementById('smartFirstName').value;
            const lastName = document.getElementById('smartLastName').value;
            const phone = document.getElementById('smartPhone').value;

            // Validate passwords match
            if (password !== confirmPassword) {
                showMessage('Пароли не совпадают', 'error');
                        return;
                    }

            // Validate password strength
            if (password.length < 8) {
                showMessage('Пароль должен содержать минимум 8 символов', 'error');
                        return;
                    }

            // Show loading
            showLoading('smartBtn', 'smartBtnText', 'smartLoading');

            try {
                // Извлекаем реферальный код из URL параметров или localStorage
                const urlParams = new URLSearchParams(window.location.search);
                const referralCodeFromUrl = urlParams.get('ref') || urlParams.get('referral') || urlParams.get('referralCode');
                const referralCodeFromStorage = localStorage.getItem('pendingReferralCode');
                const referralCode = referralCodeFromUrl || referralCodeFromStorage;
                
                // Use smart auth endpoint that handles both login and registration
                const requestBody = { 
                    email, 
                    password,
                    firstName, 
                    lastName
                };
                
                // Добавляем реферальный код, если он есть
                if (referralCode) {
                    requestBody.referralCode = referralCode;
                    console.log('🔗 Используется реферальный код: ' + referralCode);
                    // Удаляем из localStorage после использования
                    localStorage.removeItem('pendingReferralCode');
                }
                
                const response = await apiCall('/api/auth/smart-auth', {
                    method: 'POST',
                    body: JSON.stringify(requestBody)
                });

                // Registration successful
                authToken = response.accessToken;
                localStorage.setItem('authToken', authToken);
                
                if (response.refreshToken) {
                    localStorage.setItem('refreshToken', response.refreshToken);
                }

                showMessage('Регистрация завершена! Добро пожаловать!', 'success');
                
                // Redirect based on role
                setTimeout(() => {
                    redirectBasedOnRole(response.user);
                }, 1000);
                    } catch (error) {
                console.error('Smart registration error:', error);
                showMessage('Ошибка регистрации: ' + error.message, 'error');
                    } finally {
                hideLoading('smartBtn', 'smartBtnText', 'smartLoading');
            }
        }

        // Handle forgot password
        async function handleForgotPassword(event) {
            event.preventDefault();
            
            const email = document.getElementById('forgotEmail').value;

            // Show loading
            showLoading('forgotBtn', 'forgotBtnText', 'forgotLoading');

            try {
                await apiCall('/api/password-reset/forgot', {
                    method: 'POST',
                    body: JSON.stringify({ email })
                });

                showMessage('Ссылка для восстановления пароля отправлена на вашу почту', 'success');
                
                // Return to login
                setTimeout(() => {
                    showLoginForm();
                }, 2000);
                    } catch (error) {
                console.error('Forgot password error:', error);
                showMessage('Ошибка восстановления пароля: ' + error.message, 'error');
                    } finally {
                hideLoading('forgotBtn', 'forgotBtnText', 'forgotLoading');
            }
        }

        // Handle reset password
        async function handleResetPassword(event) {
            event.preventDefault();
            
            const newPassword = document.getElementById('resetNewPassword').value;
            const confirmPassword = document.getElementById('resetConfirmPassword').value;

                    if (newPassword !== confirmPassword) {
                showMessage('Пароли не совпадают', 'error');
                        return;
                    }

                    if (newPassword.length < 6) {
                showMessage('Пароль должен быть не менее 6 символов', 'error');
                        return;
                    }

            // Get token from URL
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');

            if (!token) {
                showMessage('Токен для сброса пароля отсутствует', 'error');
                        return;
                    }

            // Show loading
            showLoading('resetBtn', 'resetBtnText', 'resetLoading');

            try {
                await apiCall('/api/password-reset/reset', {
                    method: 'POST',
                    body: JSON.stringify({ 
                        token: token,
                        newPassword: newPassword 
                    })
                });

                showMessage('Пароль успешно изменен. Вы будете перенаправлены на страницу входа.', 'success');
                
                // Return to login
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 3000);
                    } catch (error) {
                console.error('Reset password error:', error);
                showMessage('Ошибка сброса пароля: ' + error.message, 'error');
                    } finally {
                hideLoading('resetBtn', 'resetBtnText', 'resetLoading');
            }
        }

        // Флаг для предотвращения множественных перенаправлений
        let isRedirecting = false;

        // Redirect based on user role
        function redirectBasedOnRole(user) {
            // Предотвращаем множественные перенаправления
            if (isRedirecting) {
                console.log('🚫 Redirect already in progress, skipping');
                return;
            }
            
            const rolePriority = {
                'super_admin': 5,
                'admin': 4,
                'manager': 3,
                'editor': 2,
                'viewer': 1
            };
            
            // Get the highest priority role
            let roles = user.roles || [];
            if (roles.length > 0 && typeof roles[0] === 'string') {
                roles = roles.map(roleName => ({ name: roleName }));
            }
            
            const highestRole = roles.reduce((highest, current) => {
                const currentPriority = rolePriority[current.name] || 0;
                const highestPriority = rolePriority[highest?.name] || 0;
                return currentPriority > highestPriority ? current : highest;
            }, null);
            
            console.log('🔍 User roles:', roles);
            console.log('🔍 Highest role:', highestRole);
            console.log('🔍 Current page:', window.location.pathname);
            
            // Проверяем, не находимся ли мы уже на правильной странице
            const currentPage = window.location.pathname;
            
            // Redirect based on role
            if (highestRole?.name === 'super_admin') {
                if (!currentPage.includes('test-micro-modules.html')) {
                    console.log('🔄 Redirecting super_admin to test-micro-modules.html');
                    isRedirecting = true;
                    window.location.href = 'test-micro-modules.html';
                } else {
                    console.log('✅ Super admin already on correct page');
                }
            } else {
                if (!currentPage.includes('dashboard.html')) {
                    console.log('🔄 Redirecting to dashboard.html');
                    isRedirecting = true;
                    window.location.href = 'dashboard.html';
                } else {
                    console.log('✅ User already on correct page');
                }
            }
        }

        // Verify token and redirect
        async function verifyTokenAndRedirect() {
            // Предотвращаем множественные проверки
            if (isRedirecting) {
                console.log('🚫 Redirect in progress, skipping token verification');
                return;
            }
            
            try {
                const response = await apiCall('/api/auth/me', { method: 'GET' });
                currentUser = response;
                
                // Redirect based on role
                redirectBasedOnRole(currentUser);
                    } catch (error) {
                console.error('Token verification failed:', error);
                localStorage.removeItem('authToken');
                localStorage.removeItem('refreshToken');
            }
        }

        // Verify email token
        async function verifyEmailToken(token) {
            try {
                console.log('🔍 Проверяем токен подтверждения email:', token);
                
                const response = await apiCall('/api/auth/email-verification/verify', {
                    method: 'POST',
                    body: JSON.stringify({ token })
                });

                if (response.success) {
                    showMessage('Email успешно подтвержден! Вы будете перенаправлены на страницу входа.', 'success');
                    
                    // Redirect to login after 3 seconds
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 3000);
                } else {
                    showMessage('Ошибка подтверждения email: ' + response.message, 'error');
                    
                    // Redirect to login after 5 seconds
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 5000);
                }
            } catch (error) {
                console.error('Ошибка подтверждения email:', error);
                showMessage('Ошибка подтверждения email: ' + error.message, 'error');
                
                // Redirect to login after 5 seconds
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 5000);
            }
        }

        // API call function
        async function apiCall(endpoint, options = {}) {
            const url = `${window.API_BASE_URL}${endpoint}`;
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    ...(authToken && { 'Authorization': `Bearer ${authToken}` })
                }
            };

            const response = await fetch(url, { ...defaultOptions, ...options });
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
            }

            return await response.json();
        }

        // Show loading state
        function showLoading(btnId, textId, loadingId) {
            document.getElementById(btnId).disabled = true;
            document.getElementById(textId).classList.add('hidden');
            document.getElementById(loadingId).classList.remove('hidden');
        }

        // Hide loading state
        function hideLoading(btnId, textId, loadingId) {
            document.getElementById(btnId).disabled = false;
            document.getElementById(textId).classList.remove('hidden');
            document.getElementById(loadingId).classList.add('hidden');
        }

        // Show message
        function showMessage(message, type) {
            // Remove existing messages
            const existingMessages = document.querySelectorAll('.error-message, .success-message');
            existingMessages.forEach(msg => msg.remove());

            // Create new message
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'error' ? 'error-message' : 'success-message';
            messageDiv.innerHTML = `
                <i class="fas fa-${type === 'error' ? 'exclamation-circle' : 'check-circle'}"></i>
                <span>${message}</span>
            `;

            // Insert message
            const form = document.querySelector('.auth-step.active form');
            if (form) {
                form.insertBefore(messageDiv, form.firstChild);
            }

            // Auto-hide after 5 seconds
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

    </script>
</body>
</html>
