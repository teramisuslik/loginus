<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í—Ö–æ–¥ —á–µ—Ä–µ–∑ Telegram - Loginus</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #1a202c;
        }

        .login-container {
            background: white;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            padding: 3rem;
            text-align: center;
            max-width: 400px;
            width: 100%;
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .logo-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
        }

        .logo-text {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        h1 {
            font-size: 1.8rem;
            margin-bottom: 1rem;
            color: #1a202c;
        }

        p {
            color: #64748b;
            margin-bottom: 2rem;
        }

        .telegram-widget-container {
            margin: 2rem 0;
        }

        .back-button {
            margin-top: 2rem;
            padding: 0.75rem 2rem;
            background: #f1f5f9;
            border: none;
            border-radius: 12px;
            color: #475569;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .back-button:hover {
            background: #e2e8f0;
        }

        .loading {
            display: none;
            padding: 1rem;
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="logo">
            <div class="logo-icon">üöÄ</div>
            <div class="logo-text">Loginus</div>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h1 style="margin: 0;">–í—Ö–æ–¥ —á–µ—Ä–µ–∑ Telegram</h1>
            <button onclick="switchTelegramAccount()" style="background: transparent; border: 1px solid #667eea; color: #667eea; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.9rem; cursor: pointer; transition: all 0.3s ease;">
                <i class="fas fa-exchange-alt"></i> –°–º–µ–Ω–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç
            </button>
        </div>
        <p>–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –≤–æ–π—Ç–∏ —á–µ—Ä–µ–∑ –≤–∞—à Telegram –∞–∫–∫–∞—É–Ω—Ç</p>

        <div class="telegram-widget-container" id="telegram-widget-container">
            <!-- Telegram Widget –±—É–¥–µ—Ç –≤—Å—Ç–∞–≤–ª–µ–Ω –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏ cookies -->
        </div>

        <div class="loading" id="loading">
            –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥–∞...
        </div>

        <button class="back-button" onclick="window.location.href='index.html'">
            ‚Üê –ù–∞–∑–∞–¥
        </button>
    </div>

    <script>
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–º–µ–Ω—ã –∞–∫–∫–∞—É–Ω—Ç–∞ Telegram
        function switchTelegramAccount() {
            console.log('üîÑ Switching Telegram account - forcing complete reset with page reload...');
            
            // –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–æ–π
            localStorage.clear();
            sessionStorage.clear();
            
            // –û—á–∏—â–∞–µ–º –í–°–ï cookies –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ
            const allCookies = document.cookie.split(";");
            allCookies.forEach(function(c) {
                const cookieName = c.split("=")[0].trim();
                if (cookieName) {
                    const domains = [
                        window.location.hostname,
                        '.' + window.location.hostname,
                        '.telegram.org',
                        '.oauth.telegram.org',
                        'web.telegram.org',
                        '.t.me'
                    ];
                    const paths = ['/', window.location.pathname];
                    
                    domains.forEach(domain => {
                        paths.forEach(path => {
                            document.cookie = `${cookieName}=;expires=${new Date(0).toUTCString()};path=${path};domain=${domain}`;
                            document.cookie = `${cookieName}=;expires=${new Date(0).toUTCString()};path=${path}`;
                        });
                    });
                }
            });
            
            // –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Å–±—Ä–æ—Å–∞
            const uniqueTimestamp = Date.now();
            const randomStr = Math.random().toString(36).substring(7);
            const resetId = Math.random().toString(36).substring(7);
            const forceReset = Math.random().toString(36).substring(7);
            
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Å–±—Ä–æ—Å–∞
            // –≠—Ç–æ –∑–∞—Å—Ç–∞–≤–∏—Ç Telegram –≤–∏–¥–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é
            const resetUrl = window.location.origin + window.location.pathname + 
                '?forceLogin=true' +
                '&_account_reset=1' +
                '&t=' + uniqueTimestamp +
                '&_fresh=' + randomStr +
                '&_reset=' + resetId +
                '&_force_new=' + forceReset +
                '&_widget_reset=' + Date.now() +
                '&_clear_session=1';
            
            console.log('üîÑ Reloading page with reset parameters:', resetUrl);
            
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
            window.location.href = resetUrl;
        }
        
        // –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –≥–ª–æ–±–∞–ª—å–Ω–æ–π —Å—Ä–∞–∑—É, —á—Ç–æ–±—ã –æ–Ω–∞ –±—ã–ª–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è onclick
        window.switchTelegramAccount = switchTelegramAccount;
        
        // –¢–∞–∫–∂–µ –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
        if (typeof switchTelegramAccount === 'function') {
            window.addEventListener('DOMContentLoaded', function() {
                window.switchTelegramAccount = switchTelegramAccount;
            });
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –≤—ã–±–æ—Ä –∞–∫–∫–∞—É–Ω—Ç–∞
        const urlParams = new URLSearchParams(window.location.search);
        const forceLogin = urlParams.get('forceLogin') === 'true';
        const widgetReset = urlParams.get('_widget_reset') === '1';
        const accountReset = urlParams.get('_account_reset') === '1';
        const clearSession = urlParams.get('_clear_session') === '1';
        
        if (forceLogin || widgetReset || accountReset || clearSession) {
            console.log('üîÑ Force login mode - clearing Telegram session data to show account selection...');
            
            // –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö Telegram
            localStorage.removeItem('telegram_auth');
            localStorage.removeItem('telegram_user');
            localStorage.removeItem('authToken');
            localStorage.removeItem('accessToken');
            localStorage.removeItem('refreshToken');
            localStorage.removeItem('userData');
            
            // –û—á–∏—â–∞–µ–º cookies, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å Telegram
            document.cookie.split(";").forEach(function(c) { 
                const cookieName = c.split("=")[0].trim();
                if (cookieName.toLowerCase().includes('telegram') || 
                    cookieName.toLowerCase().includes('tg') || 
                    cookieName.toLowerCase().startsWith('t_') ||
                    cookieName.toLowerCase().includes('widget') ||
                    cookieName.toLowerCase().includes('auth') ||
                    cookieName.toLowerCase().includes('session')) {
                    // –û—á–∏—â–∞–µ–º –¥–ª—è –≤—Å–µ—Ö –≤–æ–∑–º–æ–∂–Ω—ã—Ö –ø—É—Ç–µ–π –∏ –¥–æ–º–µ–Ω–æ–≤
                    const domains = [
                        '',
                        window.location.hostname,
                        '.' + window.location.hostname,
                        '.telegram.org',
                        '.oauth.telegram.org',
                        'web.telegram.org'
                    ];
                    domains.forEach(domain => {
                        document.cookie = cookieName + "=;expires=" + new Date(0).toUTCString() + ";path=/;domain=" + (domain ? domain : window.location.hostname);
                        document.cookie = cookieName + "=;expires=" + new Date(0).toUTCString() + ";path=/";
                    });
                    console.log('üóëÔ∏è Cleared Telegram cookie:', cookieName);
                }
            });
            
            // –û—á–∏—â–∞–µ–º sessionStorage
            sessionStorage.clear();
            
            // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –æ—á–∏—â–∞–µ–º —Ç–æ–ª—å–∫–æ –µ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
            const widgetContainer = document.getElementById('telegram-widget-container');
            if (widgetContainer) {
                // –û—á–∏—â–∞–µ–º —Ç–æ–ª—å–∫–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, –Ω–æ –ù–ï —É–¥–∞–ª—è–µ–º —Å–∞–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
                widgetContainer.innerHTML = '';
                console.log('‚úÖ Widget container cleared');
            }
            
            // –£–¥–∞–ª—è–µ–º –≤–∏–¥–∂–µ—Ç—ã –≤–Ω–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (—Å–∫—Ä–∏–ø—Ç—ã –∏ iframe)
            const existingWidgets = document.querySelectorAll(
                'script[src*="telegram-widget"], script[src*="telegram.org"], iframe[src*="telegram"]'
            );
            existingWidgets.forEach(el => {
                // –ù–µ —É–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
                if (widgetContainer && !widgetContainer.contains(el)) {
                    el.remove();
                }
            });
            console.log('üóëÔ∏è Removed existing Telegram widgets');
        } else {
            console.log('‚ÑπÔ∏è Normal login mode - using existing Telegram session if available');
        }
        
        // –í—Å—Ç–∞–≤–ª—è–µ–º Telegram Widget
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –≤–∏–¥–∂–µ—Ç–∞
        const initWidget = () => {
            const widgetContainer = document.getElementById('telegram-widget-container');
            if (!widgetContainer) {
                console.warn('‚ö†Ô∏è telegram-widget-container not found, retrying...');
                // –ü—Ä–æ–±—É–µ–º –µ—â–µ —Ä–∞–∑ —á–µ—Ä–µ–∑ 100–º—Å, –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è
                setTimeout(initWidget, 100);
                return;
            }
            
            // –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç iframe, –Ω–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º –≤–∏–¥–∂–µ—Ç
            if (widgetContainer.querySelector('iframe[src*="telegram"]')) {
                console.log('‚úÖ Telegram widget already exists');
                return;
            }
            
            // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—É—Å—Ç –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –≤–∏–¥–∂–µ—Ç–∞
            widgetContainer.innerHTML = '';
            
            const script = document.createElement('script');
            script.async = true;
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—É—é –≤–µ—Ä—Å–∏—é —Å–∫—Ä–∏–ø—Ç–∞ —Å timestamp –¥–ª—è –æ–±—Ö–æ–¥–∞ –∫–µ—à–∞
            const scriptVersion = (forceLogin || widgetReset) ? Date.now() : '22';
            script.src = `https://telegram.org/js/telegram-widget.js?${scriptVersion}`;
            
            script.setAttribute('data-telegram-login', 'sdfisdhfksdf_bot');
            script.setAttribute('data-size', 'large');
            script.setAttribute('data-onauth', 'onTelegramAuth(user)');
            script.setAttribute('data-request-access', 'write');
            
            if (forceLogin || widgetReset) {
                // –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω —Ä–µ–∂–∏–º —Å–º–µ–Ω—ã –∞–∫–∫–∞—É–Ω—Ç–∞, –¥–æ–±–∞–≤–ª—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π return_to URL
                const uniqueTimestamp = Date.now();
                const randomStr = Math.random().toString(36).substring(7);
                const returnToUrl = window.location.origin + window.location.pathname + 
                    '?t=' + uniqueTimestamp + 
                    '&forceLogin=true' + 
                    '&_fresh=' + randomStr;
                script.setAttribute('data-return-url', returnToUrl);
                // –î–æ–±–∞–≤–ª—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∞—Ç—Ä–∏–±—É—Ç –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è –≤–∏–¥–∂–µ—Ç–∞
                script.setAttribute('data-auth-url', window.location.href + '&_widget=' + uniqueTimestamp);
                script.setAttribute('data-widget-reset', 'true');
                console.log('‚úÖ Telegram Widget loaded with unique return_to URL (force login mode):', returnToUrl);
                console.log('üîê Force login mode: Widget will force account selection');
            } else {
                console.log('‚úÖ Telegram Widget loaded (normal mode)');
            }
            
            widgetContainer.appendChild(script);
            console.log('‚úÖ Telegram widget script added to container');
        };
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –≤–∏–¥–∂–µ—Ç–∞
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initWidget);
        } else {
            // DOM —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω
            setTimeout(initWidget, 100);
        }
        
        // Determine API base URL
        const API_BASE = (() => {
            const hostname = window.location.hostname;
            if (hostname === 'localhost' || hostname === '127.0.0.1') {
                return 'http://localhost:3001/api';
            }
            if (hostname.match(/^\d+\.\d+\.\d+\.\d+$/)) {
                return `${window.location.protocol}//${window.location.hostname}:3001/api`;
            }
            return `${window.location.protocol}//${window.location.hostname}/api`;
        })();

        console.log('üåê API_BASE:', API_BASE);

        // Telegram login callback
        async function onTelegramAuth(user) {
            console.log('Telegram user data:', user);
            document.getElementById('loading').style.display = 'block';
            
            // Check if this is a binding request
            const urlParams = new URLSearchParams(window.location.search);
            const bind = urlParams.get('bind');
            const userId = urlParams.get('userId');
            
            let requestBody = user;
            
            if (bind === 'true' && userId) {
                // This is a binding request
                console.log('Binding request for user:', userId);
                requestBody = {
                    telegramUser: user,
                    bind: true,
                    userId: userId
                };
            }
            
            // Send request
            try {
                const response = await fetch(`${API_BASE}/auth/multi/telegram-login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });
                
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç–∞
                let data;
                try {
                    console.log('üì• Telegram login response status:', response.status, response.ok);
                    console.log('üì• Telegram login response headers:', response.headers.get('content-type'));
                    
                    const responseText = await response.text();
                    console.log('üì• Telegram login raw response (length:', responseText.length, '):', responseText);
                    console.log('üì• Telegram login raw response (first 500 chars):', responseText.substring(0, 500));
                    
                    if (!response.ok) {
                        console.error('‚ùå Telegram login error response:', response.status, responseText);
                        let errorMessage = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
                        try {
                            const errorData = JSON.parse(responseText);
                            errorMessage = errorData.message || errorData.error || errorMessage;
                        } catch (e) {
                            errorMessage = responseText || `HTTP ${response.status}`;
                        }
                        alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + errorMessage);
                        document.getElementById('loading').style.display = 'none';
                        return;
                    }
                    
                    if (!responseText || responseText.trim() === '') {
                        console.error('‚ùå Empty response body');
                        alert('–û—à–∏–±–∫–∞: –ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
                        document.getElementById('loading').style.display = 'none';
                        return;
                    }
                    
                    try {
                        data = JSON.parse(responseText);
                        console.log('‚úÖ Response parsed successfully');
                    } catch (parseError) {
                        console.error('‚ùå JSON parse error:', parseError);
                        console.error('‚ùå Response text that failed to parse:', responseText);
                        alert('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞: ' + parseError.message);
                        document.getElementById('loading').style.display = 'none';
                        return;
                    }
                } catch (readError) {
                    console.error('‚ùå Error reading response:', readError);
                    alert('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞: ' + readError.message);
                    document.getElementById('loading').style.display = 'none';
                    return;
                }
                
                console.log('‚úÖ Login response parsed:', data);
                console.log('üìã Response data type:', typeof data);
                console.log('üìã Response data keys:', Object.keys(data));
                console.log('üìã Response data.requiresNFA:', data.requiresNFA, 'type:', typeof data.requiresNFA);
                console.log('üìã Response data.userId:', data.userId);
                console.log('üìã Response data.methods:', data.methods);
                console.log('üìã Response data.error:', data.error);
                console.log('üìã Response data.message:', data.message);
                console.log('üìã Checking requiresNFA:', data.requiresNFA === true, data.requiresNFA === 'true', data.requiresNFA === 1, !!data.requiresNFA);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º requiresNFA (–º–æ–∂–µ—Ç –±—ã—Ç—å true, —Å—Ç—Ä–æ–∫–∞ "true", –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ truthy)
                if (data.requiresNFA === true || data.requiresNFA === 'true' || data.requiresNFA === 1 || !!data.requiresNFA) {
                    // nFA required - redirect to index.html with nFA parameters
                    console.log('‚úÖ nFA required detected, methods:', data.methods);
                    const userId = data.userId || data.user?.id;
                    console.log('Extracted userId:', userId);
                    if (!userId) {
                        console.error('‚ùå No userId in response:', data);
                        alert('–û—à–∏–±–∫–∞: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –æ—Ç–≤–µ—Ç–µ');
                        document.getElementById('loading').style.display = 'none';
                        return;
                    }
                    const methods = data.methods || [];
                    const methodsParam = encodeURIComponent(JSON.stringify(methods));
                    console.log('üîÑ Redirecting to index.html with nFA params:', {
                        userId: userId,
                        methods: methods,
                        url: `index.html?nfa=true&userId=${userId}&methods=${methodsParam}`
                    });
                    // –û—á–∏—â–∞–µ–º —Ñ–ª–∞–≥ –ø–µ—Ä–µ–¥ —Ä–µ–¥–∏—Ä–µ–∫—Ç–æ–º
                    sessionStorage.removeItem('nfaCodesSent');
                    // –í—ã–ø–æ–ª–Ω—è–µ–º —Ä–µ–¥–∏—Ä–µ–∫—Ç
                    const redirectUrl = `index.html?nfa=true&userId=${userId}&methods=${methodsParam}`;
                    console.log('üîÑ About to redirect to:', redirectUrl);
                    window.location.href = redirectUrl;
                    return;
                }
                
                console.log('Not nFA, checking for accessToken...');
                
                if (data.accessToken) {
                    console.log('AccessToken found, setting tokens and redirecting to dashboard');
                    localStorage.setItem('authToken', data.accessToken);
                    localStorage.setItem('accessToken', data.accessToken);
                    if (data.refreshToken) {
                        localStorage.setItem('refreshToken', data.refreshToken);
                    }
                    
                    // Redirect to dashboard
                    window.location.href = 'dashboard.html';
                } else {
                    console.error('‚ùå No accessToken and no requiresNFA, showing error.');
                    console.error('‚ùå Full data object:', data);
                    console.error('‚ùå Full data JSON:', JSON.stringify(data, null, 2));
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –æ—à–∏–±–∫–∞ –≤ –æ—Ç–≤–µ—Ç–µ
                    if (data.error || data.message) {
                        console.error('‚ùå Error in response:', data.error || data.message);
                        alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + (data.error || data.message));
                    } else {
                        console.error('‚ùå Unknown response format');
                        alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.');
                    }
                    document.getElementById('loading').style.display = 'none';
                }
            } catch (error) {
                console.error('‚ùå Login error (catch block):', error);
                console.error('‚ùå Error name:', error.name);
                console.error('‚ùå Error message:', error.message);
                console.error('‚ùå Error stack:', error.stack);
                alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + (error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                document.getElementById('loading').style.display = 'none';
            }
        }

    </script>
</body>
</html>
